<!doctype html>
<html lang="en" data-initial-theme="{{ theme|e }}">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title|e }}</title>
    <style>{{ css_content }}</style>
</head>
<body>
<header class="header">
    <div class="container">
        <div class="title">{{ title|e }}</div>
        <button id="theme-toggle" class="theme-toggle" title="Toggle theme">
            <span class="icon-dark">🌙</span><span class="icon-light">☀️</span>
        </button>
        <section class="cards">
            <div class="card"><div class="label">Start</div><div class="value">{{ fmt_datetime(session_start) }}</div></div>
            <div class="card"><div class="label">Finish</div><div class="value">{{ fmt_datetime(session_finish) }}</div></div>
            <div class="card"><div class="label">Time (s)</div><div class="value">{{ fmt_seconds(stats.duration_total) }}</div></div>
            <div class="card total"><div class="label">Pass Rate</div><div class="value">{{ stats.pass_rate }}</div></div>
        </section>
    </div>
</header>
<main class="container">
    <section class="cards">
        <div class="card total" data-filter="all"><div class="label">Total</div><div class="value">{{ stats.total }}</div></div>
        <div class="card passed" data-filter="passed"><div class="label">Passed</div><div class="value">{{ stats.get("passed", 0) }}</div></div>
        <div class="card failed" data-filter="failed"><div class="label">Failed</div><div class="value">{{ stats.get("failed", 0) }}</div></div>
        <div class="card skipped" data-filter="skipped"><div class="label">Skipped</div><div class="value">{{ stats.get("skipped", 0) }}</div></div>
        <div class="card xfailed" data-filter="xfailed"><div class="label">XFAIL</div><div class="value">{{ stats.get("xfailed", 0) }}</div></div>
        <div class="card xpassed" data-filter="xpassed"><div class="label">XPASS</div><div class="value">{{ stats.get("xpassed", 0) }}</div></div>
        <div class="card error" data-filter="error"><div class="label">Errors</div><div class="value">{{ stats.get("error", 0) }}</div></div>
    </section>
    <div class="search"><input id="search" type="search" placeholder="Search by name, file, component..."/></div>
    <div class="table-wrap">
        <table class="table">
            <thead>
            <tr>
                <th>#</th>
                <th>Test</th>
                <th>Status</th>
                <th>Component</th>
                <th>Duration (s)</th>
            </tr>
            </thead>
            <tbody>
            {% for result in results %}
                {% set details_id = 'details-' ~ loop.index %}
                {% set test_index = loop.index %}
                {% set params_str = parse_params_from_nodeid(result.nodeid) %}
                {% set search_text = [result.nodeid, result.path, result.title, result.components|join(' ')]|join(' ')|e %}
                <tr class="test-row" data-status="{{ result.outcome }}" data-text="{{ search_text }}" role="button" tabindex="0" aria-expanded="false" aria-controls="{{ details_id }}">
                    <td class="small">{{ loop.index }}</td>
                    <td>
                        <div class="mono">{{ decode_unicode_escapes(result.title)|e }}</div>
                        {% if params_str %}<div class="small">Parametrize: {{ params_str|e }}</div>{% endif %}
                    </td>
                    <td><span class="status {{ result.outcome }}">{{ result.outcome }}</span></td>
                    <td class="small">{{ (result.components or [])|join(', ')|e }}</td>
                    <td>{{ fmt_seconds(result.duration) }}</td>
                </tr>
                <tr class="details-row" id="{{ details_id }}" hidden>
                    <td colspan="5">
                        <div class="details">
                            <div class="details-actions">
                                {% if result.details.captured_logs and result.details.captured_logs.strip() %}
                                <button class="details-btn" type="button" data-modal-target="#logs-modal-{{ details_id }}"><span>📜</span> Logs</button>
                                {% endif %}
                                <button class="details-btn copy-btn" type="button" data-copy="#grid-{{ details_id }}" title="Copy details"><span>📋</span> Copy</button>
                            </div>
                            <div class="grid" id="grid-{{ details_id }}">
                                <div class="k">NodeID</div><div class="v mono">{{ decode_unicode_escapes(result.nodeid)|e }}</div>
                                <div class="k">File</div><div class="v mono">{{ result.path|e }}</div>
                                {% if result.details.headline %}
                                <div class="k">Result</div><div class="v"><span class="status {{ result.outcome }}">{{ result.details.headline|e }}</span></div>
                                {% endif %}
                                {% if result.execution_log %}
                                <div class="k">Execution Log</div><div class="v mono">
                                    {% import '_log_tree.html.jinja2' as log_helpers %}
                                    {{ log_helpers.render_log_tree(result.execution_log, test_index, {'value': 0}, {'value': 0}) }}
                                </div>
                                {% endif %}
                                {% if result.details.longrepr and not result.get('soft_assert_only', False) %}
                                <div class="k">Details</div><div class="v"><pre class="mono">{{ result.details.longrepr|e }}</pre></div>
                                {% endif %}
                                {% if result.details.captured_stdout %}
                                <div class="k">Output</div><div class="v"><pre class="mono">{{ result.details.captured_stdout|e }}</pre></div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</main>

{# --- Modals --- #}
{% for result in results %}
    {% set details_id = 'details-' ~ loop.index %}
    {% set test_index = loop.index %}
    {# Render modals for logs #}
    {% if result.details.captured_logs and result.details.captured_logs.strip() %}
    <div class="modal" id="logs-modal-{{ details_id }}" hidden>
        <div class="modal-overlay" data-modal-close></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="mono">{{ decode_unicode_escapes(result.title)|e }}</h3>
                <button class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body"><pre><code>{{ result.details.captured_logs|e }}</code></pre></div>
        </div>
    </div>
    {% endif %}

    {# Render modals for attachments #}
    {% for attachment in result.attachments %}
        {% set modal_id = 'attachment-modal-' ~ test_index ~ '-' ~ loop.index %}
         <div class="modal" id="{{ modal_id }}" hidden>
            <div class="modal-overlay" data-modal-close></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>{{ attachment.label|e }}</h3>
                    <button class="modal-close" data-modal-close>&times;</button>
                </div>
                <div class="modal-body">
                {% if attachment.content_type == "image" %}
                    <img src="{{ attachment.data }}" alt="{{ attachment.label|e }}">
                {% else %}
                    <pre><code>{{ attachment.data|e }}</code></pre>
                {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
{% endfor %}

<script>{{ js_content }}</script>
</body>
</html>
