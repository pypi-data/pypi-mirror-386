stages: [build, test-release, release]

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

build:
  stage: build
  image: python:3.11-bookworm
  script:
    - python -m pip install -U pip build
    - python -m build
  artifacts:
    paths: [dist/]
    expire_in: 1 hour

test_pkg:
  stage: test-release
  image: python:3.11-bookworm
  needs: 
    - job: build
      artifacts: true
  script:
    - python -m pip install -U pip
    - pip install pytest
    - pip install dist/*.whl || pip install dist/*.tar.gz
    - pytest -q

# Publish to TestPyPI on any tag vX.Y.Z
publish_testpypi:
  stage: test-release
  image: python:3.11-bookworm
  needs: 
    - job: build
      artifacts: true
    - job: test_pkg
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  id_tokens:
    TESTPYPI_ID_TOKEN:
      aud: testpypi
  script:
    - python -m pip install -U twine
    - twine upload --repository testpypi dist/*
  environment:
    name: test-release

# Manual promotion to PyPI
publish_pypi:
  stage: release
  image: python:3.11-bookworm
  needs: 
    - job: build
      artifacts: true
    - job: publish_testpypi
    - job: test_pkg
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  id_tokens:
    PYPI_ID_TOKEN:
      aud: pypi
  script:
    - python -m pip install -U twine
    - twine upload dist/*
  environment:
    name: release
