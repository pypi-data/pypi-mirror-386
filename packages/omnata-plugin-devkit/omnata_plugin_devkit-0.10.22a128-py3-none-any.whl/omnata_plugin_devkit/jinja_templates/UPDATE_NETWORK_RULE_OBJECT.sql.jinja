create or replace procedure PLUGIN.UPDATE_NETWORK_RULE_OBJECT(RULE_NAME VARCHAR,VALUE_LIST ARRAY)
   returns object
   language javascript
   COMMENT = $$
   Updates the addresses of a network rule, optionally using the addresses from an existing network rule as a starting point.
   $$
   execute as owner
as
$$
try{
   // cannot seem to get bindings to work with the network rule value list.
   // unfortunately we'll just have to sanitise the input manually and interpolate
   VALUE_LIST.forEach(function(domainName) {
        if (domainName.includes("'")){
            throw `Domain name cannot contain a quote mark: ${domainName}`
        }
    });
   var networkAddressList = VALUE_LIST.map(x => `'${x}'`)
   var valueListString = networkAddressList.join(',')

   snowflake.createStatement( {
      sqlText: `ALTER NETWORK RULE IDENTIFIER(?)
                  SET VALUE_LIST = (${valueListString})`,
      binds:[RULE_NAME]
   } ).execute();
   
   return {
        "success": true,
        "data": null
   }
}
catch(e){
   return {
      "success": false,
      "error": `UPDATE_NETWORK_RULE_OBJECT: ${String(e)}`
   }
}

$$
;

grant usage on procedure PLUGIN.UPDATE_NETWORK_RULE_OBJECT(VARCHAR,ARRAY)
to application role OMNATA_MANAGEMENT;

