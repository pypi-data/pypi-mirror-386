<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%%SHEET_TITLE%%</title>
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.x/dist/index.umd.js"></script>
    <style>
        :root {
            /* Parameters */
            --font-size-multiplicator: 1.2;
            --note-font-size-multiplicator: 0.75; /* Note is details in a question */

            /* Question mark */
            --question-mark-color: #c5000b;
            --question-mark-weight: bold;

            /* Counter */
            --counter-background-color: #3771c8;
            --counter-text-color: #fff;
            --counter-font-weight: bold;

            /* Answer input */
            --answer-input-background-color: #c3e4f8;

            /* Answer box */
            --answer-box-width: 10rem;

            /* Form buttons */
            --button-background-color: #fff;
            --button-text-color: #000;

            /* Calculated parameters */
            --font-size: calc(1.2rem * var(--font-size-multiplicator));
            --width-multiplicator: calc((var(--font-size-multiplicator) + 1) / 2);
            --counter-text-size: calc(var(--font-size-multiplicator) * 1rem);
            --counter-bullet-size: calc(1.6 * var(--counter-text-size));
            --answer-input-width: calc(4rem * var(--width-multiplicator));
            --note-font-size: calc(var(--note-font-size-multiplicator) * var(--font-size));
        }

        body {
            font-family: Ubuntu, Arial, Helvetica, sans-serif;
        }

        header {
            display: flex;
            flex-direction: row;
            align-items: center;
            h1 {
                flex: 1;
            }
        }

        .container {
            width: clamp(320px, 90vw, 800px);
            margin: 0 auto; /* Centrage */
        }

        #score-box {
            border: 1px solid #000;
            padding: 0.5rem;
        }

        #score {
            display: inline-block;
            min-width: calc(3rem * var(--width-multiplicator));
        }

        .question-mark {
            color: var(--question-mark-color);
            font-weight: var(--question-mark-weight);
        }

        section.list {
            ol {
                list-style: none;
                counter-reset: exercice;
                padding-left: 0;

                li {
                    counter-increment: exercice;
                    border-top: 1px solid black;
                    font-size: var(--font-size);

                    &:last-of-type {
                        border-bottom: 1px solid black;
                    }

                    display: grid;
                    grid-template-columns: auto 1fr var(--answer-box-width); /* Compteur + Question + Réponse (largeur fixe) */
                    gap: 0.5rem 1rem; /* row-gap column-gap */
                    align-items: center;

                    &:before {
                        content: counter(exercice);
                        background: var(--counter-background-color);
                        color: var(--counter-text-color);
                        font-size: var(--counter-text-size);
                        font-weight: var(--counter-font-weight);
                        border-radius: 50%;
                        width: var(--counter-bullet-size);
                        height: var(--counter-bullet-size);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        align-self: center;
                    }

                    .question {
                        grid-column: 2;
                        align-self: center;
                    }

                    .answer-box {
                        grid-column: 3;
                        align-self: center;
                        border-left: 1px solid black;
                        width: var(--answer-box-width); /* Largeur fixe pour assurer l'alignement */
                        box-sizing: border-box;
                        padding: 1rem;
                    }

                    .note {
                        display: block;
                        font-size: var(--note-font-size);
                        font-style: italic;
                    }

                    input.answer {
                        display: inline-block;
                        padding: 0.5rem;
                        font-size: var(--font-size);
                        width: var(--answer-input-width);
                        background-color: var(--answer-input-background-color);
                        border: 1px solid black;
                    }
                }
            }

            .buttons {
                display: flex;
                justify-content: space-between;
                margin-top: 2rem;
            }

            input[type="reset"],
            input[type="submit"],
            button#toggle-solutions {
                padding: 0.5rem 1rem;
                border: 1px solid #000;
                background-color: var(--button-background-color);
                color: var(--button-text-color);
                cursor: pointer;
                font-size: var(--font-size);
            }
        }

        section#solutions {
            .answer-box {
                color: green;
            }
        }

        input.answer {
            text-align: center;
            padding: 0.2rem;
        }

        .answer.success + .validation-icon::after {
            content: " ✓";
            color: green;
        }

        .answer.fail + .validation-icon::after {
            content: " ❌";
            color: red;
        }

        .fireworks-container {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            transition: background-color 1.5s ease-in-out;
        }

        .fireworks-container.fireworks-active {
            background-color: rgba(0, 0, 0, 0.8);
        }

        @media screen and (max-width: 768px) {
            header {
                flex-direction: column;
            }

            section.list {
                ol {
                    li {
                        grid-template-columns: auto 1fr; /* Compteur + reste */
                        grid-template-rows: auto auto;   /* Question + answer */
                        padding: 0.5rem 0;

                        .question {
                            grid-row: 1;
                            grid-column: 2;
                            /*padding: 1rem;*/
                            text-align: left;
                        }

                        div.answer-box {
                            grid-row: 2;
                            grid-column: 2;
                            border: none;
                            padding: 0;
                            width: auto;
                            text-align: left;
                        }
                    }
                }
            }
        }
    </style>
</head>
<body>
    <header class="container">
        <h1>%%SHEET_TITLE%%</h1>
        <div id="score-box">
            Score : <span id="score"></span>
        </div>
    </header>
    <main class="container">
        <section class="questions list">
            <form>
                <ol>
%%QUESTIONS_TABULAR%%
                </ol>
                <div class="buttons">
                    <input type="reset" value="Tout effacer">
                    <button type="button" id="toggle-solutions">Afficher les réponses</button>
                    <input type="submit" id="validate" value="Valider">
                </div>
            </form>
        </section>
        <section id="solutions" class="list" hidden>
            <h2>%%ANSWERS_TITLE%%</h2>
            <ol>
%%ANSWERS_TABULAR%%
            </ol>
        </section>
    </main>
    <div class="fireworks-container"
         style="z-index: -1; background-size: cover; background-position: 50% 50%; background-repeat: no-repeat;">
    </div>
    <script>
        const solutionsSection = document.getElementById('solutions');
        const toggleButton = document.getElementById('toggle-solutions');

        const toggleSolutions = function () {
            if (solutionsSection.hasAttribute('hidden')) {
                solutionsSection.removeAttribute('hidden');
                toggleButton.innerHTML = 'Cacher les réponses';
            } else {
                solutionsSection.setAttribute('hidden', '');
                toggleButton.innerHTML = 'Afficher les réponses';
            }
        }

        document.getElementById('toggle-solutions').addEventListener('click', function () {
            toggleSolutions();
        });

        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            validateAnswers();
        });

        const fireworksContainer = document.querySelector('.fireworks-container')
        const fireworks = new Fireworks.default(fireworksContainer)

        const startFireworks = function () {
            fireworksContainer.classList.add('fireworks-active');
            fireworksContainer.style.zIndex = 1;
            fireworks.start();
        }

        const validateAnswers = function () {
            const answers = document.querySelectorAll('input[type="text"].answer');
            let score = 0;
            let errors = 0;
            answers.forEach(answer => {
                const accepted = JSON.parse(answer.dataset.accepted).map(String);
                const answerValue = answer.value.replace(/\s/g, '');
                if (accepted.includes(answerValue)) {
                    answer.classList.remove('fail');
                    answer.classList.add('success');
                    score++;
                } else {
                    answer.classList.remove('success');
                    answer.classList.add('fail');
                    errors++;
                }
            });

            document.getElementById('score').textContent = score;
            if (errors === 0) {
                startFireworks();
            }
        }

        document.querySelector('.fireworks-container').addEventListener('click', function(event) {
            fireworksContainer.classList.remove('fireworks-active');

            fireworksContainer.addEventListener('transitionend', (e) => {
                fireworks.stop();
                fireworksContainer.style.zIndex = -1;

            }, {once: true})
        });

        document.querySelector('input[type=reset]').addEventListener('click', function () {
            document.querySelectorAll('input.answer').forEach(answer => {
                answer.classList.remove('fail', 'success');
            });
            document.getElementById('score').textContent = '';
        })
    </script>
</body>
</html>
