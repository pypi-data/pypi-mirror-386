"use strict";(self.webpackChunk_datalayer_ui=self.webpackChunk_datalayer_ui||[]).push([[7721],{27721:(e,t,n)=>{n.d(t,{zg:()=>ee,dU:()=>te,wj:()=>Z});var s=n(88037),o=n(59179),i=n(51671),a=n(89460),l=n(23165),r=n(5279),c=n(69584),d=n(14809),u=n(52982),h=n(60372),m=n(9387),p=n(72870),g=n(63948),_=n(94064),f=n(77544),C=n(98238),v=n(72490),x=n(74389),w=n(2375),b=n(3349),y=n(41273),k=n(2335),E=n(55881),S=n(63711),R=n(85181),D=n(38921),M=n(36848),N=n(94247),I=n(9857),T=n(75960),j=n(18035),O=n(26127),A=n(92131);function P(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const $=new WeakMap;class F{static getRemoteCell(e){return $.get(e)}static run(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=U.getState(e),i=U.runSelected(e,t,n,s);return U.handleRunState(e,o,!1),i}static runCells(e,t,n,s,o){if(!e.model)return Promise.resolve(!1);const i=U.getState(e),a=U.runCells(e,t,n,s,o);return U.handleRunState(e,i,!1),a}static runAll(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=U.getState(e),i=e.widgets.length,a=U.runCells(e,e.widgets,t,n,s);return e.activeCellIndex=i,e.deselectAll(),U.handleRunState(e,o,!0),a}static runAllAbove(e,t,n,s){const{activeCell:o,activeCellIndex:i,model:a}=e;if(!a||!o||i<1)return Promise.resolve(!1);const l=U.getState(e),r=U.runCells(e,e.widgets.slice(0,e.activeCellIndex),t,n,s);return e.deselectAll(),U.handleRunState(e,l,!0),r}static runAllBelow(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=U.getState(e),i=e.widgets.length,a=U.runCells(e,e.widgets.slice(e.activeCellIndex),t,n,s);return e.activeCellIndex=i,e.deselectAll(),U.handleRunState(e,o,!0),a}static async runAndAdvance(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=U.getState(e),i=U.runSelected(e,t,n,s),a=e.model;return e.activeCellIndex===e.widgets.length-1?(a.sharedModel.insertCell(e.widgets.length,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,S.signalToPromise)(e.activeCell.inViewportChanged,200).catch(()=>{}),e.mode="edit"):e.activeCellIndex++,U.handleRunState(e,o,!0),i}static async runAndInsert(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=U.getState(e),i=U.runSelected(e,t,n,s);return e.model.sharedModel.insertCell(e.activeCellIndex+1,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,S.signalToPromise)(e.activeCell.inViewportChanged,200).catch(()=>{}),e.mode="edit",U.handleRunState(e,o,!0),i}}P(F,"serviceManager",null);let U,K=function(e){return e[e.QUEUED=0]="QUEUED",e[e.STARTING_KERNEL=1]="STARTING_KERNEL",e[e.IMPORTING=2]="IMPORTING",e[e.EXECUTING=3]="EXECUTING",e[e.EXPORTING=4]="EXPORTING",e[e.UNKNOWN=5]="UNKNOWN",e[e.DONE=6]="DONE",e[e.ERROR=7]="ERROR",e}({});class G{constructor({cell:e,sessionContext:t,metadata:n}){P(this,"cell",void 0),P(this,"sessionContext",void 0),P(this,"metadata",void 0),this.cell=e,this.sessionContext=t,this.metadata=n}get connection(){return this.sessionContext?.session?.kernel??void 0}failedExecution(e){this.cell.setPrompt("")}cancelExecution(){this.cell.setPrompt("")}scheduleExecution(){this.cell.model.sharedModel.transact(()=>{this.cell.model.clearExecution()},!1),this.cell.model.sharedModel.getSource().trim()&&this.cell.setPrompt("*")}processCell(){return Promise.resolve(!1)}}class W extends G{constructor(e){super(e),P(this,"_connection",void 0),P(this,"_reason",null),P(this,"_isDisposed",!1),P(this,"_runtimeDesc",void 0),P(this,"_processed",null),P(this,"_state",K.QUEUED),P(this,"_stateChanged",new v.Signal(this)),P(this,"_variablesIn",void 0),P(this,"_variableOut",void 0);const t=this.cell.model.getMetadata("datalayer")??{};this._runtimeDesc=t.kernel,this._variablesIn=Array.isArray(t.in)?t.in:[],this._variableOut="string"==typeof t.out?t.out:""}get connection(){return this._connection}get isDisposed(){return this._isDisposed}get reason(){return this._reason}get state(){return this._state}setState(e,t){this._state===e&&this._reason===t||(this._reason=t??null,this._state=e,this._stateChanged.emit(this._state))}get stateChanged(){return this._stateChanged}failedExecution(e){super.failedExecution(),this.setState(K.ERROR,e)}cancelExecution(){super.cancelExecution(),this.setState(K.ERROR)}scheduleExecution(){super.scheduleExecution(),this.setState(K.QUEUED)}dispose(){this._isDisposed||(this._isDisposed=!0,this._connection?.dispose(),v.Signal.clearData(this))}async processCell(){let e;await this.setupKernel();try{this._processed=new C.PromiseDelegate,this._processCell().then(e=>{this._processed?.resolve(e)}).catch(e=>{this._processed?.reject(e)}),e=await this._processed.promise}finally{await this.teardownKernel()}return e}async _processCell(){if(!this._connection){const e=`Failed to process a remote cell '${this.cell.model.id}'.`;throw this.setState(K.ERROR,e),new Error(e)}if(this._variablesIn.length){if(!this.sessionContext){const e="Unable to import variables; no document kernel available.";throw this.setState(K.ERROR,e),new Error(e)}this.setState(K.IMPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await H(e.language,this.sessionContext.session.kernel,this._variablesIn,this._connection)){const e=`Failed to transfer ${this._variablesIn.join(", ")} to ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(K.ERROR,e),new Error(e)}}this.setState(K.EXECUTING);const e=await E.Yr.execute(this.cell,{session:{kernel:this._connection}},this.metadata);if(console.debug(`@datalayer/ui:runtimes: Capture cell ${this.cell.model.id} execution`,e),this.metadata.deletedCells&&(this.metadata.deletedCells.length=0),!e)return!1;if("ok"===e.content.status){if(this._variableOut){if(!this.sessionContext){const e="Unable to export variables; no document kernel available.";throw this.setState(K.ERROR,e),new Error(e)}this.setState(K.EXPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await H(e.language,this._connection,[this._variableOut],this.sessionContext.session.kernel)){const e=`Failed to transfer ${this._variableOut} from ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(K.ERROR,e),new Error(e)}}return this.setState(K.DONE),!0}throw this.setState(K.ERROR),new i.id(e.content)}async setupKernel(){if(!F.serviceManager){const e="No service manager available";throw this.setState(K.ERROR,e),new Error(e)}this.setState(K.STARTING_KERNEL),this._connection&&(this._connection.id===this._runtimeDesc.kernelId&&this._connection.name===this._runtimeDesc.name&&(this._connection.location??"local")===runtimeDescription.location||this._connection.dispose(),this._connection.isDisposed&&(this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0));const e=!1!==this._runtimeDesc.params?.notebook;switch(this._connection?.status){case"idle":case"busy":case"autorestarting":case"restarting":case"starting":break;default:{this._connection?.dispose(),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0;const t=(0,T.R)(this._runtimeDesc.location)?F.serviceManager.remote?.runtimesManager:F.serviceManager[this._runtimeDesc.location]?.kernels;if(e&&this._runtimeDesc.kernelId)try{this._connection=t?.connectTo({model:{id:this._runtimeDesc.kernelId,name:this._runtimeDesc.name},handleComms:!0})}catch(e){if(!e||"Unable to find the kernel."!==e.message)throw e;console.log(`Persistent kernel ${this._runtimeDesc.kernelId} does not exist. Starting a new one...`)}if(!this._connection)try{const{credits:n}=O.J7.getState(),{configuration:s,runtimeModels:o}=A.LH.getState(),i=(n?.available??0)/Math.max(s.maxCellRuntimes-o.filter(e=>"cell"===e.type).length,1);if(i<I.c)throw new Error("You do not have enough credits to start a Cell Remote Runtime.");this._connection=await(t?.startNew({environmentName:this._runtimeDesc.name,type:e?"notebook":"cell",creditsLimit:i,capabilities:this._runtimeDesc.params?.capabilities},{handleComms:!0}))}catch(t){if(503===t.response?.status)(0,k.f1)("Unable to create a new remote kernel",`No kernel available for environment '${this._runtimeDesc.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please try again later.`);else if("MaxRuntimesExceededError"===t.name){if(!e){const e=new C.PromiseDelegate,t=window.setTimeout(()=>{e.reject("Timeout")},3e5),n=A.LH.subscribe(t=>{t.runtimeModels.filter(e=>"cell"===e.type).length<t.configuration.maxCellRuntimes&&e.resolve()});try{return this.setState(K.STARTING_KERNEL,"Waiting for a cell kernel to stop…"),await e.promise,clearTimeout(t),this.setupKernel()}catch(e){console.log("Waiting for free kernel slot expired.")}finally{n()}}(0,k.f1)("Unable to create a new remote kernel",`${t.message} Cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}' cannot be executed.`)}else 404===t.response?.status&&(0,k.f1)("Unable to create a new remote kernel",`Unknown environment '${this._runtimeDesc.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please select an existing environment.`);throw this.setState(K.ERROR,"string"==typeof t?t:t.message??"Unable to start a kernel"),t}this._connection&&(this._connection?.connectionStatusChanged.connect(this.onConnectionChanged,this),this._connection?.statusChanged.connect(this.onKernelStatusChanged,this),this._connection.location=this._runtimeDesc.location,e&&(this._runtimeDesc.kernelId=this._connection.id,this.cell.model.setMetadata("datalayer",Object.assign(this.cell.model.getMetadata("datalayer")??{},{kernel:this._runtimeDesc}))))}}if(!this._connection){const e=`Unable to start a kernel for cell ${this.cell.model.id} with ${JSON.stringify(this._runtimeDesc)}`;throw this.setState(K.ERROR,e),new Error(e)}}async teardownKernel(){!1===this._runtimeDesc.params?.notebook&&(this._connection&&!this._connection.isDisposed&&((0,T.R)(this._runtimeDesc.location)?F.serviceManager.remote.runtimesManager.shutdown(this._connection.id):this._connection.shutdown(),this._connection.dispose()),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0)}onConnectionChanged(){"disconnected"===this._connection?.connectionStatus&&this._processed?.reject("Kernel has been disconnected")}onKernelStatusChanged(){["dead","terminating"].includes(this._connection?.status??"")&&this._processed?.reject(`Kernel status '${this._connection?.status}' is not appropriate`)}}async function H(e,t,n,s){const o=new j.J(e),i=o.saveVariables(n),a=await new M.D({connection:t}).execute(i),l=a.get(0)?.data["text/plain"]??"";if(!l)return!1;{const e=o.loadVariables(l),t=await new M.D({connection:s}).execute(e),i=t.get(0)?.data["text/plain"]||"[]",a=JSON.parse(i.slice(1,i.length-1));if(!n.every(e=>a.includes(e)))return!1;console.debug(`Successfully transfered ${n.join(", ")}`)}return!0}!function(e){const t=i.Ft.executed,n=i.Ft.executionScheduled,s=i.Ft.selectionExecuted;async function o(e,o,r,c,d){const u=o[-1];e.mode="command";try{const h=await Promise.all(o.map(s=>async function(e,s,o,r,c){const d=await async function({notebook:e,cell:s,sessionContext:o}){if("code"!==s.model.type)return!1;const i={deletedCells:e.model?.deletedCells??[],recordTiming:e.notebookConfig.recordTiming},r=!!(s.model.getMetadata("datalayer")??{}).kernel,c=new(r?W:G)({cell:s,sessionContext:o,metadata:i});if(r){$.set(s.model,c);const e=()=>{$.delete(s.model),c.dispose()};s.disposed.connect(e),o?.disposed.connect(e)}return async function(e,s){const o=new C.PromiseDelegate;a.has(e)||a.set(e,[]);const i=a.get(e),r=0===i.length;return n.emit({notebook:e,cell:s.cell}),s.scheduleExecution(),i.push({cell:s,done:o}),r&&l(i).catch(e=>{console.error("Fail to start processing the cell queue",e)}),o.promise.then(()=>{t.emit({notebook:e,cell:s.cell,success:!0})}).catch(n=>{t.emit({notebook:e,cell:s.cell,success:!1,error:n})}),o.promise}(e,c)}({notebook:e,cell:s,sessionContext:o});if(d)return!0;const u=(c=c||R.wK).load("jupyterlab");switch(s.model.type){case"markdown":s.rendered=!0,s.inputHidden=!1,t.emit({notebook:e,cell:s,success:!0});break;case"code":if(o){if(o.isTerminating){await(0,k.ui)({title:u.__("Kernel Terminating"),body:u.__("The kernel for %1 appears to be terminating. You can not run any cell for now.",o.session?.path),buttons:[k.lG.okButton()]});break}if(o.pendingInput)return await(0,k.ui)({title:u.__("Cell not executed due to pending input"),body:u.__("The cell has not been executed to avoid kernel deadlock as there is another pending input! Submit your pending input and try again."),buttons:[k.lG.okButton()]}),!1;if(o.hasNoKernel&&await o.startKernel()&&r&&await r.selectKernel(o),o.hasNoKernel)return s.model.sharedModel.transact(()=>{s.model.clearExecution()}),!0;const a=e.model?.deletedCells??[];n.emit({notebook:e,cell:s});let l=!1;try{const t={deletedCells:a,recordTiming:e.notebookConfig.recordTiming};console.debug(`@datalayer/ui:runtimes: Processing normally cell ${s.model.id}`);const n=s.model.sharedModel.source;if((0,N.ZP)(s)){const e=s.model.getMetadata("datalayer").datasource,t=e.variant??"",o=e.database??"",i=e.outputBucket??"",a=e.destinationVar??"";s.model.sharedModel.setSource(`%%${t} ${o} ${i} ${a}\n\n${n}`),s.model.sharedModel.setMetadata("editable",!1)}const r=await E.Yr.execute(s,o,t).finally(()=>{(0,N.ZP)(s)&&(s.model.sharedModel.setSource(n),s.model.sharedModel.setMetadata("editable",!0))})??void 0;a.splice(0,a.length),l=(()=>{if(s.isDisposed)return!1;if(!r)return!0;if("ok"===r.content.status){const t=r.content;return t.payload&&t.payload.length&&function(e,t,n){const s=e.payload?.filter(e=>"set_next_input"===e.source)[0];if(!s)return;const o=s.text;if(s.replace)return void n.model.sharedModel.setSource(o);const i=t.model.sharedModel,a=t.model.cells,l=(0,D.findIndex)(a,e=>e===n.model);-1===l?i.insertCell(i.cells.length,{cell_type:"code",source:o,metadata:{trusted:!1}}):i.insertCell(l+1,{cell_type:"code",source:o,metadata:{trusted:!1}})}(t,e,s),!0}throw new i.id(r.content)})()}catch(n){if(!s.isDisposed&&!n.message.startsWith("Canceled"))throw t.emit({notebook:e,cell:s,success:!1,error:n}),n;l=!1}return l&&t.emit({notebook:e,cell:s,success:!0}),l}s.model.sharedModel.transact(()=>{s.model.clearExecution()},!1)}return Promise.resolve(!0)}(e,s,r,c,d)));return!e.isDisposed&&(s.emit({notebook:e,lastCell:u}),e.update(),h.every(e=>e))}catch(t){if(!t.message||!t.message.startsWith("KernelReplyNotOK"))throw t;return o.map(e=>{"code"===e.model.type&&null===e.model.executionCount&&e.setPrompt("")}),s.emit({notebook:e,lastCell:u}),e.update(),!1}}e.getState=function(e){return{wasFocused:e.node.contains(document.activeElement),activeCellId:e.activeCell?.model.id??null}},e.handleRunState=async function(e,t,n=!1){const{activeCell:s,activeCellIndex:o}=e;n&&s&&await e.scrollToItem(o,"smart",0).catch(e=>{}),(t.wasFocused||"edit"===e.mode)&&e.activate()},e.runCells=o,e.runSelected=function(e,t,n,s){e.mode="command";let i=e.activeCellIndex;const a=e.widgets.filter((t,n)=>{const s=e.isSelectedOrActive(t);return s&&(i=n),s});return e.activeCellIndex=i,e.deselectAll(),o(e,a,t,n,s)};const a=new WeakMap;async function l(e){const t=e[0];if(!t)return Promise.resolve();const{done:n,cell:s}=t;try{const t=await s.processCell();n.resolve(t),e.shift(),l(e).catch(e=>{console.error("Error processing cell queue")})}catch(t){for(s.failedExecution(t.message),n.reject(t),s===e[0]?.cell&&e.shift();e.length;){const{done:t,cell:n}=e.shift()??{};n?.cancelExecution(),t?.reject("Canceled")}}}}(U||(U={}));var V=n(18683);function L(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Q{constructor(e){L(this,"_isDisposed",!1),L(this,"_cellFooters",new WeakMap),L(this,"_cellResetters",new WeakMap),L(this,"_panel",void 0),L(this,"_settings",{dateFormat:"yyy-MM-dd HH:mm:ss",showDate:!0,showLiveExecutionTime:!0}),this._panel=e,this._panel.content.model?.cells.changed.connect(this.onCellsChanged,this),this._panel.content.modelChanged.connect(()=>{this._panel.content.model?.cells.changed.connect(this.onCellsChanged,this)}),this._panel.context.sessionContext.statusChanged.connect(this.onKernelStatusChanged,this)}get settings(){return this._settings}set settings(e){C.JSONExt.deepEqual(this._settings,e)||(this._settings=e,this.onCellsChanged(this._panel.context.model.cells,{type:"set",newIndex:0,newValues:Array.from(this._panel.context.model.cells),oldIndex:0,oldValues:Array.from(this._panel.context.model.cells)}))}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,v.Signal.clearData(this))}onKernelStatusChanged(e,t){["starting","restarting","autorestarting"].includes(t)&&this._panel.content.widgets.forEach(e=>{this._cellResetters.get(e.model)?.emit(void 0)})}onCellsChanged(e,t){t.oldValues.forEach(e=>{this._removeFooter(e)}),Promise.all(t.newValues.map(e=>this._addFooter(e)))}async _addFooter(e){if("code"===e.type){const t=this._panel.content.widgets.find(t=>t.model===e);if(t){await t.ready;const n=new v.Signal(this),o=s._Q.create((0,V.jsx)(l.WV,{children:(0,V.jsx)(B,{model:e,stateReset:n})}));this._cellFooters.has(e)&&this._cellFooters.get(e)?.dispose(),this._cellFooters.set(e,t),this._cellResetters.set(e,n);const i=()=>{this._cellFooters.delete(e),this._cellFooters.delete(e),o.dispose()};t.disposed.connect(i),this._panel.disposed.disconnect(i),d.x0.attach(o,t.inputArea.editorWidget.node)}}}_removeFooter(e){this._cellFooters.get(e)?.dispose()}}const z=(e,t="yyy-MM-dd HH:mm:ss")=>(0,w.GP)(e,t),X=(e,t)=>{const n=36e5,s=864e5;let o=(0,b.b)(e,t);if(o<1e3)return`${o}ms`;const i=Math.floor(o/s);o%=s;const a=Math.floor(o/n);o%=n;const l=Math.floor(o/6e4);o%=6e4;let r="";return i&&(r+=`${i}d `),(i||a)&&(r+=`${a}h `),(i||a||l)&&(r+=`${l}m `),i||(r+=`${(o/1e3).toFixed(a?0:2)}s`),r.trim()};class q{constructor(e,t){L(this,"_tracker",void 0),L(this,"_extensions",new WeakMap),L(this,"_settings",{showLiveExecutionTime:!0,showDate:!0,dateFormat:"yyy-MM-dd HH:mm:ss"}),this._tracker=e,t&&t.load("@datalayer/ui:plugin").then(e=>{e&&(this._updateSettings(e),e.changed.connect(this._updateSettings.bind(this)),t.load("@jupyterlab/notebook-extension:tracker").then(e=>e.set("recordTiming",!0),e=>{console.error("@datalayer/ui: Could not force metadata recording.",e)}))}).catch(e=>{console.error("@datalayer/ui: Could not load settings",e)})}createNew(e,t){const n=new Q(e);return this._extensions.set(e,n),e.disposed.connect(()=>{this._extensions.delete(e)}),n}_updateSettings(e){const t={showLiveExecutionTime:e.get("showLiveExecutionTime").composite,showDate:e.get("showDate").composite},n=e.get("dateFormat").composite,s=(e=>{const t=new Date;try{return(0,w.GP)(t,e),{isValid:!0}}catch(e){return{isValid:!1,message:e.message}}})(n);s.isValid?t.dateFormat=n:(t.dateFormat="yyy-MM-dd HH:mm:ss",console.warn("Invalid date format in Execute Time extension setting",s.message??"")),this._settings={...this._settings,...t},this._tracker.forEach(e=>{const t=this._extensions.get(e);t&&(t.settings={...this._settings})})}}function B(e){const{model:t,stateReset:n}=e,{enqueueToast:s}=(0,y.d)(),[o,a]=(0,m.useState)(""),[l,r]=(0,m.useState)(""),[c,d]=(0,m.useState)(null),[u,h]=(0,m.useState)(""),[v,w]=(0,m.useState)(""),[b,k]=(0,m.useState)(""),[E,S]=(0,m.useState)(F.getRemoteCell(t)??null),[R,D]=(0,m.useState)(K.UNKNOWN),[M,N]=(0,m.useState)("");(0,m.useEffect)(()=>{const e=()=>{D(K.UNKNOWN),N(""),S(null)};return n.connect(e),()=>{n.disconnect(e)}},[n]),(0,m.useEffect)(()=>{const e=()=>{const n=t.getMetadata("datalayer")?.kernel;let s="",o="";if(n){let e=p.A;switch(s=n.displayName??"Unknown kernel",o=`${s} running `,n.location){case"local":o+="locally.";break;case"browser":e=g.A,o+="in your browser.";break;default:!1===n.params?.notebook?(e=_.A,o+="remotely."):(e=f.A,o+="in a Notebook Remote Runtime.")}d(e?(0,m.createElement)(e,{title:n.location}):null),a(s),r(o)}else d(null),a(""),r("");const i=t.getMetadata("execution");if(!i||!C.JSONExt.isObject(i))return u&&h(""),v&&w(""),void(b&&k(""));const l=i["iopub.status.busy"],c=l?new Date(l):null,x=i["shell.execute_reply.started"]||i["iopub.execute_input"],y=x?new Date(x):null,E=i.execution_failed,S=i["shell.execute_reply"]??E,R=S?new Date(S):null,D=S&&!i["iopub.execute_input"],M=setInterval(()=>{if(u.startsWith("Execution started at")){if(t.getMetadata("execution").execution_failed)return clearInterval(M),void e();if(y){const e=X(new Date,y);w(`${e} ${b?`(${b})`:""}`)}}else clearInterval(M)},100);let N="";if(D)N="";else if(R&&y){const e=X(R,y);k(e),N=E?"Failed":"Last executed",N&&(N+=` at ${z(R,"yyy-MM-dd HH:mm:ss")}`),N+=` in ${e}`}else y?N=`Execution started at ${z(y,"yyy-MM-dd HH:mm:ss")}`:c&&(b&&w(`N/A (${b})`),N=`Execution queued at ${z(c,"yyy-MM-dd HH:mm:ss")}`);u!==N&&h(N)},n=(e,{notebook:n,cell:s})=>{if(s.model===t){const e=F.getRemoteCell(t)??null;D(e?.state??K.QUEUED),N(e?.state?"":"Queued"),S(e)}},o=(e,{notebook:n,cell:o,success:i,error:a})=>{if(o.model!==t)return;const l=i?K.DONE:K.ERROR;D(E?.state??l),N(E?.reason??""),E?.state===K.ERROR&&s(E.reason??"Failed to execute cell on a remote kernel.",{variant:"error"})};return e(),t.metadataChanged.connect(e),"code"===t.type&&(i.Ft.executionScheduled.connect(n),i.Ft.executed.connect(o)),()=>{t.metadataChanged.disconnect(e),"code"===t.type&&(i.Ft.executionScheduled.disconnect(n),i.Ft.executed.disconnect(o))}},[t,E]),(0,m.useEffect)(()=>{const e=(e,t)=>{switch(D(t),t){case K.QUEUED:N("Queued");break;case K.ERROR:N(e.reason??"");break;case K.EXECUTING:N("Running…");break;case K.EXPORTING:N("Exporting data…");break;case K.IMPORTING:N("Importing data…");break;case K.STARTING_KERNEL:N(e.reason??"Starting the kernel…");break;default:N("")}};return E?.stateChanged.connect(e),()=>{E?.stateChanged.disconnect(e)}},[E]);const I=!!c;let T=!1,j=100,O=I?"var(--jp-brand-color1)":"var(--jp-brand-color3)",A="var(--jp-brand-color1)",P="";switch(R){case K.QUEUED:P="💤︎",j=0;break;case K.UNKNOWN:j=0;break;case K.DONE:P="✔︎",O=I?"var(--jp-success-color1)":"var(--jp-success-color3)",A="var(--jp-success-color1)";break;case K.ERROR:P="❌︎",O=I?"var(--jp-error-color1)":"var(--jp-error-color3)",A="var(--jp-error-color1)";break;case K.EXECUTING:P="⚡︎",T=!0,j=40;break;case K.EXPORTING:P="📤︎",T=!0,j=90;break;case K.IMPORTING:P="📥︎",T=!0,j=30;break;case K.STARTING_KERNEL:P="🔥︎",T=!0,j=20}const $=["dla-Cell-footer"];return I&&$.push("jp-mod-foreign"),(0,V.jsxs)("div",{className:$.join(" "),children:[(0,V.jsx)("div",{style:{minHeight:"3px"},children:R!==K.UNKNOWN&&(0,V.jsx)(x.z,{sx:{maxHeight:"3px"},progress:j,bg:O,animated:T,barSize:"small"})}),(0,V.jsxs)("div",{children:[(0,V.jsx)("span",{style:{color:A},title:M||void 0,children:`${P} ${M}`.trimEnd()}),(0,V.jsx)("span",{children:t.getMetadata("execution")&&(0,V.jsx)(V.Fragment,{children:u})}),(0,V.jsxs)("span",{className:"dla-Cell-footer-runtime",title:l,children:[c,o]})]})]})}var J=n(71518),Y=n(92843);const Z=()=>{i.Ft.run=F.run,i.Ft.runAll=F.runAll,i.Ft.runAllAbove=F.runAllAbove,i.Ft.runAllBelow=F.runAllBelow,i.Ft.runAndAdvance=F.runAndAdvance,i.Ft.runAndInsert=F.runAndInsert,i.Ft.runCells=F.runCells},ee={id:"@datalayer/ui:runtimes:cell-executor",description:"Handle runtime code execution per cell.",requires:[J.qk,a.fI],optional:[o.qe,r.co,o.zG],autoStart:!1,activate:(e,t,n,o,i,a)=>{F.serviceManager=t,Z(),o?.addFactory("Cell","dla-Runtimes-picker",o=>{const r=n.find(e=>!(!e.model||!Array.from(e.model.cells).find(e=>e===o.model)));return"code"!==o.model.type?new d.x0:s._Q.create((0,V.jsxs)(u.az,{display:"flex",children:[(0,V.jsx)(u.az,{children:(0,V.jsx)(l.WV,{children:(0,V.jsx)(Y.zl,{model:o.model,preference:r?.sessionContext?{id:r.sessionContext.session?.kernel?.id,language:r.sessionContext.specsManager.specs?.kernelspecs[r.sessionContext.session?.kernel?.name??""]?.language}:void 0,sessionContext:r?.sessionContext})})}),(0,V.jsx)(u.az,{children:(0,V.jsx)(l.WV,{children:(0,V.jsx)(h.B,{logIn:e.commands.hasCommand("@datalayer/ui:runtimes:create-widget")?()=>e.commands.execute("@datalayer/ui:runtimes:create-widget"):void 0,markdownParser:i??void 0,sanitizer:a??void 0,model:o.model,preference:r?.sessionContext?{id:r.sessionContext.session?.kernel?.id,language:r.sessionContext.specsManager.specs?.kernelspecs[r.sessionContext.session?.kernel?.name??""]?.language,location:r.sessionContext.location}:void 0,multiServiceManager:t,sessionContext:r?.sessionContext,translator:void 0})})})]}))})}},te={id:"@datalayer/ui:runtimes:cell-footer",description:"Cell footer with runtime information.",requires:[a.fI],optional:[c.X],autoStart:!1,activate:(e,t,n)=>{e.docRegistry.addWidgetExtension("Notebook",new q(t,n))}}},71518:(e,t,n)=>{n.d(t,{Pl:()=>l,TT:()=>a,UC:()=>o,qk:()=>i});var s=n(98238);const o="@datalayer/ui:runtimes:plugin",i=new s.Token("@datalayer/ui:runtimes:multi-service-manager"),a=new s.Token("@datalayer/ui:runtimes:browser-router"),l=new s.Token(o)},92843:(e,t,n)=>{n.d(t,{YN:()=>_,zl:()=>m});var s=n(9387),o=n(85181),i=n(88037),a=n(72490),l=n(58875),r=n(38621),c=n(52982),d=n(59176),u=n(18683);function h(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){const{model:t}=e,[n,o]=(0,s.useState)(!1),[i,a]=(0,s.useState)(!1),h=(0,s.useCallback)(()=>{o(!1)},[]);return(0,s.useEffect)(()=>{const e=e=>{const t=e.getMetadata("datalayer")??{};a(!!t.kernel)};return e(t),t.metadataChanged.connect(e),()=>{t.metadataChanged.disconnect(e)}},[t]),i?(0,u.jsxs)(c.az,{className:"dla-Cell-variables-icon",children:[(0,u.jsx)(l.K,{style:{color:"var(--jp-brand-color1)",width:"33px",marginTop:"-2px"},icon:r.HGl,"aria-label":"Set variables to transfer between Runtimes",variant:"invisible",size:"small",title:"Set variables to transfer between Runtimes",onClick:e=>{e.preventDefault(),o(!0)}}),n&&(0,u.jsx)(d.m,{...e,onClose:h})]}):(0,u.jsx)(u.Fragment,{})}class p{constructor(e,t){this.commands=t,h(this,"_isDisposed",!1),h(this,"_cellActions",new WeakMap),h(this,"_panel",void 0),this._panel=e,this._panel.content.model?.cells.changed.connect(this.updateConnectedCell,this),this._panel.content.modelChanged.connect(()=>{this._panel.content.model?.cells.changed.connect(this.updateConnectedCell,this)})}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,a.Signal.clearData(this))}updateConnectedCell(e,t){t.oldValues.forEach(e=>{this._removeAction(e)}),Promise.all(t.newValues.map(e=>this._addAction(e)))}async _addAction(e){const t=this._panel.content.widgets.find(t=>t.model===e);if("code"===t?.model.type){await t.ready;const n=i._Q.create((0,u.jsx)(m,{model:t.model,preference:this._panel.sessionContext?{id:this._panel.sessionContext.session?.kernel?.id,language:this._panel.sessionContext.specsManager.specs?.kernelspecs[this._panel.sessionContext.session?.kernel?.name??""]?.language}:void 0,sessionContext:this._panel.sessionContext,translator:this._panel.translator}));n.addClass("dla-Cell-action"),this._cellActions.has(e)&&this._cellActions.get(e)?.dispose(),this._cellActions.set(e,t),this._panel.disposed.connect(()=>{this._cellActions.delete(e),n.dispose()}),t.layout.addWidget(n)}}_removeAction(e){this._cellActions.get(e)?.dispose()}}class g{constructor(e){this.commands=e,h(this,"_extensions",new WeakMap)}createNew(e,t){const n=new p(e,this.commands);return this._extensions.set(e,n),e.disposed.connect(()=>{this._extensions.delete(e)}),n}}const _={id:"@datalayer/ui:runtimes:cell-action",description:"Cell action item",optional:[o.sQ],autoStart:!1,activate:(e,t)=>{e.docRegistry.addWidgetExtension("Notebook",new g(e.commands))}}}}]);