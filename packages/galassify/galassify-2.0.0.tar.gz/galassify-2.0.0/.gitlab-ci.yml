default:
  cache:
    paths:
      - .pip-cache/
  before_script:
    - apt-get update -y && apt-get install build-essential ffmpeg libsm6 libxext6 git -y
    - python --version

variables:
  QT_QPA_PLATFORM: "offscreen"

stages:
  - build
  - test
  - deploy
  - publish

build:
  stage: build
  image: python:3.11-slim
  script:
    - pip install --upgrade pip
    - pip install build twine
    - python3 -m build
  artifacts:
    paths:
      - dist/

test-python39:
  stage: test
  image: python:3.9-slim
  script:
    - python3 -m pip install .
    - python3 -m unittest

test-python310:
  stage: test
  image: python:3.10-slim
  script:
    - python3 -m pip install .
    - python3 -m unittest

test-python311:
  stage: test
  image: python:3.11-slim
  script:
    - python3 -m pip install .
    - python3 -m unittest

test-python312:
  stage: test
  image: python:3.12-slim
  script:
    - python3 -m pip install .
    - python3 -m unittest

test-python313:
  stage: test
  image: python:3.13-slim
  script:
    - python3 -m pip install .
    - python3 -m unittest

test-python39-ds9:
  stage: test
  image: python:3.9-slim
  script:
    - python3 -m pip install .[ds9]
    - python3 -m unittest

test-python310-ds9:
  stage: test
  image: python:3.10-slim
  script:
    - python3 -m pip install .[ds9]
    - python3 -m unittest

test-python311-ds9:
  stage: test
  image: python:3.11-slim
  script:
    - python3 -m pip install .[ds9]
    - python3 -m unittest

test-python312-ds9:
  stage: test
  image: python:3.12-slim
  script:
    - python3 -m pip install .[ds9]
    - python3 -m unittest


test-python313-ds9:
  stage: test
  image: python:3.13-slim
  script:
    - python3 -m pip install .[ds9]
    - python3 -m unittest

test-doc:
  stage: test
  image: python:3.11-slim
  script:
  - pip install -U .[doc]
  - mkdir public && cd doc/sphinx && make html
  - cp -r build/html/* ../../public
  only:
  - branches
  except:
  - master

test-coverage:
  stage: test
  image: python:3.11-slim
  script:
    - python3 -m pip install coverage
    - python3 -m pip install .[ds9]
    - coverage run -m unittest
    - coverage report
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH

deploy-pages:
  stage: deploy
  image: python:3.11-slim
  script:
  - pip install -U .[doc]
  - mkdir public && cd doc/sphinx && make html && make html
  - cp -r build/html/* ../../public
  pages: true  # specifies that this is a Pages job
  artifacts:
    paths:
    - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment: production

publish:
  stage: publish
  image: python:3.11-slim
  script:
    - pip install --upgrade pip
    - pip install build twine
    - TWINE_PASSWORD=${PYPI_TOKEN} TWINE_USERNAME=__token__ python3 -m twine upload dist/*
  rules:
    rules:
    - if: '$CI_COMMIT_TAG'     # must be quoted!
      when: always
