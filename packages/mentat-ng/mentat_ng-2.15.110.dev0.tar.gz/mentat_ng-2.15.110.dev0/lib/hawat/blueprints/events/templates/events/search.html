{% extends "_layout_events_search.html" %}

{% block sectionabout %}
    <p>
        {{ _("This module provides means for searching IDEA database based on various filtering conditions and displaying results in tabular format.") | safe }}
    </p>
{% endblock sectionabout %}

{% block sectionsearchresult %}
    <p>
        <strong>{{ macros_site.render_endpoint_link('timeline.search', query_params, label = _("View these results on timeline page"), with_icon = True) }}</strong>
    </p>

    {{ macros_site.render_pager(request.endpoint, query_params, pager_index_low, pager_index_high, pager_index_limit) }}
    <div class="mb-3">
        <table class="table table-striped table-bordered table-hover table-sm table-responsive mb-0">
            <thead>
                <tr>
                    {%- if in_query_params(request.args, ['st_from', 'st_to'], True, False, False) %}
                        <th>
                            {{ _("Stored at") }}
                        </th>
                    {%- else %}
                        <th>
                            {{ _("Detected at") }}
                        </th>
                    {%- endif %}
                    <th class="d-none d-xl-table-cell">
                        {{ _("Sources") }}
                    </th>
                    <th class="d-none d-xxl-table-cell">
                        {{ _("Targets") }}
                    </th>
                    <th>
                        {{ _("Source severity") }}
                    </th>
                    <th>
                        {{ _("Target severity") }}
                    </th>
                    <th>
                        {{ _("Category") }}
                    </th>
                    <th>
                        {{ _("Detector") }}
                    </th>
                    <th data-bs-toggle="tooltip" title="{{ _('Source and target groups') }}">
                        {{ _("Groups") }}
                    </th>
                    <th data-bs-toggle="tooltip" title="{{ _('Contextual item actions') }}">
                        {{ get_icon("actions") }}
                    </th>
                </tr>
            </thead>
            <tbody>
                {%- for item in items %}
                    <tr>
                        {%- if in_query_params(request.args, ['st_from', 'st_to'], True, False, False) %}
                            <td>
                                {{ babel_format_datetime(item.get_storage_time()) | replace(' ', '&nbsp;' | safe) }}
                            </td>
                        {%- else %}
                            <td>
                                {{ babel_format_datetime(item.get_detect_time()) | replace(' ', '&nbsp;' | safe) }}
                            </td>
                        {%- endif %}
                        <td class="d-none d-xl-table-cell">
                            {{ macros_site.render_widget_csag_address(item.get_addresses('Source'),
                                                                      [] + form_data['source_addrs'] +  form_data['target_addrs'] + form_data['host_addrs'], separate_dropdown = False,
                                                                      item_limit = search_widget_item_limit,
                                                                      context_param = 'source') }}
                        </td>
                        <td class="d-none d-xxl-table-cell">
                            {{ macros_site.render_widget_csag_address(item.get_addresses('Target'),
                                                                      [] + form_data['source_addrs'] + form_data['target_addrs'] + form_data['host_addrs'], separate_dropdown = False,
                                                                      item_limit = search_widget_item_limit,
                                                                      context_param = 'target') }}
                        </td>
                        {%- for severity in (item.get_severity(), item.get_target_severity()) -%}
                            <td>
                                {%- if severity %}
                                    {{ macros_site.render_widget_csag_severity([severity],
                                                                        align_right = True,
                                                                        separate_dropdown = False) }}
                                {%- else %}
                                    <span data-bs-toggle="tooltip" title="{{ _('-- unassigned --') }}">
                                        {{ get_icon("unassigned") }}
                                    </span>
                                {%- endif %}
                            </td>
                        {%- endfor -%}
                        <td>
                            {{ macros_site.render_widget_csag_category(item.get_categories(),
                                                                       form_data['categories'],
                                                                       align_right = True,
                                                                       separate_dropdown = False) }}
                        </td>
                        <td>
                            {%- set tmpval = item.get_detectors() %}
                            {%- if tmpval %}
                                {{ macros_site.render_widget_csag_detector([tmpval[-1]],
                                                                form_data['detectors'],
                                                                align_right = True,
                                                                separate_dropdown = False) }}
                            {%- else %}
                                <span data-bs-toggle="tooltip" title="{{ _('-- unassigned --') }}">
                                    {{ get_icon("unassigned") }}
                                </span>
                            {%- endif %}
                        </td>
                        <td>
                            {{ macros_site.render_widget_csag_abuse(item.get_all_groups(),
                                                                    form_data['groups'] + form_data['target_groups'],
                                                                    align_right = True,
                                                                    separate_dropdown = False) }}
                        </td>
                        <td>
                            {{ macros_page.render_menu_context_actions(item) }}
                        </td>
                    </tr>
                {%- endfor %}
            </tbody>
        </table>
    </div>

    {{ macros_site.render_pager(request.endpoint, query_params, pager_index_low, pager_index_high, pager_index_limit) }}

    {%- if permission_can('developer') %}
        <hr>
        {{ macros_site.render_raw_var('items', items) }}
    {%- endif %}
{% endblock sectionsearchresult %}
