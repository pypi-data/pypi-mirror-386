name: Python

on:
  push:
    branches: ["develop"]
    tags: ["*"]
  pull_request:
    branches: ["develop"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [
            #$ uv python list --all-versions | awk '{print $1}' | sed -E 's/cpython-(3\.[0-9]+\.[0-9]+)-.*/"\1",/' | grep -v py | sort --version-sort | uniq
            "3.8.2",
            "3.8.3",
            "3.8.5",
            "3.8.6",
            "3.8.7",
            "3.8.8",
            "3.8.9",
            "3.8.10",
            "3.8.11",
            "3.8.12",
            "3.8.13",
            "3.8.14",
            "3.8.15",
            "3.8.16",
            "3.8.17",
            "3.8.18",
            "3.8.19",
            "3.8.20",
            "3.9.0",
            "3.9.1",
            "3.9.2",
            "3.9.3",
            "3.9.4",
            "3.9.5",
            "3.9.6",
            "3.9.7",
            "3.9.10",
            "3.9.11",
            "3.9.12",
            "3.9.13",
            "3.9.14",
            "3.9.15",
            "3.9.16",
            "3.9.17",
            "3.9.18",
            "3.9.19",
            "3.9.20",
            "3.9.21",
            "3.9.22",
            "3.9.23",
            "3.9.24",
            "3.10.0",
            "3.10.2",
            "3.10.3",
            "3.10.4",
            "3.10.5",
            "3.10.6",
            "3.10.7",
            "3.10.8",
            "3.10.9",
            "3.10.11",
            "3.10.12",
            "3.10.13",
            "3.10.14",
            "3.10.15",
            "3.10.16",
            "3.10.17",
            "3.10.18",
            "3.10.19",
            "3.11.1",
            "3.11.3",
            "3.11.4",
            "3.11.5",
            "3.11.6",
            "3.11.7",
            "3.11.8",
            "3.11.9",
            "3.11.10",
            "3.11.11",
            "3.11.12",
            "3.11.13",
            "3.11.14",
            "3.12.0",
            "3.12.1",
            "3.12.2",
            "3.12.3",
            "3.12.4",
            "3.12.5",
            "3.12.6",
            "3.12.7",
            "3.12.8",
            "3.12.9",
            "3.12.10",
            "3.12.11",
            "3.12.12",
            "3.13.0",
            "3.13.1",
            "3.13.2",
            "3.13.3",
            "3.13.4",
            "3.13.5",
            "3.13.6",
            "3.13.7",
            "3.13.8",
            "3.13.9",
            "3.14.0",

            # manual additions
            "pypy-3.8",

            # NOTE(@niklas): Mypy fails with a syntax error on `# type: ignore` on the first line for `utils_test.py`
            #   only on these PyPy versions.. huh?
            # "pypy-3.9",
            # "pypy-3.10",
            # "pypy-3.11",
          ]
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.5"
          python-version: "${{ matrix.python-version }}"

      - run: uvx --python 3.13 --from slap-cli slap test

  publish:
    runs-on: ubuntu-latest
    needs: test
    environment: release
    permissions:
      id-token: write
    if: startsWith(github.ref, 'refs/tags/') && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.5"
          python-version: "3.13"

      - name: Build dist
        run: uv build

      - name: Publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
