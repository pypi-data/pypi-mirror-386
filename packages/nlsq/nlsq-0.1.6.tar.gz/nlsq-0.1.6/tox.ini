[tox]
requires = tox>=4
envlist = py312,py313,lint,type,security,docs,test-fast,test-modules
isolated_build = true
# Test suite: 743 tests, 100% pass rate, 70% coverage (target: 80%)

[testenv]
deps = .[test]
commands = pytest {posargs}
setenv =
    NLSQ_FORCE_CPU = 1

[testenv:py312]
deps = .[test]
commands = pytest tests/ -v

[testenv:py313]
deps = .[test]
commands = pytest tests/ -v

[testenv:test-fast]
deps = .[test]
commands = pytest -m "not slow" {posargs}

[testenv:test-modules]
deps = .[test]
# Test key modules individually for detailed reporting
commands =
    pytest tests/test_stability.py tests/test_stability_extended.py -v
    pytest tests/test_init_module.py tests/test_comprehensive_coverage.py -v
    pytest tests/test_target_coverage.py tests/test_final_coverage.py -v
    pytest tests/test_diagnostics.py -v  # 42 tests, 78% coverage

[testenv:test-memory]
deps = .[test,benchmark]
commands =
    python -m memory_profiler -m pytest tests/ -k "memory" -v

[testenv:lint]
deps = .[dev]
commands =
    ruff check .
    ruff format --check .
    pyupgrade --py312-plus nlsq/*.py

[testenv:type]
deps = .[dev]
commands =
    mypy nlsq
    # pyright nlsq  # Disabled until type annotations are complete

[testenv:security]
deps = .[dev]
commands =
    bandit -r nlsq/ -ll --skip B101,B601,B602,B607

[testenv:docs]
deps = .[docs]
commands = sphinx-build -W -b html docs docs/_build/html

[testenv:coverage]
deps = .[test]
# Test suite: 743 tests (as of 2025-10-07)
# Current: 70% coverage (target: 80%)
commands =
    pytest --cov=nlsq --cov-report=term-missing --cov-report=html --cov-report=xml --cov-fail-under=70

[testenv:benchmark]
deps = .[benchmark]
commands =
    python benchmark/benchmark.py --quick
