{
    "name": "FVDB Development Environment",

    // Ensure SSH agent is running before starting
    "initializeCommand": "test -z \"$SSH_AUTH_SOCK\" && eval \"$(ssh-agent -s)\" || true",

    "dockerComposeFile": [
        "docker-compose.yml"
    ],
    "service": "fvdb-dev",
    "workspaceFolder": "/openvdb/fvdb",

    "remoteUser": "coder",

    "features": {
        "ghcr.io/devcontainers/features/common-utils:2": {
            "username": "coder",
            "uid": "1001",
            "gid": "1001",
            "installSudo": true,
            "upgradePackages": true
        }
    },

    // Single source of truth for creating the dev environment.
    // We use 'bash -i -c' to ensure the shell is interactive, which properly
    // sources the .bashrc and activates conda before running the command.
    "postCreateCommand": "bash -i -c 'conda init bash && conda env create -f /openvdb/fvdb/env/dev_environment.yml && conda clean -afy && echo \"conda activate fvdb\" >> ~/.bashrc'",

    // This runs after you connect, good for user-specific setup like SSH.
    "postAttachCommand": "rm -rf ~/.ssh && ln -sfn /tmp/.ssh-localhost ~/.ssh",

    // Mount SSH keys directory
    "mounts": [
        "source=${localEnv:HOME}/.ssh,target=/tmp/.ssh-localhost,type=bind,readonly"
    ],

    // Extensions to install inside the container's VS Code server
    "customizations": {
        "vscode": {
            "extensions": [
                "llvm-vs-code-extensions.vscode-clangd",
                "ms-azuretools.vscode-docker",
                "ms-python.black-formatter",
                "ms-python.debugpy",
                "ms-python.isort",
                "ms-python.python",
                "ms-python.python",
                "ms-python.vscode-pylance",
                "ms-toolsai.tensorboard",
                "ms-vscode.cmake-tools",
                "ms-vscode.cpptools-extension-pack",
                "ms-vscode.cpptools",
                "rodolphebarbanneau.python-docstring-highlighter",
                "Seaube.clangformat",
            ],
            "settings": {
                "python.defaultInterpreterPath": "/opt/conda/envs/fvdb/bin/python",
                "remote.SSH.enableAgentForwarding": true,
                "remote.containers.sshAgentSocketMount": true
            }
        }
    },

    "shutdownAction": "stopCompose"
}

