<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Select an Email</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.12.1/polyfill.min.js"></script> -->
        <style>

            :root {
                --espresso-dark: #3B2323; /* Darkened color */
                --espresso-medium: #4E3B3B; /* Adjusted for a more coffee-like tone */
                --espresso-light: #7A4B4B; /* Darkened color */
                --cream: #EDE0D4; /* Darkened color */
                --background: #dcd6c9; /* Darkened color */
                --accent: #C65D1E; /* Darkened color */
                --error-red: #D9534F;
                --loading-orange: #F0AD4E;
                --text-color: #222222; /* Darkened color */
                --button-hover: #4B2E2E; /* Darkened color */
            }

            * {
                box-sizing: border-box;
            }

            body {
                font-family: 'Montserrat', sans-serif;
                margin: 0;
                padding: 0;
                background-color: var(--background);
                color: var(--text-color);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }

            main {
                width: 90%;
                max-width: 800px; /* Reduced max-width */
                margin: 20px auto; /* Reduced margin */
                padding: 20px; /* Reduced padding */
                background: var(--cream);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Reduced shadow */
                border-radius: 8px; /* Reduced border-radius */
                display: flex;
                flex-direction: column;
                gap: 20px; /* Reduced gap */
            }

            h1 {
                text-align: center;
                font-family: 'Roboto', sans-serif;
                font-weight: 600; /* Reduced font weight */
                color: var(--espresso-dark);
                margin-bottom: 15px; /* Reduced margin */
                font-size: 1.8em; /* Reduced font size */
                position: relative;
            }

            h1::after {
                content: '';
                display: block;
                width: 50px; /* Reduced width */
                height: 3px; /* Reduced height */
                background-color: var(--espresso-medium);
                margin: 8px auto 0; /* Reduced margin */
                border-radius: 2px;
            }

            ul {
                list-style-type: none;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                gap: 10px; /* Reduced gap */
            }

            li {
                background-color: var(--espresso-light);
                padding: 8px; /* Reduced padding */
                border-radius: 6px; /* Reduced border-radius */
                font-size: 1.1em; /* Reduced font size */
            }

            /* New styling for docxEmailList */
            #docxEmailList li {
                background-color: transparent; /* Plain background */
                padding: 8px; /* Keep padding */
                border: none; /* No border */
                box-shadow: none; /* No shadow */
                transition: none; /* No transition */
            }

            button {
                width: 100%;
                padding: 4px 8px; /* Reduced padding */
                background-color: var(--espresso-medium);
                color: #ffffff;
                border: none;
                border-radius: 6px; /* Reduced border-radius */
                cursor: pointer;
                font-size: 1.1em; /* Reduced font size */
                font-weight: 500; /* Reduced font weight */
                transition: background-color 0.3s, transform 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 8px; /* Reduced margin */
            }

            button:hover {
                background-color: var(--espresso-dark);
                transform: scale(1.01); /* Reduced scale effect */
            }

            .error-message {
                color: var(--error-red);
                text-align: center;
                font-weight: bold;
                margin-top: 15px; /* Reduced margin */
                padding: 8px; /* Reduced padding */
                border: 1px solid var(--error-red);
                border-radius: 6px;
                background-color: #fdecea;
            }

            .loading-message {
                color: var(--loading-orange);
                text-align: center;
                font-weight: bold;
                margin-top: 15px; /* Reduced margin */
                padding: 8px; /* Reduced padding */
                border: 1px solid var(--loading-orange);
                border-radius: 6px;
                background-color: #fff4e6;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px; /* Reduced gap */
            }

            /* Responsive Design */
            @media (max-width: 600px) {
                main {
                    padding: 15px; /* Reduced padding */
                }

                h1 {
                    font-size: 1.1em; /* Reduced font size */
                }

                button {
                    font-size: 1em; /* Reduced font size */
                    padding: 4px 6px; /* Reduced padding */
                }
            }
        </style>
    </head>
    <body>
        <main>
            <!-- <h1>Please Select the Correct Email</h1> -->
            <!-- <ul id="emailList"></ul> -->

            <h1>New Surgery Schedules</h1>
            <ul id="docxEmailList" style="color: var(--text-color);"></ul> <!-- Static list with black text -->

            <div id="errorMessage" class="error-message" style="display:none;"></div>
            <div id="loadingMessage" class="loading-message" style="display:none;">
                <span>‚è≥</span> Loading DOCX results...
            </div>

            
        </main>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("Document ready, initializing flows...");
            // initializeEmailListFlow();
            initializeDocxEmailListFlow();
        });

        /**
         * Initializes the Email List Flow.
         * Fetches email subjects and builds the email list.
         */
        async function initializeEmailListFlow() {
            try {
                console.log("Initializing Email List Flow...");
                const subjectsResponse = await fetchEmailSubjects();
                console.log("Email subjects fetched:", subjectsResponse);
                buildEmailList(subjectsResponse);
            } catch (error) {
                console.error("Error initializing Email List Flow:", error);
                displayErrorMessage("Failed to load email subjects.");
            }
        }

        /**
         * Initializes the DOCX Email List Flow.
         * Initiates DOCX processing and fetches results upon completion.
         */
        async function initializeDocxEmailListFlow() {
            try {
                console.log("Initializing DOCX Email List Flow...");
                showLoadingMessage();
                const processResponse = await startProcessingDocxAsync();
                console.log("DOCX processing initiated:", processResponse);
        
                if (processResponse.status === "success") {
                    const docxResultsResponse = await fetchDocxResults();
                    console.log("DOCX results fetched:", docxResultsResponse);
                    buildDocxList(docxResultsResponse);
                } else {
                    console.error("DOCX processing failed:", processResponse.message);
                    displayErrorMessage("Failed to process DOCX attachments: " + processResponse.message);
                }
                hideLoadingMessage();
            } catch (error) {
                console.error("Error initializing DOCX Email List Flow:", error);
                displayErrorMessage("Failed to process DOCX attachments.");
                hideLoadingMessage();
            }
        }

        /**
         * Fetches email subjects from the server.
         * @returns {Object} The email subjects response.
         */
        async function fetchEmailSubjects() {
            console.log("Fetching email subjects...");
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => {
                        console.log("Received email subjects response:", response);
                        resolve(response);
                    })
                    .withFailureHandler(error => {
                        console.error("Failed to fetch email subjects:", error);
                        reject(error);
                    })
                    .get_subjects();
            });
        }

        /**
         * Builds the email list UI based on fetched subjects.
         * @param {Object} subjectsResponse The email subjects response.
         */
        function buildEmailList(subjectsResponse) {
            console.log("Building email list...");
            if (subjectsResponse.status === "success") {
                const subjects = subjectsResponse.data;
                const emailList = document.getElementById('emailList');
                emailList.innerHTML = ''; // Clear existing list

                subjects.forEach(subject => {
                    const li = document.createElement('li');
                    const button = document.createElement('button');
                    button.textContent = subject.subject;
                    button.addEventListener('click', () => selectEmail(subject.index));
                    li.appendChild(button);
                    emailList.appendChild(li);
                });

                console.log("Email list built successfully.");
            } else {
                console.error("Failed to retrieve email subjects:", subjectsResponse.message);
                displayErrorMessage("Failed to load email subjects: " + subjectsResponse.message);
            }
        }

        /**
         * Handles email selection by the user.
         * Extracts the link from the selected email and redirects the user.
         * @param {number} index The index of the selected email.
         */
        async function selectEmail(index) {
            try {
                console.log("User selected email with index:", index);
                const response = await extractLinkFromEmail(index);
                console.log("Link extraction response:", response);

                if (response.status === "success") {
                    console.log("Redirecting to link:", response.data);
                    window.open(response.data, '_blank'); // polyfill not necessary because can't inject into the Office 365.
                    // window.location.href = response.data; // Open link in the same tab.
                } else {
                    alert('Error: ' + response.message);
                }
            } catch (error) {
                console.error("Error selecting email:", error);
                alert('Failed to extract email link.');
            }
        }

        /**
         * Extracts a link from the selected email.
         * @param {number} index The index of the email to extract the link from.
         * @returns {Object} The link extraction response.
         */
        async function extractLinkFromEmail(index) {
            console.log("Extracting link from email with index:", index);
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => {
                        console.log("Received link extraction response:", response);
                        resolve(response);
                    })
                    .withFailureHandler(error => {
                        console.error("Failed to extract link from email:", error);
                        reject(error);
                    })
                    .get_link(index);
            });
        }

        /**
        * Initiates DOCX processing synchronously on the server.
        * @returns {Object} The processing initiation response.
        */
        async function startProcessingDocxAsync() {
            console.log("Starting DOCX processing...");
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => {
                        console.log("DOCX processing initiation response:", response);
                        resolve(response);
                    })
                    .withFailureHandler(error => {
                        console.error("Failed to initiate DOCX processing:", error);
                        reject(error);
                    })
                    .process_docx();
            });
        }

        /**
         * Fetches the DOCX processing results from the server.
         * @returns {Object} The DOCX results response.
         */
        async function fetchDocxResults() {
            console.log("Fetching DOCX processing results...");
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => {
                        console.log("Received DOCX results response:", response);
                        resolve(response);
                    })
                    .withFailureHandler(error => {
                        console.error("Failed to fetch DOCX results:", error);
                        reject(error);
                    })
                    .get_docx_results();
            });
        }

        /**
         * Builds the DOCX email list UI based on fetched results.
         * @param {Object} docxResultsResponse The DOCX results response.
         */
        function buildDocxList(docxResultsResponse) {
            console.log("Building DOCX email list...");
            if (docxResultsResponse.status === "success") {
                const { subjects, downloadLinks } = docxResultsResponse.data;
                const docxList = document.getElementById('docxEmailList');
                docxList.innerHTML = ''; // Clear existing list

                subjects.forEach(subject => {
                    const li = document.createElement('li');
                    li.textContent = subject.subject;
                    docxList.appendChild(li);
                });

                console.log("DOCX email list built successfully.");

                // **Uncomment the following line to send download links to the Python server**
                sendDownloadLinksToPythonServer(downloadLinks);
            } else {
                console.error("Failed to retrieve DOCX results:", docxResultsResponse.message);
                displayErrorMessage("Failed to load DOCX results: " + docxResultsResponse.message);
            }
        }

        /**
         * Sends download links to the Python server for further processing.
         * @param {Array} downloadLinks The list of download links.
         */
        async function sendDownloadLinksToPythonServer(downloadLinks) {
            if (!downloadLinks || downloadLinks.length === 0) {
                console.error("No download links to send.");
                displayErrorMessage("No download links available to send.");
                return;
            }

            const baseUrl = 'https://127.0.0.1:8000';
            console.log("Python server URL:", baseUrl);
            console.log("Sending download links to Python server:", downloadLinks);
            try {
                const response = await fetch(baseUrl + '/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        links: downloadLinks.map(link => ({
                            url: link.url,
                            filename: link.filename,
                            fileId: link.fileId,
                        }))
                    }),
                    mode: 'cors'
                });

                if (!response.ok) {
                    const errorText = await response.text().catch(() => '');
                    throw new Error(`Network response was not ok: ${response.status} - ${errorText}`);
                }

                const data = await response.json().catch(() => ({}));
                console.log("Python server response:", data);
                if (data.status === 'success') {
                    console.log('Python server handshake complete. Accepted ' + downloadLinks.length + ' link(s).');
                } else {
                    console.error("Error from Python server:", data.message);
                    displayErrorMessage('Error: ' + (data.message || 'Unexpected server response'));
                }
            } catch (error) {
                console.error('Error sending download links to Python server:', error);
                await diagnoseAfterFailure(baseUrl, error);
            }
        }

        async function diagnoseAfterFailure(baseUrl, originalError) {
            try {
                if (!navigator.onLine) {
                    displayErrorMessage('You appear to be offline. Please check your internet connection.');
                    return;
                }
                // Probe server reachability
                let healthOk = false;
                let healthStatus = null;
                try {
                    const res = await fetch(baseUrl + '/_health', { method: 'GET', mode: 'cors', cache: 'no-store', credentials: 'omit' });
                    healthOk = !!res && res.ok;
                    healthStatus = res ? (res.status + ' ' + (res.statusText || '')) : null;
                } catch (e) {
                    // ignore, handled below
                }

                if (healthOk) {
                    displayErrorMessage('The Python server is reachable, but the download request failed. Please try again or restart the Python tool.');
                } else {
                    // Generic but actionable guidance
                    displayErrorMessage('Unable to reach the local Python server at https://127.0.0.1:8000. Ensure it is running and trusted by your browser (open the URL once if needed).');
                }
            } catch (diagErr) {
                // Fallback to original error message
                displayErrorMessage('Unable to send download links to the server. Error: ' + (originalError && originalError.message ? originalError.message : String(originalError)));
            }
        }

        /**
         * Delays execution for a specified number of milliseconds.
         * @param {number} ms The delay duration in milliseconds.
         * @returns {Promise} A promise that resolves after the delay.
         */
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Displays an error message to the user.
         * @param {string} message The error message to display.
         */
        function displayErrorMessage(message) {
            console.error("Error:", message); // Log the error to the console
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        /**
         * Shows the loading message.
         */
        function showLoadingMessage() {
            console.log("Showing loading message.");
            const loadingDiv = document.getElementById('loadingMessage');
            loadingDiv.style.display = 'block';
        }

        /**
         * Hides the loading message.
         */
        function hideLoadingMessage() {
            console.log("Hiding loading message.");
            const loadingDiv = document.getElementById('loadingMessage');
            loadingDiv.style.display = 'none';
        }
    </script>
</body>
</html>