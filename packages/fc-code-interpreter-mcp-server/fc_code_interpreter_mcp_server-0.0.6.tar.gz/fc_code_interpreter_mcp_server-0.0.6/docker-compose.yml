version: '3.8'

services:
  # Sandbox Code Interpreter (Data Plane)
  sandbox-code-interpreter:
    image: sandbox-code-interpreter:latest
    container_name: sandbox-code-interpreter
    build:
      context: ../sandbox-code-interpreter
      dockerfile: Dockerfile
    ports:
      - "5001:8080"  # Data Plane API (mapped to 5001 for local access)
      - "9090:9090"  # Metrics (Prometheus)
    environment:
      - SANDBOX_ENV=production
      - SANDBOX_HOST=0.0.0.0
      - SANDBOX_PORT=8080
      - SANDBOX_DEBUG=false
      - SANDBOX_LOG_LEVEL=info
      - SANDBOX_WORKSPACE_DIR=/workspace
      - SANDBOX_MAX_CONTEXTS=100
    volumes:
      - sandbox-workspace:/workspace
      - sandbox-logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - sandbox-net

  # MCP Server (Control Plane)
  mcp-server:
    image: sandbox-mcp-server:latest
    container_name: sandbox-mcp-server
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"  # MCP Server SSE endpoint
    environment:
      - SANDBOX_URL=http://sandbox-code-interpreter:8080
      - MCP_HOST=0.0.0.0
      - MCP_PORT=3000
      - LOG_LEVEL=INFO
    depends_on:
      sandbox-code-interpreter:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/sse"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - sandbox-net

networks:
  sandbox-net:
    driver: bridge

volumes:
  sandbox-workspace:
  sandbox-logs:
