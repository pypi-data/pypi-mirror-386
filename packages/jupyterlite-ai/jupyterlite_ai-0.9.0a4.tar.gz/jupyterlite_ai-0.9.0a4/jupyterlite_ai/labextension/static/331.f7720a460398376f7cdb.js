"use strict";(self.webpackChunk_jupyterlite_ai=self.webpackChunk_jupyterlite_ai||[]).push([[331],{7331:(e,t,s)=>{s.r(t),s.d(t,{createOllama:()=>L,ollama:()=>U});var o=s(2100);function n(...e){return e.reduce((e,t)=>({...e,...null!=t?t:{}}),{})}function r(e){return Object.fromEntries([...e.headers])}s(5606);var a=(({prefix:e,size:t=16,alphabet:s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:n="-"}={})=>{const r=()=>{const e=s.length,o=new Array(t);for(let n=0;n<t;n++)o[n]=s[Math.random()*e|0];return o.join("")};if(null==e)return r;if(s.includes(n))throw new o.Di({argument:"separator",message:`The separator "${n}" must not be part of the alphabet "${s}".`});return()=>`${e}${n}${r()}`})();function i(e){return(e instanceof Error||e instanceof DOMException)&&("AbortError"===e.name||"ResponseAborted"===e.name||"TimeoutError"===e.name)}var l=["fetch failed","failed to fetch"];function u(e=globalThis){var t,s,o;return e.window?"runtime/browser":(null==(t=e.navigator)?void 0:t.userAgent)?`runtime/${e.navigator.userAgent.toLowerCase()}`:(null==(o=null==(s=e.process)?void 0:s.versions)?void 0:o.node)?`runtime/node.js/${e.process.version.substring(0)}`:e.EdgeRuntime?"runtime/vercel-edge":"runtime/unknown"}function c(e,...t){const s=(o=null!=e?e:{},Object.fromEntries(Object.entries(o).filter(([e,t])=>null!=t)));var o;const n=new Headers(s),r=n.get("user-agent")||"";return n.set("user-agent",[r,...t].filter(Boolean).join(" ")),Object.fromEntries(n)}var p=/"__proto__"\s*:/,d=/"constructor"\s*:/;function h(e){const{stackTraceLimit:t}=Error;Error.stackTraceLimit=0;try{return function(e){const t=JSON.parse(e);return null===t||"object"!=typeof t||!1===p.test(e)&&!1===d.test(e)?t:function(e){let t=[e];for(;t.length;){const e=t;t=[];for(const s of e){if(Object.prototype.hasOwnProperty.call(s,"__proto__"))throw new SyntaxError("Object contains forbidden prototype property");if(Object.prototype.hasOwnProperty.call(s,"constructor")&&Object.prototype.hasOwnProperty.call(s.constructor,"prototype"))throw new SyntaxError("Object contains forbidden prototype property");for(const e in s){const o=s[e];o&&"object"==typeof o&&t.push(o)}}}return e}(t)}(e)}finally{Error.stackTraceLimit=t}}var m=Symbol.for("vercel.ai.validator");async function f({value:e,schema:t}){const s=function(e){return function(e){return"object"==typeof e&&null!==e&&m in e&&!0===e[m]&&"validate"in e}(e)?e:"function"==typeof e?e():(t=e,s=async e=>{const s=await t["~standard"].validate(e);return null==s.issues?{success:!0,value:s.value}:{success:!1,error:new o.iM({value:e,cause:s.issues})}},{[m]:!0,validate:s});var t,s}(t);try{if(null==s.validate)return{success:!0,value:e,rawValue:e};const t=await s.validate(e);return t.success?{success:!0,value:t.value,rawValue:e}:{success:!1,error:o.iM.wrap({value:e,cause:t.error}),rawValue:e}}catch(t){return{success:!1,error:o.iM.wrap({value:e,cause:t}),rawValue:e}}}async function g({text:e,schema:t}){try{const s=h(e);return null==t?{success:!0,value:s,rawValue:s}:await f({value:s,schema:t})}catch(t){return{success:!1,error:o.u6.isInstance(t)?t:new o.u6({text:e,cause:t}),rawValue:void 0}}}async function y({provider:e,providerOptions:t,schema:s}){if(null==(null==t?void 0:t[e]))return;const n=await f({value:t[e],schema:s});if(!n.success)throw new o.Di({argument:"providerOptions",message:`invalid ${e} provider options`,cause:n.error});return n.value}var v=()=>globalThis.fetch,w=async({url:e,headers:t,body:s,failedResponseHandler:o,successfulResponseHandler:n,abortSignal:r,fetch:a})=>b({url:e,headers:{"Content-Type":"application/json",...t},body:{content:JSON.stringify(s),values:s},failedResponseHandler:o,successfulResponseHandler:n,abortSignal:r,fetch:a}),b=async({url:e,headers:t={},body:s,successfulResponseHandler:n,failedResponseHandler:a,abortSignal:p,fetch:d=v()})=>{try{const l=await d(e,{method:"POST",headers:c(t,"ai-sdk/provider-utils/3.0.12",u()),body:s.content,signal:p}),h=r(l);if(!l.ok){let t;try{t=await a({response:l,url:e,requestBodyValues:s.values})}catch(t){if(i(t)||o.hL.isInstance(t))throw t;throw new o.hL({message:"Failed to process error response",cause:t,statusCode:l.status,url:e,responseHeaders:h,requestBodyValues:s.values})}throw t.value}try{return await n({response:l,url:e,requestBodyValues:s.values})}catch(t){if(t instanceof Error&&(i(t)||o.hL.isInstance(t)))throw t;throw new o.hL({message:"Failed to process successful response",cause:t,statusCode:l.status,url:e,responseHeaders:h,requestBodyValues:s.values})}}catch(t){throw function({error:e,url:t,requestBodyValues:s}){if(i(e))return e;if(e instanceof TypeError&&l.includes(e.message.toLowerCase())){const n=e.cause;if(null!=n)return new o.hL({message:`Cannot connect to API: ${n.message}`,cause:n,url:t,requestBodyValues:s,isRetryable:!0})}return e}({error:t,url:e,requestBodyValues:s.values})}},k=e=>async({response:t})=>{const s=r(t);if(null==t.body)throw new o.Tt({});let n="";return{responseHeaders:s,value:t.body.pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({async transform(t,s){t.endsWith("\n")?(s.enqueue(await g({text:n+t,schema:e})),n=""):n+=t}}))}},_=e=>async({response:t,url:s,requestBodyValues:n})=>{const a=await t.text(),i=await g({text:a,schema:e}),l=r(t);if(!i.success)throw new o.hL({message:"Invalid JSON response",cause:i.error,statusCode:t.status,responseHeaders:l,responseBody:a,url:s,requestBodyValues:n});return{responseHeaders:l,value:i.value,rawValue:i.rawValue}};Symbol("Let zodToJsonSchema decide on which parser to use"),new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789"),Symbol.for("vercel.ai.schema");var{btoa:x,atob:T}=globalThis,S=s(6097),q=(({errorSchema:e,errorToMessage:t,isRetryable:s})=>async({response:n,url:a,requestBodyValues:i})=>{const l=await n.text(),u=r(n);if(""===l.trim())return{responseHeaders:u,value:new o.hL({message:n.statusText,url:a,requestBodyValues:i,statusCode:n.status,responseHeaders:u,responseBody:l,isRetryable:null==s?void 0:s(n)})};try{const r=await async function({text:e,schema:t}){try{const s=h(e);return null==t?s:async function({value:e,schema:t}){const s=await f({value:e,schema:t});if(!s.success)throw o.iM.wrap({value:e,cause:s.error});return s.value}({value:s,schema:t})}catch(t){if(o.u6.isInstance(t)||o.iM.isInstance(t))throw t;throw new o.u6({text:e,cause:t})}}({text:l,schema:e});return{responseHeaders:u,value:new o.hL({message:t(r),url:a,requestBodyValues:i,statusCode:n.status,responseHeaders:u,responseBody:l,data:r,isRetryable:null==s?void 0:s(n,r)})}}catch(e){return{responseHeaders:u,value:new o.hL({message:n.statusText,url:a,requestBodyValues:i,statusCode:n.status,responseHeaders:u,responseBody:l,isRetryable:null==s?void 0:s(n)})}}})({errorSchema:S.Ik({error:S.Ik({message:S.Yj(),type:S.Yj().nullish(),param:S.bz().nullish(),code:S.KC([S.Yj(),S.ai()]).nullish()})}),errorToMessage:e=>e.error.message});function I(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}function O({model:e,created_at:t}){return{id:void 0,modelId:null!=e?e:void 0,timestamp:null!=t?new Date(t):void 0}}var C=S.Ik({think:S.zM().optional(),user:S.Yj().optional(),suffix:S.Yj().optional(),echo:S.zM().optional()}),j=class{constructor(e,t,s){this.specificationVersion="v2",this.supportedUrls={},this.modelId=e,this.settings=t,this.config=s}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:s,topP:n,topK:r,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,tools:c,toolChoice:p,seed:d,providerOptions:h}){var m;const f=[],g=null!=(m=await y({provider:"ollama",providerOptions:h,schema:C}))?m:{};null!=r&&f.push({type:"unsupported-setting",setting:"topK"}),(null==c?void 0:c.length)&&f.push({type:"unsupported-setting",setting:"tools"}),null!=p&&f.push({type:"unsupported-setting",setting:"toolChoice"}),null!=u&&"text"!==u.type&&f.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:v,stopSequences:w}=function({prompt:e,user:t="user",assistant:s="assistant"}){let n="";"system"===e[0].role&&(n+=`${e[0].content}\n\n`,e=e.slice(1));for(const{role:r,content:a}of e)switch(r){case"system":throw new o.M3({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":n+=`${t}:\n${a.map(e=>{if("text"===e.type)return e.text}).filter(Boolean).join("")}\n\n`;break;case"assistant":n+=`${s}:\n${a.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new o.b8({functionality:"tool-call messages"})}}).join("")}\n\n`;break;case"tool":throw new o.b8({functionality:"tool messages"});default:throw new Error(`Unsupported role: ${r}`)}return n+=`${s}:\n`,{prompt:n,stopSequences:[`\n${t}:`]}}({prompt:e}),b=[...null!=w?w:[],...null!=l?l:[]];return{args:{model:this.modelId,user:g.user,think:g.think,max_tokens:t,temperature:s,top_p:n,frequency_penalty:a,presence_penalty:i,stop:b,prompt:v,suffix:g.suffix,echo:g.echo,stream:!1},warnings:f}}async doGenerate(e){var t,s,o,r;const{args:a,warnings:i}=await this.getArgs(e),{responseHeaders:l,value:u,rawValue:c}=await w({url:this.config.url({path:"/generate",modelId:this.modelId}),headers:n(this.config.headers(),e.headers),body:{...a,stream:!1},failedResponseHandler:q,successfulResponseHandler:_(R),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:p,...d}=a;return{content:[{type:"text",text:u.response}],usage:{inputTokens:null!=(t=u.prompt_eval_count)?t:void 0,outputTokens:null!=(s=u.eval_count)?s:void 0,totalTokens:(null!=(o=u.prompt_eval_count)?o:0)+(null!=(r=u.eval_count)?r:0)},finishReason:I("stop"),request:{body:JSON.stringify(a)},response:{...O(u),headers:l,body:c},warnings:i,providerMetadata:{ollama:{}}}}async doStream(e){const{args:t,warnings:s}=await this.getArgs(e),o={...t,stream:!0},{responseHeaders:r,value:a}=await w({url:this.config.url({path:"/generate",modelId:this.modelId}),headers:n(this.config.headers(),e.headers),body:o,failedResponseHandler:q,successfulResponseHandler:k(R),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:i,...l}=t;let u="unknown",c={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},p=!0;return{stream:a.pipeThrough(new TransformStream({transform(e,t){if(!e.success)return u="error",void t.enqueue({type:"error",error:e.error});const s=e.value;if("error"in s)return u="error",void t.enqueue({type:"error",error:s.error});p&&(p=!1,t.enqueue({type:"response-metadata",...O(s)})),s.done&&(u=I("stop")),null!=s.response&&t.enqueue({type:"text-delta",id:"0",delta:s.response})},flush(e){e.enqueue({type:"finish",finishReason:u,usage:c})}})),request:{body:JSON.stringify(o)},response:{headers:r}}}},R=S.Ik({model:S.Yj(),created_at:S.Yj(),response:S.Yj(),done:S.zM(),context:S.YO(S.ai()),eval_count:S.ai().optional(),eval_duration:S.ai().optional(),load_duration:S.ai().optional(),total_duration:S.ai().optional(),prompt_eval_count:S.ai().optional(),prompt_eval_duration:S.ai().optional()}),E=class{constructor(e,t,s){this.specificationVersion="v2",this.modelId=e,this.settings=t,this.config=s}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return null!=(e=this.settings.maxEmbeddingsPerCall)?e:2048}get supportsParallelCalls(){var e;return null==(e=this.settings.supportsParallelCalls)||e}async doEmbed({values:e,headers:t,abortSignal:s,providerOptions:r}){if(e.length>this.maxEmbeddingsPerCall)throw new o.Ch({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:a,value:i,rawValue:l}=await w({url:this.config.url({path:"/embed",modelId:this.modelId}),headers:n(this.config.headers(),t),body:{model:this.modelId,input:e},failedResponseHandler:q,successfulResponseHandler:_($),abortSignal:s,fetch:this.config.fetch});return{embeddings:i.embeddings.map(e=>e),usage:{tokens:i.prompt_eval_count},response:{headers:a,body:l}}}},$=S.Ik({model:S.Yj(),embeddings:S.YO(S.YO(S.ai())),total_duration:S.ai(),load_duration:S.ai(),prompt_eval_count:S.ai()});function H({prompt:e,systemMessageMode:t="system"}){const s=[];for(const{role:o,content:n}of e)switch(o){case"system":switch(t){case"system":s.push({role:"system",content:n});break;case"developer":s.push({role:"developer",content:n});break;case"remove":break;default:throw new Error(`Unsupported system message mode: ${t}`)}break;case"user":{if(1===n.length&&"text"===n[0].type){s.push({role:"user",content:n[0].text});break}const e=n.filter(e=>"text"===e.type).map(e=>e.text).join(""),t=n.filter(e=>"file"===e.type&&e.mediaType.startsWith("image/")).map(e=>e.data);s.push({role:"user",content:e.length>0?e:[],images:t.length>0?t:void 0});break}case"assistant":{let e="",t="";const o=[];for(const s of n)switch(s.type){case"text":e+=s.text;break;case"tool-call":o.push({id:s.toolCallId,type:"function",function:{name:s.toolName,arguments:s.input}});break;case"reasoning":t+=s.text;break;default:throw new Error(`Unsupported part: ${s}`)}s.push({role:"assistant",content:e,...t&&{thinking:t},tool_calls:o.length>0?o:void 0});break}case"tool":for(const e of n){const t=e.output;let o;switch(t.type){case"text":case"error-text":o=t.value;break;case"content":case"json":case"error-json":o=JSON.stringify(t.value)}s.push({role:"tool",tool_call_id:e.toolCallId,content:o})}break;default:throw new Error(`Unsupported role: ${o}`)}return s}var P=S.Ik({think:S.zM().optional(),options:S.Ik({num_ctx:S.ai().optional(),repeat_last_n:S.ai().optional(),repeat_penalty:S.ai().optional(),temperature:S.ai().optional(),seed:S.ai().optional(),stop:S.YO(S.Yj()).optional(),num_predict:S.ai().optional(),top_k:S.ai().optional(),top_p:S.ai().optional(),min_p:S.ai().optional()}).optional()}),M=class{async buildRequest({modelId:e,maxOutputTokens:t,temperature:s,stopSequences:n,topP:r,topK:a,presencePenalty:i,frequencyPenalty:l,seed:u,prompt:c,providerOptions:p,tools:d,toolChoice:h,responseFormat:m}){const f=this.collectUnsupportedSettingsWarnings({topK:a,seed:u,presencePenalty:i,frequencyPenalty:l,stopSequences:n}),{messages:g,warnings:y}=function({prompt:e,systemMessageMode:t}){const s=[],n=[];for(const{role:r,content:a}of e)switch(r){case"system":switch(t){case"system":s.push({role:"system",content:a});break;case"developer":s.push({role:"developer",content:a});break;case"remove":n.push({type:"other",message:"system messages are removed for this model"});break;default:throw new Error(`Unsupported system message mode: ${t}`)}break;case"user":s.push({role:"user",content:a.map((e,t)=>{var s,n,r;switch(e.type){case"text":return{type:"input_text",text:e.text};case"file":if(e.mediaType.startsWith("image/")){const t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"input_image",image_url:e.data instanceof URL?e.data.toString():`data:${t};base64,${e.data}`,detail:null==(n=null==(s=e.providerOptions)?void 0:s.ollama)?void 0:n.imageDetail}}if("application/pdf"===e.mediaType){if(e.data instanceof URL)throw new o.b8({functionality:"PDF file parts with URLs"});return{type:"input_file",filename:null!=(r=e.filename)?r:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${e.data}`}}throw new o.b8({functionality:`file part media type ${e.mediaType}`})}})});break;case"assistant":for(const e of a)switch(e.type){case"text":s.push({role:"assistant",content:[{type:"output_text",text:e.text}]});break;case"tool-call":if(e.providerExecuted)break;s.push({type:"function_call",call_id:e.toolCallId,name:e.toolName,arguments:JSON.stringify(e.input)});break;case"tool-result":n.push({type:"other",message:"tool result parts in assistant messages are not supported for Ollama responses"})}break;case"tool":for(const e of a){const t=e.output;let o;switch(t.type){case"text":case"error-text":o=t.value;break;case"content":case"json":case"error-json":o=JSON.stringify(t.value)}s.push({type:"function_call_output",call_id:e.toolCallId,output:o})}break;default:throw new Error(`Unsupported role: ${r}`)}return{messages:s,warnings:n}}({prompt:c,systemMessageMode:"system"});f.push(...y);const v=await this.parseProviderOptions(p),w=this.buildBaseArgs({modelId:e,prompt:c,temperature:s,topP:r,maxOutputTokens:t,responseFormat:m,ollamaOptions:v}),{tools:b,toolChoice:k,toolWarnings:_}=function({tools:e,toolChoice:t}){const s=[];if(null==(e=(null==e?void 0:e.length)?e:void 0))return{tools:void 0,toolChoice:void 0,toolWarnings:s};const n=[];for(const t of e)switch(t.type){case"function":{let e=t.inputSchema;e?e&&"object"==typeof e&&"object"===e.type&&e.properties&&0===Object.keys(e.properties).length&&(e={...e,properties:{},required:[]}):e={type:"object",properties:{},required:[]},n.push({type:"function",function:{name:t.name,description:t.description,parameters:e}});break}default:s.push({type:"unsupported-tool",tool:t})}if(null==t)return{tools:n,toolChoice:void 0,toolWarnings:s};const r=t.type;switch(r){case"auto":case"none":case"required":return{tools:n,toolChoice:r,toolWarnings:s};case"tool":return{tools:n,toolChoice:"web_search_preview"==t.toolName?{type:"web_search_preview"}:{type:"function",name:t.toolName},toolWarnings:s};default:{const e=r;throw new o.b8({functionality:`tool choice type: ${e}`})}}}({tools:d,toolChoice:h});return{args:{...w,tools:b,tool_choice:k},warnings:[...f,..._]}}collectUnsupportedSettingsWarnings({topK:e,seed:t,presencePenalty:s,frequencyPenalty:o,stopSequences:n}){const r=[],a=[{value:e,name:"topK"},{value:t,name:"seed"},{value:s,name:"presencePenalty"},{value:o,name:"frequencyPenalty"},{value:n,name:"stopSequences"}];for(const{value:e,name:t}of a)null!=e&&r.push({type:"unsupported-setting",setting:t});return r}async parseProviderOptions(e){const t=await y({provider:"ollama",providerOptions:e,schema:P});return null!=t?t:null}buildBaseArgs({modelId:e,prompt:t,temperature:s,topP:o,maxOutputTokens:n,responseFormat:r,ollamaOptions:a}){var i,l;return{model:e,messages:H({prompt:t,systemMessageMode:"system"}),temperature:s,top_p:o,max_output_tokens:n,..."json"===(null==r?void 0:r.type)&&{format:null!=r.schema?r.schema:"json"},think:null!=(i=null==a?void 0:a.think)&&i,options:null!=(l=null==a?void 0:a.options)?l:void 0}}},V=S.Ik({model:S.Yj(),created_at:S.Yj(),done:S.zM(),message:S.Ik({content:S.Yj(),role:S.Yj(),thinking:S.Yj().optional(),tool_calls:S.YO(S.Ik({function:S.Ik({name:S.Yj(),arguments:S.g1(S.Yj(),S.bz())}),id:S.Yj().optional()})).optional().nullable()}),done_reason:S.Yj().optional(),eval_count:S.ai().optional(),eval_duration:S.ai().optional(),load_duration:S.ai().optional(),prompt_eval_count:S.ai().optional(),prompt_eval_duration:S.ai().optional(),total_duration:S.ai().optional()}),Y=class{constructor(e){this.config=e}processGenerateResponse(e){return{content:this.extractContent(e),finishReason:I(e.done_reason),usage:this.extractUsage(e),providerMetadata:{ollama:{}}}}extractContent(e){var t,s,o,n,r;const i=[],l=e.message.content;null!=l&&l.length>0&&i.push({type:"text",text:l});for(const l of null!=(t=e.message.tool_calls)?t:[])i.push({type:"tool-call",toolCallId:null!=(r=l.id)?r:null!=(n=null==(o=(s=this.config).generateId)?void 0:o.call(s))?n:a(),toolName:l.function.name,input:JSON.stringify(l.function.arguments)});return i}extractUsage(e){var t,s,o,n;return{inputTokens:null!=(t=e.prompt_eval_count)?t:void 0,outputTokens:null!=(s=e.eval_count)?s:void 0,totalTokens:(null!=(o=e.prompt_eval_count)?o:0)+(null!=(n=e.eval_count)?n:0),reasoningTokens:void 0,cachedInputTokens:void 0}}},B=class{constructor(e){this.config=e,this.state=this.initializeState()}createTransformStream(e,t){return new TransformStream({start:t=>{t.enqueue({type:"stream-start",warnings:e})},transform:(e,s)=>{this.processChunk(e,s,t)},flush:e=>{this.finalizeStream(e)}})}initializeState(){return{finishReason:"unknown",usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},responseId:null,ongoingToolCalls:{},hasToolCalls:!1,isFirstChunk:!0,hasTextStarted:!1,hasReasoningStarted:!1,textEnded:!1,reasoningEnded:!1,textId:a()}}processChunk(e,t,s){(null==s?void 0:s.includeRawChunks)&&t.enqueue({type:"raw",rawValue:e.rawValue});const o=function(e){var t;if(e.success)return[e.value];const s=[],o=null==(t=e.error)?void 0:t.text;if("string"!=typeof o||0===o.length)return s;const n=o.split(/\r?\n/);for(const e of n){const t=e.trim();if(""!==t)try{const e=JSON.parse(t),o=V.safeParse(e);o.success&&s.push(o.data)}catch(e){}}return s}(e);if(0!==o.length)for(const e of o)this.processResponseValue(e,t);else e.success||(this.state.finishReason="error",t.enqueue({type:"error",error:e.error}))}processResponseValue(e,t){if(e&&"object"==typeof e&&"error"in e)return this.state.finishReason="error",void t.enqueue({type:"error",error:e.error});this.state.isFirstChunk&&(this.state.isFirstChunk=!1,t.enqueue({type:"response-metadata",...O(e)})),e.done&&this.handleDoneChunk(e,t);const s=null==e?void 0:e.message;s&&this.processDelta(s,t)}handleDoneChunk(e,t){var s,o,n;this.state.finishReason=I(e.done_reason),this.state.usage={inputTokens:e.prompt_eval_count||0,outputTokens:null!=(s=e.eval_count)?s:void 0,totalTokens:(null!=(o=e.prompt_eval_count)?o:0)+(null!=(n=e.eval_count)?n:0)},this.state.hasTextStarted&&!this.state.textEnded&&(t.enqueue({type:"text-end",id:this.state.textId}),this.state.textEnded=!0),this.state.hasReasoningStarted&&!this.state.reasoningEnded&&(t.enqueue({type:"reasoning-end",id:"0"}),this.state.reasoningEnded=!0)}processDelta(e,t){this.processTextContent(e,t),this.processThinking(e,t),this.processToolCalls(e,t)}processTextContent(e,t){null!=(null==e?void 0:e.content)&&(this.state.hasTextStarted||(t.enqueue({type:"text-start",id:this.state.textId}),this.state.hasTextStarted=!0),t.enqueue({type:"text-delta",id:this.state.textId,delta:e.content}))}processThinking(e,t){(null==e?void 0:e.thinking)&&(this.state.hasReasoningStarted||(t.enqueue({type:"reasoning-start",id:"0"}),this.state.hasReasoningStarted=!0),t.enqueue({type:"reasoning-delta",id:"0",delta:e.thinking}))}processToolCalls(e,t){var s,n,r,a;for(const i of null!=(s=e.tool_calls)?s:[]){if(null==(null==(n=i.function)?void 0:n.name))throw new o.xn({data:i,message:"Expected 'function.name' to be a string."});null!=(null==(r=i.function)?void 0:r.name)&&null!=(null==(a=i.function)?void 0:a.arguments)&&this.emitToolCall(i,t)}}emitToolCall(e,t){var s,o,n,r;const i=null!=(r=e.id)?r:null!=(n=null==(o=(s=this.config).generateId)?void 0:o.call(s))?n:a();t.enqueue({type:"tool-input-start",id:i,toolName:e.function.name}),t.enqueue({type:"tool-input-delta",id:i,delta:JSON.stringify(e.function.arguments)}),t.enqueue({type:"tool-input-end",id:i}),t.enqueue({type:"tool-call",toolCallId:i,toolName:e.function.name,input:JSON.stringify(e.function.arguments)}),this.state.hasToolCalls=!0}finalizeStream(e){this.state.hasTextStarted&&!this.state.textEnded&&e.enqueue({type:"text-end",id:"0"}),this.state.hasReasoningStarted&&!this.state.reasoningEnded&&e.enqueue({type:"reasoning-end",id:"0"}),e.enqueue({type:"finish",finishReason:this.state.finishReason,usage:this.state.usage,providerMetadata:{ollama:{responseId:this.state.responseId}}})}},N=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t,this.requestBuilder=new M,this.responseProcessor=new Y(t)}get provider(){return this.config.provider}async doGenerate(e){const{args:t,warnings:s}=await this.prepareRequest(e),{responseHeaders:o,value:r,rawValue:a}=await w({url:this.config.url({path:"/chat",modelId:this.modelId}),headers:n(this.config.headers(),e.headers),body:{...t,stream:!1},failedResponseHandler:q,successfulResponseHandler:_(V),abortSignal:e.abortSignal,fetch:this.config.fetch});return{...this.responseProcessor.processGenerateResponse(r),request:{body:JSON.stringify(t)},response:{modelId:this.modelId,timestamp:new Date,headers:o,body:a},warnings:s}}async doStream(e){const{args:t,warnings:s}=await this.prepareRequest(e),{responseHeaders:o,value:r}=await w({url:this.config.url({path:"/chat",modelId:this.modelId}),headers:n(this.config.headers(),e.headers),body:{...t,stream:!0},failedResponseHandler:q,successfulResponseHandler:k(V),abortSignal:e.abortSignal,fetch:this.config.fetch}),a=new B(this.config);return{stream:r.pipeThrough(a.createTransformStream(s,e)),request:{body:t},response:{headers:o}}}async prepareRequest(e){return await this.requestBuilder.buildRequest({modelId:this.modelId,...e})}};function L(e={}){var t,s;const n=null!=(t=null==(r=e.baseURL)?void 0:r.replace(/\/$/,""))?t:"http://127.0.0.1:11434/api";var r;const a=null!=(s=e.name)?s:"ollama",i=()=>({"Ollama-Organization":e.organization,"Ollama-Project":e.project,...e.headers}),l=(t,s={})=>new E(t,s,{provider:`${a}.embedding`,url:({path:e})=>`${n}${e}`,headers:i,fetch:e.fetch}),u=e=>{if(new.target)throw new Error("The Ollama model function cannot be called with the new keyword.");return c(e)},c=t=>new N(t,{provider:`${a}.responses`,url:({path:e})=>`${n}${e}`,headers:i,fetch:e.fetch}),p=function(e){return u(e)};return p.languageModel=u,p.chat=u,p.completion=(t,s={})=>new j(t,s,{provider:`${a}.completion`,url:({path:e})=>`${n}${e}`,headers:i,fetch:e.fetch}),p.embedding=l,p.textEmbedding=l,p.textEmbeddingModel=l,p.imageModel=e=>{throw new o.eM({modelId:e,modelType:"imageModel",message:"Image generation is unsupported with Ollama"})},p}var U=L()}}]);