"use strict";(self.webpackChunk_jupyterlite_ai=self.webpackChunk_jupyterlite_ai||[]).push([[593],{8593:(t,e,o)=>{o.r(e),o.d(e,{AiSdkModel:()=>d,CloudflareRealtimeTransportLayer:()=>h,TwilioRealtimeTransportLayer:()=>y,aisdk:()=>l,getResponseFormat:()=>p,itemsToLanguageV2Messages:()=>s,parseArguments:()=>c,toolChoiceToLanguageV2Format:()=>m,toolToLanguageV2Tool:()=>u});var n=o(4472),r=o(7962);function s(t,e){const o=[];let r;for(const t of e){if("message"===t.type||void 0===t.type){const{role:e,content:s,providerData:i}=t;if("system"===e){o.push({role:"system",content:s,providerOptions:{...i??{}}});continue}if("user"===e){o.push({role:e,content:"string"==typeof s?[{type:"text",text:s}]:s.map(t=>{const{providerData:e}=t;if("input_text"===t.type)return{type:"text",text:t.text,providerOptions:{...e??{}}};if("input_image"===t.type)return{type:"file",data:new URL(t.image),mediaType:"image/*",providerOptions:{...e??{}}};if("input_file"===t.type){if("string"!=typeof t.file)throw new n.UserError("File ID is not supported");return{type:"file",file:t.file,mediaType:"application/octet-stream",data:t.file,providerOptions:{...e??{}}}}throw new n.UserError(`Unknown content type: ${t.type}`)}),providerOptions:{...i??{}}});continue}if("assistant"===e){r&&(o.push(r),r=void 0),o.push({role:e,content:s.filter(t=>"output_text"===t.type).map(t=>{const{providerData:e}=t;return{type:"text",text:t.text,providerOptions:{...e??{}}}}),providerOptions:{...i??{}}});continue}throw new Error(`Unknown message type: ${t}`)}if("function_call"===t.type){if(r||(r={role:"assistant",content:[],providerOptions:{...t.providerData??{}}}),Array.isArray(r.content)&&"assistant"===r.role){const e={type:"tool-call",toolCallId:t.callId,toolName:t.name,input:c(t.arguments),providerOptions:{...t.providerData??{}}};r.content.push(e)}continue}if("function_call_result"===t.type){r&&(o.push(r),r=void 0);const e={type:"tool-result",toolCallId:t.callId,toolName:t.name,output:a(t.output),providerOptions:{...t.providerData??{}}};o.push({role:"tool",content:[e],providerOptions:{...t.providerData??{}}});continue}if("hosted_tool_call"===t.type)throw new n.UserError("Hosted tool calls are not supported");if("computer_call"===t.type)throw new n.UserError("Computer calls are not supported");if("computer_call_result"===t.type)throw new n.UserError("Computer call results are not supported");if("reasoning"===t.type&&t.content.length>0&&"string"==typeof t.content[0].text){o.push({role:"assistant",content:[{type:"reasoning",text:t.content[0].text,providerOptions:{...t.providerData??{}}}],providerOptions:{...t.providerData??{}}});continue}if("unknown"===t.type){o.push({...t.providerData??{}});continue}if(t)throw new n.UserError(`Unknown item type: ${t.type}`);const e=t;throw new n.UserError(`Unknown item type: ${e}`)}return r&&o.push(r),o}function i(t,e){return{type:"function",name:e.toolName,description:e.toolDescription,inputSchema:e.inputJsonSchema}}function a(t){const e=t;if("text"===e?.type&&"string"==typeof e.text)return{type:"text",value:e.text};if("image"===e?.type&&"string"==typeof e.data&&"string"==typeof e.mediaType)return{type:"content",value:[{type:"media",data:e.data,mediaType:e.mediaType}]};throw new n.UserError(`Unsupported tool output type: ${String(e?.type)}`)}function u(t,e){if("function"===e.type)return{type:"function",name:e.name,description:e.description,inputSchema:e.parameters};if("hosted_tool"===e.type)return{type:"provider-defined",id:`${t.provider}.${e.name}`,name:e.name,args:e.providerData?.args??{}};if("computer"===e.type)return{type:"provider-defined",id:`${t.provider}.${e.name}`,name:e.name,args:{environment:e.environment,display_width:e.dimensions[0],display_height:e.dimensions[1]}};throw new Error(`Unsupported tool type: ${e}`)}function p(t){return"text"===t?{type:"text"}:{type:"json",name:t.name,schema:t.schema}}class d{#t;#e=(0,n.getLogger)("openai-agents:extensions:ai-sdk");constructor(t){this.#t=t}async getResponse(t){return(0,n.withGenerationSpan)(async e=>{try{e.spanData.model=this.#t.provider+":"+this.#t.modelId,e.spanData.model_config={provider:this.#t.provider,model_impl:"ai-sdk"};let o="string"==typeof t.input?[{role:"user",content:[{type:"text",text:t.input}]}]:s(this.#t,t.input);t.systemInstructions&&(o=[{role:"system",content:t.systemInstructions},...o]);const a=t.tools.map(t=>u(this.#t,t));if(t.handoffs.forEach(t=>{a.push(i(this.#t,t))}),e&&!0===t.tracing&&(e.spanData.input=o),(0,r.f3)(t.outputType))throw new n.UserError("Zod output type is not yet supported");const d=p(t.outputType),l={tools:a,toolChoice:m(t.modelSettings.toolChoice),prompt:o,temperature:t.modelSettings.temperature,topP:t.modelSettings.topP,frequencyPenalty:t.modelSettings.frequencyPenalty,presencePenalty:t.modelSettings.presencePenalty,maxOutputTokens:t.modelSettings.maxTokens,responseFormat:d,abortSignal:t.signal,...t.modelSettings.providerData??{}};this.#e.dontLogModelData?this.#e.debug("Request sent"):this.#e.debug("Request:",JSON.stringify(l,null,2));const c=await this.#t.doGenerate(l),g=[],h=c.content??[],y=h.filter(t=>t&&"tool-call"===t.type),f=y.length>0;for(const t of y)g.push({type:"function_call",callId:t.toolCallId,name:t.toolName,arguments:"string"==typeof t.input?t.input:JSON.stringify(t.input??{}),status:"completed",providerData:f?c.providerMetadata:void 0});if(!f){const t=h.find(t=>t&&"text"===t.type&&"string"==typeof t.text);t&&g.push({type:"message",content:[{type:"output_text",text:t.text}],role:"assistant",status:"completed",providerData:c.providerMetadata})}e&&!0===t.tracing&&(e.spanData.output=g);const k={responseId:c.response?.id??"FAKE_ID",usage:new n.Usage({inputTokens:Number.isNaN(c.usage?.inputTokens)?0:c.usage?.inputTokens??0,outputTokens:Number.isNaN(c.usage?.outputTokens)?0:c.usage?.outputTokens??0,totalTokens:(Number.isNaN(c.usage?.inputTokens)?0:c.usage?.inputTokens??0)+(Number.isNaN(c.usage?.outputTokens)?0:c.usage?.outputTokens??0)||0}),output:g,providerData:c};return e&&!0===t.tracing&&(e.spanData.usage={input_tokens:k.usage.inputTokens,output_tokens:k.usage.outputTokens}),this.#e.dontLogModelData?this.#e.debug("Response ready"):this.#e.debug("Response:",JSON.stringify(k,null,2)),k}catch(o){throw o instanceof Error?e.setError({message:!0===t.tracing?o.message:"Unknown error",data:{error:!0===t.tracing?String(o):o instanceof Error?o.name:void 0}}):e.setError({message:"Unknown error",data:{error:!0===t.tracing?String(o):o instanceof Error?o.name:void 0}}),o}})}async*getStreamedResponse(t){const e=t.tracing?(0,n.createGenerationSpan)():void 0;try{e&&(e.start(),(0,n.setCurrentSpan)(e)),e?.spanData&&(e.spanData.model=this.#t.provider+":"+this.#t.modelId,e.spanData.model_config={provider:this.#t.provider,model_impl:"ai-sdk"});let o="string"==typeof t.input?[{role:"user",content:[{type:"text",text:t.input}]}]:s(this.#t,t.input);t.systemInstructions&&(o=[{role:"system",content:t.systemInstructions},...o]);const r=t.tools.map(t=>u(this.#t,t));t.handoffs.forEach(t=>{r.push(i(this.#t,t))}),e&&!0===t.tracing&&(e.spanData.input=o);const a=p(t.outputType),d={tools:r,prompt:o,temperature:t.modelSettings.temperature,topP:t.modelSettings.topP,frequencyPenalty:t.modelSettings.frequencyPenalty,presencePenalty:t.modelSettings.presencePenalty,maxOutputTokens:t.modelSettings.maxTokens,responseFormat:a,abortSignal:t.signal,...t.modelSettings.providerData??{}};this.#e.dontLogModelData?this.#e.debug("Request received (streamed)"):this.#e.debug("Request (streamed):",JSON.stringify(d,null,2));const{stream:l}=await this.#t.doStream(d);let c,m=!1,g=0,h=0;const y={};let f;for await(const t of l)switch(m||(m=!0,yield{type:"response_started"}),yield{type:"model",event:t},t.type){case"text-delta":f||(f={type:"output_text",text:""}),f.text+=t.delta,yield{type:"output_text_delta",delta:t.delta};break;case"tool-call":{const e=t.toolCallId;e&&(y[e]={type:"function_call",callId:e,name:t.toolName,arguments:t.input??"",status:"completed"});break}case"response-metadata":t.id&&(c=t.id);break;case"finish":g=Number.isNaN(t.usage?.inputTokens)?0:t.usage?.inputTokens??0,h=Number.isNaN(t.usage?.outputTokens)?0:t.usage?.outputTokens??0;break;case"error":throw t.error}const k=[];f&&k.push({type:"message",role:"assistant",content:[f],status:"completed"});for(const t of Object.values(y))k.push(t);const w={type:"response_done",response:{id:c??"FAKE_ID",usage:{inputTokens:g,outputTokens:h,totalTokens:g+h},output:k}};e&&!0===t.tracing&&(e.spanData.output=k,e.spanData.usage={input_tokens:w.response.usage.inputTokens,output_tokens:w.response.usage.outputTokens}),this.#e.dontLogModelData?this.#e.debug("Response ready (streamed)"):this.#e.debug("Response (streamed):",JSON.stringify(w.response,null,2)),yield w}catch(o){throw e&&e.setError({message:"Error streaming response",data:{error:!0===t.tracing?String(o):o instanceof Error?o.name:void 0}}),o}finally{e&&(e.end(),(0,n.resetCurrentSpan)())}}}function l(t){return new d(t)}function c(t){if(!t)return{};try{return JSON.parse(t)}catch(t){return{}}}function m(t){if(t)switch(t){case"auto":return{type:"auto"};case"required":return{type:"required"};case"none":return{type:"none"};default:return{type:"tool",toolName:t}}}var g=o(885);class h extends g.OpenAIRealtimeWebSocket{_audioLengthMs=0;constructor(t){super({...t,createWebSocket:async({url:t,apiKey:e})=>await this.#o({url:t,apiKey:e}),skipOpenEventListeners:!0})}async#o({url:t,apiKey:e}){const o=t.replace(/^ws/i,"http");if(!o)throw new Error("Realtime URL is not defined");const n=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Sec-WebSocket-Protocol":"realtime",Connection:"Upgrade",Upgrade:"websocket",...this.getCommonRequestHeaders()}}),r=n.webSocket;if(!r){const t=await n.text().catch(()=>"");throw new Error(`Failed to upgrade websocket: ${n.status} ${t}`)}return r.accept(),r}}class y extends g.OpenAIRealtimeWebSocket{#n;#r=null;#s=0;#i=0;#a=null;#e=(0,n.getLogger)("openai-agents:extensions:twilio");constructor(t){super(t),this.#n=t.twilioWebSocket}_setInputAndOutputAudioFormat(t){let e={};return t?e={...t,inputAudioFormat:t.inputAudioFormat??"g711_ulaw",outputAudioFormat:t.outputAudioFormat??"g711_ulaw"}:(e.inputAudioFormat="g711_ulaw",e.outputAudioFormat="g711_ulaw"),e}async connect(t){t.initialSessionConfig=this._setInputAndOutputAudioFormat(t.initialSessionConfig),this.#n.addEventListener("message",t=>{try{const e=JSON.parse(t.data.toString());switch(this.#e.dontLogModelData?this.#e.debug("Twilio message:",e.event):this.#e.debug("Twilio message:",e),this.emit("*",{type:"twilio_message",message:e}),e.event){case"media":"connected"===this.status&&this.sendAudio(g.utils.base64ToArrayBuffer(e.media.payload));break;case"mark":if(!e.mark.name.startsWith("done:")&&e.mark.name.includes(":")){const t=Number(e.mark.name.split(":")[1]);Number.isFinite(t)?this.#i=t:this.#e.warn("Invalid mark name received:",e.mark.name)}else e.mark.name.startsWith("done:")&&(this.#i=0);break;case"start":this.#r=e.start.streamSid}}catch(e){this.#e.error("Error parsing message:",e,"Message:",t),this.emit("error",{type:"error",error:e})}}),this.#n.addEventListener("close",()=>{"disconnected"!==this.status&&this.close()}),this.#n.addEventListener("error",t=>{this.emit("error",{type:"error",error:t}),this.close()}),this.on("audio_done",()=>{this.#n.send(JSON.stringify({event:"mark",mark:{name:`done:${this.currentItemId}`},streamSid:this.#r}))}),await super.connect(t)}updateSessionConfig(t){const e=this._setInputAndOutputAudioFormat(t);super.updateSessionConfig(e)}_interrupt(t,e=!0){const o=this.#i+50;this.#e.debug(`Interruption detected, clearing Twilio audio and truncating OpenAI audio after ${o}ms`),this.#n.send(JSON.stringify({event:"clear",streamSid:this.#r})),super._interrupt(o,e)}_onAudio(t){this.#e.debug(`Sending audio to Twilio ${t.responseId}: (${t.data.byteLength} bytes)`);const e={event:"media",streamSid:this.#r,media:{payload:g.utils.arrayBufferToBase64(t.data)}};this.#a!==this.currentItemId&&this.currentItemId&&(this.#a=this.currentItemId,this.#s=0),this.#s+=t.data.byteLength/8,this.#n.send(JSON.stringify(e)),this.#n.send(JSON.stringify({event:"mark",streamSid:this.#r,mark:{name:`${this.currentItemId}:${this.#s}`}})),this.emit("audio",t)}}}}]);