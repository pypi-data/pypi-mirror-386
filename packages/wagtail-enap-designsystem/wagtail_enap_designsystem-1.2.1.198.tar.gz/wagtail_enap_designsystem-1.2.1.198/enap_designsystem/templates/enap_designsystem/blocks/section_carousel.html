<!-- templates/blocks/section_carousel.html -->
{% load wagtailcore_tags %}
<section class="enap-section-carousel" 
         data-autoplay="{{ value.autoplay|yesno:'true,false' }}"
         data-interval="{{ value.intervalo_autoplay }}000"
         data-effect="{{ value.efeito_transicao }}"
         style="--altura-minima: {{ value.altura_minima }};">
    
    <!-- Título do Carrossel -->
    {% if value.titulo_carrossel %}
        <div class="carousel-header">
            <div class="container">
                <h2 class="carousel-title">{{ value.titulo_carrossel }}</h2>
            </div>
        </div>
    {% endif %}
    
    <div class="section-carousel-container">
        
        <!-- Controles Superiores -->
        {% if value.posicao_controles == 'superior' %}
            <div class="carousel-controls superior">
                {% include 'blocks/partials/section_carousel_controls.html' %}
            </div>
        {% endif %}
        
        <!-- Wrapper Principal -->
        <div class="section-carousel-wrapper">
            
            <!-- Slides das Seções -->
            <div class="section-carousel-slides {{ value.efeito_transicao }}">
                {% for slide in value.slides %}
                    <div class="section-slide {% if forloop.first %}active{% endif %}"
                         data-slide="{{ forloop.counter0 }}">
                        
                        <!-- Renderiza a seção escolhida -->
                        {% for block in slide.secao %}
                            {% include_block block %}
                        {% endfor %}
                        
                    </div>
                {% endfor %}
            </div>
            
            <!-- Navegação Lateral -->
            {% if value.mostrar_navegacao and value.posicao_controles == 'lateral' %}
                <button class="section-carousel-arrow prev" onclick="changeSectionSlide(-1)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                <button class="section-carousel-arrow next" onclick="changeSectionSlide(1)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
            {% endif %}
            
        </div>
        
        <!-- Controles Inferiores -->
        {% if value.posicao_controles == 'inferior' %}
            <div class="carousel-controls inferior">
                <div class="container">
                    
                    <!-- Indicadores -->
                    {% if value.mostrar_indicadores and value.slides|length > 1 %}
                        <div class="section-carousel-indicators {{ value.estilo_indicadores }}">
                            {% for slide in value.slides %}
                                {% if value.estilo_indicadores == 'pontos' %}
                                    <button class="indicator ponto {% if forloop.first %}active{% endif %}"
                                            onclick="goToSectionSlide({{ forloop.counter0 }})"
                                            data-slide="{{ forloop.counter0 }}">
                                    </button>
                                {% elif value.estilo_indicadores == 'numeros' %}
                                    <button class="indicator numero {% if forloop.first %}active{% endif %}"
                                            onclick="goToSectionSlide({{ forloop.counter0 }})"
                                            data-slide="{{ forloop.counter0 }}">
                                        {{ forloop.counter }}
                                    </button>
                                {% elif value.estilo_indicadores == 'barras' %}
                                    <div class="indicator barra {% if forloop.first %}active{% endif %}"
                                         data-slide="{{ forloop.counter0 }}">
                                        <div class="progress-bar"></div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Navegação por Botões -->
                    {% if value.mostrar_navegacao and value.posicao_controles == 'inferior' %}
                        <div class="section-navigation-buttons">
                            <button class="nav-button prev" onclick="changeSectionSlide(-1)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Anterior
                            </button>
                            <button class="nav-button next" onclick="changeSectionSlide(1)">
                                Próxima
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                        </div>
                    {% endif %}
                    
                </div>
            </div>
        {% endif %}
        
    </div>
</section>

<style>
.enap-section-carousel {
    position: relative;
    width: 100%;
    min-height: var(--altura-minima);
}

.carousel-header {
    background: #f8f9fa;
    padding: 40px 0;
    border-bottom: 1px solid #e9ecef;
}

.carousel-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
    text-align: center;
}

.section-carousel-container {
    position: relative;
    width: 100%;
}

.section-carousel-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
}

.section-carousel-slides {
    position: relative;
    width: 100%;
}

.section-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
}

.section-slide.active {
    opacity: 1;
    transform: translateX(0);
    z-index: 2;
    position: relative;
}

/* Efeitos de Transição */
.section-carousel-slides.fade .section-slide {
    transform: none;
    transition: opacity 0.8s ease-in-out;
}

.section-carousel-slides.slide-vertical .section-slide {
    transform: translateY(100%);
}

.section-carousel-slides.slide-vertical .section-slide.active {
    transform: translateY(0);
}

/* Setas de Navegação Lateral */
.section-carousel-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: #007D7A;
    border: 2px solid white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.section-carousel-arrow:hover {
    background: #006969;
    transform: translateY(-50%) scale(1.1);
}

.section-carousel-arrow.prev {
    left: 30px;
}

.section-carousel-arrow.next {
    right: 30px;
}

/* Controles */
.carousel-controls {
    background: #f8f9fa;
    padding: 30px 0;
    border-top: 1px solid #e9ecef;
}

.carousel-controls.superior {
    border-top: none;
    border-bottom: 1px solid #e9ecef;
}

.carousel-controls .container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 40px;
    flex-wrap: wrap;
}

/* Indicadores */
.section-carousel-indicators {
    display: flex;
    gap: 16px;
    align-items: center;
}

/* Estilo Pontos */
.section-carousel-indicators.pontos .indicator {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid #ddd;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

.section-carousel-indicators.pontos .indicator.active {
    background: #0066cc;
    border-color: #0066cc;
}

.section-carousel-indicators.pontos .indicator:hover {
    transform: scale(1.2);
    border-color: #0066cc;
}

/* Estilo Números */
.section-carousel-indicators.numeros .indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #ddd;
    background: white;
    color: #666;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.section-carousel-indicators.numeros .indicator.active {
    background: #0066cc;
    border-color: #0066cc;
    color: white;
}

.section-carousel-indicators.numeros .indicator:hover {
    border-color: #0066cc;
    color: #0066cc;
}

/* Estilo Barras */
.section-carousel-indicators.barras {
    gap: 8px;
}

.section-carousel-indicators.barras .indicator {
    width: 60px;
    height: 4px;
    background: #ddd;
    border-radius: 2px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.section-carousel-indicators.barras .indicator .progress-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: #0066cc;
    border-radius: 2px;
    width: 0;
    transition: width 0.3s ease;
}

.section-carousel-indicators.barras .indicator.active .progress-bar {
    width: 100%;
}

/* Botões de Navegação */
.section-navigation-buttons {
    display: flex;
    gap: 16px;
}

.nav-button {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: white;
    border: 2px solid #0066cc;
    border-radius: 8px;
    color: #0066cc;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-button:hover {
    background: #0066cc;
    color: white;
    transform: translateY(-2px);
}

/* Responsividade */
@media (max-width: 768px) {
    .carousel-title {
        font-size: 2rem;
    }
    
    .carousel-header {
        padding: 30px 0;
    }
    
    .section-carousel-arrow {
        width: 50px;
        height: 50px;
    }
    
    .section-carousel-arrow.prev {
        left: 15px;
    }
    
    .section-carousel-arrow.next {
        right: 15px;
    }
    
    .carousel-controls .container {
        flex-direction: column;
        gap: 20px;
    }
    
    .section-navigation-buttons {
        flex-direction: column;
        width: 100%;
        max-width: 300px;
    }
    
    .nav-button {
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .carousel-title {
        font-size: 1.6rem;
    }
    
    .carousel-controls {
        padding: 20px 0;
    }
    
    .section-carousel-indicators.numeros .indicator {
        width: 35px;
        height: 35px;
        font-size: 14px;
    }
    
    .section-carousel-indicators.barras .indicator {
        width: 40px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('.enap-section-carousel');
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.section-slide');
    const indicators = carousel.querySelectorAll('.indicator');
    const autoplay = carousel.dataset.autoplay === 'true';
    const interval = parseInt(carousel.dataset.interval) || 8000;
    
    let currentSlide = 0;
    let autoplayTimer;
    let isTransitioning = false;
    
    function showSlide(index) {
        if (isTransitioning) return;
        isTransitioning = true;
        
        // Remove active class from all
        slides.forEach(slide => slide.classList.remove('active'));
        indicators.forEach(indicator => indicator.classList.remove('active'));
        
        // Add active class to current
        if (slides[index]) {
            slides[index].classList.add('active');
        }
        if (indicators[index]) {
            indicators[index].classList.add('active');
        }
        
        currentSlide = index;
        
        // Reset transition lock after animation
        setTimeout(() => {
            isTransitioning = false;
        }, 800);
        
        // Update progress bars if using that style
        updateProgressBars();
    }
    
    function updateProgressBars() {
        const progressBars = carousel.querySelectorAll('.progress-bar');
        progressBars.forEach((bar, index) => {
            if (index === currentSlide && autoplay) {
                bar.style.transition = `width ${interval}ms linear`;
                bar.style.width = '100%';
            } else {
                bar.style.transition = 'width 0.3s ease';
                bar.style.width = index <= currentSlide ? '100%' : '0';
            }
        });
    }
    
    function nextSlide() {
        const next = (currentSlide + 1) % slides.length;
        showSlide(next);
    }
    
    function prevSlide() {
        const prev = (currentSlide - 1 + slides.length) % slides.length;
        showSlide(prev);
    }
    
    function startAutoplay() {
        if (autoplay && slides.length > 1) {
            autoplayTimer = setInterval(nextSlide, interval);
            updateProgressBars();
        }
    }
    
    function stopAutoplay() {
        if (autoplayTimer) {
            clearInterval(autoplayTimer);
        }
        // Reset progress bars
        const progressBars = carousel.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
            bar.style.transition = 'width 0.3s ease';
        });
    }
    
    // Global functions
    window.changeSectionSlide = function(direction) {
        stopAutoplay();
        if (direction > 0) {
            nextSlide();
        } else {
            prevSlide();
        }
        setTimeout(startAutoplay, 1000);
    };
    
    window.goToSectionSlide = function(index) {
        stopAutoplay();
        showSlide(index);
        setTimeout(startAutoplay, 1000);
    };
    
    // Pause on hover
    carousel.addEventListener('mouseenter', stopAutoplay);
    carousel.addEventListener('mouseleave', startAutoplay);
    
    // Touch support
    let startX = 0;
    let endX = 0;
    
    carousel.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        stopAutoplay();
    });
    
    carousel.addEventListener('touchend', function(e) {
        endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        
        if (Math.abs(diff) > 50) {
            if (diff > 0) {
                nextSlide();
            } else {
                prevSlide();
            }
        }
        setTimeout(startAutoplay, 2000);
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            window.changeSectionSlide(-1);
        } else if (e.key === 'ArrowRight') {
            window.changeSectionSlide(1);
        }
    });
    
    // Initialize
    showSlide(0);
    startAutoplay();
});
</script>