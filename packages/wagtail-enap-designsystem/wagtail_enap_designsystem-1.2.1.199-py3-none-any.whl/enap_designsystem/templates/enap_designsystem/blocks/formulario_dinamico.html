<!-- templates/enap_designsystem/blocks/formulario_dinamico.html -->

{% load wagtailcore_tags %}

<div class="formulario-dinamico-wrapper mb-5">
    <!-- Cabeçalho do formulário -->
    {% if value.titulo %}
        <div class="formulario-header mb-4">
            <h2 style="color: {{value.cor_titulo}}" class="h3 mb-2">{{ value.titulo }}</h2>
            {% if value.descricao %}
                <p class="text-muted">{{ value.descricao }}</p>
            {% endif %}
        </div>
    {% endif %}
    
    <!-- Formulário -->
    <form id="{{ form_id }}" method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        
        <!-- Campos ocultos -->
        <input type="hidden" name="page_id" value="{{ page.id }}">
        <input type="hidden" name="form_id" value="{{ form_id }}">
        <input type="hidden" name="email_notificacao" value="{{ value.email_notificacao }}">
        
        <!-- Renderizar campos dinâmicos -->
        <div class="formulario-campos">
            {% for campo in value.campos %}
                <div class="campo-wrapper mb-3">
                    {% if campo.block_type == 'nome_completo_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="text" 
                            name="nome_completo_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            placeholder="{{ campo.value.placeholder }}"
                            {% if campo.value.required %}required{% endif %}
                            {% if campo.value.min_length %}minlength="{{ campo.value.min_length }}"{% endif %}
                            {% if campo.value.max_length %}maxlength="{{ campo.value.max_length }}"{% endif %}
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'text_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="text" 
                            name="text_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            placeholder="{{ campo.value.placeholder }}"
                            {% if campo.value.required %}required{% endif %}
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'email_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="email" 
                            name="email_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            placeholder="{{ campo.value.placeholder }}"
                            {% if campo.value.required %}required{% endif %}
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'phone_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="tel" 
                            name="phone_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            placeholder="{{ campo.value.placeholder }}"
                            {% if campo.value.required %}required{% endif %}
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'cpf_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="text" 
                            name="cpf_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            placeholder="{{ campo.value.placeholder }}"
                            {% if campo.value.required %}required{% endif %}
                            maxlength="14"
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'textarea_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <textarea 
                            name="textarea_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            rows="4"
                            placeholder="{{ campo.value.placeholder }}"
                            {% if campo.value.required %}required{% endif %}
                        ></textarea>
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'dropdown_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <select 
                            name="dropdown_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-select"
                            {% if campo.value.required %}required{% endif %}
                        >
                            <option value="">Selecione uma opção</option>
                            {% for opcao in campo.value.choices %}
                                <option value="{{ opcao.choice_value }}">{{ opcao.choice_label }}</option>
                            {% endfor %}
                        </select>
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'radio_field' %}
                        <fieldset>
                            <legend class="form-label">
                                {{ campo.value.label }}
                                {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                            </legend>
                            {% for opcao in campo.value.choices %}
                                <div class="form-check">
                                    <input 
                                        type="radio" 
                                        name="radio_field_{{ campo.id }}" 
                                        id="{{ form_id }}_{{ campo.id }}_{{ forloop.counter }}"
                                        value="{{ opcao.choice_value }}"
                                        class="form-check-input"
                                        {% if campo.value.required %}required{% endif %}
                                    >
                                    <label class="form-check-label" for="{{ form_id }}_{{ campo.id }}_{{ forloop.counter }}">
                                        {{ opcao.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                            {% if campo.value.help_text %}
                                <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                            {% endif %}
                        </fieldset>
                    
                    {% elif campo.block_type == 'checkbox_field' %}
                        <div class="form-check">
                            <input 
                                type="checkbox" 
                                name="checkbox_field_{{ campo.id }}" 
                                id="{{ form_id }}_{{ campo.id }}"
                                value="true"
                                class="form-check-input"
                                {% if campo.value.required %}required{% endif %}
                            >
                            <label class="form-check-label" for="{{ form_id }}_{{ campo.id }}">
                                {{ campo.value.label }}
                                {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {% if campo.value.help_text %}
                                <small class="form-text text-muted d-block">{{ campo.value.help_text }}</small>
                            {% endif %}
                        </div>
                    
                    {% elif campo.block_type == 'checkbox_multiple_field' %}
                        <fieldset>
                            <legend class="form-label">
                                {{ campo.value.label }}
                                {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                            </legend>
                            {% for opcao in campo.value.choices %}
                                <div class="form-check">
                                    <input 
                                        type="checkbox" 
                                        name="checkbox_multiple_field_{{ campo.id }}[]" 
                                        id="{{ form_id }}_{{ campo.id }}_{{ forloop.counter }}"
                                        value="{{ opcao.choice_value }}"
                                        class="form-check-input"
                                    >
                                    <label class="form-check-label" for="{{ form_id }}_{{ campo.id }}_{{ forloop.counter }}">
                                        {{ opcao.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                            {% if campo.value.help_text %}
                                <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                            {% endif %}
                        </fieldset %}
                    
                    {% elif campo.block_type == 'file_upload_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="file" 
                            name="file_upload_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            {% if campo.value.required %}required{% endif %}
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'number_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="number" 
                            name="number_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            placeholder="{{ campo.value.placeholder }}"
                            {% if campo.value.required %}required{% endif %}
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'date_field' %}
                        <label for="{{ form_id }}_{{ campo.id }}" class="form-label">
                            {{ campo.value.label }}
                            {% if campo.value.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input 
                            type="date" 
                            name="date_field_{{ campo.id }}" 
                            id="{{ form_id }}_{{ campo.id }}"
                            class="form-control"
                            {% if campo.value.required %}required{% endif %}
                        >
                        {% if campo.value.help_text %}
                            <small class="form-text text-muted">{{ campo.value.help_text }}</small>
                        {% endif %}
                    
                    {% elif campo.block_type == 'section_header' %}
                        <div class="section-header mt-4 mb-3">
                            <h4 class="h5">{{ campo.value.title }}</h4>
                            {% if campo.value.subtitle %}
                                <p class="text-muted">{{ campo.value.subtitle }}</p>
                            {% endif %}
                        </div>
                    
                    {% elif campo.block_type == 'info_text' %}
                        <div class="alert alert-info">
                            {{ campo.value.text }}
                        </div>
                    
                    {% elif campo.block_type == 'divider' %}
                        <hr class="my-4">
                    
                    {% else %}
                        <!-- Fallback para campos não mapeados -->
                        <div class="alert alert-warning">
                            <strong>Campo não suportado:</strong> {{ campo.block_type }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
        <!-- Botão de envio -->
        <div class="formulario-submit mt-4">
            <button type="submit" class="botao-envio btn primary btn-lg">
                {% if value.botao_icone %}
                <i class="fas fa-paper-plane me-2"></i>
                {% endif %}
                {{ value.botao_texto|default:"Enviar" }}
            </button>
        </div>
    </form>
    
    <!-- Área de mensagens -->
    <div id="{{ form_id }}_messages" class="formulario-messages mt-3" style="display: none;">
        <div id="{{ form_id }}_success" class="alert alert-success" style="display: none;">
            <i class="fas fa-check-circle me-2"></i>
            <span class="message-text">{{ value.mensagem_sucesso }}</span>
        </div>
        <div id="{{ form_id }}_error" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span class="message-text">Erro ao enviar formulário. Tente novamente.</span>
        </div>
        <div id="{{ form_id }}_loading" class="alert alert-info" style="display: none;">
            <i class="fas fa-spinner fa-spin me-2"></i>
            <span class="message-text">Enviando formulário...</span>
        </div>
    </div>
</div>

<script>
(function() {
    const form = document.getElementById('{{ form_id }}');
    const messagesDiv = document.getElementById('{{ form_id }}_messages');
    const successDiv = document.getElementById('{{ form_id }}_success');
    const errorDiv = document.getElementById('{{ form_id }}_error');
    const loadingDiv = document.getElementById('{{ form_id }}_loading');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Função para mostrar mensagem
    function showMessage(type, message) {
        // Esconder todas as mensagens
        successDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        loadingDiv.style.display = 'none';
        
        // Mostrar a mensagem correta
        messagesDiv.style.display = 'block';
        
        if (type === 'success') {
            successDiv.style.display = 'block';
            if (message) successDiv.querySelector('.message-text').textContent = message;
        } else if (type === 'error') {
            errorDiv.style.display = 'block';
            if (message) errorDiv.querySelector('.message-text').textContent = message;
        } else if (type === 'loading') {
            loadingDiv.style.display = 'block';
            if (message) loadingDiv.querySelector('.message-text').textContent = message;
        }
        
        // Scroll para a mensagem
        messagesDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Handler do formulário
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Mostrar loading
        showMessage('loading', 'Enviando formulário...');
        submitBtn.disabled = true;
        
        // Preparar dados do formulário
        const formData = new FormData(form);
        
        // Processar campos de checkbox múltiplo
        const checkboxGroups = {};
        const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
        
        checkboxes.forEach(function(checkbox) {
            const name = checkbox.name;
            if (name.endsWith('[]')) {
                const groupName = name.slice(0, -2); // Remove []
                if (!checkboxGroups[groupName]) {
                    checkboxGroups[groupName] = [];
                }
                checkboxGroups[groupName].push(checkbox.value);
            }
        });
        
        // Adicionar grupos de checkbox ao FormData
        Object.keys(checkboxGroups).forEach(function(groupName) {
            formData.delete(groupName + '[]'); // Remove entradas individuais
            checkboxGroups[groupName].forEach(function(value) {
                formData.append(groupName + '[]', value);
            });
        });
        
        // Enviar formulário
        fetch('/formulario-dinamico/submit/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                showMessage('success', data.message);
                form.reset(); // Limpar formulário
                
                // Limpar campos customizados se necessário
                const customSelects = form.querySelectorAll('select');
                customSelects.forEach(function(select) {
                    select.selectedIndex = 0;
                });
                
                const fileInputs = form.querySelectorAll('input[type="file"]');
                fileInputs.forEach(function(input) {
                    input.value = '';
                });
                
            } else {
                showMessage('error', data.error || 'Erro desconhecido ao enviar formulário');
            }
        })
        .catch(function(error) {
            console.error('Erro:', error);
            showMessage('error', 'Erro de conexão. Verifique sua internet e tente novamente.');
        })
        .finally(function() {
            submitBtn.disabled = false;
        });
    });
    
    // Validação básica em tempo real (opcional)
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(function(field) {
        field.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
        
        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
    });
})();
</script>

<style>
.formulario-dinamico-wrapper {
    max-width: 800px;
    margin: auto;
}

.botao-envio{
    padding: 12px 50px;
    background-color: {{value.cor_botao}};
}

.botao-envio:hover{
    background-color: {{value.cor_botao_hover}};
}

.botao-envio:active{
    background-color: {{value.cor_botao_active}};
}

.botao-envio:focus{
    box-shadow: none;
}

.formulario-header {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 1rem;
}

.formulario-campos > * {
    margin-bottom: 1.5rem;
}

.formulario-submit {
    border-top: 1px solid #e9ecef;
    padding-top: 1.5rem;
    text-align: center;
    display: flex;
    justify-content: {{ value.posicao_botao }};
}

.formulario-messages {
    position: relative;
}

.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Animações suaves */
.formulario-messages .alert {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsividade */
@media (max-width: 768px) {
    .formulario-dinamico-wrapper {
        max-width: 100%;
    }
    
    .formulario-submit .btn {
        width: 100%;
    }
}
</style>