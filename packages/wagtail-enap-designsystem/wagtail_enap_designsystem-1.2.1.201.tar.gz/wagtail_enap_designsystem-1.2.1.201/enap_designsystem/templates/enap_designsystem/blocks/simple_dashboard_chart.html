<div class="chart-card">
    <div class="chart-title">{{ value.title }}</div>
    
    {% if value.chart_type == 'card' %}
        <div class="card-content">
            {% for item in value.chart_data %}
            <div class="card-value">{{ item.value }}</div>
            <div class="card-label">{{ item.label }}</div>
            {% endfor %}
        </div>
    {% else %}
        <canvas id="chart-{{ block.id }}" class="chart-canvas"></canvas>
    {% endif %}
</div>

{% if value.chart_type != 'card' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = [
        {% for item in value.chart_data %}
        { label: "{{ item.label }}", value: {{ item.value }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    if (typeof Chart !== 'undefined') {
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        Chart.defaults.color = '#64748b';
        
        const ctx = document.getElementById('chart-{{ block.id }}').getContext('2d');
        
        let chartConfig = {};
        
        // GRÁFICO DE BARRAS HORIZONTAIS (igual à imagem)
        if ('{{ value.chart_type }}' === 'horizontal_bar') {
            chartConfig = {
                type: 'bar',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.value),
                        backgroundColor: [
                            '#22c55e', // Verde vibrante
                            '#06b6d4', // Azul cyan
                            '#0ea5e9', // Azul
                            '#8b5cf6', // Roxo
                            '#a855f7', // Roxo claro
                            '#f59e0b', // Amarelo
                            '#ef4444'  // Vermelho
                        ],
                        borderRadius: 25,
                        borderSkipped: false,
                        barThickness: 24,
                        maxBarThickness: 24
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { right: 50 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderWidth: 0,
                            cornerRadius: 8,
                            displayColors: false,
                            padding: 12
                        }
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: { display: false }
                        },
                        y: {
                            grid: { display: false },
                            ticks: {
                                color: '#475569',
                                font: { size: 15, weight: '500' },
                                padding: 16
                            },
                            border: { display: false }
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const data = dataset.data[index];
                                
                                ctx.fillStyle = '#475569';
                                ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                                ctx.textAlign = 'left';
                                ctx.textBaseline = 'middle';
                                
                                const x = bar.x + 12;
                                const y = bar.y;
                                
                                ctx.fillText(data, x, y);
                            });
                        });
                    }
                }]
            };
        }
        
        // GRÁFICO DE BARRAS VERTICAIS
        else if ('{{ value.chart_type }}' === 'bar') {
            chartConfig = {
                type: 'bar',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.value),
                        backgroundColor: [
                            '#22c55e', // Verde vibrante
                            '#06b6d4', // Azul cyan
                            '#0ea5e9', // Azul
                            '#8b5cf6', // Roxo
                            '#a855f7', // Roxo claro
                            '#f59e0b', // Amarelo
                            '#ef4444', // Vermelho
                            '#10b981', // Verde esmeralda
                            '#6366f1', // Índigo
                            '#f97316'  // Laranja
                        ],
                        hoverBackgroundColor: [
                            '#16a34a', // Verde mais escuro no hover
                            '#0891b2', // Azul cyan mais escuro
                            '#0284c7', // Azul mais escuro
                            '#7c3aed', // Roxo mais escuro
                            '#9333ea', // Roxo claro mais escuro
                            '#d97706', // Amarelo mais escuro
                            '#dc2626', // Vermelho mais escuro
                            '#059669', // Verde esmeralda mais escuro
                            '#4f46e5', // Índigo mais escuro
                            '#ea580c'  // Laranja mais escuro
                        ],
                        borderRadius: 8,
                        borderSkipped: false,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderWidth: 0,
                            cornerRadius: 8,
                            displayColors: false,
                            padding: 12
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { weight: '500' } },
                            border: { display: false }
                        },
                        y: {
                            grid: { display: true, color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { color: '#64748b', font: { weight: '500' } },
                            border: { display: false }
                        }
                    }
                }
            };
        }
        
        // GRÁFICO DE LINHA
        else if ('{{ value.chart_type }}' === 'line') {
            chartConfig = {
                type: 'line',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.value),
                        backgroundColor: 'transparent',
                        borderColor: '#14D975',
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#14D975',
                        pointHoverBorderColor: 'white',
                        pointHoverBorderWidth: 2,
                        tension: 0.4,
                        fill: {
                            target: 'origin',
                            above: 'rgba(20, 217, 117, 0.05)'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderWidth: 0,
                            cornerRadius: 8,
                            displayColors: false,
                            padding: 12
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { weight: '500' } },
                            border: { display: false }
                        },
                        y: {
                            grid: { display: true, color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { color: '#64748b', font: { weight: '500' } },
                            border: { display: false }
                        }
                    }
                }
            };
        }
        
        // GRÁFICO DONUT
        else if ('{{ value.chart_type }}' === 'donut') {
            chartConfig = {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.value),
                        backgroundColor: [
                            '#14D975', // Verde
                            '#06b6d4', // Azul cyan
                            '#8b5cf6', // Roxo
                            '#f59e0b', // Amarelo
                            '#ef4444', // Vermelho
                            '#10b981', // Verde esmeralda
                            '#6366f1'  // Índigo
                        ],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                color: '#64748b',
                                font: { weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderWidth: 0,
                            cornerRadius: 8,
                            displayColors: false,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return context.label + ': ' + percentage + '%';
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const data = chart.data.datasets[0].data;
                        const total = data.reduce((a, b) => a + b, 0);
                        
                        chart.data.datasets[0].data.forEach((value, index) => {
                            const meta = chart.getDatasetMeta(0);
                            const arc = meta.data[index];
                            
                            if (arc && value > (total * 0.08)) {
                                const percentage = ((value * 100) / total).toFixed(0);
                                
                                const angle = (arc.startAngle + arc.endAngle) / 2;
                                const radius = (arc.innerRadius + arc.outerRadius) / 2;
                                const x = arc.x + Math.cos(angle) * radius;
                                const y = arc.y + Math.sin(angle) * radius;
                                
                                ctx.fillStyle = 'white';
                                ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(percentage + '%', x, y);
                            }
                        });
                    }
                }]
            };
        }

        new Chart(ctx, chartConfig);
    }
});
</script>
{% endif %}

<style>
.chart-card {
    background: white;
    width: 100%;
    max-width: 100%;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 6px rgba(0,0,0,0.04);
    margin-bottom: 24px;
    border: 1px solid rgba(0,0,0,0.05);
}

.chart-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 24px;
    color: #1e293b;
    letter-spacing: -0.025em;
}

.card-content {
    text-align: center;
}

.card-value {
    font-size: 48px;
    font-weight: 300;
    color: #14D975;
    margin-bottom: 8px;
    line-height: 1;
}

.card-label {
    font-size: 14px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}

.chart-canvas {
    height: 320px !important;
}
</style>