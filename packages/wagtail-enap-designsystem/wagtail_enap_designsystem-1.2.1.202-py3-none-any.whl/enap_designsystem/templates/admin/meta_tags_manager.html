{% extends "wagtailadmin/base.html" %}
{% load wagtailadmin_tags %}

{% block titletag %}Gerenciar Meta Tags{% endblock %}

{% block content %}
<header class="nice-padding hasform">
    <div class="row">
        <div class="left">
            <div class="col">
                <h1 class="icon icon-cog">üè∑Ô∏è Gerenciar Meta Tags</h1>
                <p>Adicione ou atualize meta tags (SEO title e description) em suas p√°ginas automaticamente.</p>
            </div>
        </div>
    </div>
</header>

<div class="nice-padding">
    <!-- Estat√≠sticas -->
    <div class="row">
        <div class="col3">
            <div class="card">
                <h3>üìä Estat√≠sticas</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <strong>{{ total_pages }}</strong>
                        <span>Total de P√°ginas</span>
                    </div>
                    <div class="stat-item">
                        <strong>{{ pages_without_seo }}</strong>
                        <span>Sem SEO Title</span>
                    </div>
                    <div class="stat-item">
                        <strong>{{ pages_without_description }}</strong>
                        <span>Sem Meta Description</span>
                    </div>
                    <div class="stat-item">
                        <strong>{{ pages_with_meta }}</strong>
                        <span>Com Meta Tags Completas</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col9">
            <div class="card">
                <h3>‚öôÔ∏è Configurar Aplica√ß√£o</h3>
                
                <form method="post" id="meta-form">
                    {% csrf_token %}
                    
                    <div class="form-row">
                        <label>
                            <input type="checkbox" name="force_update" id="force_update"> 
                            <strong>For√ßar atualiza√ß√£o</strong>
                            <small>Atualizar mesmo p√°ginas que j√° possuem meta tags</small>
                        </label>
                    </div>
                    
                    <div class="form-row">
                        <label for="page_type">Filtrar por tipo de p√°gina (opcional):</label>
                        <select name="page_type" id="page_type">
                            <option value="">Todas as p√°ginas</option>
                            <option value="HomePage">Home Page</option>
                            <option value="BlogPage">Blog Posts</option>
                            <option value="EventPage">Eventos</option>
                            <option value="CoursePage">Cursos</option>
                            <option value="Page">P√°ginas Gerais</option>
                        </select>
                    </div>
                    
                    <div class="button-row">
                        <button type="submit" name="action" value="preview" class="button button-secondary">
                            üîç Visualizar Mudan√ßas
                        </button>
                        <button type="submit" name="action" value="apply_all" class="button button-primary" 
                                onclick="return confirm('Tem certeza que deseja aplicar as meta tags? Esta a√ß√£o n√£o pode ser desfeita.')">
                            ‚úÖ Aplicar Meta Tags
                        </button>
                    </div>
                </form>üîç Visualizar Mudan√ßas
                        </button>
                        <button type="submit" name="action" value="apply" class="button button-primary" 
                                onclick="return confirm('Tem certeza que deseja aplicar as meta tags? Esta a√ß√£o n√£o pode ser desfeita.')">
                            ‚úÖ Aplicar Meta Tags
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    {% if showing_preview %}
    <!-- Preview das Mudan√ßas -->
    <div class="card" style="margin-top: 20px;">
        <h3>üîç Preview das Mudan√ßas ({{ total_to_update }} p√°ginas ser√£o atualizadas)</h3>
        
        {% if preview_data %}
        <div class="preview-controls">
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="force_update" value="{{ force_update|yesno:'on,off' }}">
                <input type="hidden" name="page_type" value="{{ page_type_filter }}">
                
                <button type="submit" name="action" value="apply_all" class="button button-primary" 
                        onclick="return confirm('Aplicar meta tags em {{ total_to_update }} p√°ginas?')">
                    ‚úÖ Confirmar e Aplicar Todas ({{ total_to_update }} p√°ginas)
                </button>
            </form>
            
            <button onclick="selectAllPages()" class="button">Selecionar Todas</button>
            <button onclick="applySelected()" class="button button-secondary">Aplicar Apenas Selecionadas</button>
        </div>
        
        <div class="preview-list">
            <form method="post" id="selected-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="apply_selected">
                
                {% for item in preview_data %}
                <div class="preview-item">
                    <div class="preview-header">
                        <label>
                            <input type="checkbox" name="selected_pages" value="{{ item.id }}">
                            <strong>{{ item.title }}</strong>
                        </label>
                        <small>{{ item.page_type }} ‚Ä¢ ID: {{ item.id }}</small>
                    </div>
                    
                    <div class="meta-comparison">
                        <div class="meta-field">
                            <strong>SEO Title:</strong>
                            <div class="before-after">
                                <div class="before">
                                    <small>Atual:</small>
                                    <span class="current">{{ item.current_seo }}</span>
                                </div>
                                <div class="after">
                                    <small>Novo:</small>
                                    <span class="new">{{ item.new_seo }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="meta-field">
                            <strong>Meta Description:</strong>
                            <div class="before-after">
                                <div class="before">
                                    <small>Atual:</small>
                                    <span class="current">{{ item.current_description }}</span>
                                </div>
                                <div class="after">
                                    <small>Novo:</small>
                                    <span class="new">{{ item.new_description }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </form>
        </div>
        {% else %}
        <p class="help">‚úÖ N√£o h√° p√°ginas para atualizar com os filtros selecionados.</p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Log de Atividades Recentes -->
    <div class="card" style="margin-top: 20px;">
        <h3>üìù Dicas e Informa√ß√µes</h3>
        <div class="help-content">
            <h4>üéØ Como funciona:</h4>
            <ul>
                <li><strong>SEO Title:</strong> Gerado como "T√≠tulo da P√°gina | Enap" (m√°x 60 caracteres)</li>
                <li><strong>Meta Description:</strong> Extra√≠da do conte√∫do da p√°gina ou gerada automaticamente (m√°x 160 caracteres)</li>
                <li><strong>Campos analisados:</strong> introduction, resumo, body, content, texto</li>
            </ul>
            
            <h4>‚ö†Ô∏è Cuidados:</h4>
            <ul>
                <li>Sempre fa√ßa <strong>preview</strong> antes de aplicar</li>
                <li>Use "For√ßar atualiza√ß√£o" apenas se necess√°rio</li>
                <li>As altera√ß√µes s√£o <strong>permanentes</strong> - n√£o h√° desfazer</li>
                <li>Para p√°ginas espec√≠ficas, use a op√ß√£o "Aplicar Selecionadas"</li>
            </ul>
            
            <h4>üîç Filtros dispon√≠veis:</h4>
            <ul>
                <li><strong>Todas as p√°ginas:</strong> Processa todo o site</li>
                <li><strong>Por tipo:</strong> HomePage, BlogPage, EventPage, etc.</li>
                <li><strong>For√ßar atualiza√ß√£o:</strong> Substitui meta tags existentes</li>
            </ul>
        </div>
    </div>
</div>

<script>
function selectAllPages() {
    const checkboxes = document.querySelectorAll('input[name="selected_pages"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function applySelected() {
    const selected = document.querySelectorAll('input[name="selected_pages"]:checked');
    if (selected.length === 0) {
        alert('Por favor, selecione pelo menos uma p√°gina.');
        return;
    }
    
    if (confirm(`Aplicar meta tags em ${selected.length} p√°gina(s) selecionada(s)?`)) {
        document.getElementById('selected-form').submit();
    }
}

// Auto-refresh de estat√≠sticas (opcional)
setInterval(function() {
    // Implementar se necess√°rio
}, 30000);
</script>

<style>
.card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
}

.stat-item {
    text-align: center;
    padding: 10px;
    background: #f8f8f8;
    border-radius: 4px;
}

.stat-item strong {
    display: block;
    font-size: 24px;
    color: #2e5c6e;
}

.stat-item span {
    font-size: 12px;
    color: #666;
}

.form-row {
    margin-bottom: 15px;
}

.form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-row small {
    display: block;
    color: #666;
    font-weight: normal;
}

.button-row {
    margin-top: 20px;
}

.button-row .button {
    margin-right: 10px;
}

.preview-controls {
    margin-bottom: 20px;
    padding: 15px;
    background: #f0f7ff;
    border-radius: 4px;
}

.preview-item {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 10px;
    background: white;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}

.meta-field {
    margin-bottom: 15px;
}

.before-after {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 5px;
}

.before, .after {
    padding: 10px;
    border-radius: 4px;
}

.before {
    background: #fff3cd;
}

.after {
    background: #d1f2eb;
}

.current, .new {
    display: block;
    margin-top: 5px;
    font-family: monospace;
    font-size: 13px;
}

.help-content h4 {
    color: #2e5c6e;
    margin-top: 20px;
    margin-bottom: 10px;
}

.help-content ul {
    margin-left: 20px;
    margin-bottom: 15px;
}

.help-content li {
    margin-bottom: 5px;
}

@media (max-width: 768px) {
    .before-after {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}