{% load wagtailcore_tags wagtailimages_tags %}
{% load static %}

<div class="chooser-page-menu">
    <!-- Botão principal do menu -->
    <div class="menu-toggle" id="chooserPageToggle">
        <span class="menu-title">{{ value.title }}</span>
        <i class="material-icons">keyboard_arrow_down</i>
    </div>

    <!-- Menu dropdown -->
    <div class="menu-dropdown_nav" id="chooserPageDropdown">
        <div class="menu-content">
            <div class="menu-left">
                <h3>Outras Categorias</h3>
                <ul class="parent-pages-list">
                    {% for parent_item in value.parent_pages %}
                        <li class="parent-page-item" data-page-id="{{ parent_item.page.id }}">
                            <a href="{% pageurl parent_item.page %}" class="parent-page-link">
                                {% if parent_item.icon %}
                                    <i class="material-icons">{{ parent_item.icon }}</i>
                                {% endif %}
                                <span>
                                    {% if parent_item.custom_title %}
                                        {{ parent_item.custom_title }}
                                    {% else %}
                                        {{ parent_item.page.title }}
                                    {% endif %}
                                </span>
                                {% if parent_item.page.get_children.live %}
                                    <i class="material-icons arrow">chevron_right</i>
                                {% endif %}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="menu-right">
                <h3 id="childPagesTitle">Páginas Relacionadas</h3>
                <div id="childPagesList" class="child-pages-container">
                    <p class="no-selection">Selecione uma página principal para ver as páginas relacionadas</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chooser-page-menu {
    position: relative;
    display: inline-block;
}

.menu-toggle {
    background: #0066cc;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    border: none;
    font-size: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.menu-toggle:hover {
    background: #0052a3;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.menu-toggle .material-icons {
    transition: transform 0.3s ease;
}

.menu-toggle.active .material-icons {
    transform: rotate(180deg);
}

.menu-dropdown_nav {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    min-width: 600px;
    margin-top: 8px;
}

.menu-dropdown_nav.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.menu-content {
    display: flex;
    min-height: 400px;
}

.menu-left, .menu-right {
    padding: 20px;
    flex: 1;
}

.menu-left {
    border-right: 1px solid #e0e0e0;
    background: #f8f9fa;
    border-radius: 12px 0 0 12px;
}

.menu-right {
    background: white;
    border-radius: 0 12px 12px 0;
}

.menu-left h3, .menu-right h3 {
    margin: 0 0 16px 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
}

.parent-pages-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.parent-page-item {
    margin-bottom: 4px;
}

.parent-page-link {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    text-decoration: none;
    color: #333;
    border-radius: 8px;
    transition: all 0.3s ease;
    gap: 12px;
}

.parent-page-link:hover, .parent-page-link.active {
    background: #e3f2fd;
    color: #0066cc;
    text-decoration: none;
}

.parent-page-link .material-icons:first-child {
    font-size: 20px;
}

.parent-page-link .arrow {
    margin-left: auto;
    font-size: 18px;
    opacity: 0.6;
}

.child-pages-container {
    max-height: 320px;
    overflow-y: auto;
}

.child-pages-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.child-page-item {
    margin-bottom: 8px;
}

.child-page-link {
    display: block;
    text-decoration: none;
    transition: all 0.3s ease;
}

.child-page-title {
    margin-bottom: 4px;
}

.child-page-description {
    font-size: 14px;
    color: #666;
    line-height: 1.4;
}

.no-selection {
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 40px 20px;
    margin: 0;
}

/* Scrollbar customization */
.child-pages-container::-webkit-scrollbar {
    width: 6px;
}

.child-pages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.child-pages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.child-pages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Responsivo */
@media (max-width: 768px) {
    .menu-dropdown_nav {
        min-width: 100vw;
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
    }
    
    .menu-dropdown_nav.active {
        transform: translateX(-50%) translateY(0);
    }
    
    .menu-content {
        flex-direction: column;
        min-height: auto;
    }
    
    .menu-left {
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        border-radius: 12px 12px 0 0;
    }
    
    .menu-right {
        border-radius: 0 0 12px 12px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('chooserPageToggle');
    const dropdown = document.getElementById('chooserPageDropdown');
    const parentLinks = document.querySelectorAll('.parent-page-link');
    const childPagesTitle = document.getElementById('childPagesTitle');
    const childPagesList = document.getElementById('childPagesList');

    // Dados das páginas filhas (isso será preenchido pelo Django)
    const childPagesData = {
        {% for parent_item in value.parent_pages %}
        {{ parent_item.page.id }}: [
            {% for child in parent_item.page.get_children.live %}
            {
                title: "{{ child.title|escapejs }}",
                url: "{% pageurl child %}",
                {% if value.show_child_descriptions and child.search_description %}
                description: "{{ child.search_description|escapejs }}"
                {% endif %}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    // Toggle dropdown
    toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        toggle.classList.toggle('active');
        dropdown.classList.toggle('active');
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!toggle.contains(e.target) && !dropdown.contains(e.target)) {
            toggle.classList.remove('active');
            dropdown.classList.remove('active');
        }
    });

    // Mostrar páginas filhas ao passar mouse ou clicar
    parentLinks.forEach(function(link) {
        link.addEventListener('mouseenter', function() {
            showChildPages(this);
        });
        
        link.addEventListener('click', function(e) {
            // Se tem filhas, previne navegação e mostra filhas
            const pageId = this.parentElement.getAttribute('data-page-id');
            if (childPagesData[pageId] && childPagesData[pageId].length > 0) {
                e.preventDefault();
                showChildPages(this);
            }
        });
    });

    function showChildPages(parentLink) {
        // Remove active de todos os links
        parentLinks.forEach(link => link.classList.remove('active'));
        
        // Adiciona active no link atual
        parentLink.classList.add('active');
        
        const pageId = parentLink.parentElement.getAttribute('data-page-id');
        const childPages = childPagesData[pageId] || [];
        
        // Atualiza título
        const parentTitle = parentLink.querySelector('span').textContent;
        childPagesTitle.textContent = `Páginas de ${parentTitle}`;
        
        // Atualiza lista de filhas
        if (childPages.length > 0) {
            let html = '<ul class="child-pages-list">';
            childPages.slice(0, {{ value.max_child_pages|default:10 }}).forEach(function(child) {
                html += `
                    <li class="child-page-item">
                        <a href="${child.url}" class="child-page-link">
                            <div class="child-page-title">${child.title}</div>
                            ${child.description ? `<div class="child-page-description">${child.description}</div>` : ''}
                        </a>
                    </li>
                `;
            });
            html += '</ul>';
            childPagesList.innerHTML = html;
        } else {
            childPagesList.innerHTML = '<p class="no-selection">Nenhuma página relacionada encontrada</p>';
        }
    }
});
</script>