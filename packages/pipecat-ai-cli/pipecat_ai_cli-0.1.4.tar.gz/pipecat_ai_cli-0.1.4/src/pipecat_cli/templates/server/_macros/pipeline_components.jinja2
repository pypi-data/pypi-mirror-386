{#
Pipeline Component Macros
Reusable pipeline stages that can be composed together
#}

{# Transport input stage #}
{% macro input_stage() %}
        transport.input(),
{% endmacro %}

{# RTVI processor (web bots only) #}
{% macro rtvi_stage(bot_type) %}
{% if bot_type == 'web' %}
        rtvi,
{% endif %}
{% endmacro %}

{# STT stage #}
{% macro stt_stage() %}
        stt,
{% endmacro %}

{# Transcription user stage #}
{% macro transcription_user_stage(transcription) %}
{% if transcription %}
        transcript_processor.user(),
{% endif %}
{% endmacro %}

{# Context aggregator user stage #}
{% macro context_user_stage() %}
        context_aggregator.user(),
{% endmacro %}

{# LLM stage #}
{% macro llm_stage() %}
        llm,
{% endmacro %}

{# TTS stage #}
{% macro tts_stage() %}
        tts,
{% endmacro %}

{# Transport output stage #}
{% macro output_stage() %}
        transport.output(),
{% endmacro %}

{# Transcription assistant stage #}
{% macro transcription_assistant_stage(transcription) %}
{% if transcription %}
        transcript_processor.assistant(),
{% endif %}
{% endmacro %}

{# Recording stage #}
{% macro recording_stage(recording) %}
{% if recording %}
        audio_buffer,
{% endif %}
{% endmacro %}

{# Context aggregator assistant stage #}
{% macro context_assistant_stage() %}
        context_aggregator.assistant(),
{% endmacro %}

{# Complete cascade pipeline assembly #}
{% macro cascade_pipeline(bot_type, transcription, recording) %}
    pipeline = Pipeline([
{{ input_stage() }}
{{ rtvi_stage(bot_type) }}
{{ stt_stage() }}
{{ transcription_user_stage(transcription) }}
{{ context_user_stage() }}
{{ llm_stage() }}
{{ tts_stage() }}
{{ output_stage() }}
{{ transcription_assistant_stage(transcription) }}
{{ recording_stage(recording) }}
{{ context_assistant_stage() }}
    ])
{% endmacro %}

{# Complete realtime pipeline assembly #}
{% macro realtime_pipeline(bot_type, transcription, recording) %}
    pipeline = Pipeline([
{{ input_stage() }}
{{ rtvi_stage(bot_type) }}
{{ context_user_stage() }}
{{ transcription_user_stage(transcription) }}
{{ llm_stage() }}
{{ output_stage() }}
{{ transcription_assistant_stage(transcription) }}
{{ recording_stage(recording) }}
{{ context_assistant_stage() }}
    ])
{% endmacro %}

