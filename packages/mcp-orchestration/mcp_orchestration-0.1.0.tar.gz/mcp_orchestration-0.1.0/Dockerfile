# Multi-stage Dockerfile for mcp-orchestration
# Optimized for production deployment with security best practices
# Generated by chora-base template

# === Builder Stage ===
# Build wheel distribution to avoid import path conflicts
# Inspired by mcp-n8n and chora-compose production deployments
FROM python:3.12-slim as builder

# Set working directory
WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy dependency files first (better layer caching)
COPY pyproject.toml README.md ./

# Copy source code
COPY src/ ./src/

# Build wheel distribution (not editable install)
# This prevents Python path ambiguities and import conflicts
# Pattern from chora-compose: avoids "package vs module" namespace issues
RUN pip install --no-cache-dir --upgrade pip build && \
    python -m build --wheel --outdir /dist

# === Runtime Stage ===
# Minimal image with only runtime dependencies
FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install runtime system dependencies
# MCP servers need git for version control integration
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*
# Create non-root user for security (UID 1000 for compatibility)
RUN useradd -m -u 1000 -s /bin/bash appuser && \
    chown -R appuser:appuser /app

# Install wheel from builder stage
# Pattern from mcp-n8n: cleaner than copying site-packages
COPY --from=builder /dist/*.whl /tmp/
RUN pip install --no-cache-dir /tmp/*.whl && \
    rm -rf /tmp/*.whl

# Copy application code (optional, already in wheel)
# Uncomment if you need source files at runtime
# COPY --chown=appuser:appuser src/ ./src/
COPY --chown=appuser:appuser pyproject.toml README.md ./

# Create directories for MCP server data
RUN mkdir -p /app/logs /app/data && \
    chown -R appuser:appuser /app/logs /app/data

# Environment variables for MCP server
ENV MCP_ORCHESTRATION_LOG_LEVEL=INFO \
    MCP_ORCHESTRATION_LOG_FILE=/app/logs/mcp-orchestration.log \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Expose MCP server port (if using SSE/HTTP transport)
# EXPOSE 8000

# Health check for MCP server
# Import-based pattern from coda-mcp: validates Python env without CLI overhead
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD python -c "import mcp_orchestration; assert mcp_orchestration.__version__" || exit 1

# Switch to non-root user
USER appuser

# Default command: Start MCP server
CMD ["mcp-orchestration"]

# === Build Instructions ===
#
# Standard build:
#   docker build -t mcp-orchestration:latest .
#
# Multi-architecture build (amd64 + arm64):
#   docker buildx build --platform linux/amd64,linux/arm64 \
#     -t mcp-orchestration:latest --load .
#
# With build cache (faster rebuilds):
#   docker build --cache-from mcp-orchestration:latest \
#     -t mcp-orchestration:latest .
#
# === Run Instructions ===
#
# Run MCP server:
#   docker run -d --name mcp-orchestration \
#     -v $(pwd)/logs:/app/logs \
#     -v $(pwd)/data:/app/data \
#     -v $(pwd)/.env:/app/.env:ro \
#     mcp-orchestration:latest
#
# With agent memory (if enabled):
#   docker run -d --name mcp-orchestration \
#     -v $(pwd)/.chora/memory:/app/.chora/memory \
#     -v $(pwd)/.env:/app/.env:ro \
#     mcp-orchestration:latest
#
# === Debugging ===
#
# Interactive shell:
#   docker run -it --rm mcp-orchestration:latest /bin/bash
#
# Check health status:
#   docker inspect --format='{{.State.Health.Status}}' mcp-orchestration
#
# View logs:
#   docker logs -f mcp-orchestration
