#!/bin/bash

# Script to build and run the {{ agent_name }} locally in Docker

set -e  # Exit on error

# Color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Load environment variables from .env if it exists
if [ -f .env ]; then
    echo -e "${BLUE}üìã Loading environment variables from .env file...${NC}"
    set -a  # Export all variables
    source .env
    set +a  # Stop exporting
else
    echo -e "${YELLOW}‚ö†Ô∏è  No .env file found. Using defaults.${NC}"
    echo -e "${YELLOW}   Copy .env.example to .env and configure as needed.${NC}"
fi

# Configuration with defaults
IMAGE_NAME="{{ agent_id }}"
CONTAINER_NAME="{{ agent_id }}-local"
HOST_PORT=${PORT:-8000}
CONTAINER_PORT=${PORT:-8000}

echo -e "${BLUE}üöÄ Building and running {{ agent_name }}...${NC}"
echo -e "${BLUE}   Using port: ${HOST_PORT}${NC}"
echo

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo -e "${RED}‚ùå Docker is not installed. Please install Docker first.${NC}"
    exit 1
fi

# Stop and remove existing container if it exists
if docker ps -a | grep -q $CONTAINER_NAME; then
    echo -e "${YELLOW}üõë Stopping existing container...${NC}"
    docker stop $CONTAINER_NAME >/dev/null 2>&1 || true
    docker rm $CONTAINER_NAME >/dev/null 2>&1 || true
fi

# Build the Docker image
echo -e "${BLUE}üî® Building Docker image...${NC}"
docker build -t $IMAGE_NAME .

# Run the container
echo -e "${BLUE}üèÉ Starting container...${NC}"
docker run -d \
    --name $CONTAINER_NAME \
    -p $HOST_PORT:$CONTAINER_PORT \
    --env-file .env \
    -e DEBUG_PROTOCOL=${DEBUG_PROTOCOL:-false} \
    $IMAGE_NAME

# Wait for the server to start
echo -e "${YELLOW}‚è≥ Waiting for server to start...${NC}"
sleep 3

# Check if container is running
if ! docker ps | grep -q $CONTAINER_NAME; then
    echo -e "${RED}‚ùå Container failed to start. Checking logs:${NC}"
    docker logs $CONTAINER_NAME
    exit 1
fi

# Get container info
CONTAINER_ID=$(docker ps -q -f name=$CONTAINER_NAME)

# Output connection information
echo
echo -e "${GREEN}‚úÖ {{ agent_name }} is running!${NC}"
echo
echo -e "${BLUE}üìç Connection Information:${NC}"
echo -e "   A2A Endpoint:     ${GREEN}http://localhost:${HOST_PORT}/a2a${NC}"
echo -e "   Agent Info:       ${GREEN}http://localhost:${HOST_PORT}/.well-known/agent.json${NC}"
echo -e "   Container Name:   ${GREEN}${CONTAINER_NAME}${NC}"
echo -e "   Container ID:     ${GREEN}${CONTAINER_ID:0:12}${NC}"
echo
echo -e "${BLUE}üìù Useful commands:${NC}"
echo -e "   View logs:        ${YELLOW}docker logs -f ${CONTAINER_NAME}${NC}"
echo -e "   Stop server:      ${YELLOW}docker stop ${CONTAINER_NAME}${NC}"
echo -e "   Remove container: ${YELLOW}docker rm ${CONTAINER_NAME}${NC}"
echo -e "   Shell access:     ${YELLOW}docker exec -it ${CONTAINER_NAME} /bin/bash${NC}"
echo

# Check if the server is responding
echo -e "${YELLOW}üîç Checking server health...${NC}"
if curl -s -o /dev/null -w "%{http_code}" "http://localhost:${HOST_PORT}/.well-known/agent.json" | grep -q "200"; then
    echo -e "${GREEN}‚úÖ Server is healthy!${NC}"
    
    # Get and display agency info
    echo
    echo -e "${BLUE}üìã Agency Information:${NC}"
    curl -s "http://localhost:${HOST_PORT}/.well-known/agent.json" | python -m json.tool || echo "Could not fetch agency info"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Server may still be starting up. Check logs with: docker logs -f ${CONTAINER_NAME}${NC}"
fi 