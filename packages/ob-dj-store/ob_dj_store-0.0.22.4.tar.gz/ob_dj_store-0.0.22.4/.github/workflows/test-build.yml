name: Build & Test

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
        with:
          install: true
          driver: docker

      - name: create docker-compose.local.env
        run: touch docker-compose.local.env

      - name: Build
        run: docker compose up -d

      - name: Test Code Linter
        run: docker compose run --rm app pre-commit run --all-files

      - name: Run test suite
        run: docker compose run --rm app pytest

#      - name: Upload coverage to Codecov
#        uses: codecov/codecov-action@v2
#        with:
#          token: ${{ secrets.CODECOV_TOKEN }}
#          file: ./coverage.xml
#          flags: unittests
#          name: codecov-dj-otp
#          fail_ci_if_error: true
