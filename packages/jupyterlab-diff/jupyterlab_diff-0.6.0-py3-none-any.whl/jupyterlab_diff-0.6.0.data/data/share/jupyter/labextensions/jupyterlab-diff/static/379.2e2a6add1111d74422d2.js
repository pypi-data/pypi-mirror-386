"use strict";(self.webpackChunkjupyterlab_diff=self.webpackChunkjupyterlab_diff||[]).push([[379],{379:(e,t,r)=>{r.r(t),r.d(t,{Change:()=>u,Chunk:()=>Q,MergeView:()=>Oe,acceptChunk:()=>_e,diff:()=>P,getChunks:()=>Z,getOriginalDoc:()=>Fe,goToNextChunk:()=>J,goToPreviousChunk:()=>K,originalDocChangeEffect:()=>Ge,presentableDiff:()=>I,rejectChunk:()=>Ie,uncollapseUnchanged:()=>we,unifiedMergeView:()=>Ve,updateOriginalDoc:()=>Ne});var n=r(24),i=r(195);const o="undefined"==typeof Symbol?"__ͼ":Symbol.for("ͼ"),s="undefined"==typeof Symbol?"__styleSet"+Math.floor(1e8*Math.random()):Symbol("styleSet"),l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};class a{constructor(e,t){this.rules=[];let{finish:r}=t||{};function n(e){return/^@/.test(e)?[e]:e.split(/,\s*/)}function i(e,t,o,s){let l=[],a=/^@(\w+)\b/.exec(e[0]),f=a&&"keyframes"==a[1];if(a&&null==t)return o.push(e[0]+";");for(let r in t){let s=t[r];if(/&/.test(r))i(r.split(/,\s*/).map((t=>e.map((e=>t.replace(/&/,e))))).reduce(((e,t)=>e.concat(t))),s,o);else if(s&&"object"==typeof s){if(!a)throw new RangeError("The value of a property ("+r+") should be a primitive value.");i(n(r),s,l,f)}else null!=s&&l.push(r.replace(/_.*/,"").replace(/[A-Z]/g,(e=>"-"+e.toLowerCase()))+": "+s+";")}(l.length||f)&&o.push((!r||a||s?e:e.map(r)).join(", ")+" {"+l.join(" ")+"}")}for(let t in e)i(n(t),e[t],this.rules)}getRules(){return this.rules.join("\n")}static newName(){let e=l[o]||1;return l[o]=e+1,"ͼ"+e.toString(36)}static mount(e,t,r){let n=e[s],i=r&&r.nonce;n?i&&n.setNonce(i):n=new c(e,i),n.mount(Array.isArray(t)?t:[t],e)}}let f=new Map;class c{constructor(e,t){let r=e.ownerDocument||e,n=r.defaultView;if(!e.head&&e.adoptedStyleSheets&&n.CSSStyleSheet){let t=f.get(r);if(t)return e[s]=t;this.sheet=new n.CSSStyleSheet,f.set(r,this)}else this.styleTag=r.createElement("style"),t&&this.styleTag.setAttribute("nonce",t);this.modules=[],e[s]=this}mount(e,t){let r=this.sheet,n=0,i=0;for(let t=0;t<e.length;t++){let o=e[t],s=this.modules.indexOf(o);if(s<i&&s>-1&&(this.modules.splice(s,1),i--,s=-1),-1==s){if(this.modules.splice(i++,0,o),r)for(let e=0;e<o.rules.length;e++)r.insertRule(o.rules[e],n++)}else{for(;i<s;)n+=this.modules[i++].rules.length;n+=o.rules.length,i++}}if(r)t.adoptedStyleSheets.indexOf(this.sheet)<0&&(t.adoptedStyleSheets=[this.sheet,...t.adoptedStyleSheets]);else{let e="";for(let t=0;t<this.modules.length;t++)e+=this.modules[t].getRules()+"\n";this.styleTag.textContent=e;let r=t.head||t;this.styleTag.parentNode!=r&&r.insertBefore(this.styleTag,r.firstChild)}}setNonce(e){this.styleTag&&this.styleTag.getAttribute("nonce")!=e&&this.styleTag.setAttribute("nonce",e)}}var d=r(84),h=r(839);class u{constructor(e,t,r,n){this.fromA=e,this.toA=t,this.fromB=r,this.toB=n}offset(e,t=e){return new u(this.fromA+e,this.toA+e,this.fromB+t,this.toB+t)}}function m(e,t,r,n,i,o){if(e==n)return[];let s=k(e,t,r,n,i,o),l=x(e,t+s,r,n,i+s,o),a=(r-=l)-(t+=s),f=(o-=l)-(i+=s);if(!a||!f)return[new u(t,r,i,o)];if(a>f){let s=e.slice(t,r).indexOf(n.slice(i,o));if(s>-1)return[new u(t,t+s,i,i),new u(t+s+f,r,o,o)]}else if(f>a){let s=n.slice(i,o).indexOf(e.slice(t,r));if(s>-1)return[new u(t,t,i,i+s),new u(r,r,i+s+a,o)]}if(1==a||1==f)return[new u(t,r,i,o)];let c=D(e,t,r,n,i,o);if(c){let[s,l,a]=c;return m(e,t,s,n,i,l).concat(m(e,s+a,r,n,l+a,o))}return function(e,t,r,n,i,o){let s=r-t,l=o-i;if(g<1e9&&Math.min(s,l)>16*g||p>0&&Date.now()>p)return Math.min(s,l)>64*g?[new u(t,r,i,o)]:S(e,t,r,n,i,o);let a=Math.ceil((s+l)/2);b.reset(a),B.reset(a);let f=(r,o)=>e.charCodeAt(t+r)==n.charCodeAt(i+o),c=(t,i)=>e.charCodeAt(r-t-1)==n.charCodeAt(o-i-1),d=(s-l)%2!=0?B:null,h=d?null:b;for(let u=0;u<a;u++){if(u>g||p>0&&!(63&u)&&Date.now()>p)return S(e,t,r,n,i,o);let m=b.advance(u,s,l,a,d,!1,f)||B.advance(u,s,l,a,h,!0,c);if(m)return w(e,t,r,t+m[0],n,i,o,i+m[1])}return[new u(t,r,i,o)]}(e,t,r,n,i,o)}let g=1e9,p=0,A=!1;class v{constructor(){this.vec=[]}reset(e){this.len=e<<1;for(let e=0;e<this.len;e++)this.vec[e]=-1;this.vec[e+1]=0,this.start=this.end=0}advance(e,t,r,n,i,o,s){for(let l=-e+this.start;l<=e-this.end;l+=2){let a=n+l,f=l==-e||l!=e&&this.vec[a-1]<this.vec[a+1]?this.vec[a+1]:this.vec[a-1]+1,c=f-l;for(;f<t&&c<r&&s(f,c);)f++,c++;if(this.vec[a]=f,f>t)this.end+=2;else if(c>r)this.start+=2;else if(i){let e=n+(t-r)-l;if(e>=0&&e<this.len&&-1!=i.vec[e])if(o){let r=i.vec[e];if(r>=t-f)return[r,n+r-e]}else if(f>=t-i.vec[e])return[f,c]}}return null}}const b=new v,B=new v;function w(e,t,r,n,i,o,s,l){let a=!1;return U(e,n)||++n!=r||(a=!0),U(i,l)||++l!=s||(a=!0),a?[new u(t,r,o,s)]:m(e,t,n,i,o,l).concat(m(e,n,r,i,l,s))}function C(e,t){let r=1,n=Math.min(e,t);for(;r<n;)r<<=1;return r}function k(e,t,r,n,i,o){if(t==r||t==o||e.charCodeAt(t)!=n.charCodeAt(i))return 0;let s=C(r-t,o-i);for(let l=t,a=i;;){let i=l+s,f=a+s;if(i>r||f>o||e.slice(l,i)!=n.slice(a,f)){if(1==s)return l-t-(U(e,l)?0:1);s>>=1}else{if(i==r||f==o)return i-t;l=i,a=f}}}function x(e,t,r,n,i,o){if(t==r||i==o||e.charCodeAt(r-1)!=n.charCodeAt(o-1))return 0;let s=C(r-t,o-i);for(let l=r,a=o;;){let o=l-s,f=a-s;if(o<t||f<i||e.slice(o,l)!=n.slice(f,a)){if(1==s)return r-l-(U(e,l)?0:1);s>>=1}else{if(o==t||f==i)return r-o;l=o,a=f}}}function M(e,t,r,n,i,o,s,l){let a=n.slice(i,o),f=null;for(;;){if(f||s<l)return f;for(let l=t+s;;){U(e,l)||l++;let c=l+s;if(U(e,c)||(c+=c==l+1?1:-1),c>=r)break;let d=e.slice(l,c),h=-1;for(;-1!=(h=a.indexOf(d,h+1));){let s=k(e,c,r,n,i+h+d.length,o),a=x(e,t,l,n,i,i+h),u=d.length+s+a;(!f||f[2]<u)&&(f=[l-a,i+h-a,u])}l=c}if(l<0)return f;s>>=1}}function D(e,t,r,n,i,o){let s=r-t,l=o-i;if(s<l){let s=D(n,i,o,e,t,r);return s&&[s[1],s[0],s[2]]}return s<4||2*l<s?null:M(e,t,r,n,i,o,Math.floor(s/4),-1)}function S(e,t,r,n,i,o){A=!0;let s,l=r-t,a=o-i;if(l<a){let a=M(n,i,o,e,t,r,Math.floor(l/6),50);s=a&&[a[1],a[0],a[2]]}else s=M(e,t,r,n,i,o,Math.floor(a/6),50);if(!s)return[new u(t,r,i,o)];let[f,c,d]=s;return m(e,t,f,n,i,c).concat(m(e,f+d,r,n,c+d,o))}function y(e,t){for(let r=1;r<e.length;r++){let n=e[r-1],i=e[r];n.toA>i.fromA-t&&n.toB>i.fromB-t&&(e[r-1]=new u(n.fromA,i.toA,n.fromB,i.toB),e.splice(r--,1))}}let E;try{E=new RegExp("[\\p{Alphabetic}\\p{Number}]","u")}catch(e){}function O(e){return e>48&&e<58||e>64&&e<91||e>96&&e<123}function T(e,t){if(t==e.length)return 0;let r=e.charCodeAt(t);return r<192?O(r)?1:0:E?F(r)&&t!=e.length-1?E.test(e.slice(t,t+2))?2:0:E.test(String.fromCharCode(r))?1:0:0}function L(e,t){if(!t)return 0;let r=e.charCodeAt(t-1);return r<192?O(r)?1:0:E?H(r)&&1!=t?E.test(e.slice(t-2,t))?2:0:E.test(String.fromCharCode(r))?1:0:0}const R=8;function V(e,t,r){if(t==e.length||!L(e,t))return t;for(let n=t,i=t+r,o=0;o<R;o++){let t=T(e,n);if(!t||n+t>i)return n;n+=t}return t}function N(e,t,r){if(!t||!T(e,t))return t;for(let n=t,i=t-r,o=0;o<R;o++){let t=L(e,n);if(!t||n-t<i)return n;n-=t}return t}function G(e,t,r){for(;t!=r;t--)if(10==e.charCodeAt(t-1))return t;return-1}function j(e,t,r){for(;t!=r;t++)if(10==e.charCodeAt(t))return t;return-1}const F=e=>e>=55296&&e<=56319,H=e=>e>=56320&&e<=57343;function U(e,t){return!t||t==e.length||!F(e.charCodeAt(t-1))||!H(e.charCodeAt(t))}function P(e,t,r){var n;return g=(null!==(n=null==r?void 0:r.scanLimit)&&void 0!==n?n:1e9)>>1,p=(null==r?void 0:r.timeout)?Date.now()+r.timeout:0,A=!1,function(e,t,r){for(;;){y(r,1);let n=!1;for(let i=0;i<r.length;i++){let o,s,l=r[i];(o=k(e,l.fromA,l.toA,t,l.fromB,l.toB))&&(l=r[i]=new u(l.fromA+o,l.toA,l.fromB+o,l.toB)),(s=x(e,l.fromA,l.toA,t,l.fromB,l.toB))&&(l=r[i]=new u(l.fromA,l.toA-s,l.fromB,l.toB-s));let a=l.toA-l.fromA,f=l.toB-l.fromB;if(a&&f)continue;let c=l.fromA-(i?r[i-1].toA:0),d=(i<r.length-1?r[i+1].fromA:e.length)-l.toA;if(!c||!d)continue;let h=a?e.slice(l.fromA,l.toA):t.slice(l.fromB,l.toB);c<=h.length&&e.slice(l.fromA-c,l.fromA)==h.slice(h.length-c)?(r[i]=new u(l.fromA-c,l.toA-c,l.fromB-c,l.toB-c),n=!0):d<=h.length&&e.slice(l.toA,l.toA+d)==h.slice(0,d)&&(r[i]=new u(l.fromA+d,l.toA+d,l.fromB+d,l.toB+d),n=!0)}if(!n)break}return r}(e,t,m(e,0,e.length,t,0,t.length))}function _(){return!A}function I(e,t,r){return function(e,t,r){for(let n=0,i=0;i<e.length;i++){let o=e[i],s=o.toA-o.fromA,l=o.toB-o.fromB;if(s&&l||s>3||l>3){let a=i==e.length-1?t.length:e[i+1].fromA,f=o.fromA-n,c=a-o.toA,d=N(t,o.fromA,f),h=V(t,o.toA,c),m=o.fromA-d,g=h-o.toA;if((!s||!l)&&m&&g){let f=Math.max(s,l),[c,p,A]=s?[t,o.fromA,o.toA]:[r,o.fromB,o.toB];f>m&&t.slice(d,o.fromA)==c.slice(A-m,A)?(o=e[i]=new u(d,d+s,o.fromB-m,o.toB-m),d=o.fromA,h=V(t,o.toA,a-o.toA)):f>g&&t.slice(o.toA,h)==c.slice(p,p+g)&&(o=e[i]=new u(h-s,h,o.fromB+g,o.toB+g),h=o.toA,d=N(t,o.fromA,o.fromA-n)),m=o.fromA-d,g=h-o.toA}if(m||g)o=e[i]=new u(o.fromA-m,o.toA+g,o.fromB-m,o.toB+g);else if(s){if(!l){let r,n=j(t,o.fromA,o.toA),s=n<0?-1:G(t,o.toA,o.fromA);n>-1&&(r=n-o.fromA)<=c&&t.slice(o.fromA,n)==t.slice(o.toA,o.toA+r)?o=e[i]=o.offset(r):s>-1&&(r=o.toA-s)<=f&&t.slice(o.fromA-r,o.fromA)==t.slice(s,o.toA)&&(o=e[i]=o.offset(-r))}}else{let t,n=j(r,o.fromB,o.toB),s=n<0?-1:G(r,o.toB,o.fromB);n>-1&&(t=n-o.fromB)<=c&&r.slice(o.fromB,n)==r.slice(o.toB,o.toB+t)?o=e[i]=o.offset(t):s>-1&&(t=o.toB-s)<=f&&r.slice(o.fromB-t,o.fromB)==r.slice(s,o.toB)&&(o=e[i]=o.offset(-t))}}n=o.toA}return y(e,3),e}(P(e,t,r),e,t)}const W=i.Facet.define({combine:e=>e[0]}),q=i.StateEffect.define(),z=i.Facet.define(),Y=i.StateField.define({create:e=>null,update(e,t){for(let r of t.effects)r.is(q)&&(e=r.value);for(let r of t.state.facet(z))e=r(e,t);return e}});function Z(e){let t=e.field(Y,!1);if(!t)return null;let r=e.facet(W);return{chunks:t,side:r?r.side:null}}let $=e=>({state:t,dispatch:r})=>{let o=t.field(Y,!1),s=t.facet(W);if(!o||!o.length||!s)return!1;let{head:l}=t.selection.main,a=0;for(let t=o.length-1;t>=0;t--){let r=o[t],[n,i]="b"==s.side?[r.fromB,r.toB]:[r.fromA,r.toA];if(i<l){a=t+1;break}if(n<=l){if(1==o.length)return!1;a=t+(e<0?0:1);break}}let f=o[(a+(e<0?o.length-1:0))%o.length],[c,d]="b"==s.side?[f.fromB,f.toB]:[f.fromA,f.toA];return r(t.update({selection:{anchor:c},userEvent:"select.byChunk",effects:n.EditorView.scrollIntoView(i.EditorSelection.range(d,c))})),!0};const J=$(1),K=$(-1);class Q{constructor(e,t,r,n,i,o=!0){this.changes=e,this.fromA=t,this.toA=r,this.fromB=n,this.toB=i,this.precise=o}offset(e,t){return e||t?new Q(this.changes,this.fromA+e,this.toA+e,this.fromB+t,this.toB+t,this.precise):this}get endA(){return Math.max(this.fromA,this.toA-1)}get endB(){return Math.max(this.fromB,this.toB-1)}static build(e,t,r){return te(I(e.toString(),t.toString(),r),e,t,0,0,_())}static updateA(e,t,r,n,i){return oe(ie(e,n,!0,r.length),e,t,r,i)}static updateB(e,t,r,n,i){return oe(ie(e,n,!1,t.length),e,t,r,i)}}function X(e,t,r,n){let i=r.lineAt(e),o=n.lineAt(t);return i.to==e&&o.to==t&&e<r.length&&t<n.length?[e+1,t+1]:[i.from,o.from]}function ee(e,t,r,n){let i=r.lineAt(e),o=n.lineAt(t);return i.from==e&&o.from==t?[e,t]:[i.to+1,o.to+1]}function te(e,t,r,n,i,o){let s=[];for(let l=0;l<e.length;l++){let a=e[l],[f,c]=X(a.fromA+n,a.fromB+i,t,r),[d,h]=ee(a.toA+n,a.toB+i,t,r),u=[a.offset(-f+n,-c+i)];for(;l<e.length-1;){let o=e[l+1],[s,a]=X(o.fromA+n,o.fromB+i,t,r);if(s>d+1&&a>h+1)break;u.push(o.offset(-f+n,-c+i)),[d,h]=ee(o.toA+n,o.toB+i,t,r),l++}s.push(new Q(u,f,Math.max(f,d),c,Math.max(c,h),o))}return s}const re=1e3;function ne(e,t,r,n){let i=0,o=e.length;for(;;){if(i==o){let n=0,o=0;i&&({toA:n,toB:o}=e[i-1]);let s=t-(r?n:o);return[n+s,o+s]}let s=i+o>>1,l=e[s],[a,f]=r?[l.fromA,l.toA]:[l.fromB,l.toB];if(a>t)o=s;else{if(!(f<=t))return n?[l.fromA,l.fromB]:[l.toA,l.toB];i=s+1}}}function ie(e,t,r,n){let i=[];return t.iterChangedRanges(((o,s,l,a)=>{let f=0,c=r?t.length:n,d=0,h=r?n:t.length;o>re&&([f,d]=ne(e,o-re,r,!0)),s<t.length-re&&([c,h]=ne(e,s+re,r,!1));let u,m=a-l-(s-o),[g,p]=r?[m,0]:[0,m];i.length&&(u=i[i.length-1]).toA>=f?i[i.length-1]={fromA:u.fromA,fromB:u.fromB,toA:c,toB:h,diffA:u.diffA+g,diffB:u.diffB+p}:i.push({fromA:f,toA:c,fromB:d,toB:h,diffA:g,diffB:p})})),i}function oe(e,t,r,n,i){if(!e.length)return t;let o=[];for(let s=0,l=0,a=0,f=0;;s++){let c=s==e.length?null:e[s],d=c?c.fromA+l:r.length,h=c?c.fromB+a:n.length;for(;f<t.length;){let e=t[f];if(e.toA+l>d||e.toB+a>h)break;o.push(e.offset(l,a)),f++}if(!c)break;let u=c.toA+l+c.diffA,m=c.toB+a+c.diffB,g=I(r.sliceString(d,u),n.sliceString(h,m),i);for(let e of te(g,r,n,d,h,_()))o.push(e);for(l+=c.diffA,a+=c.diffB;f<t.length;){let e=t[f];if(e.fromA+l>u&&e.fromB+a>m)break;f++}}return o}const se={scanLimit:500},le=n.ViewPlugin.fromClass(class{constructor(e){({deco:this.deco,gutter:this.gutter}=ge(e))}update(e){var t,r;(e.docChanged||e.viewportChanged||(t=e.startState,r=e.state,t.field(Y,!1)!=r.field(Y,!1))||function(e,t){return e.facet(W)!=t.facet(W)}(e.startState,e.state))&&({deco:this.deco,gutter:this.gutter}=ge(e.view))}},{decorations:e=>e.deco}),ae=i.Prec.low((0,n.gutter)({class:"cm-changeGutter",markers:e=>{var t;return(null===(t=e.plugin(le))||void 0===t?void 0:t.gutter)||i.RangeSet.empty}})),fe=n.Decoration.line({class:"cm-changedLine"}),ce=n.Decoration.mark({class:"cm-changedText"}),de=n.Decoration.mark({tagName:"ins",class:"cm-insertedLine"}),he=n.Decoration.mark({tagName:"del",class:"cm-deletedLine"}),ue=new class extends n.GutterMarker{constructor(){super(...arguments),this.elementClass="cm-changedLineGutter"}};function me(e,t,r,n,i,o){let s=r?e.fromA:e.fromB,l=r?e.toA:e.toB,a=0;if(s!=l){i.add(s,s,fe),i.add(s,l,r?he:de),o&&o.add(s,s,ue);for(let f=t.iterRange(s,l-1),c=s;!f.next().done;){if(f.lineBreak){c++,i.add(c,c,fe),o&&o.add(c,c,ue);continue}let t=c+f.value.length;if(n)for(;a<e.changes.length;){let n=e.changes[a],o=s+(r?n.fromA:n.fromB),l=s+(r?n.toA:n.toB),f=Math.max(c,o),d=Math.min(t,l);if(f<d&&i.add(f,d,ce),!(l<t))break;a++}c=t}}}function ge(e){let t=e.state.field(Y),{side:r,highlightChanges:n,markGutter:o,overrideChunk:s}=e.state.facet(W),l="a"==r,a=new i.RangeSetBuilder,f=o?new i.RangeSetBuilder:null,{from:c,to:d}=e.viewport;for(let r of t){if((l?r.fromA:r.fromB)>=d)break;(l?r.toA:r.toB)>c&&(s&&s(e.state,r,a,f)||me(r,e.state.doc,l,n,a,f))}return{deco:a.finish(),gutter:f&&f.finish()}}class pe extends n.WidgetType{constructor(e){super(),this.height=e}eq(e){return this.height==e.height}toDOM(){let e=document.createElement("div");return e.className="cm-mergeSpacer",e.style.height=this.height+"px",e}updateDOM(e){return e.style.height=this.height+"px",!0}get estimatedHeight(){return this.height}ignoreEvent(){return!1}}const Ae=i.StateEffect.define({map:(e,t)=>e.map(t)}),ve=i.StateField.define({create:()=>n.Decoration.none,update:(e,t)=>{for(let e of t.effects)if(e.is(Ae))return e.value;return e.map(t.changes)},provide:e=>n.EditorView.decorations.from(e)}),be=.01;function Be(e,t){if(e.size!=t.size)return!1;let r=e.iter(),n=t.iter();for(;r.value;){if(r.from!=n.from||Math.abs(r.value.spec.widget.height-n.value.spec.widget.height)>1)return!1;r.next(),n.next()}return!0}const we=i.StateEffect.define({map:(e,t)=>t.mapPos(e)});class Ce extends n.WidgetType{constructor(e){super(),this.lines=e}eq(e){return this.lines==e.lines}toDOM(e){let t=document.createElement("div");return t.className="cm-collapsedLines",t.textContent=e.state.phrase("$ unchanged lines",this.lines),t.addEventListener("click",(t=>{let r=e.posAtDOM(t.target);e.dispatch({effects:we.of(r)});let{side:n,sibling:i}=e.state.facet(W);i&&i().dispatch({effects:we.of(ke(r,e.state.field(Y),"a"==n))})})),t}ignoreEvent(e){return e instanceof MouseEvent}get estimatedHeight(){return 27}get type(){return"collapsed-unchanged-code"}}function ke(e,t,r){let n=0,i=0;for(let o=0;;o++){let s=o<t.length?t[o]:null;if(!s||(r?s.fromA:s.fromB)>=e)return i+(e-n);[n,i]=r?[s.toA,s.toB]:[s.toB,s.toA]}}const xe=i.StateField.define({create:e=>n.Decoration.none,update(e,t){e=e.map(t.changes);for(let r of t.effects)r.is(we)&&(e=e.update({filter:e=>e!=r.value}));return e},provide:e=>n.EditorView.decorations.from(e)});function Me({margin:e=3,minSize:t=4}){return xe.init((r=>function(e,t,r){let o=new i.RangeSetBuilder,s="a"==e.facet(W).side,l=e.field(Y),a=1;for(let i=0;;i++){let f=i<l.length?l[i]:null,c=i?a+t:1,d=f?e.doc.lineAt(s?f.fromA:f.fromB).number-1-t:e.doc.lines,h=d-c+1;if(h>=r&&o.add(e.doc.line(c).from,e.doc.line(d).to,n.Decoration.replace({widget:new Ce(h),block:!0})),!f)break;a=e.doc.lineAt(Math.min(e.doc.length,s?f.toA:f.toB)).number}return o.finish()}(r,e,t)))}const De=n.EditorView.styleModule.of(new a({".cm-mergeView":{overflowY:"auto"},".cm-mergeViewEditors":{display:"flex",alignItems:"stretch"},".cm-mergeViewEditor":{flexGrow:1,flexBasis:0,overflow:"hidden"},".cm-merge-revert":{width:"1.6em",flexGrow:0,flexShrink:0,position:"relative"},".cm-merge-revert button":{position:"absolute",display:"block",width:"100%",boxSizing:"border-box",textAlign:"center",background:"none",border:"none",font:"inherit",cursor:"pointer"}})),Se=n.EditorView.baseTheme({".cm-mergeView & .cm-scroller, .cm-mergeView &":{height:"auto !important",overflowY:"visible !important"},"&.cm-merge-a .cm-changedLine, .cm-deletedChunk":{backgroundColor:"rgba(160, 128, 100, .08)"},"&.cm-merge-b .cm-changedLine, .cm-inlineChangedLine":{backgroundColor:"rgba(100, 160, 128, .08)"},"&light.cm-merge-a .cm-changedText, &light .cm-deletedChunk .cm-deletedText":{background:"linear-gradient(#ee443366, #ee443366) bottom/100% 2px no-repeat"},"&dark.cm-merge-a .cm-changedText, &dark .cm-deletedChunk .cm-deletedText":{background:"linear-gradient(#ffaa9966, #ffaa9966) bottom/100% 2px no-repeat"},"&light.cm-merge-b .cm-changedText":{background:"linear-gradient(#22bb22aa, #22bb22aa) bottom/100% 2px no-repeat"},"&dark.cm-merge-b .cm-changedText":{background:"linear-gradient(#88ff88aa, #88ff88aa) bottom/100% 2px no-repeat"},"&.cm-merge-b .cm-deletedText":{background:"#ff000033"},".cm-insertedLine, .cm-deletedLine, .cm-deletedLine del":{textDecoration:"none"},".cm-deletedChunk":{paddingLeft:"6px","& .cm-chunkButtons":{position:"absolute",insetInlineEnd:"5px"},"& button":{border:"none",cursor:"pointer",color:"white",margin:"0 2px",borderRadius:"3px","&[name=accept]":{background:"#2a2"},"&[name=reject]":{background:"#d43"}}},".cm-collapsedLines":{padding:"5px 5px 5px 10px",cursor:"pointer","&:before":{content:'"⦚"',marginInlineEnd:"7px"},"&:after":{content:'"⦚"',marginInlineStart:"7px"}},"&light .cm-collapsedLines":{color:"#444",background:"linear-gradient(to bottom, transparent 0, #f3f3f3 30%, #f3f3f3 70%, transparent 100%)"},"&dark .cm-collapsedLines":{color:"#ddd",background:"linear-gradient(to bottom, transparent 0, #222 30%, #222 70%, transparent 100%)"},".cm-changeGutter":{width:"3px",paddingLeft:"1px"},"&light.cm-merge-a .cm-changedLineGutter, &light .cm-deletedLineGutter":{background:"#e43"},"&dark.cm-merge-a .cm-changedLineGutter, &dark .cm-deletedLineGutter":{background:"#fa9"},"&light.cm-merge-b .cm-changedLineGutter":{background:"#2b2"},"&dark.cm-merge-b .cm-changedLineGutter":{background:"#8f8"},".cm-inlineChangedLineGutter":{background:"#75d"}}),ye=new i.Compartment,Ee=new i.Compartment;class Oe{constructor(e){this.revertDOM=null,this.revertToA=!1,this.revertToLeft=!1,this.measuring=-1,this.diffConf=e.diffConfig||se;let t=[i.Prec.low(le),Se,De,ve,n.EditorView.updateListener.of((e=>{this.measuring<0&&(e.heightChanged||e.viewportChanged)&&!e.transactions.some((e=>e.effects.some((e=>e.is(Ae)))))&&this.measure()}))],r=[W.of({side:"a",sibling:()=>this.b,highlightChanges:!1!==e.highlightChanges,markGutter:!1!==e.gutter})];!1!==e.gutter&&r.push(ae);let o=i.EditorState.create({doc:e.a.doc,selection:e.a.selection,extensions:[e.a.extensions||[],n.EditorView.editorAttributes.of({class:"cm-merge-a"}),Ee.of(r),t]}),s=[W.of({side:"b",sibling:()=>this.a,highlightChanges:!1!==e.highlightChanges,markGutter:!1!==e.gutter})];!1!==e.gutter&&s.push(ae);let l=i.EditorState.create({doc:e.b.doc,selection:e.b.selection,extensions:[e.b.extensions||[],n.EditorView.editorAttributes.of({class:"cm-merge-b"}),Ee.of(s),t]});this.chunks=Q.build(o.doc,l.doc,this.diffConf);let a=[Y.init((()=>this.chunks)),ye.of(e.collapseUnchanged?Me(e.collapseUnchanged):[])];o=o.update({effects:i.StateEffect.appendConfig.of(a)}).state,l=l.update({effects:i.StateEffect.appendConfig.of(a)}).state,this.dom=document.createElement("div"),this.dom.className="cm-mergeView",this.editorDOM=this.dom.appendChild(document.createElement("div")),this.editorDOM.className="cm-mergeViewEditors";let f=e.orientation||"a-b",c=document.createElement("div");c.className="cm-mergeViewEditor";let d=document.createElement("div");d.className="cm-mergeViewEditor",this.editorDOM.appendChild("a-b"==f?c:d),this.editorDOM.appendChild("a-b"==f?d:c),this.a=new n.EditorView({state:o,parent:c,root:e.root,dispatchTransactions:e=>this.dispatch(e,this.a)}),this.b=new n.EditorView({state:l,parent:d,root:e.root,dispatchTransactions:e=>this.dispatch(e,this.b)}),this.setupRevertControls(!!e.revertControls,"b-to-a"==e.revertControls,e.renderRevertControl),e.parent&&e.parent.appendChild(this.dom),this.scheduleMeasure()}dispatch(e,t){if(e.some((e=>e.docChanged))){let r=e[e.length-1],n=e.reduce(((e,t)=>e.compose(t.changes)),i.ChangeSet.empty(e[0].startState.doc.length));this.chunks=t==this.a?Q.updateA(this.chunks,r.newDoc,this.b.state.doc,n,this.diffConf):Q.updateB(this.chunks,this.a.state.doc,r.newDoc,n,this.diffConf),t.update([...e,r.state.update({effects:q.of(this.chunks)})]);let o=t==this.a?this.b:this.a;o.update([o.state.update({effects:q.of(this.chunks)})]),this.scheduleMeasure()}else t.update(e)}reconfigure(e){if("diffConfig"in e&&(this.diffConf=e.diffConfig),"orientation"in e){let t="b-a"!=e.orientation;if(t!=(this.editorDOM.firstChild==this.a.dom.parentNode)){let e=this.a.dom.parentNode,r=this.b.dom.parentNode;e.remove(),r.remove(),this.editorDOM.insertBefore(t?e:r,this.editorDOM.firstChild),this.editorDOM.appendChild(t?r:e),this.revertToLeft=!this.revertToLeft,this.revertDOM&&(this.revertDOM.textContent="")}}if("revertControls"in e||"renderRevertControl"in e){let t=!!this.revertDOM,r=this.revertToA,n=this.renderRevert;"revertControls"in e&&(t=!!e.revertControls,r="b-to-a"==e.revertControls),"renderRevertControl"in e&&(n=e.renderRevertControl),this.setupRevertControls(t,r,n)}let t="highlightChanges"in e,r="gutter"in e,n="collapseUnchanged"in e;if(t||r||n){let i=[],o=[];if(t||r){let n=this.a.state.facet(W),s=r?!1!==e.gutter:n.markGutter,l=t?!1!==e.highlightChanges:n.highlightChanges;i.push(Ee.reconfigure([W.of({side:"a",sibling:()=>this.b,highlightChanges:l,markGutter:s}),s?ae:[]])),o.push(Ee.reconfigure([W.of({side:"b",sibling:()=>this.a,highlightChanges:l,markGutter:s}),s?ae:[]]))}if(n){let t=ye.reconfigure(e.collapseUnchanged?Me(e.collapseUnchanged):[]);i.push(t),o.push(t)}this.a.dispatch({effects:i}),this.b.dispatch({effects:o})}this.scheduleMeasure()}setupRevertControls(e,t,r){this.revertToA=t,this.revertToLeft=this.revertToA==(this.editorDOM.firstChild==this.a.dom.parentNode),this.renderRevert=r,!e&&this.revertDOM?(this.revertDOM.remove(),this.revertDOM=null):e&&!this.revertDOM?(this.revertDOM=this.editorDOM.insertBefore(document.createElement("div"),this.editorDOM.firstChild.nextSibling),this.revertDOM.addEventListener("mousedown",(e=>this.revertClicked(e))),this.revertDOM.className="cm-merge-revert"):this.revertDOM&&(this.revertDOM.textContent="")}scheduleMeasure(){if(this.measuring<0){let e=this.dom.ownerDocument.defaultView||window;this.measuring=e.requestAnimationFrame((()=>{this.measuring=-1,this.measure()}))}}measure(){!function(e,t,r){let o=new i.RangeSetBuilder,s=new i.RangeSetBuilder,l=e.state.field(ve).iter(),a=t.state.field(ve).iter(),f=0,c=0,d=0,h=0,u=e.viewport,m=t.viewport;for(let i=0;;i++){let g=i<r.length?r[i]:null,p=g?g.fromA:e.state.doc.length,A=g?g.fromB:t.state.doc.length;if(f<p){let r=e.lineBlockAt(f).top+d-(t.lineBlockAt(c).top+h);r<-.01?(d-=r,o.add(f,f,n.Decoration.widget({widget:new pe(-r),block:!0,side:-1}))):r>be&&(h+=r,s.add(c,c,n.Decoration.widget({widget:new pe(r),block:!0,side:-1})))}if(p>f+1e3&&f<u.from&&p>u.from&&c<m.from&&A>m.from){let e=Math.min(u.from-f,m.from-c);f+=e,c+=e,i--}else{if(!g)break;f=g.toA,c=g.toB}for(;l.value&&l.from<f;)d-=l.value.spec.widget.height,l.next();for(;a.value&&a.from<c;)h-=a.value.spec.widget.height,a.next()}for(;l.value;)d-=l.value.spec.widget.height,l.next();for(;a.value;)h-=a.value.spec.widget.height,a.next();let g=e.contentHeight+d-(t.contentHeight+h);g<be?o.add(e.state.doc.length,e.state.doc.length,n.Decoration.widget({widget:new pe(-g),block:!0,side:1})):g>be&&s.add(t.state.doc.length,t.state.doc.length,n.Decoration.widget({widget:new pe(g),block:!0,side:1}));let p=o.finish(),A=s.finish();Be(p,e.state.field(ve))||e.dispatch({effects:Ae.of(p)}),Be(A,t.state.field(ve))||t.dispatch({effects:Ae.of(A)})}(this.a,this.b,this.chunks),this.revertDOM&&this.updateRevertButtons()}updateRevertButtons(){let e=this.revertDOM,t=e.firstChild,r=this.a.viewport,n=this.b.viewport;for(let i=0;i<this.chunks.length;i++){let o=this.chunks[i];if(o.fromA>r.to||o.fromB>n.to)break;if(o.fromA<r.from||o.fromB<n.from)continue;let s=this.a.lineBlockAt(o.fromA).top+"px";for(;t&&+t.dataset.chunk<i;)t=Te(t);t&&t.dataset.chunk==String(i)?(t.style.top!=s&&(t.style.top=s),t=t.nextSibling):e.insertBefore(this.renderRevertButton(s,i),t)}for(;t;)t=Te(t)}renderRevertButton(e,t){let r;if(this.renderRevert)r=this.renderRevert();else{r=document.createElement("button");let e=this.a.state.phrase("Revert this chunk");r.setAttribute("aria-label",e),r.setAttribute("title",e),r.textContent=this.revertToLeft?"⇜":"⇝"}return r.style.top=e,r.setAttribute("data-chunk",String(t)),r}revertClicked(e){let t,r=e.target;for(;r&&r.parentNode!=this.revertDOM;)r=r.parentNode;if(r&&(t=this.chunks[r.dataset.chunk])){let[r,n,i,o,s,l]=this.revertToA?[this.b,this.a,t.fromB,t.toB,t.fromA,t.toA]:[this.a,this.b,t.fromA,t.toA,t.fromB,t.toB],a=r.state.sliceDoc(i,Math.max(i,o-1));i!=o&&l<=n.state.doc.length&&(a+=r.state.lineBreak),n.dispatch({changes:{from:s,to:Math.min(n.state.doc.length,l),insert:a},userEvent:"revert"}),e.preventDefault()}}destroy(){this.a.destroy(),this.b.destroy(),this.measuring>-1&&(this.dom.ownerDocument.defaultView||window).cancelAnimationFrame(this.measuring),this.dom.remove()}}function Te(e){let t=e.nextSibling;return e.remove(),t}const Le=new class extends n.GutterMarker{constructor(){super(...arguments),this.elementClass="cm-deletedLineGutter"}},Re=i.Prec.low((0,n.gutter)({class:"cm-changeGutter",markers:e=>{var t;return(null===(t=e.plugin(le))||void 0===t?void 0:t.gutter)||i.RangeSet.empty},widgetMarker:(e,t)=>t instanceof Ue?Le:null}));function Ve(e){var t;let r="string"==typeof e.original?i.Text.of(e.original.split(/\r?\n/)):e.original,o=e.diffConfig||se;return[i.Prec.low(le),qe,Se,n.EditorView.editorAttributes.of({class:"cm-merge-b"}),z.of(((e,t)=>{let r=t.effects.find((e=>e.is(Ne)));return r&&(e=Q.updateA(e,r.value.doc,t.startState.doc,r.value.changes,o)),t.docChanged&&(e=Q.updateB(e,t.state.field(je),t.newDoc,t.changes,o)),e})),W.of({highlightChanges:!1!==e.highlightChanges,markGutter:!1!==e.gutter,syntaxHighlightDeletions:!1!==e.syntaxHighlightDeletions,syntaxHighlightDeletionsMaxLength:3e3,mergeControls:null===(t=e.mergeControls)||void 0===t||t,overrideChunk:e.allowInlineDiffs?Ke:void 0,side:"b"}),je.init((()=>r)),!1!==e.gutter?Re:[],e.collapseUnchanged?Me(e.collapseUnchanged):[],Y.init((e=>Q.build(r,e.doc,o)))]}const Ne=i.StateEffect.define();function Ge(e,t){return Ne.of({doc:t.apply(Fe(e)),changes:t})}const je=i.StateField.define({create:()=>i.Text.empty,update(e,t){for(let r of t.effects)r.is(Ne)&&(e=r.value.doc);return e}});function Fe(e){return e.field(je)}const He=new WeakMap;class Ue extends n.WidgetType{constructor(e){super(),this.buildDOM=e,this.dom=null}eq(e){return this.dom==e.dom}toDOM(e){return this.dom||(this.dom=this.buildDOM(e))}}function Pe(e,t,r){let i=He.get(t.changes);if(i)return i;let o=n.Decoration.widget({block:!0,side:-1,widget:new Ue((n=>{let{highlightChanges:i,syntaxHighlightDeletions:o,syntaxHighlightDeletionsMaxLength:s,mergeControls:l}=e.facet(W),a=document.createElement("div");if(a.className="cm-deletedChunk",l){let t=a.appendChild(document.createElement("div"));t.className="cm-chunkButtons";let r=e=>{e.preventDefault(),_e(n,n.posAtDOM(a))},i=e=>{e.preventDefault(),Ie(n,n.posAtDOM(a))};if("function"==typeof l)t.appendChild(l("accept",r)),t.appendChild(l("reject",i));else{let n=t.appendChild(document.createElement("button"));n.name="accept",n.textContent=e.phrase("Accept"),n.onmousedown=r;let o=t.appendChild(document.createElement("button"));o.name="reject",o.textContent=e.phrase("Reject"),o.onmousedown=i}}if(r||t.fromA>=t.toA)return a;let f=n.state.field(je).sliceString(t.fromA,t.endA),c=o&&e.facet(d.language),u=A(),m=t.changes,g=0,p=!1;function A(){let e=a.appendChild(document.createElement("div"));return e.className="cm-deletedLine",e.appendChild(document.createElement("del"))}function v(e,t,r){for(let n=e;n<t;){if("\n"==f.charAt(n)){u.firstChild||u.appendChild(document.createElement("br")),u=A(),n++;continue}let e=t,o=r+(p?" cm-deletedText":""),s=!1,l=f.indexOf("\n",n);if(l>-1&&l<t&&(e=l),i&&g<m.length){let t=Math.max(0,p?m[g].toA:m[g].fromA);t<=e&&(e=t,p&&g++,s=!0)}if(e>n){let t=document.createTextNode(f.slice(n,e));if(o){let e=u.appendChild(document.createElement("span"));e.className=o,e.appendChild(t)}else u.appendChild(t);n=e}s&&(p=!p)}}if(c&&t.toA-t.fromA<=s){let t=c.parser.parse(f),r=0;(0,h.highlightTree)(t,{style:t=>(0,d.highlightingFor)(e,t)},((e,t,n)=>{e>r&&v(r,e,""),v(e,t,n),r=t})),v(r,f.length,"")}else v(0,f.length,"");return u.firstChild||u.appendChild(document.createElement("br")),a}))});return He.set(t.changes,o),o}function _e(e,t){let{state:r}=e,n=null!=t?t:r.selection.main.head,o=e.state.field(Y).find((e=>e.fromB<=n&&e.endB>=n));if(!o)return!1;let s=e.state.sliceDoc(o.fromB,Math.max(o.fromB,o.toB-1)),l=e.state.field(je);o.fromB!=o.toB&&o.toA<=l.length&&(s+=e.state.lineBreak);let a=i.ChangeSet.of({from:o.fromA,to:Math.min(l.length,o.toA),insert:s},l.length);return e.dispatch({effects:Ne.of({doc:a.apply(l),changes:a}),userEvent:"accept"}),!0}function Ie(e,t){let{state:r}=e,n=null!=t?t:r.selection.main.head,i=r.field(Y).find((e=>e.fromB<=n&&e.endB>=n));if(!i)return!1;let o=r.field(je).sliceString(i.fromA,Math.max(i.fromA,i.toA-1));return i.fromA!=i.toA&&i.toB<=r.doc.length&&(o+=r.lineBreak),e.dispatch({changes:{from:i.fromB,to:Math.min(r.doc.length,i.toB),insert:o},userEvent:"revert"}),!0}function We(e){let t=new i.RangeSetBuilder;for(let r of e.field(Y)){let n=e.facet(W).overrideChunk&&Ye(e,r);t.add(r.fromB,r.fromB,Pe(e,r,!!n))}return t.finish()}const qe=i.StateField.define({create:e=>We(e),update:(e,t)=>t.state.field(Y,!1)!=t.startState.field(Y,!1)?We(t.state):e,provide:e=>n.EditorView.decorations.from(e)}),ze=new WeakMap;function Ye(e,t){let r=ze.get(t);if(void 0!==r)return r;r=null;let i=e.field(je),o=e.doc,s=i.lineAt(t.endA).number-i.lineAt(t.fromA).number+1;e:if(s==o.lineAt(t.endB).number-o.lineAt(t.fromB).number+1&&s<10){let e=[],o=0,l=t.fromA,a=t.fromB;for(let r of t.changes){if(r.fromA<r.toA){o+=r.toA-r.fromA;let t=i.sliceString(l+r.fromA,l+r.toA);if(/\n/.test(t))break e;e.push(n.Decoration.widget({widget:new Ze(t),side:-1}).range(a+r.fromB))}r.fromB<r.toB&&e.push(ce.range(a+r.fromB,a+r.toB))}o<t.endA-t.fromA-2*s&&(r=e)}return ze.set(t,r),r}class Ze extends n.WidgetType{constructor(e){super(),this.text=e}eq(e){return this.text==e.text}toDOM(e){let t=document.createElement("del");return t.className="cm-deletedText",t.textContent=this.text,t}}const $e=new class extends n.GutterMarker{constructor(){super(...arguments),this.elementClass="cm-inlineChangedLineGutter"}},Je=n.Decoration.line({class:"cm-inlineChangedLine"});function Ke(e,t,r,n){let i=Ye(e,t),o=0;if(!i)return!1;for(let s=e.doc.lineAt(t.fromB);;){for(n&&n.add(s.from,s.from,$e),r.add(s.from,s.from,Je);o<i.length&&i[o].to<=s.to;){let e=i[o++];r.add(e.from,e.to,e.value)}if(s.to>=t.endB)break;s=e.doc.lineAt(s.to+1)}return!0}}}]);