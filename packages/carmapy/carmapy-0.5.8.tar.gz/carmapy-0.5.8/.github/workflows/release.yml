name: Build and release CARMApy

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # os: [ubuntu-latest, ubuntu-24.04-arm, windows-latest, windows-11-arm, macos-15-intel, macos-14]
        os: [ubuntu-latest, ubuntu-24.04-arm, windows-latest, windows-11-arm, macos-14]

    steps:
      # Checkout repo and submodules
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: true

      - name: Set macOS deployment target
        if: startsWith(matrix.os, 'macos')
        run: echo "MACOSX_DEPLOYMENT_TARGET=14.0" >> $GITHUB_ENV

      # Install gfortran on macOS
      - name: Install gfortran (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install gcc
          # Get full path to gfortran
          GFORTRAN="$(brew --prefix gcc)/bin/gfortran"
          echo "GFORTRAN=$GFORTRAN" >> $GITHUB_ENV
          echo "$(brew --prefix gcc)/bin" >> $GITHUB_PATH
          $GFORTRAN --version

      # Install gfortran on Ubuntu
      - name: Install gfortran (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran
          gfortran --version

      # Build wheels
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.2.1
        env:
          FC: ${{ env.GFORTRAN }}

      # Upload wheels
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  make_sdist:
    name: Make SDist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: true

      - name: Install gfortran
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran
          gfortran --version

      - name: Build SDist
        run: pipx run build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-sdist
          path: dist/*.tar.gz

  upload_all:
    needs: [build_wheels, make_sdist]
    environment: pypi
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v5
        with:
          pattern: cibw-*
          path: dist
          merge-multiple: true

      - uses: pypa/gh-action-pypi-publish@release/v1
