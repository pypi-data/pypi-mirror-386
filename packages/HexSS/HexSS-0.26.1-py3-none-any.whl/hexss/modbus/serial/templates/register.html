<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robot Register Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <style>
        body {
            background: #f7f7f7;
        }
        .register-table th, .register-table td {
            text-align: center;
            vertical-align: middle;
        }
        .register-section {
            margin-bottom: 2rem;
        }
        .address-text {
            font-size: 0.95em;
            color: #888;
        }
        .tg { border-collapse: collapse; width: 100%; }
        .tg th, .tg td { border: 1px solid #ccc; text-align: center; padding: 0.25em; }
        .tg th { background: #f8f9fa; font-size: 0.95em; }
        .tg .green { background: #d4edda; color: #155724; font-weight: bold; }
        .tg .red { background: #f8d7da; color: #721c24; }
        .tg .gray { background: #e9ecef; color: #888; }
    </style>
</head>
<body>
{% include "header.html" %}
<div class="container my-4">
    <h1 class="mb-4">Robot Register Monitor</h1>
    <div class="mb-3">
        <label for="slaveSelect" class="form-label">Select Slave:</label>
        <select id="slaveSelect" class="form-select" style="width: auto; display: inline-block;">
            {% for i in range(num_slaves) %}
            <option value="{{ i }}">Slave {{ i }}</option>
            {% endfor %}
        </select>
        <span id="connectionStatus" class="ms-3 badge bg-secondary">Connecting...</span>
    </div>
    <div id="registerDisplay">
        <div class="alert alert-info">Loading register data...</div>
    </div>
</div>

<script>
    function renderBitfieldTable(reg) {
        let bits = [];
        let maxBit = 15;
        for (let i = maxBit; i >= 0; i--) {
            let sig = null;
            if (reg.signals && reg.signals.hasOwnProperty(String(i))) {
                sig = reg.signals[String(i)];
            }
            bits.push({
                bit: i,
                symbol: sig ? sig.symbol : "-",
                value: sig ? sig.value : null
            });
        }
        let ths = bits.map(b => `<th>${b.bit}</th>`).join('');
        let trs = bits.map(b => `<td>${b.symbol}</td>`).join('');
        let vals = bits.map(b => {
            if (b.value === 1) return `<td class="green">1</td>`;
            if (b.value === 0) return `<td class="red">0</td>`;
            return `<td class="gray">-</td>`;
        }).join('');
        return `
        <div class="pt-2">
          <table class="tg">
            <thead><tr>${ths}</tr></thead>
            <tbody>
              <tr>${trs}</tr>
              <tr>${vals}</tr>
            </tbody>
          </table>
        </div>
        `;
    }

    function renderMultiWordBitfieldTable(reg) {
        function makeTable(startBit, endBit) {
            let bits = [];
            for (let i = startBit; i >= endBit; i--) {
                let sig = reg.signals && reg.signals.hasOwnProperty(String(i)) ? reg.signals[String(i)] : null;
                bits.push({
                    bit: i,
                    symbol: sig ? sig.symbol : "-",
                    value: sig ? sig.value : null
                });
            }
            let ths = bits.map(b => `<th>${b.bit}</th>`).join('');
            let trs = bits.map(b => `<td>${b.symbol}</td>`).join('');
            let vals = bits.map(b => {
                if (b.value === 1) return `<td class="green">1</td>`;
                if (b.value === 0) return `<td class="red">0</td>`;
                return `<td class="gray">-</td>`;
            }).join('');
            return `
            <div class="pt-2">
              <table class="tg">
                <thead><tr>${ths}</tr></thead>
                <tbody>
                  <tr>${trs}</tr>
                  <tr>${vals}</tr>
                </tbody>
              </table>
            </div>
            `;
        }
        return makeTable(31, 16) + makeTable(15, 0);
    }

    function registerTable(registers) {
        let html = "";
        for (const [symbol, reg] of Object.entries(registers)) {
            html += `<div class="register-section card mb-3">
                        <div class="card-header register-title">
                            <strong>${reg.symbol} - ${reg.name}</strong>
                            <span class="address-text ms-2">(Address: ${reg.address.map(a => "0x" + a.toString(16).padStart(4, "0")).join(", ")})</span>
                        </div>
                        <div class="card-body">
                            <div class="mb-2"><strong>Value:</strong> <span class="badge bg-dark">${reg.val !== null ? reg.val : "N/A"}</span></div>`;

            if (
                reg.signals &&
                Object.keys(reg.signals).length > 0 &&
                reg.address.length === 2 &&
                Math.max(...Object.keys(reg.signals).map(Number)) >= 16
            ) {
                html += renderMultiWordBitfieldTable(reg);
            }
            else if (reg.signals && Object.keys(reg.signals).length > 0) {
                html += renderBitfieldTable(reg);
            }

            html += `</div></div>`;
        }
        return html;
    }

    let eventSource = null;
    let lastData = null;

    function updateDisplay(data) {
        let slaveSelect = document.getElementById('slaveSelect');
        let slaveKey = "Slave " + slaveSelect.value;
        let regData = data[slaveKey];
        if (!regData) {
            document.getElementById('registerDisplay').innerHTML = `<div class="alert alert-warning">No data for ${slaveKey}</div>`;
            return;
        }
        document.getElementById('registerDisplay').innerHTML = registerTable(regData);
    }

    function connectEventSource() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        lastData = null;
        const slave = document.getElementById('slaveSelect').value;
        document.getElementById('connectionStatus').textContent = "Connecting...";
        document.getElementById('connectionStatus').className = "ms-3 badge bg-secondary";
        document.getElementById('registerDisplay').innerHTML = `<div class="alert alert-info">Loading register data...</div>`;

        eventSource = new EventSource(`/api/socket/register?slave=${slave}`);
        eventSource.onopen = function() {
            document.getElementById('connectionStatus').textContent = "Connected";
            document.getElementById('connectionStatus').className = "ms-3 badge bg-success";
        };
        eventSource.onerror = function() {
            document.getElementById('connectionStatus').textContent = "Disconnected";
            document.getElementById('connectionStatus').className = "ms-3 badge bg-danger";
        };
        eventSource.onmessage = function(e) {
            try {
                if (e.data && e.data !== lastData) {
                    lastData = e.data;
                    let data = JSON.parse(e.data);
                    updateDisplay(data);
                }
            } catch (ex) {
                document.getElementById('registerDisplay').innerHTML = `<div class="alert alert-danger">Error parsing data: ${ex}<br><pre>${e.data}</pre></div>`;
            }
        };
    }

    document.getElementById('slaveSelect').addEventListener('change', function() {
        connectEventSource();
    });

    // Initial load
    connectEventSource();
</script>
</body>
</html>