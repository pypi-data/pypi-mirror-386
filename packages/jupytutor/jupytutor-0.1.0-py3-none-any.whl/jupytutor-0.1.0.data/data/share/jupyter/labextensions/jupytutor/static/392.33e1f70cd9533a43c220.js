/*! For license information please see 392.33e1f70cd9533a43c220.js.LICENSE.txt */
"use strict";(self.webpackChunkjupytutor=self.webpackChunkjupytutor||[]).push([[392],{20:(e,t,s)=>{var n=s(345),o=Symbol.for("react.element"),r=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),a=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,s){var n,l={},c=null,u=null;for(n in void 0!==s&&(c=""+s),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(u=t.ref),t)r.call(t,n)&&!i.hasOwnProperty(n)&&(l[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===l[n]&&(l[n]=t[n]);return{$$typeof:o,type:e,key:c,ref:u,props:l,_owner:a.current}}t.jsx=l,t.jsxs=l},296:(e,t,s)=>{s.d(t,{A:()=>u});var n=s(551),o=s.n(n),r=s(992),a=s.n(r),i=s(965),l=s(594),c=a()(o());c.i(i.A),c.i(l.A),c.push([e.id,"\n",""]);const u=c},392:(e,t,s)=>{s.r(t),s.d(t,{DEMO_PRINTS:()=>z,default:()=>G});var n=s(762),o=s(345),r=s(848),a=s(986);const i={api:{baseURL:"http://localhost:3000/"},usage:{show_on_success:!0,show_on_free_response:!0,automatic_first_query_on_error:!0,use_streaming:!0},context_gathering:{enabled:!0,whitelist:["inferentialthinking.com"],blacklist:["data8.org","berkeley.edu","gradescope.com"],jupyterbook:{url:"inferentialthinking.com",link_expansion:!0}},keywords:{free_response_regex:/.*question\s+\d+(?:\.\d+)*\.\s+.*\(?\d+\s+points\)?.*/i,success_regex:/.* passed!.*/i},instructor_note:""},l=i.api.baseURL;var c=s(318),u=s.n(c),d=s(879),p=s.n(d),h=s(237),m=s.n(h),g=s(862),f=s.n(g),x=s(50),y=s.n(x),k=s(495),v=s.n(k),w=s(296),b={};b.styleTagTransform=v(),b.setAttributes=f(),b.insert=m().bind(null,"head"),b.domAPI=p(),b.insertStyleElement=y(),u()(w.A,b),w.A&&w.A.locals&&w.A.locals;var _=s(375);const L="The following input after this is an aggregation of potentially relevant resources to the assignment.\n\n Keep in mind, some are relevant to each particular question, some are not. Each different source is started with its url surrounded by the tokens [LINK] and [/LINK] (e.g. [LINK]https://www.data8.org/[LINK]). You should attempt to cite these source labels when you use the source contents in your response, formatted as link HTML tags. This should function to encourage student agency and help to not reveal answers directly.",T=class{constructor({sourceLinks:e=[],whitelistedURLs:t=[],blacklistedURLs:s=["data8.org","berkeley.edu","gradescope.com"],jupyterbookURL:n="inferentialthinking.com",attemptJupyterbookLinkExpansion:o=!1,debug:r=!1}={}){this._context=null,this._sourceLinks=e,this._blacklistedURLs=s,this._whitelistedURLs=t,this._loaded=!1,r||(o?this._expandJupyterBookLinksAsync(n):this.scrapeSourceLinks())}async scrapeSourceLinks(){if(0===this._sourceLinks.length)return this._context=null,void(this._loaded=!0);const e=e=>this._blacklistedURLs.some(t=>e.includes(t)),t=e=>this._whitelistedURLs.some(t=>e.includes(t));this._whitelistedURLs.length>0&&(this._sourceLinks=this._sourceLinks.filter(e=>t(e))),this._blacklistedURLs.length>0&&(this._sourceLinks=this._sourceLinks.filter(t=>!e(t)));const s=(await Promise.all(this._sourceLinks.map(async e=>await(async(e,t=e=>e)=>{try{const s=await fetch(t(e));if(!s.ok)return 404===s.status||console.log(`HTTP ${s.status}: ${s.statusText}`),null;const n=await s.text(),o=await(async e=>{try{return(0,_.convert)(e,{wordwrap:!1,selectors:[{selector:"script",format:"skip"},{selector:"style",format:"skip"},{selector:"nav",format:"skip"},{selector:"header",format:"skip"},{selector:"footer",format:"skip"},{selector:"aside",format:"skip"},{selector:".navbar",format:"skip"},{selector:".navigation",format:"skip"},{selector:".sidebar",format:"skip"},{selector:".toc",format:"skip"},{selector:".table-of-contents",format:"skip"},{selector:".breadcrumb",format:"skip"},{selector:".pagination",format:"skip"},{selector:".social-share",format:"skip"},{selector:".comments",format:"skip"},{selector:".advertisement",format:"skip"},{selector:".ads",format:"skip"},{selector:".ad",format:"skip"},{selector:".sponsor",format:"skip"},{selector:".menu",format:"skip"},{selector:".navigation-menu",format:"skip"},{selector:".site-header",format:"skip"},{selector:".site-footer",format:"skip"}],baseElements:{selectors:["main",".main-content","#main",".content","body"]}})}catch(t){return console.warn("Error converting HTML to text:",t),e}})(n);return`[LINK] ${e} [/LINK]\n${o}`}catch(e){return e instanceof Error&&(e.message.includes("404")||e.message.includes("Not Found"))||console.error(`Error scraping page text: ${e}`),null}})(e)))).filter(e=>null!==e).join("\n\n");this._context=s||"",""===this._context&&(this._context=null),this._loaded=!0}getContext(){if(this._loaded){if(null===this._context)return console.error("Context does not lead to any detected resource text."),null}else console.error("Context still loading.");return this._context}getSourceLinks(){return this._sourceLinks}async _expandJupyterBookLinksAsync(e){try{this._sourceLinks=await this.expandJupyterBookLinks(this._sourceLinks,e)}catch(e){console.warn("Failed to expand JupyterBook links:",e)}this.scrapeSourceLinks()}async expandJupyterBookLinks(e,t){const s=e.filter(e=>e.includes(t)).map(async e=>{try{return await this.findJupyterBookLinks(e,t)}catch(t){return console.warn(`Failed to expand links for ${e}:`,t),[]}}),n=await Promise.all(s),o=[],r=new Set;let a=0;for(let s=0;s<e.length;s++){const i=e[s];if(i.includes(t)){const e=this.normalizeUrl(i);r.has(e)||(o.push(i),r.add(e));const t=(n[a]||[]).filter(t=>{const s=this.normalizeUrl(t);return s!==e&&!r.has(s)});t.sort((e,t)=>{const s=new URL(e).pathname,n=new URL(t).pathname,o=s.match(/\/chapters\/(\d+)(?:\/(\d+))?/),r=n.match(/\/chapters\/(\d+)(?:\/(\d+))?/);if(o&&r){const e=parseInt(o[1]),t=parseInt(r[1]),s=o[2]?parseInt(o[2]):0,n=r[2]?parseInt(r[2]):0;return e!==t?e-t:s-n}return s.localeCompare(n)});for(const e of t){const t=this.normalizeUrl(e);r.has(t)||(o.push(e),r.add(t))}a++}else{const e=this.normalizeUrl(i);r.has(e)||(o.push(i),r.add(e))}}return o}normalizeUrl(e){try{const t=new URL(e);return t.hash="",t.pathname.length>1&&t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1)),t.href}catch(t){return e}}async findJupyterBookLinks(e,t){try{const s=await fetch(e);if(!s.ok)return[];const n=await s.text(),o=[],r=new URL(e).pathname,a=r.match(/\/chapters\/(\d+)/),i=r.match(/\/chapters\/(\d+)\/(\d+)/);let l=null,c=null;i?(l=i[1],c=i[2]):a&&(l=a[1]);const u=/<a[^>]+href\s*=\s*["']([^"']+)["'][^>]*>/gi;let d;for(;null!==(d=u.exec(n));){const s=d[1];if(!s)continue;if(s.includes(".ipynb")||s.includes("mybinder")||s.includes("datahub")||s.includes("_sources")||s.includes("_static")||s.includes("_images"))continue;let n;if(n=s.startsWith("/")?new URL(s,e).href:s.startsWith("http")?s:new URL(s,e).href,n.includes(t)){const e=this.normalizeUrl(n),t=new URL(e).pathname;this.isChapterSectionLink(t,l,c)&&o.push(e)}}const p=[...new Set(o)];return this.sortChapterSectionLinks(p,l,c)}catch(t){return console.warn(`Error finding JupyterBook links for ${e}:`,t),[]}}isChapterSectionLink(e,t,s){if(e.includes("/_sources/")||e.includes("/_static/")||e.includes("/_images/")||e.endsWith(".ipynb")||e.endsWith(".pdf")||e.endsWith(".zip")||e.endsWith(".tar.gz"))return!1;if(!e.includes("/chapters/"))return!1;const n=e.match(/\/chapters\/(\d+)/);if(s){if(n&&n[1]===t)return!0}else if(t&&n&&n[1]===t)return!0;return!1}sortChapterSectionLinks(e,t,s){return e.sort((e,t)=>{const s=new URL(e).pathname,n=new URL(t).pathname,o=s.match(/\/chapters\/(\d+)/),r=s.match(/\/chapters\/(\d+)\/(\d+)/),a=n.match(/\/chapters\/(\d+)/),i=n.match(/\/chapters\/(\d+)\/(\d+)/),l=o?parseInt(o[1]):0,c=r?parseInt(r[2]):0,u=a?parseInt(a[1]):0,d=i?parseInt(i[2]):0;return l!==u?l-u:c!==d?c-d:s.localeCompare(n)})}},j=e=>{const t=/<a\s+href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi,s=[];let n,o=0;for(;null!==(n=t.exec(e));){n.index>o&&s.push((0,r.jsx)("span",{children:e.slice(o,n.index)},`text-${o}`));const t=n[1],a=n[2];s.push((0,r.jsx)("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"assistant-link",children:a},`link-${n.index}`)),o=n.index+n[0].length}return o<e.length&&s.push((0,r.jsx)("span",{children:e.slice(o)},`text-${o}`)),s.length>0?s:[(0,r.jsx)("span",{children:e},"text")]},E=e=>{const[t,s]=(0,o.useState)(""),n=(0,o.useRef)(null),a=(0,o.useRef)(!1),c=(0,o.useRef)([]),[u,d]=(0,o.useState)(null),{sendTextbookWithRequest:p,contextRetriever:h,cellType:m,userId:g}=e,[f,x]=(0,o.useState)([]),[y,k]=(0,o.useState)(!1);(0,o.useEffect)(()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},[f]),(0,o.useEffect)(()=>{n.current&&u&&(n.current.scrollTop=n.current.scrollHeight)},[u]),(0,o.useEffect)(()=>{z&&console.log("Chat history changed:",f)},[f]);const v=(e,t="file")=>{try{if(!e.startsWith("data:"))return z&&console.warn('Invalid data URL: must start with "data:"',e),null;const[s,n]=e.split(",");if(!n)return z&&console.warn("Invalid data URL: missing base64 data",e),null;const o=s.match(/data:([^;]+)/),r=o?o[1]:"application/octet-stream";if(!r.startsWith("image/"))return z&&console.warn(`Unexpected MIME type: ${r}, expected image/*`,e),null;const a=atob(n),i=new Array(a.length);for(let e=0;e<a.length;e++)i[e]=a.charCodeAt(e);const l=new Uint8Array(i),c=new File([l],t,{type:r});return z&&console.log(`Created file: ${t}, type: ${r}, size: ${c.size} bytes`),c}catch(t){throw console.error("Error converting data URL to File:",t),console.error("Data URL preview:",e.substring(0,100)+"..."),new Error(`Invalid data URL format: ${t instanceof Error?t.message:String(t)}`)}},w=async(n,o=i.usage.use_streaming)=>{var r;const u=""===t&&!n,y=0===f.length;if(u&&!y)return;let w=n||t,_=[...f];if(u)w="This is my current attempt at the question. Focus on providing concise and accurate feedback that promotes understanding.";else{const e={role:"user",content:w};_=[..._,e],x(_)}k(!0);const T=((t,s,n=5)=>{const o=[];for(let n=e.activeIndex;n>Math.max(0,e.activeIndex-s);n--){const e=t[n];if(e.images.length>0&&"code"===e.type&&o.push(...e.images),e.images.length>0&&"code"!==e.type){o.push(...e.images);break}}return o.slice(0,n)})(e.allCells,10,5);z&&T.length>0&&console.log("First image preview:",T[0].substring(0,100)+"...");try{a.current||(c.current=(()=>{const t=e.allCells.filter(e=>e.images.length>0||""!==e.text||null!=e.text||null!=e.outputText),s=t.findIndex(t=>t.index===e.activeIndex);let n;switch(e.notebookContext){case"whole":n=t;break;case"upToGrader":n=t.slice(0,Math.max(0,s+1));break;case"fiveAround":n=t.slice(Math.max(0,s-5),Math.min(t.length,s+5));break;case"tenAround":n=t.slice(Math.max(0,s-10),Math.min(t.length,s+10));break;case"none":n=[t[s]]}return(e=>{let t=[];if(p&&null!=h){const e=h.getContext();t=[{role:"system",content:[{text:L,type:"input_text"}],noShow:!0},{role:"system",content:[{text:e||"",type:"input_text"}],noShow:!0}],z&&console.log("Sending textbook with request")}else z&&console.log("NOT sending textbook with request");const s=e.map(e=>""!==e.outputText&&null!=e.outputText&&"code"===e.type||"grader"===e.type?{role:"system",content:[{text:e.text+"\nThe above code produced the following output:\n"+e.outputText,type:"input_text"}],noShow:!0}:"free_response"===e.type?(z&&console.log("Sending free response prompt with request!"),{role:"system",content:[{text:"The following is the student's response to the free response question directly above: [response start]"+e.text+"\n[response over]. Provide concise feedback on the response with a focus on accuracy and understanding.",type:"input_text"}],noShow:!0}):{role:"system",content:[{text:e.text,type:"input_text"}],noShow:!0});return[...t,...s]})(n)})());const t=a.current?_.slice(0,-1):[...c.current,..._],s=T.map((e,t)=>{let s="image.png";try{const[n]=e.split(","),o=n.match(/data:([^;]+)/);if(o){const e=o[1];s=`image_${t}.${"image/png"===e?"png":"image/jpeg"===e?"jpg":"image/gif"===e?"gif":"png"}`}}catch(e){console.warn("Could not extract filename from image:",e),s=`image_${t}.png`}return{name:s,file:v(e,s)}});if(o){d("");const e=new FormData;e.append("chatHistory",JSON.stringify(t)),e.append("images",JSON.stringify(T)),e.append("newMessage",w),e.append("currentChatHistory",JSON.stringify(_)),e.append("cellType",m),e.append("userId",g||""),s.filter(e=>e.file instanceof File).forEach(t=>{t.file&&e.append(t.name,t.file)});const n=await fetch(`${i.api.baseURL}interaction/stream`,{method:"POST",body:e,mode:"cors",credentials:"include",cache:"no-cache"});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=null===(r=n.body)||void 0===r?void 0:r.getReader();if(!o)throw new Error("No response body reader available");const a=new TextDecoder;let l="",c="";try{for(;;){const{done:e,value:t}=await o.read();if(e)break;l+=a.decode(t,{stream:!0});const s=l.split("\n");l=s.pop()||"";for(const e of s)if(""!==e.trim()&&e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));if("message_delta"===t.type)c+=t.content,d(c);else if("final_response"===t.type){b(t.data,u,w),d(null);break}}catch(t){console.warn("Failed to parse SSE data:",t,"Line:",e)}}}finally{o.releaseLock()}}else{const e=await async function(e,t={}){const{data:s={},files:n=[],headers:o={},authToken:r=null,method:a="POST",baseURL:i=l}=t;try{const t={...o};r&&(t.Authorization=`Bearer ${r}`);let l=null;(n.length>0||Object.keys(s).length>0)&&(l=function(e={},t=[]){const s=new FormData;Object.keys(e).forEach(t=>{null!==e[t]&&void 0!==e[t]&&("object"==typeof e[t]?s.append(t,JSON.stringify(e[t])):s.append(t,e[t]))});for(const e of t)e.file&&e.name&&(e.file instanceof File?s.append(e.name,e.file):console.warn("Invalid file object:",e.file,"Expected File object (browser environment only)"));return s}(s,n));const c={method:a.toUpperCase(),headers:t,body:l,mode:"cors",credentials:"include",cache:"no-cache"};"GET"===a.toUpperCase()&&delete c.body,z&&console.log("API Request:",{url:`${i}${e}`,method:c.method,headers:c.headers,body:l instanceof FormData?"FormData":l});const u=await fetch(`${i}${e}`,c);if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);let d;const p=u.headers.get("content-type");return d=p&&p.includes("application/json")?await u.json():await u.text(),{success:!0,data:d,status:u.status,headers:u.headers}}catch(e){return{success:!1,error:e.message,status:null}}}("interaction",{method:"POST",data:{chatHistory:t,images:T,newMessage:w,currentChatHistory:_,cellType:m,userId:g||""},files:s.filter(e=>e.file instanceof File)});e.success?b(e.data,u,w):(console.error("API request failed:",e.error),y&&i.usage.automatic_first_query_on_error||x(e=>e.slice(0,-1)))}}catch(e){console.error("API request failed:",e),x(e=>e.slice(0,-1))}k(!1),s("")},b=(e,t,s)=>{if(null==e?void 0:e.newChatHistory){z&&console.log("Server returned newChatHistory:",e.newChatHistory);let n=e.newChatHistory;if(z&&console.log("finalChatHistory",n,"firstQuery",t),t){const e=n.length-3;e>=0&&e<n.length&&n[e]&&(n[e].noShow=!0),n=n.map(e=>{if("user"===(null==e?void 0:e.role)){let t;if("string"==typeof e.content?t=e.content:Array.isArray(e.content)&&e.content.length>0&&e.content[0]&&"string"==typeof e.content[0].text&&(t=e.content[0].text),t===s)return{...e,noShow:!0}}return e})}x(n),a.current||(a.current=!0)}else{z&&console.log("Chat history not send, appending as fallback",e);const t={role:"assistant",content:(null==e?void 0:e.response)||"I apologize, but I encountered an issue processing your request."},n={role:"user",content:s};x(e=>[...e,n,t])}};(0,o.useEffect)(()=>{i.usage.automatic_first_query_on_error&&"grader"===m&&0===f.length&&(w(),s("Generating analysis..."))},[]);const _=(0,o.useMemo)(()=>{let e;return e="grader"===m?[{id:"error",text:"Explain this error."},{id:"source",text:"Provide a concise list of important review materials."},{id:"progress",text:"What progress have I made so far?"}]:"free_response"===m?[{id:"evaluate",text:"Evaluate my answer."}]:"success"===m?[{id:"clarify",text:"I still don't feel confident in my answer."},{id:"source_success",text:"Provide me three important review materials."},{id:"improvements",text:"Can I make further improvements?"}]:[],e},[m]);return(0,r.jsxs)("div",{className:"jupytutor "+(y?"loading":""),children:[(0,r.jsxs)("div",{className:"chat-container",ref:n,children:[f.filter(e=>!e.noShow).map((e,t)=>{const s="string"==typeof e.content?e.content:e.content[0].text,n="user"===e.role;return(0,r.jsxs)("div",{className:"chat-message-wrapper",children:[(0,r.jsx)("div",{className:"chat-sender-label "+(n?"user":"assistant"),children:n?"You":"JupyTutor"}),n?(0,r.jsx)(S,{message:s,position:"right"}):(0,r.jsx)(N,{message:s,streaming:i.usage.use_streaming?"streamed":"none"})]},t)}),u&&(0,r.jsxs)("div",{className:"chat-message-wrapper",children:[(0,r.jsx)("div",{className:"chat-sender-label assistant",children:"JupyTutor"}),(0,r.jsxs)("div",{className:"streaming-message",children:[(0,r.jsx)(N,{message:u,streaming:"streaming"}),(0,r.jsx)("div",{className:"streaming-indicator",children:(0,r.jsxs)("div",{className:"typing-dots",children:[(0,r.jsx)("span",{}),(0,r.jsx)("span",{}),(0,r.jsx)("span",{})]})})]})]})]}),_.length>0&&(0,r.jsx)(C,{options:_,callSuggestion:e=>{y||(s(e),w(e))},isLoading:y}),(0,r.jsx)(I,{value:t,onChange:s,onSubmit:()=>{y||w(t)},isLoading:y,placeholder:"Ask JupyTutor anything..."})]})},C=e=>(0,r.jsx)("div",{className:"tailoredOptionsContainer "+(e.isLoading?"loading":""),children:e.options.map((t,s)=>(0,o.createElement)(R,{...t,key:t.id,callSuggestion:e.callSuggestion}))}),R=e=>(0,r.jsx)("div",{className:"tailoredOption",onClick:()=>e.callSuggestion&&e.callSuggestion(e.text),children:(0,r.jsx)("h4",{children:e.text})}),S=e=>{const{message:t,position:s,timestamp:n}=e,[a,i]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{const e=setTimeout(()=>{i(!0)},100);return()=>clearTimeout(e)},[]),(0,r.jsxs)("div",{className:`chat-bubble chat-bubble-${s} ${a?"chat-bubble-visible":""}`,children:[(0,r.jsx)("div",{className:"chat-message",children:t}),n&&(0,r.jsx)("div",{className:"chat-timestamp",children:n})]})},N=e=>{const{message:t,streaming:s}=e,[n,a]=(0,o.useState)("none"!==s);return(0,o.useEffect)(()=>{if("none"!==s)return;const e=setTimeout(()=>{a(!0)},100);return()=>clearTimeout(e)},[]),(0,r.jsx)("div",{className:`assistant-message ${n?"assistant-visible":""} ${"streaming"===s?"assistant-streaming":""}`,children:(i=t,i.split("\n").map((e,t)=>{const s=e.trim(),n=e.search(/\S/),o=n>0?{marginLeft:.5*n+"em"}:{};if(s.startsWith("- ")){const e=s.substring(2);return e.endsWith(":")&&e.split(" ").length<=15?(0,r.jsxs)("div",{className:"assistant-list-item",style:o,children:[(0,r.jsx)("span",{className:"list-bullet",children:"•"}),(0,r.jsx)("span",{className:"list-content-header",children:j(e)})]},t):(0,r.jsxs)("div",{className:"assistant-list-item",style:o,children:[(0,r.jsx)("span",{className:"list-bullet",children:"•"}),(0,r.jsx)("span",{className:"list-content",children:j(e)})]},t)}if(/^\d+\.\s/.test(s)){const e=s.match(/^(\d+)\.\s(.+)/);if(e)return(0,r.jsxs)("div",{className:"assistant-list-item",style:o,children:[(0,r.jsxs)("span",{className:"list-number",children:[e[1],"."]}),(0,r.jsx)("span",{className:"list-content",children:j(e[2])})]},t)}return/^(\s{4,}|\t)/.test(e)?(0,r.jsx)("div",{className:"assistant-code-line",style:o,children:e},t):""===s?(0,r.jsx)("div",{className:"assistant-empty-line"},t):s.endsWith(":")&&!s.includes("\n")&&s.split(" ").length<=15?(0,r.jsx)("div",{className:"assistant-header-line",style:o,children:(0,r.jsx)("strong",{children:j(s)})},t):(0,r.jsx)("div",{className:"assistant-text-line",style:o,children:j(s)},t)}))});var i},I=e=>{const{value:t,onChange:s,onSubmit:n,isLoading:o,placeholder:a}=e;return(0,r.jsxs)("div",{className:"chat-input-container "+(o?"loading":""),children:[(0,r.jsx)("input",{type:"text",className:"chat-input "+(o?"loading":""),value:t,onChange:e=>s(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||o||(e.preventDefault(),n())},placeholder:a,disabled:o}),(0,r.jsx)("button",{className:"chat-submit-btn "+(o?"loading":""),onClick:n,disabled:o||!t.trim(),children:o?(0,r.jsx)("div",{className:"loading-spinner",children:(0,r.jsx)("div",{className:"spinner-ring"})}):(0,r.jsx)("svg",{className:"submit-icon",viewBox:"0 0 24 24",fill:"none",children:(0,r.jsx)("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z",fill:"currentColor"})})})]})};class A extends a.ReactWidget{constructor(e={autograderResponse:void 0,allCells:[],activeIndex:-1,notebookContext:"upToGrader",sendTextbookWithRequest:!1,contextRetriever:null,cellType:"code",userId:null}){super(),this.props=e,this.addClass("jp-ReactWidget")}render(){return(0,r.jsx)(E,{...this.props})}}const U=A,O=["check"];let $="";const W=i.keywords.free_response_regex,H=i.keywords.success_regex,M=(e,t,s=void 0)=>{var n,o,r,a,i;if("code"===e.model.type){const s=e;if(!t)return"error";const a=null===(n=s.inputArea)||void 0===n?void 0:n.editor.getTokens();if(void 0===a)return console.log("ISSUE RETRIEVING TOKENS FROM CODE CELL"),null;const i=null!==(o=null==a?void 0:a.length)&&void 0!==o?o:0;if(""===$)for(let e=2;e<i;e+=1)"otter"===a[e].value&&"AssignOp"===a[e-1].type&&($=a[e-2].value,z&&console.log("GRADER VARIABLE NAME FOUND",$));if(""===$)return z&&console.log("GRADER NOT INITIALIZED YET"),"grader_not_initialized";let l=!1;for(let e=0;e<i-2;e+=1)"VariableName"===a[e].type&&a[e].value===$&&"."===a[e+1].type&&"PropertyName"===a[e+2].type&&-1!==O.indexOf(a[e+2].value)&&(l=!0);const c=null===(r=s.outputArea)||void 0===r?void 0:r.layout.widgets[0],u=c?c.node.innerText.toLowerCase():"",d=H.test(u);return l?d?(z&&console.log("SUCCESS CELL DETECTED"),"success"):"grader":"code"}{let t=!0;try{const s=e.model.metadata,n=null===(a=null==s?void 0:s.get)||void 0===a?void 0:a.call(s,"locked"),o=null===(i=null==s?void 0:s.get)||void 0===i?void 0:i.call(s,"readonly");t=!n&&!o}catch(e){t=!0}if(!t)return"text";let n=!1;if(s){const e=s.node.innerText.toLowerCase();n=W.test(e)}return t&&n?(z&&console.log("FREE RESPONSE CELL DETECTED"),"free_response"):"text"}};var P=s(256);function D(e,t){const s=e.lastIndexOf(t);return-1===s?e:e.slice(0,s)+e.slice(s+t.length)}function q(e){const t=/<img[^>]+src\s*=\s*["']([^"']+)["']|<source[^>]+srcset\s*=\s*["']([^"']+)["']|url\((['"]?)(?!#)(.*?)\3\)/gi,s=new Set;let n;for(;null!==(n=t.exec(e));){const e=n[1]||n[2]||n[4];e&&s.add(e.trim())}return Array.from(s)}function F(e){const t=/<a[^>]+href\s*=\s*["']([^"']+)["']/gi,s=new Set;let n;for(;null!==(n=t.exec(e));){const e=n[1];if(e){const t=e.trim();if(""===t||t.startsWith("javascript:")||t.startsWith("mailto:")||t.startsWith("#"))continue;try{if(t.startsWith("http://")||t.startsWith("https://"))s.add(t);else{const e=new URL(t,"https://example.com");s.add(e.href)}}catch(e){s.add(t)}}}return Array.from(s)}const J=(e,t=void 0)=>{let s=e.activeCellIndex;const n=e.cellsArray.map((t,s)=>{var n,o,r;const a=M(t,!0,s>0?e.cellsArray[s-1]:void 0);let i={index:s,type:a,html:t.node.innerHTML,text:t.node.innerText,outputText:null,outputHtml:null,images:q(t.node.innerHTML),links:F(t.node.innerHTML)};if("grader"===a||"code"===a||"error"===a||"success"===a){const e=t;(null===(n=e.outputArea.layout.widgets)||void 0===n?void 0:n.length)>0&&(i.outputText=e.outputArea.layout.widgets[0].node.innerText,i.text=D(i.text,null!==(o=i.outputText)&&void 0!==o?o:""),i.outputHtml=e.outputArea.layout.widgets[0].node.innerHTML,i.html=D(i.html,null!==(r=i.outputHtml)&&void 0!==r?r:""),i.images=[...i.images,...q(e.outputArea.layout.widgets[0].node.innerHTML)])}return i});return null!=t&&0!==s&&n[s-1].outputText===t.outputArea.layout.widgets[0].node.innerText&&(s-=1,console.log("ACTIVE INDEX CORRECTION PERFORMED")),[n,s]},z=!0,B=i.context_gathering.enabled,G={id:"jupytutor:plugin",description:"A Jupyter extension for providing students LLM feedback based on autograder results and supplied course context.",autoStart:!0,requires:[n.INotebookTracker],activate:(e,t)=>{console.log("JupyterLab extension jupytutor is activated with config: (config not connected yet)",i);const s=(()=>{const e=window.location.pathname.match(/\/user\/([^\/]+)/);return e?e[1]:null})();z&&(console.log("Current URL:",window.location.href),console.log("DataHub User ID:",s));let o=null;const r=async()=>{var e;try{const s=null===(e=t.currentWidget)||void 0===e?void 0:e.content;if(!s)return void console.log("No active notebook found for context gathering");const[n,r]=J(s);z&&console.log("Initial load: Gathered all cells from notebook:",n);const a=new Set;n.forEach(e=>{e.links&&e.links.length>0&&e.links.forEach(e=>a.add(e))});const l=Array.from(a);z&&console.log("Gathered unique links from notebook:",l),o=new T({sourceLinks:l,whitelistedURLs:i.context_gathering.whitelist,blacklistedURLs:i.context_gathering.blacklist,jupyterbookURL:i.context_gathering.jupyterbook.url,attemptJupyterbookLinkExpansion:i.context_gathering.jupyterbook.link_expansion,debug:!1}),setTimeout(()=>{var e,t;z&&(console.log("Textbook Context Gathering Completed\n"),console.log("Starting Textbook Prompt:\n",L),console.log("Textbook Context Snippet:\n",null===(e=null==o?void 0:o.getContext())||void 0===e?void 0:e.substring(528,1028)),console.log("Textbook Context Length:\n",null===(t=null==o?void 0:o.getContext())||void 0===t?void 0:t.length),console.log("Textbook Source Links:\n",null==o?void 0:o.getSourceLinks()))},3e3)}catch(e){console.error("Error gathering context:",e)}},a=e=>new Promise(t=>setTimeout(t,e));t.currentChanged.connect(async()=>{await a(500),r()}),t.currentWidget&&a(500).then(()=>{r()}),n.NotebookActions.executed.connect((e,t)=>{const{cell:n,success:r,notebook:a}=t,l=M(n,r);if("grader_not_initialized"===l){const e=n,t=new P.Widget;t.node.innerHTML="<h4>Did not find autograder. Make sure you have run the cells to initialize it!</h4>",e.outputArea&&e.outputArea.layout&&e.outputArea.layout.addWidget(t)}if("grader"===l||"success"===l&&i.usage.show_on_success){const e=n,[t,r]=J(a,e);if(e.outputArea&&e.outputArea.layout){const n=e.outputArea.layout.widgets[0].node.innerText,a=new U({autograderResponse:n,allCells:t,activeIndex:r,notebookContext:"upToGrader",sendTextbookWithRequest:B,contextRetriever:o,cellType:l,userId:s});e.outputArea.layout.addWidget(a)}}else if("code"===l);else if(i.usage.show_on_free_response){const[e,t]=J(a,void 0),r=e[t].type;if("free_response"===r){const a=new U({autograderResponse:"",allCells:e,activeIndex:t,notebookContext:"upToGrader",sendTextbookWithRequest:B,contextRetriever:o,cellType:r,userId:s}),i=n.node.querySelector(".jp-jupytutor-markdown-container");i&&i.remove();const l=document.createElement("div");l.className="jp-jupytutor-markdown-container",l.style.cssText="\n            margin-top: 15px;\n            border: 1px solid #e0e0e0;\n            border-radius: 6px;\n            padding: 0;\n            background-color: #ffffff;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n          ",l.appendChild(a.node),n.node.appendChild(l),requestAnimationFrame(()=>{a.update()})}}})}}},848:(e,t,s)=>{e.exports=s(20)}}]);