<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/favicon.ico">
        <title>betterbio</title>
        <style>
            body {
                background-color: #0c0c0c;
            }
            
            .container {
                display: none;

                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);

                background-color: #151515;
                border-radius: 25px;
                box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.05);
                padding: 20px;
                width: 800px;
                height: 600px;
                max-width: 90vw;
                max-height: 90vh;
            }

            .profile {
                width: 350px;
                height: 600px;
                box-sizing: border-box;

                position: absolute;
                bottom: 0;
                left: 30px;

                background: var(--gradient, var(--gradient-color, #151515));
                border-radius: 25px 25px 0 0;
                box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.05);
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .profile::-webkit-scrollbar {
                display: none;
            }

            .pages-section {
                position: absolute;
                top: 40px;
                left: 400px;
                right: 20px;
                height: 560px;
                display: flex;
                flex-direction: column;
            }

            .pages-navbar {
                height: 50px;
                border-bottom: 2px solid rgba(255, 255, 255, 0.05);
                overflow-x: auto;
                overflow-y: hidden;
                display: flex;
                align-items: center;
                padding: 0 10px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .page-tab {
                flex-shrink: 0;
                padding: 8px 16px;
                margin-right: 10px;
                background-color: transparent;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s ease;
                white-space: nowrap;
            }

            .page-tab:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }

            .page-tab.active {
                background-color: rgba(255, 255, 255, 0.15);
                color: var(--text-color, #ffffff);
            }

            .page-tab.inactive {
                color: color-mix(in srgb, var(--text-color, #ffffff) 60%, transparent);
            }

            .page-content {
                flex: 1;
                border-radius: 10px;
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
                word-wrap: break-word;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .page-content::-webkit-scrollbar {
                display: none;
            }

            .page-content h1, .page-content h2, .page-content h3, 
            .page-content h4, .page-content h5, .page-content h6 {
                margin-top: 0;
                margin-bottom: 0.5em;
            }

            .page-content p {
                margin: 0 0 1em 0;
                line-height: 1.6;
            }

            .page-content ul, .page-content ol {
                margin: 0 0 1em 0;
                padding-left: 1.5em;
            }

            .page-content code {
                background-color: rgba(255, 255, 255, 0.1);
                padding: 2px 4px;
                border-radius: 3px;
                font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                font-size: 0.9em;
            }

            .page-content pre {
                background-color: rgba(255, 255, 255, 0.1);
                padding: 15px;
                border-radius: 6px;
                overflow-x: auto;
                margin: 0 0 1em 0;
            }

            .page-content blockquote {
                border-left: 4px solid rgba(255, 255, 255, 0.3);
                padding-left: 15px;
                margin: 0 0 1em 0;
                font-style: italic;
            }

            .profile::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 140px;
                background-color: #151515;
                border-radius: 25px 25px 0 0;
                z-index: 0;
            }

            .profile-image {
                position: absolute;
                top: 90px;
                left: 22px;

                width: 100px;
                height: 100px;
                z-index: 1;

                border-radius: 50%;
                box-shadow: 0 0 0 6px rgba(255, 255, 255, 1);
            }

            .onlinedot {
                position: absolute;
                top: 160px;
                left: 90px;

                width: 25px;
                height: 25px;
                z-index: 2;

                border-radius: 50%;
                box-shadow: 0 0 0 6px rgba(255, 255, 255, 1);
                background-color: #747f8d;
            }

            .status-bubble {
                position: absolute;
                top: 120px;
                left: 135px;
                z-index: 2;

                background-color: #0c0c0c;
                border-radius: 15px;
                padding: 8px 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                
                display: none;
                align-items: center;
                gap: 8px;
                
                max-width: 185px;
                width: fit-content;
                word-wrap: break-word;
                font-size: 13px;
                line-height: 1.3;
                
                transition: max-width 0.3s ease, box-shadow 0.3s ease;
                cursor: pointer;
            }

            .status-bubble:hover {
                max-width: 185px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                z-index: 10;
            }

            .status-bubble.visible {
                display: flex;
            }

            .status-emoji {
                width: 16px;
                height: 16px;
                flex-shrink: 0;
                border-radius: 2px;
            }

            .status-text {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                transition: white-space 0.3s ease;
            }

            .status-bubble:hover .status-text {
                white-space: normal;
                word-wrap: break-word;
            }

            .profile-banner {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;

                width: 100%;
                height: 140px;
                z-index: 0;
                
                border-radius: 25px 25px 0 0;
                object-fit: cover;
            }

            .displayname {
                position: absolute;
                top: 185px;
                left: 24px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 24px;
                z-index: 1;
            }

            .username {
                position: absolute;
                top: 216px;
                left: 24px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 16px;
                z-index: 1;
            }
            .bio {
                width: 315px;
                min-height: 25px;
                box-sizing: border-box;

                position: absolute;
                top: 260px;
                left: 50%;
                transform: translateX(-50%);

                background-color: #151515;
                border-radius: 10px;
                padding: 12.5px;
                word-wrap: break-word;
                z-index: 3;
                padding-top: 0px;
            }

            .bio-content {
                margin-top: 0;
                margin-bottom: 0;
            }

            .bio-content p {
                margin-top: 0;
                margin-bottom: 0;
            }

            .bio-content p + p {
                margin-top: 0.5em;
            }

            .bio-header {
                font-weight: bold;
                font-size: 12px;
                margin-top: 14px;
                margin-bottom: 8px;
            }

            @media (max-width: 768px) {
                .container {
                    background: none !important;
                    box-shadow: none !important;
                    padding: 0 !important;
                }
                
                .profile {
                    display: block;
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    border-radius: 25px;
                    width: 350px;
                    height: 600px;
                    max-width: 90vw;
                    max-height: 90vh;
                }

                .pages-section {
                    display: none;
                }
            }

            * {
                color: var(--text-color, #ffffff);
                font-family: Arial, sans-serif;
            }
        </style>
    </head>
    <body>
    <div class="container" id="container">
        <div class="profile" id="profile-content">
            <img src="" alt="Profile Image" class="profile-image" id="profile-image">
            <div class="onlinedot" id="onlinedot"></div>
            <div class="status-bubble" id="status-bubble">
                <img src="" alt="Status Emoji" class="status-emoji" id="status-emoji" style="display: none;">
                <span class="status-text" id="status-text"></span>
            </div>
            <img src="" alt="Profile Banner" class="profile-banner" id="profile-banner">
            <h1 class="displayname" id="displayname">loading</h1>
            <p class="username" id="username">loading</p>
            <div class="bio" id="bio">
                <p class="bio-header">About Me</p>
                <p class="bio-content" id="bio-content">loading</p>
            </div>
        </div>
        <div class="pages-section" id="pages-section">
            <div class="pages-navbar" id="pages-navbar">
            </div>
            <div class="page-content" id="page-content">
                <p>loading page...</p>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
    <script>
        function getRandomBannerColor() {
            const colors = [
                '#5865f2', '#57f287', '#fee75c', '#eb459e', '#ed4245',
                '#f38ba8', '#94b3fd', '#9bb59a', '#fab387', '#cba6f7',
                '#74c7ec', '#a6e3a1', '#f9e2af', '#eba0ac', '#89b4fa'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getDefaultAvatar() {
            return 'data:image/svg+xml,' + encodeURIComponent(`
                <svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="50" fill="#5865F2"/>
                    <text x="50" y="60" font-family="Arial, sans-serif" font-size="40" font-weight="bold" text-anchor="middle" fill="white">?</text>
                </svg>
            `);
        }

        function loadAvatar() {
            const profileImage = document.getElementById('profile-image');
            
            fetch('/api/profile/avatar')
                .then(response => response.json())
                .then(avatarUrl => {
                    if (avatarUrl && avatarUrl.trim() !== '') {
                        // test if the URL is valid by creating a temporary pfp
                        const testImg = new Image();
                        testImg.onload = function() {
                            profileImage.src = avatarUrl;
                        };
                        testImg.onerror = function() {
                            console.warn('Failed to load avatar from URL:', avatarUrl);
                            profileImage.src = getDefaultAvatar();
                        };
                        // fallback if loading takes too long
                        setTimeout(() => {
                            if (profileImage.src === '' || profileImage.src === window.location.href) {
                                profileImage.src = getDefaultAvatar();
                            }
                        }, 5000);
                        testImg.src = avatarUrl;
                    } else {
                        profileImage.src = getDefaultAvatar();
                    }
                })
                .catch(error => {
                    console.error('Error fetching avatar:', error);
                    profileImage.src = getDefaultAvatar();
                });
        }

        function loadBanner() {
            const profileBanner = document.getElementById('profile-banner');
            
            fetch('/api/profile/banner')
                .then(response => response.json())
                .then(bannerUrl => {
                    if (bannerUrl && bannerUrl.trim() !== '') {
                        // test if the URL is valid by creating a temporary banner
                        const testImg = new Image();
                        testImg.onload = function() {
                            // remove any existing temp banner
                            const existingColorBanner = document.getElementById('color-banner');
                            if (existingColorBanner) {
                                existingColorBanner.remove();
                            }
                            profileBanner.src = bannerUrl;
                            profileBanner.style.display = 'block';
                        };
                        testImg.onerror = function() {
                            console.warn('Failed to load banner from URL:', bannerUrl);
                            setupRandomColorBanner();
                        };
                        // fallback if loading takes too long
                        setTimeout(() => {
                            if (profileBanner.src === '' || profileBanner.src === window.location.href) {
                                setupRandomColorBanner();
                            }
                        }, 5000);
                        testImg.src = bannerUrl;
                    } else {
                        setupRandomColorBanner();
                    }
                })
                .catch(error => {
                    console.error('Error fetching banner:', error);
                    setupRandomColorBanner();
                });
        }

        function setupRandomColorBanner() {
            const profileBanner = document.getElementById('profile-banner');
            const randomColor = getRandomBannerColor();
            
            // hide image
            profileBanner.style.display = 'none';
            
            // create div to act as colored banner
            let colorBanner = document.getElementById('color-banner');
            if (!colorBanner) {
                colorBanner = document.createElement('div');
                colorBanner.id = 'color-banner';
                colorBanner.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    width: 100%;
                    height: 140px;
                    z-index: 0;
                    border-radius: 25px 25px 0 0;
                    background-color: ${randomColor};
                `;
                // insert before profile banner
                profileBanner.parentNode.insertBefore(colorBanner, profileBanner);
            } else {
                colorBanner.style.backgroundColor = randomColor;
            }
        }
        
        let currentActivePage = null;
        let availablePages = [];

        function loadPages() {
            fetch('/pages')
                .then(response => response.json())
                .then(pages => {
                    availablePages = pages;
                    setupPagesNavbar(pages);
                    if (pages.length > 0) {
                        // find preferred default page (about/ABOUT/readme/README)
                        const preferredPages = ['about', 'ABOUT', 'readme', 'README'];
                        let defaultPage = pages[0]; // fallback to first page
                        
                        for (const preferred of preferredPages) {
                            if (pages.includes(preferred)) {
                                defaultPage = preferred;
                                break;
                            }
                        }
                        
                        loadPageContent(defaultPage);
                        setActiveTab(defaultPage);
                    } else {
                        document.getElementById('page-content').style.display = 'none';
                        document.getElementById('pages-navbar').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching pages:', error);
                    document.getElementById('page-content').style.display = 'none';
                    document.getElementById('pages-navbar').style.display = 'none';
                });
        }

        function setupPagesNavbar(pages) {
            const navbar = document.getElementById('pages-navbar');
            navbar.innerHTML = '';
            
            pages.forEach(pageName => {
                const tab = document.createElement('button');
                tab.className = 'page-tab inactive';
                tab.textContent = pageName;
                tab.dataset.pageName = pageName;
                
                tab.addEventListener('click', () => {
                    loadPageContent(pageName);
                    setActiveTab(pageName);
                });
                
                navbar.appendChild(tab);
            });
        }

        function setActiveTab(activePage) {
            currentActivePage = activePage;
            const tabs = document.querySelectorAll('.page-tab');
            tabs.forEach(tab => {
                if (tab.dataset.pageName === activePage) {
                    tab.className = 'page-tab active';
                    if (window.themeTextColor) {
                        tab.style.color = window.themeTextColor;
                    }
                } else {
                    tab.className = 'page-tab inactive';
                    if (window.themeTextColor) {
                        tab.style.color = `color-mix(in srgb, ${window.themeTextColor} 60%, transparent)`;
                    }
                }
            });
        }

        function loadPageContent(pageName) {
            const contentDiv = document.getElementById('page-content');
            contentDiv.innerHTML = '<p>loading page...</p>';
            
            fetch(`/page/${pageName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load page: ${response.status}`);
                    }
                    return response.text();
                })
                .then(markdownContent => {
                    marked.setOptions({
                        breaks: true,
                        gfm: true
                    });
                    contentDiv.innerHTML = marked.parse(markdownContent);
                    
                    // apply theme text color to all new elements
                    if (window.themeTextColor) {
                        const newElements = contentDiv.querySelectorAll('*');
                        newElements.forEach(element => {
                            element.style.color = window.themeTextColor;
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading page content:', error);
                    contentDiv.innerHTML = `<p>Error loading page "${pageName}": ${error.message}</p>`;
                });
        }

        function updatePageTabsColor(textColor) {
            const tabs = document.querySelectorAll('.page-tab');
            tabs.forEach(tab => {
                if (tab.classList.contains('active')) {
                    tab.style.color = textColor;
                } else {
                    tab.style.color = `color-mix(in srgb, ${textColor} 60%, transparent)`;
                }
            });
        }

        function loadStatusBubble() {
            const statusBubble = document.getElementById('status-bubble');
            const statusEmoji = document.getElementById('status-emoji');
            const statusText = document.getElementById('status-text');
            
            Promise.all([
                fetch('/api/status/text').then(response => response.json()),
                fetch('/api/status/emoji').then(response => response.json())
            ])
            .then(([text, emoji]) => {
                const hasText = text && text.trim() !== '';
                const hasEmoji = emoji && emoji.trim() !== '';
                
                if (hasText || hasEmoji) {
                    if (hasEmoji) {
                        // Check if emoji is a URL (custom Discord emoji or Twemoji)
                        if (emoji.startsWith('http')) {
                            statusEmoji.src = emoji;
                            statusEmoji.style.display = 'block';
                        } else {
                            // Unicode emoji - display as text
                            statusEmoji.style.display = 'none';
                            statusText.textContent = `${emoji} ${text || ''}`.trim();
                        }
                    } else {
                        statusEmoji.style.display = 'none';
                    }
                    
                    if (hasText && hasEmoji && emoji.startsWith('http')) {
                        statusText.textContent = text;
                    } else if (hasText && (!hasEmoji || !emoji.startsWith('http'))) {
                        // Text already set above for unicode emoji case
                        if (!hasEmoji) {
                            statusText.textContent = text;
                        }
                    }
                    
                    statusBubble.classList.add('visible');
                    
                    // Apply theme color if available
                    if (window.themeTextColor) {
                        statusText.style.color = window.themeTextColor;
                    }
                } else {
                    statusBubble.classList.remove('visible');
                }
            })
            .catch(error => {
                console.error('Error loading status:', error);
                statusBubble.classList.remove('visible');
            });
        }

        window.addEventListener('load', function() {
            // load pfp & banner
            loadAvatar();
            loadBanner();
            
            // load pages
            loadPages();
            
            // load status bubble
            loadStatusBubble();
            
            fetch('/api/profile/theme')
                .then(response => response.json())
                .then(data => {
                    if (data.background_color) {
                        document.body.style.backgroundColor = data.background_color;
                        
                        // update status bubble background to match page background
                        const statusBubble = document.getElementById('status-bubble');
                        if (statusBubble) {
                            statusBubble.style.backgroundColor = data.background_color;
                        }
                        
                        if (Array.isArray(data.profile_color)) {
                            const gradient = `linear-gradient(180deg, ${data.profile_color[0]} 0%, ${data.profile_color[1]} 100%)`;
                            const darkerGradient = `linear-gradient(180deg, color-mix(in srgb, ${data.profile_color[0]} 70%, black) 0%, color-mix(in srgb, ${data.profile_color[1]} 70%, black) 100%)`;
                            document.querySelector('.container').style.background = darkerGradient;
                            document.querySelector('.profile').style.setProperty('--gradient', gradient);
                            document.querySelector('.profile-image').style.boxShadow = `0 0 0 6px ${data.profile_color[0]}`;
                            document.querySelector('.onlinedot').style.boxShadow = `0 0 0 6px ${data.profile_color[0]}`;

                        } else if (data.profile_color) {
                            const darkerColor = `color-mix(in srgb, ${data.profile_color} 70%, black)`;
                            document.querySelector('.container').style.backgroundColor = darkerColor;
                            document.querySelector('.profile').style.setProperty('--gradient-color', data.profile_color);
                            document.querySelector('.profile-image').style.boxShadow = `0 0 0 6px ${data.profile_color}`;
                            document.querySelector('.onlinedot').style.boxShadow = `0 0 0 6px ${data.profile_color}`;
                        }
                        // set text color from theme data
                        if (data.text_color) {
                            document.documentElement.style.setProperty('--text-color', data.text_color);
                            // apply to existing elements
                            const textElements = document.querySelectorAll('*');
                            textElements.forEach(element => {
                                element.style.color = data.text_color;
                            });
                            // store the color globally for new elements
                            window.themeTextColor = data.text_color;
                            
                            // update page tabs if they exist
                            updatePageTabsColor(data.text_color);
                            
                            // update status bubble text color
                            const statusText = document.getElementById('status-text');
                            if (statusText) {
                                statusText.style.color = data.text_color;
                            }
                        }

                        if (data.title) {
                            document.title = data.title;
                        }
                        else {
                            document.title = 'BetterBio';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching theme:', error);
                });
            fetch('api/profile/info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('displayname').textContent = data.name || 'No Display Name';
                    document.getElementById('username').textContent = `${data.username ? `@${data.username}` : '@no_username'} • ${data.pronouns || 'No pronouns'}`;
                    const bioText = (data.bio || 'This user has no bio.').replace(/\\n/g, '\n');
                    marked.setOptions({
                        breaks: true, // convert single line breaks to <br>
                        gfm: true     // enable GitHub Flavored Markdown
                    });
                    document.getElementById('bio-content').innerHTML = marked.parse(bioText);
                    if (data.connections && data.connections.length > 0) {
                        const bioSection = document.getElementById('bio');
                        
                        const connectionsHeader = document.createElement('p');
                        connectionsHeader.className = 'bio-header';
                        connectionsHeader.textContent = 'Connections';
                        bioSection.appendChild(connectionsHeader);
                        
                        data.connections.forEach(connection => {
                            const connectionDiv = document.createElement('div');
                            connectionDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;';
                            
                            if (connection.iconurl) {
                                const icon = document.createElement('img');
                                icon.src = connection.iconurl;
                                icon.style.cssText = 'width: 20px; height: 20px; margin-right: 8px; filter: brightness(0) invert(1);';
                                connectionDiv.appendChild(icon);
                            }
                            
                            const label = document.createElement('span');
                            label.textContent = connection.label;
                            label.style.textDecoration = 'underline';
                            if (window.themeTextColor) {
                                label.style.color = window.themeTextColor;
                            }
                            
                            connectionDiv.appendChild(label);
                            
                            connectionDiv.addEventListener('click', () => {
                                window.open(connection.url, '_blank');
                            });
                            
                            bioSection.appendChild(connectionDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching profile info:', error);
                });
            fetch('api/profile/joindate')
                .then(response => response.json())
                .then(data => {
                    if (data && data.trim() !== '') {
                        const bioSection = document.getElementById('bio');
                        
                        const joinedHeader = document.createElement('p');
                        joinedHeader.className = 'bio-header';
                        joinedHeader.textContent = 'Joined at';
                        
                        const joinedContent = document.createElement('p');
                        joinedContent.className = 'bio-content';
                        joinedContent.textContent = data;
                        
                        bioSection.appendChild(joinedHeader);
                        bioSection.appendChild(joinedContent);
                    }
                })
                .catch(error => {
                    console.error('Error fetching profile info:', error);
                });
            fetch('api/status/online')
                .then(response => response.json())
                .then(data => {
                    if (data === 'online') {
                        document.getElementById('onlinedot').style.backgroundColor = "#43b581";
                    }
                    else if (data === 'idle') {
                        document.getElementById('onlinedot').style.backgroundColor = "#faa61a";
                    }
                    else if (data === 'dnd') {
                        document.getElementById('onlinedot').style.backgroundColor = "#f04747";
                    }
                    else if (data === '') {
                        document.getElementById('onlinedot').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching profile info:', error);
                });
            document.getElementById('container').style.display = 'block';
        });
    </script>
    </body>
</html>