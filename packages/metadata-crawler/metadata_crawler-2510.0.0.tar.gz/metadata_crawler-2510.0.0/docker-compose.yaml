---
services:
  solr:
    networks:
      - freva-rest
    image: ghcr.io/freva-org/freva-solr:latest
    ports:
      - "8983:8983"
    hostname: solr

  mongodb:
    networks:
      - freva-rest
    image: ghcr.io/freva-org/freva-mongo:latest
    environment:
      API_MONGO_DB: metadata
      API_MONGO_USER: mongo
      API_MONGO_PASSWORD: secret
    hostname: mongodb
    ports:
      - "27017:27017"

  minio:
    networks:
      - freva-rest
    image: quay.io/minio/minio
    hostname: minio
    environment:
       MINIO_ROOT_USER: minioadmin
       MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address :9001
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 2s
      timeout: 1s
      retries: 30

  setup-minio:
    networks:
      - freva-rest
    image: quay.io/minio/mc
    environment:
       MINIO_ROOT_USER: minioadmin
       MINIO_ROOT_PASSWORD: minioadmin
    hostname: minio-setup
    volumes:
      - ./data:/seed:ro
      - ./dev-env/setup-minio.sh:/usr/local/bin/setup-minio:ro
    entrypoint: ["sh", "/usr/local/bin/setup-minio"]
    depends_on:
      minio:
        condition: service_healthy

  swift:
    image: openstackswift/saio:latest
    hostname: swift
    networks: [freva-rest]
    ports:
      - "8081:8080"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://swift:8080/info"]
      interval: 5s
      timeout: 3s
      retries: 30

  setup-swift:
    image: docker.io/curlimages/curl
    hostname: swift-setup
    networks: [freva-rest]
    depends_on:
      swift:
        condition: service_healthy
    environment:
      SWIFT_AUTH_URL: http://swift:8080/auth/v1.0
      SWIFT_USER: test:tester
      SWIFT_KEY: testing
    volumes:
      - ./data:/seed:ro
      - ./dev-env/setup-swift.sh:/usr/local/bin/setup-swift:ro
    entrypoint: ["/bin/sh", "/usr/local/bin/setup-swift"]


networks:
  freva-rest:
    driver: bridge
