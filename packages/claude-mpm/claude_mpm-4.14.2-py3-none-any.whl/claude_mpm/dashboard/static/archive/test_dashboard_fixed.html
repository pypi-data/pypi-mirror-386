<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude MPM - Fixed Dashboard Test</title>

    <!-- Basic styling -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .status-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .status-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .status-connected {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #22c55e;
        }

        .status-connecting {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.5);
            color: #fbbf24;
        }

        .status-disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }

        .events-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }

        .event-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            border-left: 3px solid #4ade80;
        }

        .event-timestamp {
            color: #94a3b8;
            margin-right: 10px;
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.8rem;
        }

        .nav-links {
            text-align: center;
            margin-top: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.2s;
            display: inline-block;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Claude MPM - Fixed Dashboard Test</h1>
            <p>Testing connection and event display fixes</p>
        </div>

        <div class="status-section">
            <h3>Connection Status</h3>
            <div class="connection-status">
                <div id="connection-status" class="status-badge status-disconnected">
                    <span>‚óè</span> Checking...
                </div>
            </div>

            <div class="status-grid">
                <div class="status-card">
                    <div class="status-value" id="total-events">0</div>
                    <div class="status-label">Total Events</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="events-per-second">0</div>
                    <div class="status-label">Events/Second</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="connection-uptime">0s</div>
                    <div class="status-label">Connection Uptime</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="unique-event-types">0</div>
                    <div class="status-label">Event Types</div>
                </div>
            </div>
        </div>

        <div class="events-section">
            <h3>Recent Events</h3>
            <div id="events-list" class="events-list">
                <div class="event-item">
                    <span class="event-timestamp">[Loading...]</span>
                    <span>Connecting to Socket.IO server...</span>
                </div>
            </div>
        </div>

        <div class="debug-info">
            <h4>Debug Information:</h4>
            <div id="debug-output">
                Socket.IO Status: Loading...<br>
                Events Array: Not initialized<br>
                Last Event: None<br>
            </div>
        </div>

        <div class="nav-links">
            <a href="/static/monitors-index.html">üè† Monitor Index</a>
            <a href="/static/events.html">üìä Events Page</a>
            <a href="/static/agents.html">ü§ñ Agents Page</a>
            <a href="/static/">üìà Main Dashboard</a>
        </div>
    </div>

    <!-- Socket.IO from CDN -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        console.log('üöÄ Fixed Dashboard Test - Starting initialization...');

        // Variables to track state
        let socket = null;
        let events = [];
        let connectionStartTime = null;
        let lastEventTime = null;
        let eventCount = 0;
        let eventsPerSecond = 0;

        // DOM elements
        const connectionStatus = document.getElementById('connection-status');
        const totalEventsEl = document.getElementById('total-events');
        const eventsPerSecondEl = document.getElementById('events-per-second');
        const connectionUptimeEl = document.getElementById('connection-uptime');
        const uniqueEventTypesEl = document.getElementById('unique-event-types');
        const eventsList = document.getElementById('events-list');
        const debugOutput = document.getElementById('debug-output');

        // Update connection status
        function updateConnectionStatus(status, type) {
            console.log(`üîå Connection status: ${status} (${type})`);

            connectionStatus.innerHTML = `<span>‚óè</span> ${status}`;
            connectionStatus.className = `status-badge status-${type}`;

            if (type === 'connected' && !connectionStartTime) {
                connectionStartTime = Date.now();
            } else if (type === 'disconnected') {
                connectionStartTime = null;
            }

            updateDebugInfo();
        }

        // Add event to the list
        function addEvent(eventData) {
            console.log('üì° Received event:', eventData);

            events.push(eventData);
            eventCount++;
            lastEventTime = Date.now();

            // Calculate events per second
            const recentEvents = events.filter(e =>
                (Date.now() - new Date(e.timestamp).getTime()) < 1000
            );
            eventsPerSecond = recentEvents.length;

            updateEventsList();
            updateMetrics();
            updateDebugInfo();
        }

        // Update events list display
        function updateEventsList() {
            const recentEvents = events.slice(-10); // Show last 10 events

            if (recentEvents.length === 0) {
                eventsList.innerHTML = '<div class="event-item"><span class="event-timestamp">[Waiting...]</span><span>No events received yet</span></div>';
                return;
            }

            const html = recentEvents.map(event => {
                const timestamp = new Date(event.timestamp).toLocaleTimeString();
                const type = event.type || 'unknown';
                const subtype = event.subtype || '';
                const fullType = subtype ? `${type}.${subtype}` : type;

                return `
                    <div class="event-item">
                        <span class="event-timestamp">[${timestamp}]</span>
                        <span><strong>${fullType}</strong> - ${formatEventData(event)}</span>
                    </div>
                `;
            }).join('');

            eventsList.innerHTML = html;
            eventsList.scrollTop = eventsList.scrollHeight;
        }

        // Format event data for display
        function formatEventData(event) {
            if (event.tool_name) {
                return `Tool: ${event.tool_name}`;
            } else if (event.data && event.data.message) {
                return event.data.message.substring(0, 50) + '...';
            } else if (event.data && typeof event.data === 'object') {
                return JSON.stringify(event.data).substring(0, 50) + '...';
            }
            return 'Event data';
        }

        // Update metrics display
        function updateMetrics() {
            totalEventsEl.textContent = eventCount;
            eventsPerSecondEl.textContent = eventsPerSecond;

            // Calculate uptime
            if (connectionStartTime) {
                const uptime = Math.floor((Date.now() - connectionStartTime) / 1000);
                connectionUptimeEl.textContent = uptime + 's';
            } else {
                connectionUptimeEl.textContent = '0s';
            }

            // Count unique event types
            const uniqueTypes = new Set(events.map(e => e.type || 'unknown'));
            uniqueEventTypesEl.textContent = uniqueTypes.size;
        }

        // Update debug information
        function updateDebugInfo() {
            const socketStatus = socket ?
                (socket.connected ? 'Connected' : 'Disconnected') :
                'Not initialized';

            const lastEvent = events.length > 0 ?
                events[events.length - 1].type : 'None';

            debugOutput.innerHTML = `
                Socket.IO Status: ${socketStatus}<br>
                Socket ID: ${socket ? socket.id || 'No ID' : 'N/A'}<br>
                Events Array Length: ${events.length}<br>
                Last Event Type: ${lastEvent}<br>
                Events per Second: ${eventsPerSecond}<br>
                Last Event Time: ${lastEventTime ? new Date(lastEventTime).toLocaleString() : 'None'}<br>
                Connection Start: ${connectionStartTime ? new Date(connectionStartTime).toLocaleString() : 'None'}<br>
                Window.socket Available: ${!!window.socket}<br>
                Window.io Available: ${!!window.io}<br>
            `;
        }

        // Initialize Socket.IO connection
        function initializeSocket() {
            console.log('üîå Initializing Socket.IO connection...');

            updateConnectionStatus('Connecting...', 'connecting');

            try {
                socket = io('http://localhost:8765', {
                    autoConnect: true,
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    reconnectionAttempts: 10,
                    timeout: 20000,
                    forceNew: true,
                    transports: ['websocket', 'polling']
                });

                // Expose socket globally
                window.socket = socket;

                // Connection events
                socket.on('connect', () => {
                    console.log('‚úÖ Connected to Socket.IO server');
                    updateConnectionStatus('Connected', 'connected');

                    // Request initial status
                    socket.emit('request.status');
                });

                socket.on('disconnect', (reason) => {
                    console.log('‚ùå Disconnected from server:', reason);
                    updateConnectionStatus(`Disconnected: ${reason}`, 'disconnected');
                });

                socket.on('connect_error', (error) => {
                    console.error('üö´ Connection error:', error);
                    updateConnectionStatus('Connection Error', 'disconnected');
                });

                // Event handlers
                socket.on('claude_event', (data) => {
                    console.log('üì° Received claude_event:', data);
                    addEvent(data);
                });

                // Legacy event handlers for backward compatibility
                const eventTypes = [
                    'session.started', 'session.ended',
                    'claude.request', 'claude.response',
                    'agent.loaded', 'agent.executed',
                    'todo.updated', 'memory.operation',
                    'log.entry'
                ];

                eventTypes.forEach(eventType => {
                    socket.on(eventType, (data) => {
                        console.log(`üì° Received ${eventType}:`, data);
                        addEvent({
                            type: eventType.split('.')[0],
                            subtype: eventType.split('.')[1] || 'generic',
                            timestamp: new Date().toISOString(),
                            data: data
                        });
                    });
                });

                // System events
                socket.on('history', (data) => {
                    console.log('üìö Received event history:', data);
                    if (data && Array.isArray(data.events)) {
                        data.events.forEach(event => {
                            addEvent(event);
                        });
                        console.log(`üìö Loaded ${data.events.length} historical events`);
                    }
                });

                socket.on('system.status', (data) => {
                    console.log('üìä Received system status:', data);
                });

                // Test heartbeat
                socket.on('heartbeat', (data) => {
                    console.log('üíì Server heartbeat:', data);
                    addEvent({
                        type: 'system',
                        subtype: 'heartbeat',
                        timestamp: data.timestamp || new Date().toISOString(),
                        data: data
                    });
                });

            } catch (error) {
                console.error('üí• Failed to initialize socket:', error);
                updateConnectionStatus('Initialization Failed', 'disconnected');
            }
        }

        // Update metrics every second
        setInterval(updateMetrics, 1000);

        // Update debug info every 2 seconds
        setInterval(updateDebugInfo, 2000);

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM ready, initializing...');

            // Check if Socket.IO is available
            if (typeof io === 'undefined') {
                console.error('‚ùå Socket.IO library not loaded!');
                updateConnectionStatus('Socket.IO Not Available', 'disconnected');
                return;
            }

            // Initialize socket connection
            initializeSocket();

            // Initial debug update
            updateDebugInfo();
        });

        // Send test event button (for debugging)
        window.sendTestEvent = function() {
            if (socket && socket.connected) {
                const testEvent = {
                    type: 'test',
                    subtype: 'manual',
                    timestamp: new Date().toISOString(),
                    data: {
                        message: 'Manual test event',
                        test_id: Math.random().toString(36).substr(2, 9)
                    }
                };

                console.log('üß™ Sending test event:', testEvent);
                addEvent(testEvent);
            } else {
                alert('Socket not connected!');
            }
        };

        console.log('üöÄ Dashboard test script loaded');
    </script>

    <!-- Add test button -->
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="sendTestEvent()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer;">
            üß™ Send Test Event
        </button>
        <button onclick="location.reload()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; margin-left: 10px;">
            üîÑ Reload Page
        </button>
    </div>
</body>
</html>