Metadata-Version: 2.1
Name: maas-task-backoff-framework
Version: 1.0.11
Summary: åŸºäºRedisçš„ä»»åŠ¡é€€é¿é‡è¯•ã€è°ƒåº¦æ¡†æ¶ï¼Œæ”¯æŒå¤šç§é€€é¿ç­–ç•¥
Home-page: https://github.com/xiaofucoding/maas-task-backoff-framework.git/
Author: xinzf
Author-email: 515361725@qq.com
License: MIT
Project-URL: Source, https://github.com/yourusername/task-backoff-scheduler
Project-URL: Documentation, https://github.com/yourusername/task-backoff-scheduler#readme
Project-URL: Bug Reports, https://github.com/yourusername/task-backoff-scheduler/issues
Keywords: task retry backoff redis queue
Platform: UNKNOWN
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Requires-Python: >=3.7
Description-Content-Type: text/markdown
Requires-Dist: redis (>=4.0.0)
Requires-Dist: PyYAML (>=6.0)
Requires-Dist: dataclasses (>=0.6) ; python_version < "3.7"
Provides-Extra: dev
Requires-Dist: pytest (>=6.0.0) ; extra == 'dev'
Requires-Dist: pytest-cov (>=2.0.0) ; extra == 'dev'
Requires-Dist: black (>=21.0.0) ; extra == 'dev'
Requires-Dist: flake8 (>=3.8.0) ; extra == 'dev'
Requires-Dist: mypy (>=0.800) ; extra == 'dev'

# ä»»åŠ¡é€€é¿é‡è¯•ã€è°ƒåº¦æ¡†æ¶

[![Python](https://img.shields.io/badge/Python-3-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

ä¸€ä¸ªåŸºäºRedisçš„åˆ†å¸ƒå¼ä»»åŠ¡é€€é¿é‡è¯•ã€è°ƒåº¦æ¡†æ¶ï¼Œæ”¯æŒå¤šç§é€€é¿ç­–ç•¥å’Œå¹¶å‘æ‰§è¡Œã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ”„ **å¤šç§é€€é¿ç­–ç•¥**: å›ºå®šé—´éš”ã€æŒ‡æ•°é€€é¿ã€çº¿æ€§é€€é¿
- ğŸš€ **é«˜å¹¶å‘æ‰§è¡Œ**: æ”¯æŒçº¿ç¨‹æ± /è¿›ç¨‹æ± å¹¶å‘å¤„ç†
- ğŸ“Š **ä»»åŠ¡ä¼˜å…ˆçº§**: æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†
- â±ï¸ **è¶…æ—¶æ§åˆ¶**: ä»»åŠ¡æ‰§è¡Œè¶…æ—¶å’Œå¤±è´¥å¤„ç†
- ğŸ“ˆ **çŠ¶æ€ç›‘æ§**: å®Œæ•´çš„ä»»åŠ¡çŠ¶æ€ç®¡ç†å’Œç›‘æ§
- ğŸ¯ **çµæ´»è°ƒåº¦**: å¯é…ç½®çš„å®šæ—¶è°ƒåº¦é—´éš”
- ğŸ”’ **åˆ†å¸ƒå¼é”**: åŸºäºRedisçš„åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—
- ğŸ’¾ **å­˜å‚¨æ–¹å¼**: ç›®å‰åªæ”¯æŒ Redisï¼Œåç»­ä¼šå¢åŠ MySQLã€è¾¾æ¢¦æ•°æ®åº“ç­‰æ”¯æŒ

## ğŸ“šè®¾è®¡æ€è·¯


### ä¸šåŠ¡æ¶æ„è®¾è®¡

![](http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20250909113017.png)

### é€€é¿å·¥å…·å†…éƒ¨ç»„ä»¶è®¾è®¡


![](http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20250909113043.png)

### è®¾è®¡ç±»å›¾

![](http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20250909113102.png)

### è°ƒç”¨æ—¶åºå›¾

ç”¨æˆ·æäº¤task

![](http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20250909113117.png)

è°ƒåº¦æ‰§è¡Œtask

![](http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20250909113543.png)

## ğŸ“¦ å®‰è£…

```bash
pip install maas-task-backoff-framework
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨ç¤ºä¾‹

```python
from backoff.scheduler.backoff_scheduler import (
    TaskBackoffScheduler,
    TaskBackoffConfig,
    TaskEntity,
    TaskConfig,
    StorageConfig,
    ThreadPoolConfig,
    SchedulerConfig,
    ResultEntity,
)

# 1. åˆ›å»ºé…ç½®
config = TaskBackoffConfig()

# Rediså­˜å‚¨é…ç½®
config.storage = StorageConfig(
    type="redis", 
    host="localhost", 
    port=6379, 
    database=0, 
    password=""
)

# ä»»åŠ¡é…ç½®
config.task = TaskConfig(
    biz_prefix="my_service",
    batch_size=10,
    max_retry_count=3,
    backoff_strategy="exponential",
    backoff_interval=30,
    backoff_multiplier=2.0,
    min_gpu_memory_gb=0.5,
    min_gpu_utilization=10
)

# çº¿ç¨‹æ± é…ç½®
config.threadpool = ThreadPoolConfig(
    concurrency=5, 
    exec_timeout=300, 
    proc_mode="process"
)

# è°ƒåº¦å™¨é…ç½®
config.scheduler = SchedulerConfig(interval=10)

# 2. åˆ›å»ºè°ƒåº¦å™¨
scheduler = TaskBackoffScheduler(config)

# 3. å®šä¹‰ä»»åŠ¡å¤„ç†å™¨
def task_handler(task: TaskEntity):
    # æ‚¨çš„ä¸šåŠ¡é€»è¾‘
    print(f"å¤„ç†ä»»åŠ¡: {task.task_id}")
    return ResultEntity.ok(
        result={"status": "success", "data": "å¤„ç†å®Œæˆ"},
        task_id=task.task_id,
    )

def exception_handler(task: TaskEntity):
    # å¼‚å¸¸å¤„ç†é€»è¾‘
    return ResultEntity.fail(
        code=-1,
        message="ä»»åŠ¡æ‰§è¡Œå¤±è´¥",
        task_id=task.task_id,
    )

# 4. æ³¨å†Œå¤„ç†å™¨
scheduler.set_custom_task_handler(task_handler)

scheduler.set_custom_task_exception_handler(exception_handler)

# 5. å¯åŠ¨è°ƒåº¦å™¨ï¼ˆå¦‚æœä¸éœ€è¦å¯åŠ¨è°ƒåº¦å™¨ï¼Œè¯·å¿½ç•¥æ­¤æ­¥éª¤ï¼Œåªæä¾›åŸºç¡€çš„Task APIæ“ä½œï¼‰
scheduler.start()
```

## ğŸ’» Taskä»»åŠ¡æ•°æ®ç»“æ„

```python
{
    "task_id": "task_5775520148",
    "process": 0,
    "status": "pending",
    "result": "",
    "param": "{\"index\": 111, \"data\": \"test_data\"}",
    "retry_count": 0,
    "next_execution_time": 0,
    "create_time": 1756695076,
    "update_time": 1756695076,
    "max_retry_count": 5,
    "backoff_strategy": "fixed",
    "backoff_interval": 60,
    "backoff_multiplier": 2.0,
    "min_gpu_memory_gb": 0,
    "min_gpu_utilization": 0.0,
    "biz_prefix": "custom_scheduling_example"
}
```

ç»“æœå­—æ®µè¯´æ˜

|å­—æ®µ     | ç±»å‹   |  è¯´æ˜           |
|----------|--------|----------------|
| task_id     | string |  ä»»åŠ¡å”¯ä¸€id     |
| biz_prefix     | string |  ä»»åŠ¡çš„ä¸šåŠ¡å‰ç¼€    |
| process     | int |  ä»»åŠ¡è¿›åº¦  |
| status     | string    |  ä»»åŠ¡çŠ¶æ€      |
| result | string    | ä»»åŠ¡çš„æ‰§è¡Œç»“æœ    |
| param | string |   ä»»åŠ¡çš„å‚æ•°      |
| retry_count | int |   é‡è¯•æ¬¡æ•°      |
| next_execution_time | int |   ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ |
| create_time | int |   åˆ›å»ºæ—¶é—´      |
| update_time | int |   æ›´æ–°æ—¶é—´      |
| max_retry_count | int |   æœ€å¤§é‡è¯•æ¬¡æ•°      |
| backoff_strategy | string |   é€€é¿ç±»å‹      |
| backoff_interval | int |   é€€é¿é—´éš”      |
| backoff_multiplier | int |      é€€é¿å€æ•°   |
| min_gpu_memory_gb | int |      éœ€è¦çš„æœ€å°GPUå†…å­˜   |
| min_gpu_utilization | int |      éœ€è¦çš„æœ€å°GPUä½¿ç”¨ç‡   |


## ğŸ“š API å‚è€ƒ

### ä»»åŠ¡ç®¡ç†

#### 1.åˆ›å»ºä»»åŠ¡

åˆ›å»ºä»»åŠ¡å¯é€‰æƒé‡å€¼ `priority` , ä¸ä¼ é»˜è®¤ä¼šä»¥ä¸ºå½“å‰æ—¶é—´ä¸ºæƒé‡å€¼å…ˆè¿›å…ˆå‡ºï¼›`priority` è¶Šå°è¶Šå…ˆæ‰§è¡Œ

```python
scheduler.create_task(
    task_params={"key": "value"},
    task_id="unique_task_id",
    priority=100
) -> Tuple[bool, message: str]
```

å‚æ•°å­—æ®µè¯´æ˜
| å­—æ®µ     | ç±»å‹ | å¿…å¡«   |  è¯´æ˜           |
|----------|--------|--------|----------------|
| task_params     |æ˜¯| dict |  ä»»åŠ¡çš„ä¸šåŠ¡å‚æ•°     |
| task_id     | æ˜¯ |string |  è‡ªå®šä¹‰çš„ä»»åŠ¡id    |
| priority     |å¦| int |  æƒé‡å€¼ï¼ˆä¸ä¼ é»˜è®¤ä¼šä»¥ä¸ºå½“å‰æ—¶é—´ä¸ºæƒé‡å€¼å…ˆè¿›å…ˆå‡ºï¼›è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰  |


#### 2.æŸ¥è¯¢ä»»åŠ¡

```python
scheduler.get_task(task_id) -> TaskEntity
```

#### 3.æ’¤é”€ä»»åŠ¡

- çº¿ç¨‹æ¨¡å¼ä¸‹æ’¤é”€ä»»åŠ¡ä»…ä¼šå˜æ›´ä»»åŠ¡çŠ¶æ€ä¸º `canceled`ï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ

- è¿›ç¨‹æ¨¡å¼ä¸‹ä¼šç›´æ¥å–æ¶ˆæ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡å¹¶å˜æ›´ä»»åŠ¡çŠ¶æ€

```python
scheduler.cancel_task(task_id) -> Tuple[bool, str]:
```

#### 4.è·å–é˜Ÿåˆ—ç»Ÿè®¡

```python
scheduler.get_queue_statistics() -> Dict[str, int]:
```

é˜Ÿåˆ—ç»Ÿè®¡ç»“æ„è¿”å›ç»“æœç¤ºä¾‹

```python
{
    "system_status": {
        "update_time": "2025-09-01 15:30:13"
    },
    "tasks": {
        "PENDING": {
            "total": 34,
            "queue": [
                "task_2728059290",
                "task_2829088805"
            ]
        },
        "DOING": {
            "total": 0,
            "queue": []
        },
        "DONE": {
            "total": 0,
            "queue": []
        },
        "FAILED": {
            "total": 0,
            "queue": []
        }
    }
}
```

å­—æ®µè¯´æ˜
| å­—æ®µ     | ç±»å‹   |  è¯´æ˜           |
|----------|--------|----------------|
| update_time     | string |  è¯·æ±‚æ—¶é—´    |
| tasks     | object |  ä»»åŠ¡é˜Ÿåˆ—ç»Ÿè®¡      |
| PENDING     | object |  ç­‰å¾…é˜Ÿåˆ—      |
| DOING     | object |  å¤„ç†ä¸­é˜Ÿåˆ—      |
| DONE     | object |  å·²å®Œæˆé˜Ÿåˆ—      |
| FAILED     | object |  å¤±è´¥é˜Ÿåˆ—      |
| total     | int  |  ä»»åŠ¡é˜Ÿåˆ—æˆå‘˜æ€»æ•°      | 
| queue     | list |  ä»»åŠ¡æˆå‘˜åˆ—è¡¨      |


### 5.æ›´ä»»åŠ¡çŠ¶æ€

```python
# æ ‡è®°ä»»åŠ¡å®Œæˆ
scheduler.mark_task_completed(task_id, "æ‰§è¡Œç»“æœ") -> bool

# æ ‡è®°ä»»åŠ¡å¤±è´¥
scheduler.mark_task_failed(task_id, "å¤±è´¥åŸå› ") -> bool

# æ ‡è®°ä»»åŠ¡å¤„ç†ä¸­
scheduler.mark_task_processing(task_id) -> bool
```

### 6.æ›´æ–°ä»»åŠ¡è¿›åº¦

```python
# æ›´æ–°ä»»åŠ¡è¿›åº¦
scheduler.update_task_progress(task_id, 75) -> bool # 75%
```

### 7.è°ƒåº¦å™¨æ§åˆ¶

å¦‚æœä¸æ˜¾ç¤ºæ‰§è¡Œ `scheduler.start()` åˆ™ä¸ä¼šå¯åŠ¨å®šæ—¶è°ƒåº¦ï¼Œåªæä¾› Task API çš„åŸºç¡€æ“ä½œ

```python
# å¯åŠ¨è°ƒåº¦å™¨
scheduler.start()

# å…³é—­è°ƒåº¦å™¨
scheduler.shutdown()
```

### 8.å¤„ç†å™¨ç®¡ç†

- ä»»åŠ¡å¤„ç†å™¨ ( `set_custom_task_handler` ): å¯é€‰è®¾ç½®ï¼Œå¤„ç†æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘

- å¼‚å¸¸å¤„ç†å™¨ ( `set_custom_task_exception_handler` ): å¯é€‰è®¾ç½®ï¼Œå¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µ

```python
# æ³¨å†Œä»»åŠ¡å¤„ç†å™¨ï¼ˆå¯é€‰ï¼‰
scheduler.set_custom_task_handler(task_handler)

# æ³¨å†Œå¼‚å¸¸å¤„ç†å™¨ï¼ˆå¯é€‰ï¼‰
scheduler.set_custom_task_exception_handler(exception_handler)
```

**å¤„ç†å™¨å‡½æ•°ç­¾å**

å¤„ç†å™¨å‚æ•°å¿…é¡»ä¸º `TaskEntity` ï¼Œå“åº”ç±»å‹å¿…é¡»ä¸º `ResultEntity`

```python
from backoff.scheduler.backoff_scheduler import (
    TaskEntity,
    ResultEntity,
)
def task_handler(task: TaskEntity) -> ResultEntity:
    # æ‚¨çš„ä¸šåŠ¡é€»è¾‘
    pass

def exception_handler(task: TaskEntity) -> ResultEntity:
    # å¼‚å¸¸å¤„ç†é€»è¾‘
    pass
```

#### è¿”å›å€¼ç¤ºä¾‹

**æˆåŠŸå¤„ç†:**

```python
return ResultEntity.ok(
    result={"status": "success", "data": "å¤„ç†ç»“æœ"},
    task_id=task.task_id,
)
```

**å¤±è´¥å¤„ç†:**
```python
return ResultEntity.fail(
    code=-1,
    message="ä»»åŠ¡æ‰§è¡Œå¤±è´¥",
    result={"error": "å…·ä½“é”™è¯¯ä¿¡æ¯"},
    task_id=task.task_id,
)
```


## âš™ï¸ é…ç½®è¯¦è§£

### StorageConfig (å­˜å‚¨é…ç½®)

| å‚æ•°     | ç±»å‹   | å¿…å¡« | é»˜è®¤å€¼    | è¯´æ˜           |
|----------|--------|------|-----------|----------------|
| type     | string | æ˜¯   | redis     | å­˜å‚¨ç±»å‹ï¼Œç›®å‰ä»…æ”¯æŒRedis      |
| host     | string | æ˜¯   |  localhost| Redisä¸»æœºåœ°å€  |
| port     | int    | æ˜¯   | 6379      | Redisç«¯å£      |
| database | int    | å¦   | 0         | Redisæ•°æ®åº“    |
| password | string | å¦   | ""        | Rediså¯†ç       |

**type å­˜å‚¨ç±»å‹:**

- `redis` : é»˜è®¤
- `mysql` : æš‚æœªæ”¯æŒ
- `è¾¾æ¢¦` : æš‚æœªæ”¯æŒ

### TaskConfig (ä»»åŠ¡é…ç½®)

| å‚æ•°                | ç±»å‹   | å¿…å¡« | é»˜è®¤å€¼        | è¯´æ˜                    |
|---------------------|--------|------|---------------|-------------------------|
| biz_prefix          | string | **æ˜¯**   | -         | ä¸šåŠ¡å”¯ä¸€æ ‡è¯†               |
| max_retry_count     | int    | å¦   | 3             | æœ€å¤§é‡è¯•æ¬¡æ•°            |
| backoff_strategy    | string | å¦   | exponential   | é€€é¿ç­–ç•¥                |
| backoff_interval    | int    | å¦   | 30            | åˆå§‹é€€é¿é—´éš”(ç§’)        |
| backoff_multiplier  | float  | å¦   | 2.0           | é€€é¿å€æ•°                |
| batch_size          | int    | å¦   | 100           | æ‰¹æ¬¡å¤§å°                |
| min_gpu_memory_gb   | float  | å¦   | 0             | æœ€å°GPUå†…å­˜(GB)         |
| min_gpu_utilization | int    | å¦   | 0             | æœ€å°GPUåˆ©ç”¨ç‡(%)        |

**backoff_strategy é€€é¿ç­–ç•¥è¯´æ˜:**

- `exponential` : æŒ‡æ•°é€€é¿ (é»˜è®¤)
- `fixed` : å›ºå®šé—´éš”é‡è¯•
- `linear` : çº¿æ€§é€€é¿

### ThreadPoolConfig (çº¿ç¨‹æ± é…ç½®)

| å‚æ•°          | ç±»å‹   | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜                    |
|---------------|--------|------|--------|-------------------------|
| concurrency   | int    | å¦   | 10     | å¹¶å‘çº¿ç¨‹/è¿›ç¨‹æ•°         |
| proc_mode     | string | å¦   | process | æ‰§è¡Œæ¨¡å¼                |
| exec_timeout  | int    | å¦   | 300    | ä»»åŠ¡è¶…æ—¶æ—¶é—´(ç§’)        |

**proc_mode æ‰§è¡Œæ¨¡å¼è¯´æ˜:**

- `thread` : çº¿ç¨‹æ± æ¨¡å¼
- `process` : è¿›ç¨‹æ± æ¨¡å¼ (é»˜è®¤)

çº¿ç¨‹æ± æ¨¡å¼ï¼Œä¸€æ—¦çº¿ç¨‹å¯åŠ¨åï¼Œçº¿ç¨‹å°†ä¼šæŒç»­è¿è¡Œï¼Œç›´åˆ°æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹å°†è¢«å›æ”¶ã€‚

è¿›ç¨‹æ± æ¨¡å¼ï¼Œå¦‚æœè¿›ç¨‹å†…ä¸šåŠ¡å¼‚å¸¸æˆ–è€…è¶…æ—¶ç­‰å¾…ï¼Œè¿›ç¨‹å°†è¢«æ”¶å›ã€‚

### SchedulerConfig (è°ƒåº¦å™¨é…ç½®)

| å‚æ•°     | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜           |
|----------|------|------|--------|----------------|
| interval | int  | å¦   | 10     | è½®è¯¢é—´éš”(ç§’)   |





