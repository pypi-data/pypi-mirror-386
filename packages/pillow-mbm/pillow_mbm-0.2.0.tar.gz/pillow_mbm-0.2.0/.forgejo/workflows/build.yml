name: build
on: [ push, pull_request ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-24.04
    env:
      UV_LINK_MODE: copy

    steps:
      - name: Checkout
        uses: https://code.forgejo.org/actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: https://code.forgejo.org/actions/setup-python@v6
        with:
          python-version: 3.14

      - name: Setup uv
        shell: bash
        run: | 
          if ! command -v uv >/dev/null 2>&1; then
            curl -LsSf https://astral.sh/uv/install.sh | sh
          else
            echo "uv already installed"
          fi
        env:
          UV_UNMANAGED_INSTALL: /usr/local/bin

      - name: Setup tea
        shell: bash
        run: |
          set -u
          if ! command tea 2>/dev/null; then
            TEA_BIN=/usr/local/bin/tea
            TEA_VERSION=0.11.0
            case $RUNNER_ARCH in
              ARM64)
                ARCH=arm64
              ;;
              X64)
                ARCH=amd64
              ;;
            esac
            curl -sL https://dl.gitea.io/tea/$TEA_VERSION/tea-$TEA_VERSION-linux-$ARCH -o $TEA_BIN
            chmod +x $TEA_BIN
          fi
          tea login add --url ${{ forge.server_url }} --token ${{ secrets.FORGEJO_TOKEN }}

      - name: Get Changelog Information
        id: yaclog-show
        uses: https://git.offworldcolonies.nexus/drewcassidy/yaclog@1.6.2

      - name: Run and check for errors
        run: uv run convert-mbm test/swis_mesh.mbm

      - name: Build
        run: uv build

      - uses: https://code.forgejo.org/forgejo/upload-artifact@v4
        with:
          name: python-distribution.zip
          path: dist/
          compression-level: 0 # already compressed

      - name: Create release
        if: forge.event_name == 'push' && startsWith(forge.ref, 'refs/tags')
        run: >
          tea release create 
          --repo "${{ forge.repository }}"
          --title "${{ steps.yaclog-show.outputs.name }}"
          --note-file "${{ steps.yaclog-show.outputs.body-file }}"
          "${{ forge.ref_name }}"

      - name: Upload artifacts to release
        if: forge.event_name == 'push' && startsWith(forge.ref, 'refs/tags')
        run: >
          tea release assets create 
          --repo "${{ forge.repository }}"
          "${{ forge.ref_name }}" dist/*

      - name: Upload to PyPI
        run: uv publish ${{ !(forge.event_name == 'push' && startsWith(forge.ref, 'refs/tags')) && '--dry-run' || ''}}
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}

      - name: Upload to Forgejo
        run: uv publish ${{ !(forge.event_name == 'push' && startsWith(forge.ref, 'refs/tags')) && '--dry-run' || ''}}
        env:
          UV_PUBLISH_USERNAME: ${{ forge.repository_owner }}
          UV_PUBLISH_PASSWORD: ${{ secrets.FORGEJO_TOKEN }}
          UV_PUBLISH_URL: ${{ forge.server_url }}/api/packages/${{ forge.repository_owner }}/pypi
          UV_PUBLISH_CHECK_URL: ${{ forge.server_url }}/api/packages/${{ forge.repository_owner }}/pypi