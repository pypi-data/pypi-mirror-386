---
- name: Stop  all Docker containers
  hosts: target_servers
  become: yes
  tasks:
  - name: Stop all running containers
    shell: |
      # Gracefully stop all containers with 30s timeout
      sudo docker stop -t 60 $(sudo docker ps -q)
    args:
      executable: /bin/bash
    register: stop_output
    changed_when: "'No such container' not in stop_output.stderr"
