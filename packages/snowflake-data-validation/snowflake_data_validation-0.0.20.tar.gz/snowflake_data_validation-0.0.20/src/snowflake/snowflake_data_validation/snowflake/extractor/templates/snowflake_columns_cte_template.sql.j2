{{ type_category }} AS (
    SELECT
        {% for metric, template in metrics.items() %}
        {{ template }} AS {{ metric }}{% if not loop.last %},{% endif %}
        {% endfor %}
    FROM {{ table_name }}
    {% if has_where_clause %} WHERE {{ where_clause }} {% endif %}
)
