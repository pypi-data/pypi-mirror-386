<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Taskiq Dashboard</title>
    <meta name="description" content="Main page of Taskiq Dashboard">
    <meta name="keywords" content="python, packages, projects, libraries">
    {% include "partial/head.html" %}
</head>
<body class="bg-ctp-base">
    {% include "partial/header.html" %}
    <main class="container mx-auto px-4 py-8">
        <div>
            <!-- Filter Section -->
            <section class="mb-6 p-5">
                <div id="filter-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <!-- Name Search -->
                    <div class="col-span-1 relative group text-ctp-subtext0 hover:text-ctp-subtext1 focus:text-ctp-subtext1">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none">
                            <use href="{{ url_for('static', path='icons.svg#search') }}"></use>
                        </svg>
                        <input
                            type="text"
                            name="search"
                            id="search"
                            class=" w-full pl-12 pr-4 py-2 border rounded focus:outline-none focus:ring-2 transition-all duration-200 hover:shadow-md border-ctp-subtext0 group-hover:border-ctp-subtext1 "
                            placeholder="Search by task name"
                            value="{{ filters.search }}"
                            hx-get="/"
                            hx-trigger="keyup changed delay:500ms"
                            hx-target="body"
                            hx-push-url="true"
                            hx-include="[name='status']"
                        >
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-6 p-2 pt-1 rounded-sm bg-ctp-lavender/10 text-sm"
                             title="Фокус на поисковой строке">/</div>
                    </div>

                    <!-- Status Filter -->
                    <div class="col-span-1 text-ctp-subtext0 hover:text-ctp-subtext1 focus:text-ctp-subtext1">
                        <select
                            id="status"
                            name="status"
                            class=" w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 transition-all duration-200 hover:shadow-md border-ctp-subtext0 group-hover:border-ctp-subtext1 "
                            hx-get="/"
                            hx-trigger="change"
                            hx-target="body"
                            hx-push-url="true"
                            hx-include="[name='search']"
                        >
                            <option class="bg-ctp-base" value="all" {% if filters.status == "all" %}selected{% endif %}>All Statuses</option>
                            <option class="bg-ctp-base" value="in progress" {% if filters.status == "in progress" %}selected{% endif %}>In Progress</option>
                            <option class="bg-ctp-base" value="completed" {% if filters.status == "completed" %}selected{% endif %}>Completed</option>
                            <option class="bg-ctp-base" value="failure" {% if filters.status == "failure" %}selected{% endif %}>Failure</option>
                            <option class="bg-ctp-base" value="queued" {% if filters.status == "queued" %}selected{% endif %}>Queued</option>
                        </select>
                    </div>


                </div>
            </section>

            <!-- Tasks Table -->
            <section class="overflow-x-auto">
                <table class="min-w-full divide-y divide-ctp-blue/20">
                    <thead class="">
                        <tr>
                            {% set headers = ['Task ID', 'Name', 'Status', 'Worker', 'Started At', 'Finished At'] %}
                            {% for header in headers %}
                                <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider">{{ header }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="divide-y text-ctp-text divide-ctp-blue/20">
                        {% if tasks %}
                            {% for task in tasks %}
                            <tr class="group whitespace-nowrap text-sm">
                                <td class="px-6 py-4 group-hover:bg-ctp-blue-100/20">
                                    <a href="/tasks/{{ task.id }}" class="text-ctp-text hover:text-ctp-subtext0">{{ task.id }}</a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm group-hover:bg-ctp-blue-100/20">{{ task.name }}</td>
                                <td class="px-6 py-3 whitespace-nowrap group-hover:bg-ctp-blue-100/20">
                                    <span
                                        class="px-2 py-1 inline-flex text-sm leading-5 rounded text-ctp-base bg-linear-to-br
                                            {% if task.status == 0 %} from-ctp-teal to-ctp-teal-600
                                            {% elif task.status == 1 %}from-ctp-green to-ctp-green-600
                                            {% elif task.status == 2 %}from-ctp-red to-ctp-red-600
                                            {% elif task.status == 3 %}from-ctp-blue to-ctp-blue-600{% endif %}"
                                    >
                                        {% if task.status == 0 %}In progress
                                        {% elif task.status == 1 %}Completed
                                        {% elif task.status == 2 %}Failure
                                        {% elif task.status == 3 %}Queued
                                        {% else %}Unknown{% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4 group-hover:bg-ctp-blue-100/20">{{ task.worker }}</td>
                                <td class="px-6 py-4 group-hover:bg-ctp-blue-100/20">{{ task.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td class="px-6 py-4 group-hover:bg-ctp-blue-100/20">
                                    {{ task.finished_at.strftime('%Y-%m-%d %H:%M:%S') if task.finished_at else '-' }}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-sm text-center">No tasks found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </section>

            <!-- Pagination -->
            {% if pagination.total_pages > 1 %}
            <section class="mt-6 flex items-center justify-between">
                <div class="text-sm text-ctp-subtext0">
                    Showing <span>{{ (pagination.page - 1) * pagination.per_page + 1 }}</span> to
                    <span>
                        {{ [pagination.page * pagination.per_page, pagination.total_count] | min }}
                    </span> of
                    <span">{{ pagination.total_count }}</span> tasks
                </div>

                <div>
                    <nav class="relative z-0 inline-flex rounded -space-x-px" aria-label="Pagination">
                        <!-- Previous page -->
                        {% if pagination.has_prev %}
                            <a href="?page={{ pagination.page - 1 }}{% for k, v in pagination.filter_params.items() %}&{{ k }}={{ v }}{% endfor %}"
                               class="relative inline-flex items-center px-2 py-2 rounded-l border border-ctp-blue/20 text-sm font-medium hover:bg-ctp-blue/20"
                               aria-label="Previous">
                                <span class="sr-only">Previous</span>
                                <svg class="h-4 w-4">
                                    <use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use>
                                </svg>
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-2 py-2 rounded-l border border-ctp-blue/20 text-sm font-medium cursor-not-allowed"
                                 aria-label="Previous disabled">
                                <span class="sr-only">Previous</span>
                                <svg class="h-4 w-4 text-ctp-base">
                                    <use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use>
                                </svg>
                            </span>
                        {% endif %}

                        <!-- Page numbers -->
                        {% for page_num in pagination.visible_pages %}
                            {% if page_num == -1 %}
                                <!-- Ellipsis -->
                                <span class="relative inline-flex items-center px-4 py-2 border border-ctp-blue/20 text-sm font-medium text-ctp-text">
                                    ...
                                </span>
                            {% else %}
                                <!-- Page number -->
                                <a href="?page={{ page_num }}{% for k, v in pagination.filter_params.items() %}&{{ k }}={{ v }}{% endfor %}"
                                   class="relative inline-flex items-center px-4 py-2 border border-ctp-blue/20 {% if page_num == pagination.page %}bg-ctp-blue-100 text-primary border-ctp-blue-600 z-10 text-ctp-base{% else %}text-ctp-text hover:bg-ctp-blue/20{% endif %} text-sm">
                                   {{ page_num }}
                                </a>
                            {% endif %}
                        {% endfor %}

                        <!-- Next page -->
                        {% if pagination.has_next %}
                            <a href="?page={{ pagination.page + 1 }}{% for k, v in pagination.filter_params.items() %}&{{ k }}={{ v }}{% endfor %}"
                               class="relative inline-flex items-center px-2 py-2 rounded-r border border-ctp-blue/20 text-sm font-medium hover:bg-ctp-blue/20"
                               aria-label="Next">
                                <span class="sr-only">Next</span>
                                <svg class="h-4 w-4 rotate-180">
                                    <use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use>
                                </svg>
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-2 py-2 rounded-r border border-ctp-blue/20  text-sm font-medium cursor-not-allowed"
                                aria-label="Next disabled">
                                <span class="sr-only">Next</span>
                                <svg class="h-4 w-4 rotate-180 text-ctp-base">
                                    <use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use>
                                </svg>
                            </span>
                        {% endif %}
                    </nav>
                </div>
            </section>
            {% endif %}
        </div>
    </main>
</body>
</html>
