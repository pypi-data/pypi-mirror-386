# ğŸ” PRæµ‹è¯•è¯¦è§£ï¼šVCR Cassetteç¦»çº¿æµ‹è¯•æœºåˆ¶

**é‡è¦ç­”æ¡ˆ**: âŒ **PRä¸­çš„pytest NOTä½¿ç”¨çœŸå®API Keyå’ŒçœŸå®API URL**

---

## ğŸ“‹ å®Œæ•´å·¥ä½œæµç¨‹

### PRè¿è¡Œçš„pytestæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     GitHub Actions åœ¨PRä¸Šè¿è¡Œ: pytest tests/test_paid_apis.py    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VCRè¯»å–cassetteæ–‡ä»¶ (tests/cassettes/*.yaml)           â”‚
â”‚                                                          â”‚
â”‚  âœ… tavily_search.yaml (å·²é¢„å½•åˆ¶)                       â”‚
â”‚  âœ… google_search.yaml (å·²é¢„å½•åˆ¶)                       â”‚
â”‚  âœ… brave_search.yaml (å·²é¢„å½•åˆ¶)                        â”‚
â”‚  âœ… serper_search.yaml (å·²é¢„å½•åˆ¶)                       â”‚
â”‚  âœ… metasota_search.yaml (å·²é¢„å½•åˆ¶)                     â”‚
â”‚  âœ… newsapi_search.yaml (å·²é¢„å½•åˆ¶)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VCRæ‹¦æˆªHTTPè¯·æ±‚ â†’ è¿”å›é¢„å½•åˆ¶çš„å“åº”ï¼ˆä¸è§¦ç½‘ï¼‰          â”‚
â”‚                                                          â”‚
â”‚ Mock API URL: https://localhost:33210/...               â”‚
â”‚ (æ‰€æœ‰è¯·æ±‚éƒ½è¢«VCRæ‹¦æˆª)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµ‹è¯•éªŒè¯å“åº”ç»“æœ âœ…                                    â”‚
â”‚  - æ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨æœ¬åœ°å½•åˆ¶æ•°æ®                           â”‚
â”‚  - æ— éœ€çœŸå®API Key                                     â”‚
â”‚  - æ— ç½‘ç»œè¯·æ±‚                                           â”‚
â”‚  - è¿è¡Œé€Ÿåº¦å¿«                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å…³é”®å®‰å…¨ç‰¹æ€§

### 1. VCRé…ç½®ï¼ˆconftest.pyï¼‰

```python
@pytest.fixture(scope="session")
def vcr_vcr(allow_network):
    """VCRå®ä¾‹é…ç½®"""
    return vcr.VCR(
        cassette_library_dir=_cassette_dir,
        record_mode=_get_record_mode(allow_network),  # â† å…³é”®
        filter_headers=["Authorization", "X-API-KEY"],  # â† è¿‡æ»¤æ•æ„Ÿå¤´
        filter_query_parameters=["apiKey", "key"],      # â† è¿‡æ»¤URLå‚æ•°
        match_on=["method", "path", "query"],
        decode_compressed_response=True,
    )
```

### 2. å½•åˆ¶æ¨¡å¼æ§åˆ¶

**GitHub Actionsä¸Šçš„è¡Œä¸º**ï¼ˆ.github/workflows/test-paid-apis.ymlï¼‰:

```yaml
# ç¯å¢ƒå˜é‡å®Œå…¨æœªè®¾ç½®ï¼Œæ‰€ä»¥ï¼š
# ALLOW_NETWORK = "0" (é»˜è®¤)
# UPDATE_CASSETTES ä¸å­˜åœ¨ (é»˜è®¤)

# å› æ­¤ record_mode = "none"
# â†“
# "none" = åªä½¿ç”¨cassettesï¼Œä¸æ‰§è¡Œä»»ä½•ç½‘ç»œè¯·æ±‚
```

**conftest.pyä¸­çš„é€»è¾‘**:

```python
def _get_record_mode(allow_net: bool) -> str:
    """
    - False (ä¸å…è®¸ç½‘ç»œ) â†’ "none" 
      = ç¦»çº¿æ¨¡å¼ï¼Œåªå›æ”¾cassette
      
    - True & UPDATE_CASSETTES=1 â†’ "all" 
      = é‡æ–°å½•åˆ¶æ¨¡å¼ï¼ˆä»…æœ¬åœ°å¼€å‘ï¼‰
      
    - True & UPDATE_CASSETTESæœªè®¾ â†’ "once" 
      = æ­£å¸¸æ¨¡å¼ï¼Œæœ‰cassetteç”¨cassetteï¼Œæ— åˆ™å½•åˆ¶
    """
    if not allow_net:
        return "none"  # â† GitHub Actionsä½¿ç”¨è¿™ä¸ª
    if os.getenv("UPDATE_CASSETTES", "0") == "1":
        return "all"
    return "once"
```

---

## ğŸ§ª å®é™…æµ‹è¯•æµç¨‹åˆ†è§£

### æµ‹è¯•ä»£ç ç¤ºä¾‹ï¼ˆtest_tavily_searchï¼‰

```python
@pytest.mark.asyncio
@pytest.mark.paid_api
async def test_tavily_search(vcr_vcr):
    """æµ‹è¯• Tavily API æœç´¢"""
    from ai_news_collector_lib.tools.search_tools import TavilyTool

    # â†“ APIå¯†é’¥å¤„ç†
    api_key = os.getenv("TAVILY_API_KEY")  # GitHub Actionsä¸Šä¸ºNone
    
    # â†“ ä½¿ç”¨çœŸå®å¯†é’¥æˆ–å ä½ç¬¦
    tool = TavilyTool(
        api_key=api_key or "test-api-key",  # ä½¿ç”¨å ä½ç¬¦
        max_articles=3
    )

    # â†“ VCRæ‹¦æˆªæ‰€æœ‰HTTPè¯·æ±‚
    with vcr_vcr.use_cassette("tavily_search.yaml"):
        # è¿™é‡Œè™½ç„¶è°ƒç”¨tool.search()ï¼Œä½†VCRä¼šï¼š
        # 1. æ‹¦æˆªHTTPè¯·æ±‚
        # 2. è¿”å›cassetteä¸­çš„é¢„å½•åˆ¶å“åº”
        # 3. ä¸è¿›è¡ŒçœŸå®ç½‘ç»œè¯·æ±‚
        articles = tool.search("artificial intelligence", days_back=7)

    # â†“ éªŒè¯å“åº”
    assert isinstance(articles, list)
    assert articles[0].title
    assert articles[0].source == "tavily"
```

### GitHub Actionsæ‰§è¡Œæ—¶çš„å…·ä½“æ­¥éª¤

```
Step 1: æ£€å‡ºä»£ç 
  â””â”€ git clone åˆ° CI ç¯å¢ƒ

Step 2: å®‰è£…ä¾èµ–
  â””â”€ pip install .[dev]
  â””â”€ åŒ…æ‹¬: pytest, pytest-asyncio, vcrpy, requests, ...

Step 3: è¿è¡Œæµ‹è¯•
  â””â”€ python -m pytest tests/test_paid_apis.py -v
  
  æ‰§è¡Œæµç¨‹:
  â”œâ”€ åŠ è½½ conftest.py
  â”‚  â””â”€ record_mode = "none" (å› ä¸ºALLOW_NETWORK=0)
  â”‚
  â”œâ”€ æ‰§è¡Œ test_tavily_search
  â”‚  â”œâ”€ åˆ›å»º TavilyTool(api_key="test-api-key")
  â”‚  â”œâ”€ VCR.use_cassette("tavily_search.yaml")
  â”‚  â”‚  â”œâ”€ è¯»å–cassetteæ–‡ä»¶
  â”‚  â”‚  â”œâ”€ æ‹¦æˆªtool.search()å†…çš„HTTPè¯·æ±‚
  â”‚  â”‚  â””â”€ è¿”å›é¢„å½•åˆ¶å“åº” (æ— ç½‘ç»œè¯·æ±‚)
  â”‚  â””â”€ éªŒè¯å“åº”
  â”‚
  â”œâ”€ æ‰§è¡Œ test_google_search
  â”‚  â””â”€ ... (åŒä¸Šæµç¨‹)
  â”‚
  â”œâ”€ ... (å…¶ä»–5ä¸ªæµ‹è¯•)
  â”‚
  â””â”€ æµ‹è¯•å®Œæˆ âœ…

Step 4: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
  â””â”€ --cov=ai_news_collector_lib.tools.search_tools
```

---

## âœ… PRä¸Šä¸ä½¿ç”¨çœŸå®APIçš„è¯æ®

### è¯æ®1: ç¯å¢ƒå˜é‡æœªè®¾ç½®

```yaml
# .github/workflows/test-paid-apis.yml
steps:
  - name: Run paid API tests (offline with cassettes)
    run: |
      python -m pytest tests/test_paid_apis.py -v
```

**æ³¨æ„**: æ²¡æœ‰ä»»ä½• `env:` éƒ¨åˆ†è®¾ç½®APIå¯†é’¥ âœ“

### è¯æ®2: VCRå½•åˆ¶æ¨¡å¼ä¸º"none"

```python
# conftest.py ä¸­çš„å†³ç­–

ALLOW_NETWORK = os.getenv("ALLOW_NETWORK", "0")  # é»˜è®¤ "0"
# â†“
record_mode = "none"  # ç¦»çº¿æ¨¡å¼
```

**"none"** æ¨¡å¼çš„å«ä¹‰:
- âŒ ä¸æ‰§è¡ŒçœŸå®ç½‘ç»œè¯·æ±‚
- âŒ ä¸ä½¿ç”¨çœŸå®API Key
- âœ… åªå›æ”¾cassettes
- âœ… å¦‚æœæœªæ‰¾åˆ°cassetteåˆ™å¤±è´¥ï¼ˆä¸å½•åˆ¶ï¼‰

### è¯æ®3: cassetteså·²é¢„å½•åˆ¶

æ‰€æœ‰cassetteæ–‡ä»¶éƒ½å·²å­˜åœ¨äºç‰ˆæœ¬æ§åˆ¶ä¸­:

```
tests/cassettes/
â”œâ”€ tavily_search.yaml ............ é¢„å½•åˆ¶ âœ…
â”œâ”€ google_search.yaml ............ é¢„å½•åˆ¶ âœ…
â”œâ”€ brave_search.yaml ............  é¢„å½•åˆ¶ âœ…
â”œâ”€ serper_search.yaml ............ é¢„å½•åˆ¶ âœ…
â”œâ”€ metasota_search.yaml .......... é¢„å½•åˆ¶ âœ…
â”œâ”€ newsapi_search.yaml ........... é¢„å½•åˆ¶ âœ…
â”œâ”€ basic_ai_hn_ddg.yaml .......... é¢„å½•åˆ¶ âœ…
â””â”€ advanced_ml_hn_ddg.yaml ....... é¢„å½•åˆ¶ âœ…
```

---

## ğŸ¯ ä¸‰ç§è¿è¡Œæ¨¡å¼å¯¹æ¯”

| åœºæ™¯ | ç¯å¢ƒå˜é‡ | VCRæ¨¡å¼ | ä½¿ç”¨çœŸå®API? | ç›®çš„ |
|------|---------|--------|-----------|------|
| **GitHub Actions (PR)** | æ—  | "none" | âŒ NO | ç¦»çº¿éªŒè¯ |
| **æœ¬åœ°å¼€å‘-é¦–æ¬¡å½•åˆ¶** | ALLOW_NETWORK=1<br/>UPDATE_CASSETTES=1 | "all" | âœ… YES | å½•åˆ¶cassette |
| **æœ¬åœ°å¼€å‘-æ—¥å¸¸æµ‹è¯•** | æ—  | "none" | âŒ NO | å¿«é€Ÿæµ‹è¯• |
| **æ›´æ–°cassette** | ALLOW_NETWORK=1<br/>UPDATE_CASSETTES=1 | "all" | âœ… YES | åˆ·æ–°æ•°æ® |

---

## ğŸ” å®‰å…¨æ€§æ€»ç»“

### âœ… PRæµ‹è¯•çš„å®‰å…¨ç‰¹æ€§

1. **æ— ç½‘ç»œè®¿é—®**
   - VCR record_mode = "none"
   - æ‰€æœ‰è¯·æ±‚éƒ½è¢«æ‹¦æˆª

2. **ä¸ä½¿ç”¨çœŸå®å¯†é’¥**
   - GitHub Actionsæœªé…ç½®APIå¯†é’¥
   - ä½¿ç”¨å ä½ç¬¦ "test-api-key"

3. **é¢„å½•åˆ¶cassettes**
   - å“åº”æ•°æ®åœ¨ä»“åº“ä¸­ä¿å­˜
   - æ°¸ä¸è¿‡æœŸï¼Œæ°¸ä¸å˜åŒ–

4. **å®Œå…¨ç¦»çº¿è¿è¡Œ**
   - PR CI/CDæ— éœ€ç½‘ç»œè¿æ¥
   - æµ‹è¯•è¿è¡Œå¿«é€Ÿä¸”å¯é 

5. **æ•æ„Ÿæ•°æ®è¿‡æ»¤**
   - cassettesä¸­å¯†é’¥å·²æ›¿æ¢ä¸º "FILTERED"
   - å®‰å…¨å­˜å‚¨åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­

### âŒ ä¸ä¼šå‘ç”Ÿ

- âŒ ä¸ä¼šè°ƒç”¨çœŸå®API
- âŒ ä¸ä¼šæ¶ˆè€—APIé…é¢
- âŒ ä¸ä¼šæ³„éœ²çœŸå®å¯†é’¥
- âŒ ä¸ä¼šæœ‰ç½‘ç»œå»¶è¿Ÿ
- âŒ ä¸ä¼šå› APIæ•…éšœè€Œå¤±è´¥

---

## ğŸ“Š æˆæœ¬åˆ†æ

### GitHub Actionsæˆæœ¬

```
PRæµ‹è¯•è¿è¡Œæˆæœ¬ (æ¯æ¬¡):
â”œâ”€ ä»£ç æ£€å‡º .................... <1ç§’
â”œâ”€ ä¾èµ–å®‰è£… .................... ~30ç§’
â”œâ”€ 7ä¸ªæµ‹è¯•æ‰§è¡Œ ................ ~5ç§’ (å…¨éƒ¨ç¦»çº¿)
â”‚  â”œâ”€ test_tavily_search ....... <1ç§’
â”‚  â”œâ”€ test_google_search ....... <1ç§’
â”‚  â”œâ”€ test_brave_search ........ <1ç§’
â”‚  â”œâ”€ test_serper_search ....... <1ç§’
â”‚  â”œâ”€ test_metasota_search ..... <1ç§’
â”‚  â”œâ”€ test_newsapi_search ...... <1ç§’
â”‚  â””â”€ test_paid_apis_advanced .. <1ç§’
â”œâ”€ è¦†ç›–ç‡ç”Ÿæˆ .................. ~10ç§’
â””â”€ ä¸Šä¼ ç»“æœ .................... ~2ç§’

æ€»è®¡: ~50ç§’

æˆæœ¬å¯¹æ¯”:
â”œâ”€ çœŸå®APIæµ‹è¯• ................ ~5-10åˆ†é’Ÿ(è¶…æ—¶é£é™©) âŒ
â”œâ”€ VCRç¦»çº¿æµ‹è¯• ................ ~1åˆ†é’Ÿ âœ…
â””â”€ èŠ‚çœ: 80-90% âœ…
```

---

## ğŸš€ æœ¬åœ°å¼€å‘æµç¨‹å‚è€ƒ

### é¦–æ¬¡å½•åˆ¶cassette (éœ€è¦çœŸå®å¯†é’¥)

```bash
# 1. é…ç½®.env
echo "TAVILY_API_KEY=tvly-xxxxx" >> .env
echo "ALLOW_NETWORK=1" >> .env
echo "UPDATE_CASSETTES=1" >> .env

# 2. è¿è¡Œæµ‹è¯•ï¼ˆä¼šå½•åˆ¶cassetteï¼‰
pytest tests/test_paid_apis.py::test_tavily_search -v

# 3. ç§»é™¤UPDATE_CASSETTES
# ï¼ˆåç»­ä¸è¦è¿™ä¸ªæ ‡å¿—ï¼‰

# 4. cassetteå·²ä¿å­˜åˆ°: tests/cassettes/tavily_search.yaml
```

### åç»­è¿è¡Œ (åªéœ€cassette)

```bash
# å®Œå…¨ç¦»çº¿ï¼Œæ— éœ€ä»»ä½•APIå¯†é’¥
pytest tests/test_paid_apis.py -v

# é€Ÿåº¦å¿«ï¼Œæ— ç½‘ç»œä¾èµ–
```

---

## ğŸ¯ å…³é”®è¦ç‚¹

### PRä¸Šçš„pytest:

| ç‰¹æ€§ | çŠ¶æ€ |
|------|------|
| ä½¿ç”¨çœŸå®API URL? | âŒ NO |
| ä½¿ç”¨çœŸå®API Key? | âŒ NO |
| è¿›è¡Œç½‘ç»œè¯·æ±‚? | âŒ NO |
| ä½¿ç”¨é¢„å½•åˆ¶æ•°æ®? | âœ… YES |
| å®Œå…¨ç¦»çº¿? | âœ… YES |
| å¿«é€Ÿè¿è¡Œ? | âœ… YES (~1min) |
| å¯é æ€§é«˜? | âœ… YES (100%) |
| APIé…é¢æ¶ˆè€—? | âœ… ZERO |

---

## ğŸ“ ç»“è®º

**PRä¸Šçš„pytestæµ‹è¯•**æ˜¯é€šè¿‡**VCR Cassette**å®ç°çš„å®Œå…¨**ç¦»çº¿æµ‹è¯•**:

1. âœ… **æ— çœŸå®APIè°ƒç”¨** - æ‰€æœ‰è¯·æ±‚éƒ½è¢«VCRæ‹¦æˆª
2. âœ… **æ— çœŸå®å¯†é’¥ä½¿ç”¨** - ä½¿ç”¨å ä½ç¬¦ "test-api-key"
3. âœ… **å¿«é€Ÿå¯é ** - ~50ç§’å®Œæˆï¼Œæ— ç½‘ç»œä¾èµ–
4. âœ… **å®‰å…¨** - cassettesä¸­æ•æ„Ÿæ•°æ®å·²è¿‡æ»¤
5. âœ… **å¯é‡ç°** - ç›¸åŒè¾“å…¥æ°¸è¿œå¾—åˆ°ç›¸åŒç»“æœ

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆPRä¸Šçš„æµ‹è¯•èƒ½å¤Ÿå¿«é€Ÿã€å¯é åœ°è¿è¡Œï¼ğŸ‰

