[tox]
envlist = typecheck,lint,format,func
# Before 4.3.3, the requires for tox plugins didnt work properly
# See: https://github.com/tox-dev/tox/issues/2862
min_version = 4.3.3
requires =
    tox-ignore-env-name-mismatch ~= 0.2.0
no_package=true

[pytest]
minversion = 6.0
addopts = -vs
testpaths =
    tests/unit

[common]
envdir = {work_dir}/common
runner = ignore_env_name_mismatch
deps =
    .
    .[test]

[testenv:typecheck]
envdir = {[common]envdir}
deps =
    {[common]deps}
runner = ignore_env_name_mismatch
commands =
    mypy --strict extencli

[testenv:lint]
envdir = {[common]envdir}
deps =
    {[common]deps}
runner = ignore_env_name_mismatch
commands =
    ruff check ./extencli

[testenv:format]
envdir = {[common]envdir}
deps =
    {[common]deps}
runner = ignore_env_name_mismatch
commands =
    ruff format --check ./extencli

[testenv:func]
envdir = {work_dir}/autoreset
allowlist_externals = sh
deps =
    -e .
commands =
    pip install -e ./tests/python_packages/test_core
    sh -c 'core --help 2>&1 | grep -v "ext"'
    sh -c 'core --help 2>&1 | grep -v "ext2"'
    pip install -e ./tests/python_packages/test_ext
    sh -c 'core --help 2>&1 | grep "ext"'
    sh -c 'core --help 2>&1 | grep -v "ext2"'
    pip install -e ./tests/python_packages/ext2
    sh -c 'core --help 2>&1 | grep "ext"'
    sh -c 'core --help 2>&1 | grep "ext2"'
