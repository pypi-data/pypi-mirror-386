# GitLab CI configuration for exeter
# A multi-language testing library with Python 3, Shell, and C support

stages:
  - test

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - builddir/

# Test matrix for multiple Python versions
.test-template: &test-template
  stage: test
  before_script:
    - apt-get update -qq && apt-get install -y -qq meson ninja-build gcc cppcheck clang-tidy rustc
    - pip install --upgrade pip meson-python "avocado-framework>=107.0"
  script:
    - meson setup builddir-$CI_JOB_NAME
    - meson compile -C builddir-$CI_JOB_NAME
    - meson test -C builddir-$CI_JOB_NAME --verbose --print-errorlogs
  artifacts:
    when: always
    paths:
      - builddir-$CI_JOB_NAME/meson-logs/testlog.junit.xml
    expire_in: 1 week
    reports:
      junit: builddir-$CI_JOB_NAME/meson-logs/testlog.junit.xml

.package-test-template: &package-test-template
  stage: test
  before_script:
    - apt-get update -qq && apt-get install -y -qq meson ninja-build
    - pip install --upgrade pip build twine meson-python
  script:
    - python -m build
    - pip install dist/*.whl
    - python -c "import exeter; print('Package import successful')"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

test-python-3.11:
  <<: *test-template
  image: python:3.11

test-python-3.12:
  <<: *test-template
  image: python:3.12

test-python-3.13:
  <<: *test-template
  image: python:3.13

package-test-python-3.11:
  <<: *package-test-template
  image: python:3.11

package-test-python-3.12:
  <<: *package-test-template
  image: python:3.12

package-test-python-3.13:
  <<: *package-test-template
  image: python:3.13
