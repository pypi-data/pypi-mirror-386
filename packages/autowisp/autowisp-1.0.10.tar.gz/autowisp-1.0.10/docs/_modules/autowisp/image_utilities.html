

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>autowisp.image_utilities &mdash; AutoWISP  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/unlimited_width.css?v=eea1f72d" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AutoWISP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#run-the-tests-optional">Run the Tests (optional)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../test_data.html">Example Usage: Processing the test data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Create-a-temporary-directory-to-work-in-(remember-to-delete-it-at-the-end),-enter-it,-and-get-its-path">Create a temporary directory to work in (remember to delete it at the end), enter it, and get its path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Download-the-test-data">Download the test data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-the-calibration-for-the-zero-frames">Perform the calibration for the zero frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Create-a-master-bias-by-stacking-the-calibrated-zero-frames">Create a master bias by stacking the calibrated zero frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-the-calibration-for-the-dark-frames">Perform the calibration for the dark frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Create-a-master-dark-by-stacking-the-calibrated-dark-images">Create a master dark by stacking the calibrated dark images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-calibration-for-flat-frames">Perform calibration for flat frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Build-a-master-flat-out-of-the-individual-calibrated-flat-frames">Build a master flat out of the individual calibrated flat frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-calibration-for-object-frames">Perform calibration for object frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Find-stars-in-the-calibrated-object-frames">Find stars in the calibrated object frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-astrometry-on-DR-files">Perform astrometry on DR files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-PSF/PRF-fitting">Perform PSF/PRF fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-aperture-photometry">Perform aperture photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Run-fit-source-extracted-PSF-map">Run fit source extracted PSF map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-magnitude-fitting">Perform magnitude fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Create-light-curves">Create light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-EPD-on-light-curves">Perform EPD on light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Generate-EPD-statistics-file-for-light-curves">Generate EPD statistics file for light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Perform-TFA-on-light-curves">Perform TFA on light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Generate-TFA-statistics-file-for-light-curves">Generate TFA statistics file for light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../test_data.html#Extract-brightness-vs-time-from-lightcurves">Extract brightness vs time from lightcurves</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../processing_steps.html">Pipeline Steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#split-raw-frames-by-type">Split Raw Frames by Type:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#image-calibration">1. Image Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#find-stars">2. Find Stars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#astrometry">3. Astrometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#prf-psf-fitting">4. PRF/PSF Fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#aperture-photometry">5. Aperture Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#fit-psf-map-to-extracted-stars">6. Fit PSF Map to Extracted Stars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#magnitude-fitting">7. Magnitude fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#creating-lightcurves">8. Creating Lightcurves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#external-parameter-decorrelation-epd">9. External Parameter Decorrelation (EPD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing_steps.html#trend-filtering-algorithm-tfa">10. Trend Filtering Algorithm (TFA)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../wisp_options.html">Configuration Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implementation/autowisp.html">autowisp package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../implementation/autowisp.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../implementation/autowisp.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../implementation/autowisp.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AutoWISP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">autowisp.image_utilities</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for autowisp.image_utilities</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;A collection of functions for working with pipeline images.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.interpolate</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astrowisp.utils.file_utilities</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">prepare_file_output</span><span class="p">,</span>
    <span class="n">get_fname_pattern_substitutions</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autowisp.pipeline_exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">BadImageError</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">git_id</span> <span class="o">=</span> <span class="s2">&quot;$Id: 688e202458f7084d6c407c222ef25a2570babe21 $&quot;</span>


<span class="c1"># pylint: disable=anomalous-backslash-in-string</span>
<span class="c1"># Triggers on doxygen commands.</span>
<div class="viewcode-block" id="zoom_image">
<a class="viewcode-back" href="../../implementation/autowisp.image_utilities.html#autowisp.image_utilities.zoom_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zoom_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">interp_order</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Increase the resolution of an image using flux conserving interpolation.</span>

<span class="sd">    Interpolation is performed using the following recipe:</span>

<span class="sd">        1.  create a cumulative image (C), i.e. C(x, y) = sum(</span>
<span class="sd">            image(x&#39;, y&#39;), {x&#39;, 0, x}, {y&#39;, 0, y}). Note that C&#39;s x and y</span>
<span class="sd">            resolutions are both bigger than image&#39;s by one with all entries in</span>
<span class="sd">            the first row and the first column being zero.</span>

<span class="sd">        2.  Interpolate the cumulative image using a bivariate spline to get a</span>
<span class="sd">            continuous cumulative flux F(x, y).</span>

<span class="sd">        3.  Create the final image I by setting each pixel to the flux implied</span>
<span class="sd">            by F(x, y) from step 2, i.e. if zx is the zoom factor along x and zy</span>
<span class="sd">            is the zoom factor along y::</span>

<span class="sd">                I(x, y) = F((x+1)/z, (y+1)/z)</span>
<span class="sd">                          - F((x+1)/z, y/z)</span>
<span class="sd">                          - F(x/z, (y+1)/z)</span>
<span class="sd">                          + F(x/z, y/z)</span>

<span class="sd">    Since this is a flux conserving method, zooming and then binning an image</span>
<span class="sd">    reproduces the original image with close to machine precision.</span>

<span class="sd">    Args:</span>
<span class="sd">        image:    The image to zoom.</span>

<span class="sd">        zoom:    The factor(s) by which to zoom the image. Should be either an</span>
<span class="sd">            integer defining a common zoom factor both dimensions or a pair of</span>
<span class="sd">            numbers, specifying the zoom along each axis (y first, then x).</span>

<span class="sd">        interp_order:    The order of the interpolation of the cumulative array.</span>

<span class="sd">    Returns:</span>
<span class="sd">        2-D array:</span>
<span class="sd">            The zoomed image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">x_zoom</span><span class="p">,</span> <span class="n">y_zoom</span> <span class="o">=</span> <span class="n">zoom</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">x_zoom</span> <span class="o">=</span> <span class="n">y_zoom</span> <span class="o">=</span> <span class="n">zoom</span>

    <span class="k">if</span> <span class="n">x_zoom</span> <span class="o">==</span> <span class="n">y_zoom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="n">y_res</span><span class="p">,</span> <span class="n">x_res</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># False positive</span>
    <span class="c1"># pylint: disable=no-member</span>
    <span class="n">cumulative_image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># pylint: enable=no-member</span>
    <span class="n">cumulative_image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cumulative_image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># False positive</span>
    <span class="c1"># pylint: disable=no-member</span>
    <span class="n">cumulative_image</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># pylint: enable=no-member</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">spline_kx</span><span class="p">,</span> <span class="n">spline_ky</span> <span class="o">=</span> <span class="n">interp_order</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">spline_kx</span> <span class="o">=</span> <span class="n">spline_ky</span> <span class="o">=</span> <span class="n">interp_order</span>

    <span class="n">cumulative_flux</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span>
        <span class="c1"># False positive</span>
        <span class="c1"># pylint: disable=no-member</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># pylint: enable=no-member</span>
        <span class="n">cumulative_image</span><span class="p">,</span>
        <span class="n">kx</span><span class="o">=</span><span class="n">spline_kx</span><span class="p">,</span>
        <span class="n">ky</span><span class="o">=</span><span class="n">spline_ky</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">cumulative_image</span> <span class="o">=</span> <span class="n">cumulative_flux</span><span class="p">(</span>
        <span class="c1"># False positive</span>
        <span class="c1"># pylint: disable=no-member</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_res</span> <span class="o">*</span> <span class="n">y_zoom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_zoom</span><span class="p">,</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_res</span> <span class="o">*</span> <span class="n">x_zoom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_zoom</span><span class="p">,</span>
        <span class="c1"># pylint: enable=no-member</span>
        <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># False positive</span>
    <span class="c1"># pylint: disable=no-member</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cumulative_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="c1"># pylint: enable=no-member</span>


<span class="c1"># pylint: enable=anomalous-backslash-in-string</span>


<div class="viewcode-block" id="bin_image">
<a class="viewcode-back" href="../../implementation/autowisp.image_utilities.html#autowisp.image_utilities.bin_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bin_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bin_factor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bins the image to a lower resolution (must be exact factor of image shape).</span>

<span class="sd">    The output pixels are the sum of the pixels in each bin.</span>

<span class="sd">    Args:</span>
<span class="sd">        image:    The image to bin.</span>

<span class="sd">        bin_factor:    Either a single integer in which case this is the binning</span>
<span class="sd">            in both directions, or a pair of integers, specifying different</span>
<span class="sd">            binnin in each direction.</span>

<span class="sd">    Returns:</span>
<span class="sd">        2-D array:</span>
<span class="sd">            The binned image with a resolution decreased by the binning factor</span>
<span class="sd">            for each axis, which has the same total flux as the input image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">x_bin_factor</span><span class="p">,</span> <span class="n">y_bin_factor</span> <span class="o">=</span> <span class="n">bin_factor</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">x_bin_factor</span> <span class="o">=</span> <span class="n">y_bin_factor</span> <span class="o">=</span> <span class="n">bin_factor</span>

    <span class="k">if</span> <span class="n">x_bin_factor</span> <span class="o">==</span> <span class="n">y_bin_factor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="n">y_res</span><span class="p">,</span> <span class="n">x_res</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">assert</span> <span class="n">x_res</span> <span class="o">%</span> <span class="n">x_bin_factor</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">y_res</span> <span class="o">%</span> <span class="n">y_bin_factor</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">y_res</span> <span class="o">//</span> <span class="n">y_bin_factor</span><span class="p">,</span>
                <span class="n">y_bin_factor</span><span class="p">,</span>
                <span class="n">x_res</span> <span class="o">//</span> <span class="n">x_bin_factor</span><span class="p">,</span>
                <span class="n">x_bin_factor</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="get_pointing_from_header">
<a class="viewcode-back" href="../../implementation/autowisp.image_utilities.html#autowisp.image_utilities.get_pointing_from_header">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_pointing_from_header</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the sky coordinates of this frame&#39;s pointing per its header.</span>

<span class="sd">    Args:</span>
<span class="sd">        frame:    The frame to return the pointing of. Could be in one of the</span>
<span class="sd">            following formats:</span>

<span class="sd">              * string: the filanema of a FITS frame. The pointing information</span>
<span class="sd">                  is extracted from the header of the first non-trivial HDU.</span>

<span class="sd">              * HDUList: Same as above, only this time the file is</span>
<span class="sd">                  already opened.</span>

<span class="sd">              * astropy.io.fits ImageHDU or TableHDU, containing the header to</span>
<span class="sd">                  extract the pointing information from.</span>

<span class="sd">              * asrtopy.io.fits.Header instance: the header from which to</span>
<span class="sd">                  extract the pointing information.</span>

<span class="sd">    Returns:</span>
<span class="sd">        astropy.coordinates.SkyCoord:</span>
<span class="sd">            The frame pointing information contained in the header.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">get_pointing_from_header</span><span class="p">(</span><span class="n">hdulist</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">frame</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">get_pointing_from_header</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">BadImageError</span><span class="p">(</span>
            <span class="s2">&quot;FITS file &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; contains only trivial HDUs&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;header&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_pointing_from_header</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">15.0</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="zscale_image">
<a class="viewcode-back" href="../../implementation/autowisp.image_utilities.html#autowisp.image_utilities.zscale_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zscale_image</span><span class="p">(</span><span class="n">image_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the given image ZScaled to 8 bits.&quot;&quot;&quot;</span>

    <span class="n">zscale_min</span><span class="p">,</span> <span class="n">zscale_max</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="mi">255</span>
        <span class="o">*</span> <span class="p">(</span>
            <span class="c1"># False positive</span>
            <span class="c1"># pylint: disable=no-member</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">zscale_min</span><span class="p">,</span> <span class="n">image_data</span><span class="p">),</span> <span class="n">zscale_max</span><span class="p">)</span>
            <span class="c1"># pylint: enable=no-member</span>
            <span class="o">-</span> <span class="n">zscale_min</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">zscale_max</span> <span class="o">-</span> <span class="n">zscale_min</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
        <span class="c1"># False positive</span>
        <span class="c1"># pylint: disable=no-member</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span>
        <span class="c1"># pylint: enable=no-member</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="create_snapshot">
<a class="viewcode-back" href="../../implementation/autowisp.image_utilities.html#autowisp.image_utilities.create_snapshot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_snapshot</span><span class="p">(</span>
    <span class="n">fits_fname</span><span class="p">,</span>
    <span class="n">snapshot_fname_pattern</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">image_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">create_directories</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a snapshot (e.g. JPEG image) from a fits file in zscale.</span>

<span class="sd">    Args:</span>
<span class="sd">        fits_fname(str):    The FITS image to create a snapshot of.</span>

<span class="sd">        snapshot_fname_pattern(str):    A %-substitution pattern that when</span>
<span class="sd">            filled using the header and the extra keyword FITS_ROOT (set to the</span>
<span class="sd">            filename of the FITS file with path and extension removed) expands</span>
<span class="sd">            to the filename to save the snapshot as.</span>

<span class="sd">        image_index(int):    Offset from the first non-empty HDU in the FITS</span>
<span class="sd">            file to make a snapshot of.</span>

<span class="sd">        overwrite(bool):    If a file called `snapshot_fname` already exists, an</span>
<span class="sd">            `OSError` is raised if this argument and `skip_existing` are both</span>
<span class="sd">            False (default). That file is overwritten if this argument is True</span>
<span class="sd">            and `skip_existing` is False.</span>

<span class="sd">        skip_existing(bool):    If True and a file already exists with the name</span>
<span class="sd">            determined for the snapshot, this function exists immediately</span>
<span class="sd">            without error.</span>

<span class="sd">        create_directories(bool):    Whether the script is allowed to create</span>
<span class="sd">            the directories where the output snapshot will be stored. `OSError`</span>
<span class="sd">            is raised if this argument is False and the destination directory</span>
<span class="sd">            does not exist.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_fname</span><span class="p">,</span> <span class="s2">&quot;readonly&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits_image</span><span class="p">:</span>
        <span class="c1"># False positive</span>
        <span class="c1"># pylint: disable=no-member</span>
        <span class="n">fits_hdu</span> <span class="o">=</span> <span class="n">fits_image</span><span class="p">[</span>
            <span class="n">image_index</span> <span class="k">if</span> <span class="n">fits_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="c1"># pylint: enable=no-member</span>
        <span class="n">snapshot_fname</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">snapshot_fname_pattern</span>
            <span class="o">%</span> <span class="n">get_fname_pattern_substitutions</span><span class="p">(</span><span class="n">fits_fname</span><span class="p">,</span> <span class="n">fits_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">snapshot_exists</span> <span class="o">=</span> <span class="n">prepare_file_output</span><span class="p">(</span>
            <span class="n">snapshot_fname</span><span class="p">,</span>
            <span class="n">allow_existing</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
            <span class="n">allow_dir_creation</span><span class="o">=</span><span class="n">create_directories</span><span class="p">,</span>
            <span class="n">delete_existing</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">snapshot_exists</span> <span class="ow">and</span> <span class="n">skip_existing</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Snapshot </span><span class="si">%s</span><span class="s2"> already exists, skipping!&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">snapshot_fname</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">scaled_data</span> <span class="o">=</span> <span class="n">zscale_image</span><span class="p">(</span><span class="n">fits_hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">snapshot_fname</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating snapshot: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">snapshot_fname</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Kaloyan Penev.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>