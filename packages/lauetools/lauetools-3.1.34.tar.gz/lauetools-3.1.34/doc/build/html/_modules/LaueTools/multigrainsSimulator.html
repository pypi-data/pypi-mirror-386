

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LaueTools.multigrainsSimulator &mdash; LaueTools  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> LaueTools
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getStarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GUIs.html">Graphical User Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LaueToolsModules.html">LaueTools Modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LaueTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>LaueTools.multigrainsSimulator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for LaueTools.multigrainsSimulator</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to compute Laue Patterns from several crystals in various geometry</span>

<span class="sd">Main author is J. S. Micha:   micha [at] esrf [dot] fr</span>

<span class="sd">version July 2019</span>
<span class="sd">from LaueTools package for python2 hosted in</span>

<span class="sd">http://sourceforge.net/projects/lauetools/</span>

<span class="sd">or for python3 and 2 in</span>

<span class="sd">https://gitlab.esrf.fr/micha/lauetools</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">dict_LaueTools</span> <span class="k">as</span> <span class="n">DictLT</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">generaltools</span> <span class="k">as</span> <span class="n">GT</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">lauecore</span> <span class="k">as</span> <span class="n">LAUE</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">LaueGeometry</span> <span class="k">as</span> <span class="n">LTGeo</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">CrystalParameters</span> <span class="k">as</span> <span class="n">CP</span>

<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dict_LaueTools</span> <span class="k">as</span> <span class="nn">DictLT</span>
    <span class="kn">import</span> <span class="nn">generaltools</span> <span class="k">as</span> <span class="nn">GT</span>
    <span class="kn">import</span> <span class="nn">lauecore</span> <span class="k">as</span> <span class="nn">LAUE</span>
    <span class="kn">import</span> <span class="nn">LaueGeometry</span> <span class="k">as</span> <span class="nn">LTGeo</span>
    <span class="kn">import</span> <span class="nn">CrystalParameters</span> <span class="k">as</span> <span class="nn">CP</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">WXPYTHON</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="kn">import</span> <span class="nn">wx</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">WXPYTHON</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Read_GrainListparameter"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.multigrainsSimulator.Read_GrainListparameter">[docs]</a><span class="k">def</span> <span class="nf">Read_GrainListparameter</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read dictionary of  input key parameters for simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Elem, Extinc, Transf_a, Rot, Bmatrix, Transf_c, GrainName, transform = param</span>
    <span class="n">key_material</span><span class="p">,</span> <span class="n">Extinc</span><span class="p">,</span> <span class="n">Transf_a</span><span class="p">,</span> <span class="n">Rot</span><span class="p">,</span> <span class="n">Bmatrix</span><span class="p">,</span> <span class="n">Transf_c</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">GrainName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
    <span class="c1"># print &quot;param in Read_GrainListparameter&quot;,param</span>

    <span class="n">Extinctions</span> <span class="o">=</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">dict_Extinc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Extinc</span><span class="p">)]</span>
    <span class="n">Transform_labframe</span> <span class="o">=</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">dict_Transforms</span><span class="p">[</span><span class="n">Transf_a</span><span class="p">]</span>
    <span class="n">orientMatrix</span> <span class="o">=</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">dict_Rot</span><span class="p">[</span><span class="n">Rot</span><span class="p">]</span>
    <span class="n">B_matrix</span> <span class="o">=</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">dict_Vect</span><span class="p">[</span><span class="n">Bmatrix</span><span class="p">]</span>
    <span class="n">Transform_crystalframe</span> <span class="o">=</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">dict_Transforms</span><span class="p">[</span><span class="n">Transf_c</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">([</span><span class="n">key_material</span><span class="p">,</span> <span class="n">Extinctions</span><span class="p">,</span> <span class="n">Transform_labframe</span><span class="p">,</span> <span class="n">orientMatrix</span><span class="p">,</span> <span class="n">B_matrix</span><span class="p">,</span> <span class="n">Transform_crystalframe</span><span class="p">],</span>
            <span class="n">GrainName</span><span class="p">,</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Construct_GrainsParameters_parametric"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.multigrainsSimulator.Construct_GrainsParameters_parametric">[docs]</a><span class="k">def</span> <span class="nf">Construct_GrainsParameters_parametric</span><span class="p">(</span><span class="n">SelectGrains_parametric</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return list of simulation parameters for each grain set (mother and children grains)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list_selectgrains_param</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># keys from dialogs were in reverse order</span>
    <span class="c1"># self.SelectGrains_parametric  == parametric_Grain_Dialog().SelectGrains</span>
    <span class="k">for</span> <span class="n">key_grain</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">SelectGrains_parametric</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># print &quot;self.SelectGrains_parametric[key_grain]&quot;,self.SelectGrains_parametric[key_grain]</span>
        <span class="n">list_selectgrains_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Read_GrainListparameter</span><span class="p">(</span><span class="n">SelectGrains_parametric</span><span class="p">[</span><span class="n">key_grain</span><span class="p">]))</span>
    <span class="c1"># print list_selectgrains_param</span>
    <span class="k">return</span> <span class="n">list_selectgrains_param</span></div>


<div class="viewcode-block" id="dosimulation_parametric"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.multigrainsSimulator.dosimulation_parametric">[docs]</a><span class="k">def</span> <span class="nf">dosimulation_parametric</span><span class="p">(</span><span class="n">_list_param</span><span class="p">,</span> <span class="n">Transform_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SelectGrains</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span>
                                                            <span class="n">emin</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                                                            <span class="n">detectordistance</span><span class="o">=</span><span class="mf">68.7</span><span class="p">,</span>
                                                            <span class="n">detectordiameter</span><span class="o">=</span><span class="mf">165.0</span><span class="p">,</span>
                                                            <span class="n">posCEN</span><span class="o">=</span><span class="p">(</span><span class="mf">1024.0</span><span class="p">,</span> <span class="mf">1024.0</span><span class="p">),</span>
                                                            <span class="n">cameraAngles</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                                                            <span class="n">gauge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">kf_direction</span><span class="o">=</span><span class="s2">&quot;Z&gt;0&quot;</span><span class="p">,</span>
                                                            <span class="n">pixelsize</span><span class="o">=</span><span class="mf">165.0</span> <span class="o">/</span> <span class="mi">2048</span><span class="p">,</span>
                                                            <span class="n">dictmaterials</span><span class="o">=</span><span class="n">DictLT</span><span class="o">.</span><span class="n">dict_Materials</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulation of orientation or deformation gradient.</span>
<span class="sd">    From parent grain simulate a list of transformations (deduced by a parametric variation)</span>

<span class="sd">    _list_param   : list of parameters for each grain  [grain parameters, grain name]</span>

<span class="sd">    posCEN =(Xcen, Ycen)</span>
<span class="sd">    cameraAngles =(Xbet, Xgam)</span>

<span class="sd">    :return: (list_twicetheta,</span>
<span class="sd">                list_chi,</span>
<span class="sd">                list_energy,</span>
<span class="sd">                list_Miller,</span>
<span class="sd">                list_posX,</span>
<span class="sd">                list_posY,</span>
<span class="sd">                ParentGrainName_list,</span>
<span class="sd">                list_ParentGrain_transforms,</span>
<span class="sd">                calib,</span>
<span class="sd">                total_nb_grains)</span>

<span class="sd">    TODO:simulate for any camera position</span>
<span class="sd">    TODO: simulate spatial distribution of laue pattern origin</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">********* Starting dosimulation_parametric *********</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Number_ParentGrains parent grains</span>
    <span class="n">Number_ParentGrains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list_param</span><span class="p">)</span>

    <span class="c1"># Extracting parent grains  simluation param and name</span>
    <span class="c1"># creating list of simulation parameters for parent grains</span>
    <span class="n">ListParam</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ParentGrainName_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Number_ParentGrains</span><span class="p">):</span>
        <span class="c1"># print &quot;_list_param[m]&quot;, _list_param[m]</span>
        <span class="n">_paramsimul</span><span class="p">,</span> <span class="n">_grainname</span> <span class="o">=</span> <span class="n">_list_param</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

        <span class="n">elem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_paramsimul</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c1"># print &quot;elem parametric&quot;,elem</span>

        <span class="c1"># convert EULER angles to matrix in case of  3 input elements</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_paramsimul</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="n">_paramsimul</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">fromEULERangles_toMatrix</span><span class="p">(</span><span class="n">_paramsimul</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">ListParam</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_paramsimul</span><span class="p">)</span>
        <span class="n">ParentGrainName_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_grainname</span><span class="p">)</span>

    <span class="c1">#            print &quot;ListParam in dosimulation_parametric&quot;, ListParam</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ParentGrainName_list&quot;</span><span class="p">,</span> <span class="n">ParentGrainName_list</span><span class="p">)</span>

    <span class="c1"># Calculating Laue spots of each parent grain ----------------------------</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Doing simulation with </span><span class="si">%d</span><span class="s2"> parent grains&quot;</span> <span class="o">%</span> <span class="n">Number_ParentGrains</span><span class="p">)</span>
    <span class="n">list_twicetheta</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_chi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_energy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_Miller</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_posX</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_posY</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">total_nb_grains</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># list of [Parent grain index,Number of corresponding transforms, transform_type]</span>
    <span class="n">list_ParentGrain_transforms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">gauge</span> <span class="ow">and</span> <span class="n">WXPYTHON</span><span class="p">:</span>
        <span class="n">gaugecount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gauge</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">gaugecount</span><span class="p">)</span>
        <span class="c1"># gauge count max has been set to 1000*Number_ParentGrains</span>

    <span class="c1"># loop over parent grains</span>
    <span class="k">for</span> <span class="n">parentgrain_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Number_ParentGrains</span><span class="p">):</span>

        <span class="c1"># read simulation parameters</span>
        <span class="n">name_of_grain</span> <span class="o">=</span> <span class="n">ParentGrainName_list</span><span class="p">[</span><span class="n">parentgrain_index</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> </span><span class="si">%d</span><span class="s2">, name_of_grain: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parentgrain_index</span><span class="p">,</span> <span class="n">name_of_grain</span><span class="p">))</span>

        <span class="n">Laue_classic_param</span> <span class="o">=</span> <span class="n">ListParam</span><span class="p">[</span><span class="n">parentgrain_index</span><span class="p">]</span>

        <span class="n">key_material</span><span class="p">,</span> <span class="n">Extinc</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Tc</span> <span class="o">=</span> <span class="n">Laue_classic_param</span>  <span class="c1"># from combos</span>

        <span class="c1"># build GrainSimulParam</span>
        <span class="n">GrainSimulParam</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># user has entered his own B matrix</span>
        <span class="k">if</span> <span class="n">key_material</span> <span class="o">==</span> <span class="s2">&quot;inputB&quot;</span><span class="p">:</span>
            <span class="c1"># print &quot;\n**************&quot;</span>
            <span class="c1"># print &quot;using Bmatrix containing lattice parameter&quot;</span>
            <span class="c1"># print &quot;****************\n&quot;</span>

            <span class="c1"># take then parameters from combos</span>
            <span class="n">GrainSimulParam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span>
            <span class="n">GrainSimulParam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Extinc</span>
            <span class="n">GrainSimulParam</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ta</span><span class="p">,</span> <span class="n">U</span><span class="p">),</span> <span class="n">Tc</span><span class="p">)</span>
            <span class="n">GrainSimulParam</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inputB&quot;</span>

        <span class="c1"># user uses a pre defined B matrix contain in material dictionnary</span>
        <span class="c1"># (need to read lattice parameter or element definition</span>
        <span class="c1"># then compute B matrix)</span>
        <span class="k">elif</span> <span class="n">key_material</span> <span class="o">!=</span> <span class="s2">&quot;inputB&quot;</span><span class="p">:</span>

            <span class="n">grain</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">Prepare_Grain</span><span class="p">(</span><span class="n">key_material</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">dictmaterials</span><span class="o">=</span><span class="n">dictmaterials</span><span class="p">)</span>

            <span class="c1"># print &quot;grain in dosimulation_parametric() input Element&quot;,grain</span>

            <span class="c1"># B0, Extinc0, U0, key = grain  # U0 is identity</span>
            <span class="n">B0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">U0</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">grain</span>  <span class="c1"># U0 is identity</span>

            <span class="c1"># new B matrix</span>
            <span class="n">newB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Tc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">B0</span><span class="p">))</span>
            <span class="c1"># Extinction is overwritten by value in comboExtinc</span>
            <span class="n">newExtinc</span> <span class="o">=</span> <span class="n">Extinc</span>
            <span class="c1"># new U matrix</span>
            <span class="n">newU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ta</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">U0</span><span class="p">))</span>

            <span class="n">GrainSimulParam</span> <span class="o">=</span> <span class="p">[</span><span class="n">newB</span><span class="p">,</span> <span class="n">newExtinc</span><span class="p">,</span> <span class="n">newU</span><span class="p">,</span> <span class="n">key_material</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using following parameters from Material Dict.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">DictLT</span><span class="o">.</span><span class="n">dict_Materials</span><span class="p">[</span><span class="n">key_material</span><span class="p">])</span>

        <span class="c1"># --- Simulate</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GrainSimulParam in dosimulation_parametric() input Element&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">GrainSimulParam</span><span class="p">)</span>

        <span class="n">spots2pi</span> <span class="o">=</span> <span class="n">LAUE</span><span class="o">.</span><span class="n">getLaueSpots</span><span class="p">(</span><span class="n">DictLT</span><span class="o">.</span><span class="n">CST_ENERGYKEV</span> <span class="o">/</span> <span class="n">emax</span><span class="p">,</span>
                                        <span class="n">DictLT</span><span class="o">.</span><span class="n">CST_ENERGYKEV</span> <span class="o">/</span> <span class="n">emin</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">GrainSimulParam</span><span class="p">],</span>  <span class="c1"># bracket because of a list of one grain</span>
                                        <span class="p">[[</span><span class="s2">&quot;&quot;</span><span class="p">]],</span>
                                        <span class="n">fastcompute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">fileOK</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">kf_direction</span><span class="o">=</span><span class="n">kf_direction</span><span class="p">,</span>
                                        <span class="n">dictmaterials</span><span class="o">=</span><span class="n">dictmaterials</span><span class="p">)</span>

        <span class="c1"># q vectors in lauetools frame, miller indices</span>
        <span class="c1"># print &quot;spots2pi&quot;,spots2pi</span>

        <span class="c1"># ---------  [list of 3D vectors],[list of corresponding Miller indices]</span>

        <span class="c1"># remove Parent Grain Laue spots too close from detector border vicinity</span>
        <span class="n">Qvectors_ParentGrain</span><span class="p">,</span> <span class="n">HKLs_ParentGrain</span> <span class="o">=</span> <span class="n">LAUE</span><span class="o">.</span><span class="n">filterQandHKLvectors</span><span class="p">(</span><span class="n">spots2pi</span><span class="p">,</span>
                                                                    <span class="n">detectordistance</span><span class="p">,</span>
                                                                    <span class="n">detectordiameter</span><span class="p">,</span> <span class="n">kf_direction</span><span class="p">)</span>

        <span class="c1"># Qvectors_ParentGrain, HKLs_ParentGrain = spots2pi</span>

        <span class="k">if</span> <span class="n">gauge</span> <span class="ow">and</span> <span class="n">WXPYTHON</span><span class="p">:</span>
            <span class="n">gaugecount</span> <span class="o">+=</span> <span class="mi">100</span>
            <span class="c1"># print &quot;gaugecount += 100&quot;,gaugecount</span>
            <span class="n">gauge</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">gaugecount</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">Yield</span><span class="p">()</span>

        <span class="c1"># --- Calculating small deviations(rotations and strain)</span>
        <span class="c1"># --- from parent grains according to transform</span>

        <span class="c1"># print &quot; in simul Transform_params&quot;,Transform_params</span>
        <span class="c1"># print &quot; in simul SelectGrains&quot;,SelectGrains</span>

        <span class="c1"># get transform</span>
        <span class="k">if</span> <span class="n">Transform_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Transform_listparam</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">Transform_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Transform_params</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

            <span class="c1"># print &quot;SelectGrains[name_of_grain]&quot;,SelectGrains[name_of_grain]</span>
            <span class="n">Transform_listparam</span> <span class="o">=</span> <span class="n">Transform_params</span><span class="p">[</span><span class="n">SelectGrains</span><span class="p">[</span><span class="n">name_of_grain</span><span class="p">][</span><span class="mi">7</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">Transform_listparam</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">Transform_listparam</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># print &quot;Transform_listparam&quot;,Transform_listparam</span>

        <span class="n">nb_transforms</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GrainSimulParam&quot;</span><span class="p">,</span> <span class="n">GrainSimulParam</span><span class="p">)</span>
        <span class="n">matrix_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

        <span class="c1"># matrix giving a*,b*,c* in absolute x, y,z frame</span>
        <span class="c1"># this matrix is used for strain a*,b*,c* are NORMALIZED:</span>
        <span class="c1"># this is a B matrix used in  q= U B G* formalism</span>
        <span class="c1"># this matrix represents also an initial orientation</span>

        <span class="c1"># old way</span>
        <span class="c1"># InitMat = Bmatrix</span>
        <span class="c1"># # matrix of additional dilatation in Reciprocal space of a* b* c* of the lattice giving the proper length of a*,b*,c*</span>
        <span class="c1"># mat_dilatinRS = np.array([[Laue_classic_param[1][0],0, 0],[0, Laue_classic_param[1][1],0],[0, 0,Laue_classic_param[1][2]]])  # in a* b* c* frame</span>

        <span class="c1"># # Rotation matrix from initial orientation to the given orientation   Newpostion = R oldposition    in x, y,z frame</span>
        <span class="c1"># matOrient_pure = np.array(Laue_classic_param[2])</span>
        <span class="c1"># # full matrix containing</span>

        <span class="c1"># matOrient = np.dot(matOrient_pure, np.dot(InitMat, mat_dilatinRS))  # U * B *(diagonal three elements reciprocal dilatation matrix)</span>
        <span class="c1"># print &quot;matOrient in dosimulation_parametric&quot;,matOrient</span>

        <span class="c1"># Calculates matOrient which is U*B in q = U*B*Gstar</span>
        <span class="n">matOrient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">GrainSimulParam</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GrainSimulParam</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">Transform_listparam</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># print &quot;Transform_listparam[0]&quot;,Transform_listparam[0]</span>
            <span class="k">if</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;r_axis&quot;</span><span class="p">:</span>
                <span class="n">axis_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">angle_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nb_transforms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r_axis_d&quot;</span><span class="p">,</span> <span class="s2">&quot;r_axis_d_slipsystem&quot;</span><span class="p">):</span>
                <span class="n">axis_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># print &quot;axis_list before orientation in d frame&quot;, axis_list</span>
                <span class="n">angle_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nb_transforms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>
                <span class="c1"># axis coordinate change from abc frame(direct crystal) to a*b*c* frame( reciprocal crystal)</span>
                <span class="n">axis_list_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">CP</span><span class="o">.</span><span class="n">fromrealframe_to_reciprocalframe</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">GrainSimulParam</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axis_list</span><span class="p">])</span>
                <span class="c1">#  print &quot;axis_list_c&quot;, axis_list_c</span>
                <span class="c1"># axis coordinate change from a*b*c* frame(crystal) to absolute frame</span>
                <span class="n">axis_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matOrient</span><span class="p">,</span> <span class="n">axis_list_c</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="c1">#                 print &quot;axis_list in absolute frame from d frame&quot;, axis_list</span>

            <span class="c1"># general transform expressed in absolute lauetools frame</span>
            <span class="k">elif</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;r_axis_c&quot;</span><span class="p">:</span>
                <span class="n">axis_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># print &quot;axis_list before orientation in c frame&quot;,axis_list</span>
                <span class="n">angle_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nb_transforms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>
                <span class="c1"># axis coordinate change from hkl frame(crystal) to absolute frame</span>
                <span class="n">axis_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matOrient</span><span class="p">,</span> <span class="n">axis_list</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="c1">#                 print &quot;axis_list in absolute frame from c frame&quot;, axis_list</span>

            <span class="c1"># general transform expressed in absolute lauetools frame</span>
            <span class="k">elif</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;r_mat&quot;</span><span class="p">:</span>
                <span class="n">matrix_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nb_transforms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrix_list</span><span class="p">)</span>

                <span class="c1"># general transform expressed in crystal frame</span>

            <span class="k">elif</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;r_mat_d&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r_mat_d matrix transform with d frame is not implemented yet&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;r_mat_c&quot;</span><span class="p">:</span>
                <span class="c1"># print &quot;using r_mat_c&quot;</span>
                <span class="n">matrix_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nb_transforms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrix_list</span><span class="p">)</span>
                <span class="c1"># then convert transform in absolute lauetools frame</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_transforms</span><span class="p">):</span>
                    <span class="n">matrix_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                        <span class="n">matOrient</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_list</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">matOrient</span><span class="p">)))</span>
                    <span class="c1"># matrix_list[k] = np.dot(inv(matOrient),np.dot(matrix_list[k],matOrient))</span>

                <span class="c1"># transform is a list of tensile transforms</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># is a list of &#39;s_axis&#39; or &#39;s_axis_c</span>
                <span class="n">liststrainframe</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># list of 3 arrays, each array contains the nb_transforms axis</span>
                <span class="c1"># (array of three elements)</span>
                <span class="n">_axis_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># list of 3 arrays, each array contains the nb_transforms strain factor</span>
                <span class="n">factor_list</span> <span class="o">=</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># print &quot;axis_list in c frame&quot;,_axis_list</span>
                <span class="c1"># print &quot;factor_list&quot;,factor_list</span>
                <span class="n">nb_transforms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">factor_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">axis_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
                <span class="c1"># loop over the three proposed axial strain in simulation board</span>
                <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">liststrainframe</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;s_axis_c&quot;</span><span class="p">:</span>
                        <span class="n">axis_list</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                            <span class="n">matOrient</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_axis_list</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axis_list</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">_axis_list</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span>
                <span class="c1"># print &quot;axis_list in a frame&quot;,axis_list</span>
                <span class="c1"># print &quot;Transform_listparam[2]&quot;,Transform_listparam[2]</span>

        <span class="c1">#         print &quot;HKLs_ParentGrain&quot;, HKLs_ParentGrain</span>
        <span class="c1">#         print &quot;nb_transforms&quot;, nb_transforms</span>
        <span class="c1">#         print &quot;Transform_listparam[0]&quot;, Transform_listparam[0]</span>

        <span class="n">calib</span> <span class="o">=</span> <span class="p">[</span><span class="n">detectordistance</span><span class="p">,</span> <span class="n">posCEN</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posCEN</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cameraAngles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cameraAngles</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># -----------------------------------------------------</span>
        <span class="c1"># loop over child grains derived from transformation of a single parent grain</span>
        <span class="k">for</span> <span class="n">ChildGrain_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_transforms</span><span class="p">):</span>
            <span class="c1"># Qvectors_ParentGrain is used to create Qvectors_ParentGrain for each chold grain</span>
            <span class="c1"># according to the transform</span>

            <span class="c1"># print &quot;Qvectors_ParentGrain&quot;, Qvectors_ParentGrain</span>

            <span class="c1"># Geometrical transforms for each case</span>
            <span class="c1"># loop over reciprocal lattice vectors is done with numpy array functions</span>

            <span class="c1"># for rotation around axis expressed in any frame</span>
            <span class="k">if</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r_axis&quot;</span><span class="p">,</span> <span class="s2">&quot;r_axis_c&quot;</span><span class="p">,</span> <span class="s2">&quot;r_axis_d&quot;</span><span class="p">,</span> <span class="s2">&quot;r_axis_d_slipsystem&quot;</span><span class="p">):</span>
                <span class="c1"># print &quot;angle, axis&quot;,angle_list[ChildGrain_index],axis_list[ChildGrain_index]</span>
                <span class="n">qvectors_ChildGrain</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">rotate_around_u</span><span class="p">(</span>
                                                            <span class="n">Qvectors_ParentGrain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                            <span class="n">angle_list</span><span class="p">[</span><span class="n">ChildGrain_index</span><span class="p">],</span>
                                                            <span class="n">u</span><span class="o">=</span><span class="n">axis_list</span><span class="p">[</span><span class="n">ChildGrain_index</span><span class="p">])</span>
                <span class="c1"># list of spot which are on camera(without harmonics)</span>
                <span class="c1"># hkl are common to all child grains</span>
                <span class="n">spots2pi</span> <span class="o">=</span> <span class="p">[</span><span class="n">qvectors_ChildGrain</span><span class="p">],</span> <span class="n">HKLs_ParentGrain</span>

            <span class="c1"># for general transform expressed in any frame</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;r_mat&quot;</span> <span class="ow">or</span>
                            <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r_mat_c&quot;</span><span class="p">,</span> <span class="s2">&quot;r_mat_d&quot;</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="n">Transform_listparam</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span>
                            <span class="n">Transform_listparam</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]):</span>

                <span class="c1"># general transformation is applied to q vector</span>
                <span class="c1"># expressed in lauetools absolute frame</span>
                <span class="n">qvectors_ChildGrain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">matrix_list</span><span class="p">[</span><span class="n">ChildGrain_index</span><span class="p">],</span> <span class="n">Qvectors_ParentGrain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># if 0:</span>
                <span class="c1">#     print(&quot; 10 first transpose(Qvectors_ParentGrain[0])&quot;,</span>
                <span class="c1">#         Qvectors_ParentGrain[0].T[:, :10])</span>
                <span class="c1">#     print(&quot;%d / %d&quot; % (ChildGrain_index, nb_transforms))</span>
                <span class="c1">#     print(&quot;current matrix&quot;, matrix_list[ChildGrain_index])</span>
                <span class="c1">#     print(np.shape(qvectors_ChildGrain))</span>
                <span class="c1">#     print(&quot;GrainSimulParam&quot;, GrainSimulParam)</span>
                <span class="c1">#     print(&quot;qvectors_ChildGrain&quot;, qvectors_ChildGrain[:10])</span>
                <span class="c1"># list of spot which are on camera(without harmonics)</span>
                <span class="n">spots2pi</span> <span class="o">=</span> <span class="p">[</span><span class="n">qvectors_ChildGrain</span><span class="p">],</span> <span class="n">HKLs_ParentGrain</span>

            <span class="c1"># for the three consecutive axial strains</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>

                <span class="n">first_traction</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">tensile_along_u</span><span class="p">(</span>
                    <span class="n">Qvectors_ParentGrain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">factor_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ChildGrain_index</span><span class="p">],</span>
                    <span class="n">u</span><span class="o">=</span><span class="n">axis_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ChildGrain_index</span><span class="p">])</span>
                <span class="n">second_traction</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">tensile_along_u</span><span class="p">(</span>
                    <span class="n">first_traction</span><span class="p">,</span>
                    <span class="n">factor_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ChildGrain_index</span><span class="p">],</span>
                    <span class="n">u</span><span class="o">=</span><span class="n">axis_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ChildGrain_index</span><span class="p">])</span>
                <span class="n">qvectors_ChildGrain</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">tensile_along_u</span><span class="p">(</span>
                    <span class="n">second_traction</span><span class="p">,</span>
                    <span class="n">factor_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ChildGrain_index</span><span class="p">],</span>
                    <span class="n">u</span><span class="o">=</span><span class="n">axis_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ChildGrain_index</span><span class="p">])</span>
                <span class="c1"># list of spots for a child grain (on camera + without harmonics)</span>
                <span class="n">spots2pi</span> <span class="o">=</span> <span class="p">[</span><span class="n">qvectors_ChildGrain</span><span class="p">],</span> <span class="n">HKLs_ParentGrain</span>

                <span class="c1"># if 0:</span>
                <span class="c1">#     print(&quot; 10 first transpose(Qvectors_ParentGrain[0])&quot;,</span>
                <span class="c1">#         Qvectors_ParentGrain[0][:10])</span>
                <span class="c1">#     print(np.shape(qvectors_ChildGrain))</span>
                <span class="c1">#     print(&quot;GrainSimulParam&quot;, GrainSimulParam)</span>
                <span class="c1">#     print(&quot;qvectors_ChildGrain&quot;, qvectors_ChildGrain[:10])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no transformation</span>
                <span class="k">pass</span>

            <span class="c1"># test whether there is at least one Laue spot in the camera</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">spots2pi</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is at least one child grain without peaks on CCD camera for ChildGrain_index= </span><span class="si">%.3f</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">ChildGrain_index</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="c1"># ---------------------------------</span>
            <span class="c1"># filter spots to keep those in camera, filter harmonics</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># print(&quot;kf_direction = (in dosimulationparametric)&quot;, kf_direction)</span>
                <span class="k">if</span> <span class="n">kf_direction</span> <span class="o">==</span> <span class="s2">&quot;Z&gt;0&quot;</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">kf_direction</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># or isinstance(kf_direction, np.array):</span>
                    <span class="n">Laue_spot_list</span> <span class="o">=</span> <span class="n">LAUE</span><span class="o">.</span><span class="n">filterLaueSpots</span><span class="p">(</span><span class="n">spots2pi</span><span class="p">,</span>
                                                    <span class="n">fileOK</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">fastcompute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">detectordistance</span><span class="o">=</span><span class="n">detectordistance</span><span class="p">,</span>
                                                    <span class="n">detectordiameter</span><span class="o">=</span><span class="n">detectordiameter</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span>  <span class="c1"># * 1.2, # avoid losing some spots in large transformation</span>
                                                    <span class="n">kf_direction</span><span class="o">=</span><span class="n">kf_direction</span><span class="p">,</span>
                                                    <span class="n">HarmonicsRemoval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">)</span>

                    <span class="c1"># for elem in Laue_spot_list[0][:10]:</span>
                    <span class="c1"># print elem</span>

                    <span class="c1"># print &quot;Laue_spot_list[0][0].Twicetheta&quot;</span>
                    <span class="c1"># print Laue_spot_list[0][0].Twicetheta</span>

                    <span class="k">if</span> <span class="n">gauge</span> <span class="ow">and</span> <span class="n">WXPYTHON</span><span class="p">:</span>
                        <span class="n">gaugecount</span> <span class="o">=</span> <span class="n">gaugecount</span> <span class="o">+</span> <span class="mi">900</span> <span class="o">/</span> <span class="n">nb_transforms</span>
                        <span class="n">gauge</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">gaugecount</span><span class="p">)</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">Yield</span><span class="p">()</span>
                        <span class="c1"># print &quot;ChildGrain_index 900%nb_transforms&quot;,ChildGrain_index, gaugecount</span>

                    <span class="n">Listspots</span> <span class="o">=</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">twicetheta</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Twicetheta</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Listspots</span><span class="p">]</span>
                    <span class="n">chi</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Chi</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Listspots</span><span class="p">]</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">EwaldRadius</span> <span class="o">*</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">CST_ENERGYKEV</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Listspots</span><span class="p">]</span>
                    <span class="n">Miller_ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">spot</span><span class="o">.</span><span class="n">Millers</span><span class="p">)</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Listspots</span><span class="p">]</span>

                    <span class="n">calib</span> <span class="o">=</span> <span class="p">[</span><span class="n">detectordistance</span><span class="p">,</span> <span class="n">posCEN</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posCEN</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cameraAngles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cameraAngles</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

                    <span class="c1"># print(&quot;calib parameters in dosimulation_parametric&quot;)</span>
                    <span class="c1"># print(calib)</span>
                    <span class="c1"># print(&quot;pixelsize&quot;, pixelsize)</span>
                    <span class="c1"># print(&quot;framedim&quot;, framedim)</span>

                    <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span> <span class="o">=</span> <span class="n">LTGeo</span><span class="o">.</span><span class="n">calc_xycam_from2thetachi</span><span class="p">(</span><span class="n">twicetheta</span><span class="p">,</span>
                                                                    <span class="n">chi</span><span class="p">,</span>
                                                                    <span class="n">calib</span><span class="p">,</span>
                                                                    <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">,</span>
                                                                    <span class="n">kf_direction</span><span class="o">=</span><span class="n">kf_direction</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># vecRR = [spot.Qxyz for spot in Laue_spot_list[0]] #uf_lab in JSM LaueTools frame</span>

                    <span class="n">list_twicetheta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twicetheta</span><span class="p">)</span>
                    <span class="n">list_chi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
                    <span class="n">list_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
                    <span class="n">list_Miller</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Miller_ind</span><span class="p">)</span>
                    <span class="n">list_posX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posx</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">list_posY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posy</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="c1"># success = 1</span>

                <span class="k">elif</span> <span class="n">kf_direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Y&lt;0&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&gt;0&quot;</span><span class="p">):</span>
                    <span class="c1"># TODO: patch for test: detectordistance = 126.5</span>

                    <span class="n">Laue_spot_list</span> <span class="o">=</span> <span class="n">LAUE</span><span class="o">.</span><span class="n">filterLaueSpots</span><span class="p">(</span><span class="n">spots2pi</span><span class="p">,</span>
                                                            <span class="n">fileOK</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">fastcompute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">detectordistance</span><span class="o">=</span><span class="n">detectordistance</span><span class="p">,</span>
                                                            <span class="n">detectordiameter</span><span class="o">=</span><span class="n">detectordiameter</span><span class="p">,</span>  <span class="c1"># * 1.2, # avoid losing some spots in large transformation</span>
                                                            <span class="n">kf_direction</span><span class="o">=</span><span class="n">kf_direction</span><span class="p">,</span>
                                                            <span class="n">HarmonicsRemoval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">)</span>

                    <span class="c1"># for elem in Laue_spot_list[0][:10]:</span>
                    <span class="c1"># print elem</span>

                    <span class="c1"># print &quot;Laue_spot_list[0][0].Twicetheta&quot;</span>
                    <span class="c1"># print Laue_spot_list[0][0].Twicetheta</span>
                    <span class="k">if</span> <span class="n">gauge</span> <span class="ow">and</span> <span class="n">WXPYTHON</span><span class="p">:</span>
                        <span class="n">gaugecount</span> <span class="o">=</span> <span class="n">gaugecount</span> <span class="o">+</span> <span class="mi">900</span> <span class="o">/</span> <span class="n">nb_transforms</span>
                        <span class="n">gauge</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">gaugecount</span><span class="p">)</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">Yield</span><span class="p">()</span>
                        <span class="c1"># print &quot;ChildGrain_index 900%nb_transforms&quot;,ChildGrain_index, gaugecount</span>

                    <span class="n">twicetheta</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Twicetheta</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">chi</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Chi</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">EwaldRadius</span> <span class="o">*</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">CST_ENERGYKEV</span>
                        <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">Miller_ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">spot</span><span class="o">.</span><span class="n">Millers</span><span class="p">)</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                    <span class="n">calib</span> <span class="o">=</span> <span class="p">[</span><span class="n">detectordistance</span><span class="p">,</span> <span class="n">posCEN</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posCEN</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cameraAngles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cameraAngles</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

                    <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span> <span class="o">=</span> <span class="n">LTGeo</span><span class="o">.</span><span class="n">calc_xycam_from2thetachi</span><span class="p">(</span><span class="n">twicetheta</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">calib</span><span class="p">,</span>
                                        <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">,</span>
                                        <span class="n">kf_direction</span><span class="o">=</span><span class="n">kf_direction</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># posx, posy, theta0 = LTGeo.calc_xycam_from2thetachi(twicetheta, chi, calib, pixelsize = self.pixelsize)</span>

                    <span class="n">posx</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Xcam</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">posy</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Ycam</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                    <span class="c1"># vecRR = [</span>
                    <span class="c1">#     spot.Qxyz for spot in Laue_spot_list[0]</span>
                    <span class="c1"># ]  # uf_lab in JSM frame</span>

                    <span class="c1"># print &quot;twicetheta&quot;,twicetheta</span>
                    <span class="c1"># print &quot;2*th0&quot;,(2*theta0).tolist()</span>

                    <span class="n">list_twicetheta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twicetheta</span><span class="p">)</span>
                    <span class="n">list_chi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
                    <span class="n">list_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
                    <span class="n">list_Miller</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Miller_ind</span><span class="p">)</span>
                    <span class="n">list_posX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posx</span><span class="p">)</span>
                    <span class="n">list_posY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posy</span><span class="p">)</span>

                    <span class="c1"># success = 1</span>

                <span class="k">elif</span> <span class="n">kf_direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;X&gt;0&quot;</span><span class="p">,</span> <span class="s2">&quot;X&lt;0&quot;</span><span class="p">):</span>  <span class="c1"># transmission mode or back reflection mode</span>

                    <span class="c1"># print(&quot;spots2pi&quot;,spots2pi)</span>
                    <span class="n">Laue_spot_list</span> <span class="o">=</span> <span class="n">LAUE</span><span class="o">.</span><span class="n">filterLaueSpots</span><span class="p">(</span><span class="n">spots2pi</span><span class="p">,</span>
                                                    <span class="n">fileOK</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">fastcompute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">detectordistance</span><span class="o">=</span><span class="n">detectordistance</span><span class="p">,</span>
                                                    <span class="n">detectordiameter</span><span class="o">=</span><span class="n">detectordiameter</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span>  <span class="c1"># * 1.2, # avoid losing some spots in large transformation</span>
                                                    <span class="n">kf_direction</span><span class="o">=</span><span class="n">kf_direction</span><span class="p">,</span>
                                                    <span class="n">HarmonicsRemoval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">Laue_spot_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">list_twicetheta</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">list_chi</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">list_energy</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">list_Miller</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">list_posX</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">list_posY</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="k">continue</span>

                    <span class="c1"># print(&quot;Laue_spot_list&quot;,Laue_spot_list)</span>
                    <span class="c1"># for elem in Laue_spot_list[0]:</span>
                    <span class="c1">#     print(&#39;transmission spots&#39;,elem)</span>

                    <span class="c1"># print &quot;Laue_spot_list[0][0].Twicetheta&quot;</span>
                    <span class="c1"># print Laue_spot_list[0][0].Twicetheta</span>
                    <span class="k">if</span> <span class="n">gauge</span> <span class="ow">and</span> <span class="n">WXPYTHON</span><span class="p">:</span>
                        <span class="n">gaugecount</span> <span class="o">=</span> <span class="n">gaugecount</span> <span class="o">+</span> <span class="mi">900</span> <span class="o">/</span> <span class="n">nb_transforms</span>
                        <span class="n">gauge</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">gaugecount</span><span class="p">)</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">Yield</span><span class="p">()</span>
                        <span class="c1"># print &quot;ChildGrain_index 900%nb_transforms&quot;,ChildGrain_index, gaugecount</span>

                    <span class="n">twicetheta</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Twicetheta</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">chi</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">Chi</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="p">[</span><span class="n">spot</span><span class="o">.</span><span class="n">EwaldRadius</span> <span class="o">*</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">CST_ENERGYKEV</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">Miller_ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">spot</span><span class="o">.</span><span class="n">Millers</span><span class="p">)</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">Laue_spot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                    <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span> <span class="o">=</span> <span class="n">LTGeo</span><span class="o">.</span><span class="n">calc_xycam_from2thetachi</span><span class="p">(</span><span class="n">twicetheta</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">calib</span><span class="p">,</span>
                                        <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">,</span>
                                        <span class="n">kf_direction</span><span class="o">=</span><span class="n">kf_direction</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">posx</span> <span class="o">=</span> <span class="n">posx</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">posy</span> <span class="o">=</span> <span class="n">posy</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="c1"># posx, posy, theta0 = LTGeo.calc_xycam_from2thetachi(twicetheta, chi, calib, pixelsize = self.pixelsize)</span>

                    <span class="c1">#                     posx = [spot.Xcam for spot in  Laue_spot_list[0]]</span>
                    <span class="c1">#                     posy = [spot.Ycam for spot in  Laue_spot_list[0]]</span>

                    <span class="c1"># vecRR = [spot.Qxyz for spot in Laue_spot_list[0]]  # uf_lab in JSM frame</span>

                    <span class="c1"># print &quot;twicetheta&quot;,twicetheta</span>
                    <span class="c1"># print &quot;2*th0&quot;,(2*theta0).tolist()</span>

                    <span class="n">list_twicetheta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twicetheta</span><span class="p">)</span>
                    <span class="n">list_chi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
                    <span class="n">list_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
                    <span class="n">list_Miller</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Miller_ind</span><span class="p">)</span>
                    <span class="n">list_posX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posx</span><span class="p">)</span>
                    <span class="n">list_posY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posy</span><span class="p">)</span>

                    <span class="c1"># success = 1</span>

            <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;With theses parameters, there are no peaks in the CCD frame!!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;for transform with t = </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ChildGrain_index</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;It may seem that the transform you have designed has a too large amplitude</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;-Try then to reduce the variation range of t</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;-Or reduce ratio between extrema in input matrix transform</span><span class="se">\n\n</span><span class="s2">&quot;</span>

                <span class="c1"># success = 0</span>
                <span class="k">break</span>

            <span class="c1"># end of loop over transforms(or children grains)</span>

        <span class="n">transform_type</span> <span class="o">=</span> <span class="s2">&quot;parametric&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transform_listparam in dosimultion&quot;</span><span class="p">,</span> <span class="n">Transform_listparam</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Transform_listparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;slipsystem&quot;</span><span class="p">):</span>
                <span class="n">transform_type</span> <span class="o">=</span> <span class="s2">&quot;slipsystem&quot;</span>

        <span class="n">list_ParentGrain_transforms</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">parentgrain_index</span><span class="p">,</span> <span class="n">nb_transforms</span><span class="p">,</span> <span class="n">transform_type</span><span class="p">])</span>
        <span class="n">total_nb_grains</span> <span class="o">+=</span> <span class="n">nb_transforms</span>

        <span class="k">if</span> <span class="n">gauge</span> <span class="ow">and</span> <span class="n">WXPYTHON</span><span class="p">:</span>
            <span class="n">gaugecount</span> <span class="o">+=</span> <span class="p">(</span><span class="n">parentgrain_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">gauge</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">gaugecount</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">Yield</span><span class="p">()</span>
            <span class="c1"># print &quot;(parentgrain_index+1)*1000&quot;,gaugecount</span>

    <span class="c1"># end of loop over parent grains-------------------------------</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total_nb_grains (cumulated from single and grains assembly):&quot;</span><span class="p">,</span> <span class="n">total_nb_grains</span><span class="p">)</span>

    <span class="c1"># 1 grain data lists are listed i.e. use list_twicetheta[0] etc.</span>
    <span class="c1"># polygrain use list_twicetheta</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;List of Grain Name&quot;</span><span class="p">,</span> <span class="n">ParentGrainName_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number_ParentGrains of parent grains&quot;</span><span class="p">,</span> <span class="n">Number_ParentGrains</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number_ParentGrains of spots in grain0&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_twicetheta</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;list_ParentGrain_transforms&#39;</span><span class="p">,</span> <span class="n">list_ParentGrain_transforms</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_twicetheta</span><span class="p">,</span>
        <span class="n">list_chi</span><span class="p">,</span>
        <span class="n">list_energy</span><span class="p">,</span>
        <span class="n">list_Miller</span><span class="p">,</span>
        <span class="n">list_posX</span><span class="p">,</span>
        <span class="n">list_posY</span><span class="p">,</span>
        <span class="n">ParentGrainName_list</span><span class="p">,</span>
        <span class="n">list_ParentGrain_transforms</span><span class="p">,</span>
        <span class="n">calib</span><span class="p">,</span>
        <span class="n">total_nb_grains</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test of multigrainSimulator.py&#39;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, J.S. Micha, O. Robach., S. Tardif

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>