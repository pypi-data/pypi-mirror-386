Metadata-Version: 2.4
Name: django-tos-uploader
Version: 1.1.1
Summary: Django widget for uploading files to Volcengine TOS (Tinder Object Storage)
Home-page: https://github.com/ren000thomas/django-tos-uploader
Author: Your Name
Author-email: Ren Thomas <ren000thomas@gmail.com>
License: MIT
Project-URL: Homepage, https://github.com/ren000thomas/django-tos-uploader
Project-URL: Bug Reports, https://github.com/ren000thomas/django-tos-uploader/issues
Project-URL: Source, https://github.com/ren000thomas/django-tos-uploader
Project-URL: Documentation, https://github.com/ren000thomas/django-tos-uploader#readme
Keywords: django,volcengine,tos,upload,widget,file-upload
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Framework :: Django
Classifier: Framework :: Django :: 3.2
Classifier: Framework :: Django :: 4.0
Classifier: Framework :: Django :: 4.1
Classifier: Framework :: Django :: 4.2
Classifier: Framework :: Django :: 5.0
Classifier: Framework :: Django :: 5.1
Classifier: Framework :: Django :: 5.2
Classifier: Topic :: Internet :: WWW/HTTP
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: Django>=3.2
Requires-Dist: volcengine>=1.0.0
Dynamic: author
Dynamic: home-page
Dynamic: license-file
Dynamic: requires-python

# Django TOS Uploader

ä¸€ä¸ªç”¨äº Django çš„ç«å±±å¼•æ“ TOSï¼ˆTinder Object Storageï¼‰æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ æ”¯æŒå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
- ğŸ”’ ä½¿ç”¨ STS ä¸´æ—¶å‡­è¯ï¼Œå®‰å…¨å¯é 
- ğŸ¨ ç°ä»£åŒ– UI è®¾è®¡ï¼Œæ”¯æŒå“åº”å¼å¸ƒå±€
- ğŸ“± æ”¯æŒæ‹–æ‹½ä¸Šä¼ å’Œç‚¹å‡»é€‰æ‹©
- ğŸ” å®æ—¶é¢„è§ˆï¼ˆå›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰
- ğŸ“Š ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
- ğŸ›¡ï¸ æ”¯æŒåªè¯»æ¨¡å¼
- ğŸ¯ åŠ¨æ€ä¸Šä¼ è·¯å¾„é…ç½®
- âš¡ æ‡’åŠ è½½é¢„è§ˆï¼ŒèŠ‚çœèµ„æº

## å®‰è£…

```bash
pip install django-tos-uploader
```

## å¿«é€Ÿå¼€å§‹

### ä¾èµ–

```bash
pip install volcengine
```

### 1. æ·»åŠ åˆ° INSTALLED_APPS

```python
INSTALLED_APPS = [
    # ... å…¶ä»–åº”ç”¨
    'tos_uploader',
]
```

### 2. é…ç½®è®¾ç½®

```python
# settings.py

# ç«å±±å¼•æ“é…ç½®
VOLCENGINE_ACCESS_KEY = 'your-access-key'
VOLCENGINE_SECRET_KEY = 'your-secret-key'
VOLCENGINE_REGION = 'cn-beijing'  # æˆ–å…¶ä»–åŒºåŸŸ
VOLCENGINE_ENDPOINT = 'tos-cn-beijing.volces.com'
VOLCENGINE_BUCKET = 'your-bucket-name'
VOLCENGINE_ACCOUNT_ID = 'your-account-id'
VOLCENGINE_STS_ROLE_NAME = 'your-sts-role-name'
```

### 3. å®ç° STS Token è§†å›¾

```python
# views.py
from django.conf import settings
from volcengine.sts.StsService import StsService

from rest_framework import serializers


class StsTokenSerializer(serializers.Serializer):
    access_key = serializers.CharField(help_text="ä¸´æ—¶è®¿é—®å¯†é’¥ID")
    secret_key = serializers.CharField(help_text="ä¸´æ—¶è®¿é—®å¯†é’¥")
    security_token = serializers.CharField(help_text="å®‰å…¨ä»¤ç‰Œ")
    expiration = serializers.DateTimeField(help_text="å‡­è¯è¿‡æœŸæ—¶é—´")
    endpoint = serializers.CharField(help_text="Endpoint")
    bucket = serializers.CharField(help_text="Bucket")
    region = serializers.CharField(help_text="Region")

class GetStsTokenAPIView(APIView):
    # permission_classes = [IsAuthenticated]

    @extend_schema(
        tags=["æœåŠ¡"],
        summary="è·å–ç«å±±å¼•æ“STSä¸´æ—¶è®¿é—®å‡­è¯",
        responses={
            status.HTTP_200_OK: StsTokenSerializer,
            status.HTTP_500_INTERNAL_SERVER_ERROR: OpenApiTypes.OBJECT,
        },
    )
    def get(self, request, *args, **kwargs):
        try:
            # åˆå§‹åŒ– STS æœåŠ¡
            sts_service = StsService()
            sts_service.set_ak(settings.VOLCENGINE_ACCESS_KEY)
            sts_service.set_sk(settings.VOLCENGINE_SECRET_KEY)

            # è·å– STS ä¸´æ—¶å‡­è¯
            params = {
                "DurationSeconds": 3600,  # 1å°æ—¶æœ‰æ•ˆæœŸ
                "RoleTrn": f"trn:iam::{settings.VOLCENGINE_ACCOUNT_ID}:role/{settings.VOLCENGINE_STS_ROLE_NAME}",
                "RoleSessionName": f"renlib_user_{request.user.id}",
            }
            resp = sts_service.assume_role(params)
            credentials = resp["Result"]["Credentials"]

            data = {
                "access_key": credentials["AccessKeyId"],
                "secret_key": credentials["SecretAccessKey"],
                "security_token": credentials["SessionToken"],
                "expiration": credentials["ExpiredTime"],
                "endpoint": settings.VOLCENGINE_ENDPOINT,
                "bucket": settings.VOLCENGINE_BUCKET,
                "region": settings.VOLCENGINE_REGION,
            }
            serializer = StsTokenSerializer(data=data)
            serializer.is_valid(raise_exception=True)
            return Response(serializer.data)

        except Exception as e:
            return Response(
                {"error": str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

```

### 4. é…ç½® URL è·¯ç”±

```python
# urls.py
from django.urls import path
from . import views

urlpatterns = [
    path('<your url>/', views.GetStsTokenAPIView.as_view(), name='get_sts_token'),
    # ... å…¶ä»–URL
]

```

### 5. åœ¨æ¨¡å‹ä¸­ä½¿ç”¨

```python
from tos_uploader.fields import TOSFileField
from django.db import models

class MyModel(models.Model):
    # å…¶ä»–å­—æ®µ...
    tos_file = TOSFileField(
        upload_path="my-uploads/",
        get_sts_token_url=reverse_lazy('get_sts_token'),  # æ›¿æ¢ä¸ºä½ çš„è§†å›¾å
        file_types=["image/*", "video/*"],  # å¯é€‰ï¼Œæ–‡ä»¶ç±»å‹é™åˆ¶
        readonly=False,  # å¯é€‰ï¼Œæ˜¯å¦åªè¯»
    )
```
