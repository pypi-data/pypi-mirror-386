test_case_id: "proxy_streaming_response_001"
description: "Tests that the proxy correctly handles a full streaming response with intermediate events."
tags: ["all", "proxy", "streaming"]
skip_intermediate_events: false

gateway_input:
  target_agent_name: "TestAgent_Proxied"
  user_identity: "proxy_stream_tester@example.com"
  parts:
    - type: "text"
      text: "Stream me a response."
  external_context:
    a2a_session_id: "session_proxy_streaming_001"

# This section primes the TestA2AAgentServer's DeclarativeAgentExecutor.
# The test server will return these events in order. The executor will overwrite
# the taskId and contextId with the actual values from the request.
downstream_a2a_agent_responses:
  # First, a status update
  - kind: "status-update"
    taskId: "downstream-task-id"
    contextId: "session_proxy_streaming_001"
    final: false
    status:
      state: "working"
      message:
        role: "agent"
        messageId: "msg-1"
        kind: "message"
        parts:
          - kind: "text"
            text: "Working on it... "
  # Second, a text delta
  - kind: "status-update"
    taskId: "downstream-task-id"
    contextId: "session_proxy_streaming_001"
    final: false
    status:
      state: "working"
      message:
        role: "agent"
        messageId: "msg-2"
        kind: "message"
        parts:
          - kind: "text"
            text: "here is some more text."
  # Finally, the completed task
  - id: "downstream-task-id"
    contextId: "session_proxy_streaming_001"
    kind: "task"
    status:
      state: "completed"
      message:
        role: "agent"
        messageId: "msg-final"
        kind: "message"
        parts:
          - kind: "text"
            text: "All done."

# This section asserts what the TestGatewayComponent receives
expected_gateway_output:
  - type: "status_update"
    final_flag: false
    content_parts:
      - type: "text"
        text_exact: "Working on it... "
  - type: "status_update"
    final_flag: false
    content_parts:
      - type: "text"
        text_exact: "here is some more text."
  - type: "final_response"
    task_state: "completed"
    content_parts:
      - type: "text"
        text_exact: "All done."
