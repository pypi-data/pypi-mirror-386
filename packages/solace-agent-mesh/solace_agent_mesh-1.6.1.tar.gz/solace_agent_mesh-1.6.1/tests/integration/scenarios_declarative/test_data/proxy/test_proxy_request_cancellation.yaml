test_case_id: "proxy_request_cancellation_001"
description: "Tests that cancellation requests are correctly forwarded to the downstream agent"
tags: ["all", "proxy", "cancellation"]
skip_intermediate_events: true

gateway_input:
  target_agent_name: "TestAgent_Proxied"
  user_identity: "cancel_tester@example.com"
  parts:
    - type: "text"
      text: "Start a long-running task"
  external_context:
    a2a_session_id: "session_cancel_001"

# Action to perform after input is sent
gateway_actions_after_input:
  - type: "cancel_task"
    delay_seconds: 0.1  # Small delay to ensure task is in-flight

# Downstream agent acknowledges cancellation
downstream_a2a_agent_responses:
  - id: "task-to-cancel"
    contextId: "session_cancel_001"
    kind: "task"
    status:
      state: "canceled"
      message:
        role: "agent"
        messageId: "msg-cancel"
        kind: "message"
        parts:
          - kind: "text"
            text: "Task was canceled"

expected_gateway_output:
  - type: "final_response"
    task_state: "canceled"
    content_parts:
      - type: "text"
        text_exact: "Task was canceled"

# Verify cancellation was sent
assert_cancellation_sent:
  gateway_sent: true
  downstream_received: true
