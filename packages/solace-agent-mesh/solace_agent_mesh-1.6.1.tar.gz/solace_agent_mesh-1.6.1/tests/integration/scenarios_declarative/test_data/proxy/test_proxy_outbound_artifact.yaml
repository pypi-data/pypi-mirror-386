test_case_id: "proxy_outbound_artifact_001"
description: "Tests that the proxy correctly saves an outbound artifact and rewrites the URI."
tags: ["all", "proxy", "artifacts"]
skip_intermediate_events: true

gateway_input:
  target_agent_name: "TestAgent_Proxied"
  user_identity: "proxy_artifact_tester@example.com"
  is_streaming: false
  a2a_parts:
    - type: "text"
      text: "Generate an artifact for me."
  external_context:
    a2a_session_id: "session_proxy_outbound_artifact_001"

downstream_a2a_agent_responses:
  - id: "downstream-task-id"
    contextId: "session_proxy_outbound_artifact_001"
    kind: "task"
    status:
      state: "completed"
      message:
        role: "agent"
        messageId: "msg-1"
        kind: "message"
        parts:
          - kind: "text"
            text: "Here is your generated artifact."
    artifacts:
      - artifact_id: "downstream-artifact-1"
        name: "outbound.txt"
        description: "Generated by downstream agent"
        parts:
          - kind: "file"
            file:
              name: "outbound.txt"
              mime_type: "text/plain"
              # Base64 of "outbound artifact content"
              bytes: "b3V0Ym91bmQgYXJ0aWZhY3QgY29udGVudA=="

expected_gateway_output:
  - type: "final_response"
    task_state: "completed"
    content_parts:
      - type: "text"
        text_exact: "Here is your generated artifact."
    artifacts:
      - name: "outbound.txt"
        description: "Generated by downstream agent"
        parts:
          - kind: "file"
            file:
              name: "outbound.txt"
              mimeType: "text/plain"
              uri_matches_regex: "artifact://TestAgent_Proxied/proxy_artifact_tester@example.com/session_proxy_outbound_artifact_001/outbound.txt/0"
    assert_artifact_state:
      - filename: "outbound.txt"
        version: 0
        user_id: "proxy_artifact_tester@example.com"
        session_id: "session_proxy_outbound_artifact_001"
        # The app_name for assertion is derived from the gateway_input's target_agent_name
        app_name: "TestAgent_Proxied"
        expected_content_bytes_base64: "b3V0Ym91bmQgYXJ0aWZhY3QgY29udGVudA=="
        expected_metadata_contains:
          description: "Generated by downstream agent"
          proxied_from_artifact_id: "downstream-artifact-1"
