name: ci/cd

on:
  # only on branch pushes
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  # don't cancel on main/master/default
  cancel-in-progress: ${{ format('refs/heads/{0}', github.event.repository.default_branch) != github.ref }}

jobs:

  #############################################################################
  # TOOLS FOR SETTING UP MATRIX-BASED JOBS
  #############################################################################

  py-versions:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.versions.outputs.matrix }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.sha }}  # lock to triggered commit (github.ref is dynamic)
      - id: versions
        uses: WIPACrepo/wipac-dev-py-versions-action@v2.7

  ###########################################################################
  # LINTERS
  ###########################################################################

#  flake8:
#    needs: [ py-versions ]
#    runs-on: ubuntu-latest
#    strategy:
#      fail-fast: false
#      matrix:
#        py3: ${{ fromJSON(needs.py-versions.outputs.matrix) }}
#    steps:
#      - uses: actions/checkout@v5
#        with:
#          ref: ${{ github.sha }}  # lock to triggered commit (github.ref is dynamic)
#      - uses: actions/setup-python@v6
#        with:
#          python-version: ${{ matrix.py3 }}
#      - uses: WIPACrepo/wipac-dev-flake8-action@v1.3
#        with:
#          max-complexity: 10  # ideal is ~10-15

  mypy:
    needs: [ py-versions ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        py3: ${{ fromJSON(needs.py-versions.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.sha }}  # lock to triggered commit (github.ref is dynamic)
          fetch-depth: 0  # setuptools-scm needs to access git tags
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.py3 }}
      - uses: WIPACrepo/wipac-dev-mypy-action@v2.0


  ###########################################################################
  # PACKAGING
  ###########################################################################

  py-setup:
    if: ${{ github.actor != 'dependabot[bot]' }} # dependabot cannot access PAT
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          ref: ${{ github.ref }}  # dont lock to sha (action needs to push)
      - uses: WIPACrepo/wipac-dev-py-setup-action@v5.7
        with:
          mode: PACKAGING_AND_PYPI
          python_min: 3.9
          pypi_name: icecube-voka
          author: IceCube
          author_email: developers@icecube.wisc.edu
          keywords_comma: IceCube, WIPAC, histogram comparison, outlier detection, statistical tests, empirical p-value threshold, poissonian statistics
          auto_mypy_option: True

  py-dependencies:
    needs: [
      # linters so we don't waste compute on faulty code...
      # flake8,
      mypy,
    ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.sha }}  # lock to triggered commit (github.ref is dynamic)
          fetch-depth: 0  # setuptools-scm needs to access git tags
      - uses: WIPACrepo/wipac-dev-py-dependencies-action@v3.2


  ###########################################################################
  # TESTS
  ###########################################################################

  tests:
    needs: [ py-versions ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        py3: ${{ fromJSON(needs.py-versions.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.sha }}  # lock to triggered commit (github.ref is dynamic)
          fetch-depth: 0  # setuptools-scm needs to access git tags
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.py3 }}
      - name: Setup Dependencies
        run: |
          set -euo pipefail; echo "now: $(date -u +"%Y-%m-%dT%H:%M:%S.%3N")"
          pip install --upgrade pip wheel setuptools
          pip install .[tests]
      - name: "python -m pytest test"
        run: |
          set -euo pipefail; echo "now: $(date -u +"%Y-%m-%dT%H:%M:%S.%3N")"
          python -m pytest test

  ###########################################################################
  # RELEASE
  ###########################################################################

  release:
    # only run on main/master/default
    if: format('refs/heads/{0}', github.event.repository.default_branch) == github.ref
    needs: [
      py-versions,
      mypy,
      # flake8,
      py-setup,
      py-dependencies,
      tests,
    ]
    uses: WIPACrepo/wipac-dev-workflows/.github/workflows/tag-and-release.yml@v1.16
    permissions: # for GITHUB_TOKEN
      contents: write
    with:
      project-type: python
      python-version: "${{ fromJSON(needs.py-versions.outputs.matrix)[0] }}"
      release-artifacts: |
        py-dependencies-logs
      publish-to-pypi: true
    secrets:
      TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}  # trigger tag-event gha workflows
      PYPI_TOKEN: ${{ secrets.WIPAC_PYPI_TOKEN }}
