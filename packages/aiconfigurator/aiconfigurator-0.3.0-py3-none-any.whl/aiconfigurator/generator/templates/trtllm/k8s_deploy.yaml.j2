{%- set name_prefix = name_prefix | default('trtllm') -%}
{%- set mode = mode | default('disagg') -%}

# Router and naming
{%- set router_mode = dynamo_config.router_mode | default('') -%}
{%- set is_kv = router_mode == 'kv' -%}
{%- set name = name | default(name_prefix ~ '-' ~ ('agg' if mode == 'agg' else 'disagg') ~ ('-router' if is_kv else '')) -%}

# K8s essentials
{%- set k8s_namespace = dynamo_config.k8s_namespace | default('dynamo') -%}
{%- set k8s_image = dynamo_config.k8s_image | default('nvcr.io/nvidia/ai-dynamo/tensorrtllm-runtime:0.5.0') -%}
{%- set k8s_image_pull_secret = dynamo_config.k8s_image_pull_secret | default('') -%}
{%- set working_dir = '/workspace/components/backends/trtllm' -%}

# Model and strategy
{%- set model_path = dynamo_config.model_path | default(model_name) -%}
{%- set served_model_name = dynamo_config.served_model_name | default(model_name) -%}
{%- set disaggregation_strategy = dynamo_config.disaggregation_strategy | default('prefill_first') -%}

# Engine delivery mode: 'configmap' or 'inline'
{%- set k8s_engine_mode = dynamo_config.k8s_engine_mode | default('inline') -%} # dynamo_config.k8s_engine_mode configmap or inline
{%- set use_engine_cm = (k8s_engine_mode == 'configmap') -%}
{%- set k8s_engine_cm_name = dynamo_config.k8s_engine_cm_name | default('engine-configs') -%}
{%- set k8s_engine_cm_mount = '/workspace/engine_configs' -%}

# Model cache: 'disabled' or 'pvc:<claimName>'
{%- set _mc = dynamo_config.k8s_model_cache | default('pvc:model-cache') -%} # dynamo_config.k8s_model_cache disabled or pvc:<claimName>
{%- set _mc_parts = _mc.split(':') -%}
{%- set k8s_use_model_cache = (_mc != 'disabled') -%}
{%- set k8s_model_cache_pvc = (_mc_parts[1] if _mc_parts[0] == 'pvc' else 'model-cache') -%}
{%- set k8s_model_cache_mount = '/workspace/model_cache' -%}

# Engine-args file locations inside container
{%- set prefill_engine_args = '/workspace/engine_configs/prefill_config.yaml' -%}
{%- set decode_engine_args = '/workspace/engine_configs/decode_config.yaml' -%}
{%- set agg_engine_args = '/workspace/engine_configs/agg_config.yaml' -%}

# Replica/GPU counts come from generator
{%- set frontend_replicas = frontend_replicas | default(1) -%}
{%- set prefill_workers = prefill_workers | default(1) -%}
{%- set decode_workers = decode_workers | default(1) -%}
{%- set prefill_gpu = prefill_gpu | default('1') -%}
{%- set decode_gpu = decode_gpu | default('1') -%}
{%- set agg_workers = agg_workers | default(1) -%}
{%- set agg_gpu = agg_gpu | default('1') -%}

{{ '\n' }}
apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: {{ name }}
  namespace: {{ k8s_namespace }}
spec:
  services:
    Frontend:
      dynamoNamespace: {{ name }}
      componentType: frontend
      replicas: {{ frontend_replicas }}
      extraPodSpec:
        {% if k8s_use_model_cache %}
        volumes:
          - name: model-cache
            persistentVolumeClaim:
              claimName: {{ k8s_model_cache_pvc }}
        {% endif %}
        {% if k8s_image_pull_secret %}
        imagePullSecrets:
          - name: {{ k8s_image_pull_secret }}
        {% endif %}
        mainContainer:
          image: {{ k8s_image }}
          imagePullPolicy: IfNotPresent
          {% if k8s_use_model_cache %}
          volumeMounts:
            - name: model-cache
              mountPath: {{ k8s_model_cache_mount }}
          {% endif %}
      {% if is_kv %}
      envs:
        - name: DYN_ROUTER_MODE
          value: kv
      {% endif %}

    {% if mode == 'agg' %}
    # ===================== AGG =====================
    TRTLLMWorker:
      envFromSecret: hf-token-secret
      dynamoNamespace: {{ name }}
      componentType: worker
      replicas: {{ agg_workers }}
      resources:
        limits:
          gpu: "{{ agg_gpu }}"
      extraPodSpec:
        volumes:
          {% if k8s_use_model_cache %}
          - name: model-cache
            persistentVolumeClaim:
              claimName: {{ k8s_model_cache_pvc }}
          {% endif %}
          {% if use_engine_cm %}
          - name: engine-configs
            configMap:
              name: {{ k8s_engine_cm_name }}
          {% else %}
          - name: engine-configs
            emptyDir: {}
          {% endif %}
          - name: tmp
            emptyDir:
              medium: Memory
              sizeLimit: 10Gi
        {% if k8s_image_pull_secret %}
        imagePullSecrets:
          - name: {{ k8s_image_pull_secret }}
        {% endif %}
        mainContainer:
          image: {{ k8s_image }}
          workingDir: {{ working_dir }}
          imagePullPolicy: IfNotPresent
          volumeMounts:
            {% if k8s_use_model_cache %}
            - name: model-cache
              mountPath: {{ k8s_model_cache_mount }}
            {% endif %}
            - name: engine-configs
              mountPath: {{ k8s_engine_cm_mount }}
              {% if use_engine_cm %}readOnly: true{% endif %}
            - name: tmp
              mountPath: /tmp
          command: ["/bin/bash","-c"]
          args:
            - |
              set -euo pipefail
              cd "{{ working_dir }}"
              {% if not use_engine_cm %}
              mkdir -p {{ k8s_engine_cm_mount }}
              cat > {{ agg_engine_args }} <<'YAML'
{{ (agg_engine_args_inline | trim | indent(14, true)) }}
              YAML
              {% endif %}
              args=(
                --model-path "{{ model_path }}"
                --served-model-name "{{ served_model_name }}"
                --extra-engine-args "{{ agg_engine_args }}"
                {% if is_kv %}
                --publish-events-and-metrics
                {% endif %}
              )
              exec python3 -m dynamo.trtllm "${args[@]}"
          startupProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 40
          livenessProbe:
            httpGet:
              path: /live
              port: 9090
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 10
          readinessProbe:
            httpGet:
              path: /live
              port: 9090
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 10

    {% else %}
    # ================== DISAGG ==================
    TRTLLMPrefillWorker:
      dynamoNamespace: {{ name }}
      envFromSecret: hf-token-secret
      componentType: worker
      replicas: {{ prefill_workers }}
      resources:
        limits:
          gpu: "{{ prefill_gpu }}"
      extraPodSpec:
        volumes:
          {% if k8s_use_model_cache %}
          - name: model-cache
            persistentVolumeClaim:
              claimName: {{ k8s_model_cache_pvc }}
          {% endif %}
          {% if use_engine_cm %}
          - name: engine-configs
            configMap:
              name: {{ k8s_engine_cm_name }}
          {% else %}
          - name: engine-configs
            emptyDir: {}
          {% endif %}
          - name: tmp
            emptyDir:
              medium: Memory
              sizeLimit: 10Gi
        {% if k8s_image_pull_secret %}
        imagePullSecrets:
          - name: {{ k8s_image_pull_secret }}
        {% endif %}
        mainContainer:
          image: {{ k8s_image }}
          imagePullPolicy: IfNotPresent
          workingDir: {{ working_dir }}
          volumeMounts:
            {% if k8s_use_model_cache %}
            - name: model-cache
              mountPath: {{ k8s_model_cache_mount }}
            {% endif %}
            - name: engine-configs
              mountPath: {{ k8s_engine_cm_mount }}
              {% if use_engine_cm %}readOnly: true{% endif %}
            - name: tmp
              mountPath: /tmp
          command: ["/bin/bash","-c"]
          args:
            - |
              set -euo pipefail
              cd "{{ working_dir }}"
              {% if not use_engine_cm %}
              mkdir -p {{ k8s_engine_cm_mount }}
              cat > {{ prefill_engine_args }} <<'YAML'
{{ (prefill_engine_args_inline | trim | indent(14, true)) }}
              YAML
              {% endif %}
              args=(
                --model-path "{{ model_path }}"
                --served-model-name "{{ served_model_name }}"
                --extra-engine-args "{{ prefill_engine_args }}"
                --disaggregation-mode prefill
                --disaggregation-strategy "{{ disaggregation_strategy }}"
                {% if is_kv and disaggregation_strategy == 'prefill_first' %}
                --publish-events-and-metrics
                {% endif %}
              )
              exec python3 -m dynamo.trtllm "${args[@]}"
          startupProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 40
          livenessProbe:
            httpGet:
              path: /live
              port: 9090
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 10
          readinessProbe:
            httpGet:
              path: /live
              port: 9090
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 10

    TRTLLMDecodeWorker:
      dynamoNamespace: {{ name }}
      envFromSecret: hf-token-secret
      componentType: worker
      replicas: {{ decode_workers }}
      resources:
        limits:
          gpu: "{{ decode_gpu }}"
      extraPodSpec:
        volumes:
          {% if k8s_use_model_cache %}
          - name: model-cache
            persistentVolumeClaim:
              claimName: {{ k8s_model_cache_pvc }}
          {% endif %}
          {% if use_engine_cm %}
          - name: engine-configs
            configMap:
              name: {{ k8s_engine_cm_name }}
          {% else %}
          - name: engine-configs
            emptyDir: {}
          {% endif %}
          - name: tmp
            emptyDir:
              medium: Memory
              sizeLimit: 10Gi
        {% if k8s_image_pull_secret %}
        imagePullSecrets:
          - name: {{ k8s_image_pull_secret }}
        {% endif %}
        mainContainer:
          image: {{ k8s_image }}
          imagePullPolicy: IfNotPresent
          workingDir: {{ working_dir }}
          volumeMounts:
            {% if k8s_use_model_cache %}
            - name: model-cache
              mountPath: {{ k8s_model_cache_mount }}
            {% endif %}
            - name: engine-configs
              mountPath: {{ k8s_engine_cm_mount }}
              {% if use_engine_cm %}readOnly: true{% endif %}
            - name: tmp
              mountPath: /tmp
          command: ["/bin/bash","-c"]
          args:
            - |
              set -euo pipefail
              cd "{{ working_dir }}"
              {% if not use_engine_cm %}
              mkdir -p {{ k8s_engine_cm_mount }}
              cat > {{ decode_engine_args }} <<'YAML'
{{ (decode_engine_args_inline | trim | indent(14, true)) }}
              YAML
              {% endif %}
              args=(
                --model-path "{{ model_path }}"
                --served-model-name "{{ served_model_name }}"
                --extra-engine-args "{{ decode_engine_args }}"
                --disaggregation-mode decode
                --disaggregation-strategy "{{ disaggregation_strategy }}"
                {% if is_kv and disaggregation_strategy == 'decode_first' %}
                --publish-events-and-metrics
                {% endif %}
              )
              exec python3 -m dynamo.trtllm "${args[@]}"
          startupProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 40
          livenessProbe:
            httpGet:
              path: /live
              port: 9090
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 10
          readinessProbe:
            httpGet:
              path: /live
              port: 9090
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 10
    {% endif %}
