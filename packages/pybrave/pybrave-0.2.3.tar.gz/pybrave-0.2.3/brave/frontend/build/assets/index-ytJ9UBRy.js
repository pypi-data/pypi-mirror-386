import{f as E,A as me,G as de,H as _e,r as w,J as ve,K as be,_ as ae,W as Se,L as Me,a as pe,d as re,s as Ee,j as te}from"./main-D6qHus43.js";import{C as we}from"./index-oyOmkC6S.js";import{u as Ce}from"./index-CjmxhRai.js";const fe=3,ne=function(t,e){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const a=document.createElement("canvas"),l=a.getContext("2d"),o=t*s,m=e*s;return a.setAttribute("width",`${o}px`),a.setAttribute("height",`${m}px`),l.save(),[l,a,o,m]},We=(t,e,s)=>{const a=t*Math.cos(s)-e*Math.sin(s),l=t*Math.sin(s)+e*Math.cos(s);return[a,l]},Ae=()=>{const t=(e,s,a,l,o,m,d,g)=>{const[k,Z,_,H]=ne(l,o,a);if(e instanceof HTMLImageElement)k.drawImage(e,0,0,_,H);else{const{color:n,fontSize:u,fontStyle:h,fontWeight:I,fontFamily:p,textAlign:K}=m,Y=Number(u)*a;k.font=`${h} normal ${I} ${Y}px/${o}px ${p}`,k.fillStyle=n,k.textAlign=K,k.textBaseline="top";const F=me(e);F==null||F.forEach((D,J)=>{k.fillText(D??"",_/2,J*(Y+fe*a))})}const Q=Math.PI/180*Number(s),v=Math.max(l,o),[j,T,C]=ne(v,v,a);j.translate(C/2,C/2),j.rotate(Q),_>0&&H>0&&j.drawImage(Z,-_/2,-H/2);let W=0,z=0,b=0,L=0;const N=_/2,A=H/2;[[0-N,0-A],[0+N,0-A],[0+N,0+A],[0-N,0+A]].forEach(n=>{let[u,h]=n;const[I,p]=We(u,h,Q);W=Math.min(W,I),z=Math.max(z,I),b=Math.min(b,p),L=Math.max(L,p)});const X=W+C/2,q=b+C/2,$=z-W,S=L-b,R=d*a,M=g*a,B=($+R)*2,x=S+M,[U,V]=ne(B,x),O=function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;U.drawImage(T,X,q,$,S,n,u,$,S)};return O(),O($+R,-S/2-M/2),O($+R,+S/2+M/2),[V.toDataURL(),B/a,x/a]};return E.useCallback(t,[])};function $e(t){const e=E.useRef(!1),s=E.useRef(null),a=de(t);return()=>{e.current||(e.current=!0,a(),s.current=_e(()=>{e.current=!1}))}}function Ne(){const t=w.useRef([null,null]);return(s,a)=>{const l=s.map(o=>o instanceof HTMLElement||Number.isNaN(o)?"":o);return ve(t.current[0],l)||(t.current=[l,a()]),t.current[1]}}function Re(t){return t.replace(/([A-Z])/g,"-$1").toLowerCase()}function Fe(t){return Object.keys(t).map(e=>`${Re(e)}: ${t[e]};`).join(" ")}function Pe(){return window.devicePixelRatio||1}const je=(t,e)=>{let s=!1;return t.removedNodes.length&&(s=Array.from(t.removedNodes).some(a=>e(a))),t.type==="attributes"&&e(t.target)&&(s=!0),s},ze={visibility:"visible !important"};function Oe(t){const e=w.useRef(new Map);return[(o,m,d)=>{if(d){if(!e.current.get(d)){const k=document.createElement("div");e.current.set(d,k)}const g=e.current.get(d);g.setAttribute("style",Fe(Object.assign(Object.assign(Object.assign({},t),{backgroundImage:`url('${o}')`,backgroundSize:`${Math.floor(m)}px`}),ze))),g.removeAttribute("class"),g.removeAttribute("hidden"),g.parentElement!==d&&d.append(g)}return e.current.get(d)},o=>{const m=e.current.get(o);m&&o&&o.removeChild(m),e.current.delete(o)},o=>Array.from(e.current.values()).includes(o)]}function ce(t,e){return t.size===e.size?t:e}const ie=100,le=100,ue={position:"relative",overflow:"hidden"},Ie=t=>{var e,s;const{zIndex:a=9,rotate:l=-22,width:o,height:m,image:d,content:g,font:k={},style:Z,className:_,rootClassName:H,gap:Q=[ie,le],offset:v,children:j,inherit:T=!0}=t,C=Object.assign(Object.assign({},ue),Z),[,W]=be(),{color:z=W.colorFill,fontSize:b=W.fontSizeLG,fontWeight:L="normal",fontStyle:N="normal",fontFamily:A="sans-serif",textAlign:ee="center"}=k,[X=ie,q=le]=Q,$=X/2,S=q/2,R=(e=v==null?void 0:v[0])!==null&&e!==void 0?e:$,M=(s=v==null?void 0:v[1])!==null&&s!==void 0?s:S,B=E.useMemo(()=>{const r={zIndex:a,position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"none",backgroundRepeat:"repeat"};let c=R-$,i=M-S;return c>0&&(r.left=`${c}px`,r.width=`calc(100% - ${c}px)`,c=0),i>0&&(r.top=`${i}px`,r.height=`calc(100% - ${i}px)`,i=0),r.backgroundPosition=`${c}px ${i}px`,r},[a,R,$,M,S]),[x,U]=E.useState(),[V,O]=E.useState(new Set),n=E.useMemo(()=>{const r=x?[x]:[];return[].concat(r,ae(Array.from(V)))},[x,V]),u=r=>{let c=120,i=64;if(!d&&r.measureText){r.font=`${Number(b)}px ${A}`;const P=me(g),G=P.map(y=>{const f=r.measureText(y);return[f.width,f.fontBoundingBoxAscent+f.fontBoundingBoxDescent]});c=Math.ceil(Math.max.apply(Math,ae(G.map(y=>y[0])))),i=Math.ceil(Math.max.apply(Math,ae(G.map(y=>y[1]))))*P.length+(P.length-1)*fe}return[o??c,m??i]},h=Ae(),I=Ne(),[p,K]=E.useState(null),F=$e(()=>{const c=document.createElement("canvas").getContext("2d");if(c){const i=Pe(),[P,G]=u(c),y=f=>{const oe=[f||"",l,i,P,G,{color:z,fontSize:b,fontStyle:N,fontWeight:L,fontFamily:A,textAlign:ee},X,q],[xe,ke]=I(oe,()=>h.apply(void 0,oe));K([xe,ke])};if(d){const f=new Image;f.onload=()=>{y(f)},f.onerror=()=>{y(g)},f.crossOrigin="anonymous",f.referrerPolicy="no-referrer",f.src=d}else y(g)}}),[D,J,se]=Oe(B);w.useEffect(()=>{p&&n.forEach(r=>{D(p[0],p[1],r)})},[p,n]);const ge=de(r=>{r.forEach(c=>{if(je(c,se))F();else if(c.target===x&&c.attributeName==="style"){const i=Object.keys(ue);for(let P=0;P<i.length;P+=1){const G=i[P],y=C[G],f=x.style[G];y&&y!==f&&(x.style[G]=y)}}})});Ce(n,ge),w.useEffect(F,[l,a,o,m,d,g,z,b,L,N,A,ee,X,q,R,M]);const he=E.useMemo(()=>({add:r=>{O(c=>{const i=new Set(c);return i.add(r),ce(c,i)})},remove:r=>{J(r),O(c=>{const i=new Set(c);return i.delete(r),ce(c,i)})}}),[]),ye=T?E.createElement(Se.Provider,{value:he},j):j;return E.createElement("div",{ref:U,className:Me(_,H),style:C},ye)},De=async({project:t,analysisFileNames:e,params:s})=>(await pe.post("/fast-api/find-analyais-result-by-analysis-method",{project:t,analysis_method:e,...s})).data,Le=({pipeline:t,form:e,resultTableList:s,operatePipeline:a,formJson:l,formDom:o,params:m,sampleGroupApI:d,setPlotLoading:g,inputAnalysisMethod:k,saveAnalysisMethod:Z,project:_,setFilePlot:H,plotReloadTable:Q,callback:v,dataComponentIds:j,name:T,analysisResultId:C,...W})=>{const z=re.useWatch(n=>n==null?void 0:n.analysis_id,e),b=re.useWatch(n=>n,e),[L,N]=w.useState([]),[A,ee]=w.useState("xlsx"),[X,q]=w.useState("pdf"),[$,S]=Ee.useMessage(),R=async()=>{try{const u=(await pe.post("/fast-api/find-sample",{project:"hexiaoyan",sequencing_target:"DNA",sequencing_technique:"NGS",sample_composition:"meta_genome"})).data.map(h=>({label:h.sample_key,value:h.sample_key,sample_group:h.sample_group,sample_source:h.sample_source,host_disease:h.host_disease}));N(u)}catch(n){console.log(n)}};w.useEffect(()=>{e.resetFields()},[_]);const M={first_data_key:void 0},[B,x]=w.useState(M);w.useEffect(()=>{T&&e.setFieldValue("analysis_name",T)},[T]);const U=n=>{if(n&&Object.keys(n).length>0)return Object.keys(n)[0]},V=async n=>{const h=(await De({project:_,analysisFileNames:n})).reduce((p,K)=>{const Y=K.analysis_method;p[Y]||(p[Y]=[]);const{sample_key:F,id:D,sample_group:J,...se}=K;return p[Y].push({label:F,value:D,sample_group:J||"no_group",sample_key:F,id:D,...se}),p},{}),I={...M,...s,...h,first_data_key:U(s)};x(I)};w.useEffect(()=>{if(d)R();else{let n=[];if(l&&(n=l.filter(u=>u.inputAnalysisMethod!==void 0).map(u=>u.inputAnalysisMethod)),n.length!=0)V(n);else{const u={...M,...s,first_data_key:U(s)};console.log(u),x(u)}}},[JSON.stringify(s)]);const O={...m,project:_,analysis_result_id:C,analysis_method:Z,table_type:A,imgType:X,software:"python",component_id:W.component_id,data_component_ids:JSON.stringify(j)};return te.jsxs(te.Fragment,{children:[S,te.jsx(Ie,{content:z&&`更新分析(${b.analysis_name})(${String(b.analysis_id).slice(0,8)})`,children:te.jsx(we,{analysisResultId:C,form:e,requestParam:O,dataMap:B,formJson:l,databases:W.databases,callback:v})})]})};export{Le as A};
