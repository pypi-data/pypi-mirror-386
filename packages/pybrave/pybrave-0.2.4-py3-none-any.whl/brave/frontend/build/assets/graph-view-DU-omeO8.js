const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./force-graph-BrUwvHgU.js","./main-CH82g4dw.js","./main-PWR3lu3V.css","./rgb-DmU_BU0N.js","./Paired-CYeW8vca.js","./zoom-Dkc1Gi0B.js","./vis-network-wtTxkkyT.js"])))=>i.map(i=>d[i]);
import{r as l,ed as me,b as ge,k as ve,M as X,ad as be,u as ye,a as we,j as e,I as je,bq as ke,F as Re,eg as Ce,t as z,l as K,U as Y,S as Se,B as _e,D as De,e as Ge}from"./main-CH82g4dw.js";import{C as Ee}from"./index-ZaXfouA1.js";import{S as $}from"./index-C0dVCwMu.js";import{d as Ie,R as ze,c as Le,a as Te,b as Ae}from"./TableOutlined-CZ_BS3k3.js";import{R as Me}from"./index-DTJd4Z3p.js";import{R as Ne}from"./RedoOutlined-DNpCn5kL.js";import{D as Z,m as Pe,n as Oe}from"./Table-Rz-gL0vt.js";import{R as Ve}from"./NodeIndexOutlined-Cav4TyHH.js";import"./index-B_L60N4-.js";import"./Dropdown-B4TP4OlU.js";import"./addEventListener-DrXUXNAy.js";import"./index-BL_XwOQI.js";function $e(n,o,{signal:s,edges:r}={}){let a,i=null;const h=r!=null&&r.includes("leading"),v=r==null||r.includes("trailing"),g=()=>{i!==null&&(n.apply(a,i),a=void 0,i=null)},x=()=>{v&&g(),S()};let u=null;const f=()=>{u!=null&&clearTimeout(u),u=setTimeout(()=>{u=null,x()},o)},m=()=>{u!==null&&(clearTimeout(u),u=null)},S=()=>{m(),a=void 0,i=null},y=()=>{g()},b=function(..._){if(s!=null&&s.aborted)return;a=this,i=_;const w=u==null;f(),h&&w&&g()};return b.schedule=f,b.cancel=S,b.flush=y,s==null||s.addEventListener("abort",S,{once:!0}),b}function ee(n,o=0,s={}){typeof s!="object"&&(s={});const{leading:r=!1,trailing:a=!0,maxWait:i}=s,h=Array(2);r&&(h[0]="leading"),a&&(h[1]="trailing");let v,g=null;const x=$e(function(...m){v=n.apply(this,m),g=null},o,{edges:h}),u=function(...m){return i!=null&&(g===null&&(g=Date.now()),Date.now()-g>=i)?(v=n.apply(this,m),g=Date.now(),x.cancel(),x.schedule(),v):(x.apply(this,m),v)},f=()=>(x.flush(),v);return u.cancel=x.cancel,u.flush=f,u}function Fe(n,o=0,s={}){const{leading:r=!0,trailing:a=!0}=s;return ee(n,o,{leading:r,maxWait:o,trailing:a})}const Be=(n,o,s,r)=>{switch(o){case"debounce":return ee(n,s,r);case"throttle":return Fe(n,s,r);default:return n}},We=n=>{const o=l.useRef(n);return l.useEffect(()=>{o.current=n}),l.useMemo(()=>(...s)=>{var r;return(r=o.current)===null||r===void 0?void 0:r.call(o,...s)},[])},qe=n=>{const[o,s]=l.useState((n==null?void 0:n.current)||null);return n&&setTimeout(()=>{n.current!==o&&s(n.current)},0),{refProxy:l.useMemo(()=>new Proxy(a=>{a!==o&&s(a)},{get(a,i){return i==="current"?o:a[i]},set(a,i,h){return i==="current"?s(h):a[i]=h,!0}}),[o]),refElement:o,setRefElement:s}},He=(n,o)=>{var s,r;const a=(s=n.borderBoxSize)===null||s===void 0?void 0:s[0],i=(r=n.contentBoxSize)===null||r===void 0?void 0:r[0];return o==="border-box"&&a?{width:a.inlineSize,height:a.blockSize}:o==="content-box"&&i?{width:i.inlineSize,height:i.blockSize}:{width:n.contentRect.width,height:n.contentRect.height}};function Qe({skipOnMount:n=!1,refreshMode:o,refreshRate:s=1e3,refreshOptions:r,handleWidth:a=!0,handleHeight:i=!0,targetRef:h,observerOptions:v,onResize:g,disableRerender:x=!1}={}){const u=l.useRef(n),f=We(g),[m,S]=l.useState({width:void 0,height:void 0}),y=l.useRef({width:void 0,height:void 0}),{refProxy:b,refElement:_}=qe(h),{box:w}=v||{},L=l.useCallback(j=>{if(!a&&!i)return;if(u.current){u.current=!1;return}const k=(p,d)=>a&&p.width!==d.width||i&&p.height!==d.height;j.forEach(p=>{const d=He(p,w);x?k(y.current,d)&&(y.current.width=d.width,y.current.height=d.height,f==null||f({width:d.width,height:d.height,entry:p})):S(N=>k(N,d)?(f==null||f({width:d.width,height:d.height,entry:p}),d):N)})},[a,i,u,w,x]),D=l.useCallback(Be(L,o,s,r),[L,o,s,r]);return l.useEffect(()=>{let j;if(_)try{j=new window.ResizeObserver(D),j.observe(_,v)}catch(k){console.warn("ResizeObserver not supported or failed to initialize:",k)}else(m.width||m.height)&&(f==null||f({width:null,height:null,entry:null}),y.current.width=void 0,y.current.height=void 0,x||S({width:void 0,height:void 0}));return()=>{var k,p,d;(k=j==null?void 0:j.disconnect)===null||k===void 0||k.call(j),(d=(p=D).cancel)===null||d===void 0||d.call(p)}},[D,_]),Object.assign({ref:b},x?y.current:m)}const{Option:bt}=Ge,{Search:Ue}=je,M=[{label:"Disease",value:"disease"},{label:"Taxonomy",value:"taxonomy"},{label:"Diet_and_food",value:"diet_and_food"},{label:"Study",value:"study"}],Je=l.lazy(()=>Y(()=>import("./force-graph-BrUwvHgU.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),Ke=l.lazy(()=>Y(()=>import("./vis-network-wtTxkkyT.js"),__vite__mapDeps([6,1,2]),import.meta.url)),Xe=[{key:"forceGraphView",label:"ai chat",component:Je},{key:"visNetwork",label:"details",component:Ke}],Ye=({view:n,...o})=>{if(!n)return e.jsx("div",{onClick:close,children:"未知类型"});const s=Xe.find(h=>h.key===n);if(!s)return e.jsx("div",{children:"未知类型"});const{component:r,key:a,...i}=s;return e.jsx(l.Suspense,{fallback:e.jsx(Se,{active:!0}),children:e.jsx(r,{...i,...o})})},Ze=({openView:n,height:o,activeView:s,updateQueryParams:r,entity_id:a,openGlobalModal:i,...h},v)=>{const[g,x]=l.useState({nodes:[],links:[]}),[u,f]=l.useState(),[m,S]=l.useState("visNetwork"),y=l.useRef(new Map);console.log("GraphView mounted");const b=l.useRef(null),{locale:_}=me(),{modal:w,openModal:L,closeModal:D}=ge(),{width:j,ref:k}=Qe(),[p,d]=l.useState(null),[N,st]=l.useState(null),[T,F]=l.useState(!1),[E,P]=l.useState(null),[B,te]=l.useState({x:0,y:0}),[W,O]=l.useState(!1),{messageApi:ne}=ve(),[oe,se]=l.useState(null),[it,ie]=X.useModal(),re=be(),{displayNode:le}=ye(t=>t.graph),[q,ae]=l.useState(!0),ce=()=>{var t,c;if((t=b.current)!=null&&t.renderer){const C=b.current.renderer();console.log(C.info),se({geometries:C.info.memory.geometries,textures:C.info.memory.textures,programs:((c=C.info.programs)==null?void 0:c.length)||0,renderCalls:C.info.render.calls})}};l.useImperativeHandle(v,()=>({reload:A,cancelSelectLink:()=>f(null),cancelSelectNode:()=>P(null),updateQueryParam:I,queryParams:R}));const de=[{key:"details",label:"details"}],ue=t=>{t.key=="details"&&(console.log(t),console.log(E),I("entity_id",E.id)),O(!1)};l.useEffect(()=>{const t=()=>{O(!1)};return W&&window.addEventListener("click",t),()=>{window.removeEventListener("click",t)}},[E]);const H=()=>{console.log("isWebGLAvailable");try{const t=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!t.getContext("webgl")}catch{return!1}},[R,Q]=l.useState({label:"",keyword:void 0,entity_id:a,nodes:le,nodes_dict:void 0,nodes_dict_condition:"OR"}),I=(t,c)=>{Q(C=>({...C,[t]:c||void 0}))},A=async()=>{V(),F(!0),console.log("请求参数:",R);const t=await we.post("/entity-relation/graph",{...R,locale:_});x(t.data),F(!1)},fe=t=>{Q(c=>({...c,[t]:void 0}))},V=()=>{var U,J;if(!b.current)return;const t=b.current;t.pauseAnimation&&t.pauseAnimation();const c=(U=t.renderer)==null?void 0:U.call(t);c&&c.dispose();const C=(J=t.scene)==null?void 0:J.call(t);C&&C.traverse(G=>{G.geometry&&G.geometry.dispose(),G.material&&(Array.isArray(G.material)?G.material.forEach(xe=>xe.dispose()):G.material.dispose())}),y.current.clear()};l.useEffect(()=>(H()?d(!0):d(!1),()=>{V()}),[]);const he=()=>{p&&V(),H()?d(!p):(d(!1),ne.error("WebGL not available!"))};l.useEffect(()=>{A(),r&&r(R)},[R,_]);const pe={loading:T,is3D:p,fgRef:b,graphData:g,width:j,height:o,queryParams:R,contextNode:E,labelColorMap:{study:"#6a5acd",disease:"#ff6347",taxonomy:"#3cb371",association:"#ffa500",diet_and_food:"#20b2aa"},spriteCacheRef:y,graphReady:q,openView:n,setContextNode:P,setSelectedLink:f,setOpenRightMenu:O,setMenuPos:te,selectedLink:u,setGraphReady:ae};return e.jsxs(e.Fragment,{children:[ie,e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center"},children:e.jsxs(Ee,{title:e.jsxs("div",{children:[Object.entries(R).filter(([t,c])=>t!=="nodes"&&t!=="label"&&t!=="nodes_dict"&&t!="nodes_dict_condition"&&c!==void 0).map(([t,c])=>e.jsxs(K,{closable:!0,color:"blue",onClose:()=>fe(t),style:{marginBottom:8},children:[t,": ",String(c)]},t)),R.nodes_dict&&Object.entries(R.nodes_dict).filter(([t,c])=>c&&c.length>0).map(([t,c])=>e.jsxs(K,{onClick:()=>n("dataFilter"),color:"green",style:{marginBottom:"0.5rem",cursor:"pointer"},children:[t,": ",c.length]},t))]}),styles:{body:{padding:0}},size:"small",extra:e.jsx(e.Fragment,{children:e.jsxs(Re,{justify:"flex-end",gap:"small",children:[m=="forceGraphView"&&e.jsx("span",{style:{cursor:"pointer"},onClick:he,children:p?"2D":"3D"}),e.jsx(ot,{options:[{label:"VisNetwork",value:"visNetwork"},{label:"ForceGraphView",value:"forceGraphView"}],onChange:()=>{},selectedLabel:m,setSelectedLabel:S,loading:T}),e.jsx(nt,{loading:T,options:M,selectedLabels:R.nodes,setSelectedLabels:t=>I("nodes",t),onChange:t=>{I("nodes",t),re(Ce(t))}}),e.jsx(z,{title:"association page",children:e.jsx(Ie,{onClick:()=>{n("associationPage")}})}),e.jsx(z,{title:"data screening",children:e.jsx(ze,{onClick:()=>{n("dataFilter")}})}),e.jsx(z,{title:"AI",children:e.jsx(Le,{onClick:()=>{n("chat")}})}),e.jsx(z,{title:"create",children:e.jsx(Me,{onClick:()=>{i("optModal",{entityType:"association"})}})}),e.jsx(z,{title:"refresh",children:e.jsx(Ne,{onClick:()=>A()})}),e.jsx(Te,{onClick:()=>{ce(),L("webGLInfo")}})]})}),style:{borderRadius:"12px",height:o,boxShadow:"0 4px 20px rgba(0,0,0,0.1)",padding:"0.5rem",overflow:"hidden",width:"100%"},children:[e.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:e.jsx(Ue,{placeholder:"搜索...",allowClear:!0,onSearch:t=>{I("keyword",t)},style:{flex:1}})}),e.jsx($,{indicator:e.jsx(ke,{spin:!0}),spinning:T||p==null||!q,children:e.jsxs("div",{ref:k,style:{height:`${o}px`},children:[e.jsx(Ye,{...pe,...h,view:m}),W&&E&&e.jsx("div",{style:{position:"fixed",top:B.y,left:B.x,background:"#222",border:"1px solid #444",borderRadius:"8px",boxShadow:"0 5px 15px rgba(0,0,0,0.5)",zIndex:100,padding:"4px 0",minWidth:"160px",color:"white"},children:de.map(t=>e.jsx("div",{onClick:()=>ue(t),style:{padding:"8px 16px",cursor:"pointer",transition:"background 0.2s, color 0.2s"},onMouseEnter:c=>{c.currentTarget.style.background="#555",c.currentTarget.style.color="#fff"},onMouseLeave:c=>{c.currentTarget.style.background="transparent",c.currentTarget.style.color="white"},children:t.label},t.key))})]})})]})}),e.jsx(tt,{callback:()=>A(),visible:w.key=="nodeView"&&w.visible,params:w.params,onClose:()=>{P(null),D()}}),e.jsx(et,{webglInfo:oe,visible:w.key=="webGLInfo"&&w.visible,onClose:D})]})},et=({webglInfo:n,visible:o,onClose:s})=>e.jsx(X,{title:"webGL",footer:null,open:o,onCancel:s,onClose:s,children:n&&e.jsxs("ul",{children:[e.jsxs("li",{children:["geometries: ",n.geometries]}),e.jsxs("li",{children:["textures: ",n.textures]}),e.jsxs("li",{children:["programs: ",n.programs]}),e.jsxs("li",{children:["renderCalls: ",n.renderCalls]})]})}),tt=({visible:n,params:o,onClose:s,callback:r})=>e.jsx(De,{title:`${o!=null&&o.entity_name?o.entity_name:""}`,open:n,onClose:s,width:"50%",placement:"right",children:JSON.stringify(o)}),yt=l.forwardRef(Ze),nt=({options:n,onChange:o,selectedLabels:s,setSelectedLabels:r,loading:a})=>e.jsx(Z,{trigger:["hover"],dropdownRender:()=>e.jsxs("div",{style:{padding:12,backgroundColor:"#1f1f1f",borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.3)",color:"#fff"},children:[e.jsx($,{spinning:a,children:e.jsx(Oe.Group,{style:{display:"flex",flexDirection:"column",gap:8},options:n.map(i=>({label:i.label,value:i.value,style:{color:"#fff"}})),value:s,onChange:i=>{r(i),o(i)}})}),e.jsx("div",{style:{marginTop:12,textAlign:"center"},children:e.jsx(_e,{size:"small",type:"primary",onClick:()=>{if(s.length===M.length)r([]),o([]);else{const i=M.map(h=>h.value);r(i),o(i)}},children:s.length===M.length?" Unselect All":"Select All"})})]}),children:e.jsx(Ve,{})}),ot=({options:n,onChange:o,selectedLabel:s,setSelectedLabel:r,loading:a=!1})=>e.jsx(Z,{trigger:["hover"],dropdownRender:()=>e.jsx("div",{style:{padding:12,backgroundColor:"#1f1f1f",borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.3)",color:"#fff"},children:e.jsx($,{spinning:a,children:e.jsx(Pe.Group,{style:{display:"flex",flexDirection:"column",gap:8},options:n.map(i=>({label:i.label,value:i.value,style:{color:"#fff"}})),value:s,onChange:i=>{r(i.target.value),o(i.target.value)}})})}),children:e.jsx(Ae,{})});export{Ye as GraphRender,yt as default,Xe as graphViewMapping};
