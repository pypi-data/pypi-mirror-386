import{d as y,k as Ie,r as o,u as de,j as e,F as A,B as b,I as G,E as Qe,m as We,i as me,a as F,M as ve,N as Xe,b as Ye,c as Ze,t as _,p as Ke,P,O as Pe,y as Ae,Q as Me,z as el,l as ll}from"./main-CH82g4dw.js";import sl from"./index-6IaXHF5K.js";import{C as Re}from"./index-ZaXfouA1.js";import{S as al}from"./index-B1-7HnQ_.js";import{F as $e,S as we,D as nl}from"./Table-Rz-gL0vt.js";import{u as tl}from"./index-_r2zE_l-.js";import{D as ol,T as il,U as rl,R as Se}from"./index-CweiUdAw.js";import{a as cl,b as dl,B as ml,c as pl}from"./index-BcI8WOZ3.js";import{A as xl}from"./index-Cem7jUqj.js";import{S as ke}from"./index-C0dVCwMu.js";import{T as ul}from"./index-B_L60N4-.js";import{R as Fe}from"./DeleteOutlined-CIV_DNOf.js";import{R as ye}from"./RedoOutlined-DNpCn5kL.js";import{R as _l}from"./index-BL_XwOQI.js";const fl=({parseData:n,columns:t,importData:i})=>e.jsx($e,{size:"small",bordered:!0,pagination:!1,footer:()=>e.jsxs("div",{style:{textAlign:"right"},children:["A total of",n.length," records   ",e.jsx(b,{size:"small",color:"cyan",variant:"solid",onClick:i,children:"Ok"})]}),columns:t,dataSource:n}),ce=({component_type:n,component_id:t,component_name:i,inputForm:x,operatePipeline:w,name:V,file_type:I,callback:L})=>{const[S]=y.useForm();console.log("-->ImportFile渲染");const{messageApi:v,project:se}=Ie(),[M,r]=o.useState([]);de(d=>d.global.setting);const[$,O]=o.useState(!1),[H,ae]=o.useState(),u=o.useRef(null);o.useEffect(()=>{if(x){let m=x.map(c=>Array.isArray(c.name)?c.name[1]:c.name).map(c=>({title:c,dataIndex:c,key:c,render:g=>e.jsx("span",{children:g})}));m=[{title:"Sample Name",dataIndex:"sample_name",key:"sample_name",render:c=>e.jsx("span",{children:c})},...m,{title:"Action",dataIndex:"action",key:"action",ellipsis:!0,render:(c,g)=>e.jsx(A,{gap:"small",children:e.jsx(b,{size:"small",danger:!0,onClick:()=>{Q(g.sample_name)},children:"删除"})})}],console.log(m),u.current=m,ae(m)}},[x]);const Q=d=>{r(m=>m.filter(c=>c.sample_name!==d))},W=d=>{const{content:m,sample_name:c,file_name:g}=d;return $?M.map(f=>{const{sample_name:R,...h}=f;return{...d,project:se,component_id:t,file_type:I,content:JSON.stringify(h),sample_name:R}}):[{...d,project:se,component_id:t,file_name:g,file_type:I,content:I&&I=="collected"?m:JSON.stringify(m),sample_name:c}]},s=async()=>{const d=await S.validateFields();if(d.length==0){v.error("No data added!");return}if(x&&x.length==0){v.error("This component does not have inputForm configured!");return}const m=W(d);try{const c=await F.post("/import-data",m);v.success("Imported successfully!"),L&&L()}catch(c){v.error(c.response.data.detail)}},ee=async()=>{const d=await S.validateFields();if(x&&x.length==0){v.error("This component does not have inputForm configured!");return}const m=await F.post("/parse-import-data",{content:JSON.stringify(d.content)});console.log(m),r(m.data)};return o.useEffect(()=>{const d=m=>{var J;const c=((J=m.clipboardData)==null?void 0:J.getData("Text"))||"";if(!c)return;const g=c.includes("	")?"	":",",R=c.split(/\r?\n/).filter(D=>D.trim()!=="").map(D=>D.split(g).map(E=>E.trim()));console.log(R);const h=R.map(D=>{const E={};return u.current.forEach((le,U)=>{D.length<=U?E[le.dataIndex]="unknown":E[le.dataIndex]=D[U]}),E});r(h),v.success("Paste successful!")};return document.addEventListener("paste",d),()=>{document.removeEventListener("paste",d)}},[]),e.jsx(e.Fragment,{children:e.jsx(Re,{variant:"borderless",size:"small",style:{boxShadow:"none"},title:`${i}(${t})`,extra:e.jsxs(A,{gap:"small",children:[e.jsx(al,{value:$,onChange:d=>O(d)}),e.jsx(b,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w.openModal("modalC",{data:{component_id:t},structure:{component_type:n}})},children:"Edit InputForm"}),e.jsx(b,{size:"small",color:"cyan",variant:"solid",disabled:!M,onClick:()=>r([]),children:"Clear"}),e.jsx(b,{size:"small",color:"cyan",variant:"solid",disabled:!x,onClick:ee,children:"Parse"})]}),children:e.jsxs(y,{form:S,children:[e.jsx(y.Item,{name:"sample_source",label:"Sample Source",rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(G,{placeholder:"gut,brain..."})}),!$&&e.jsx(e.Fragment,{children:I&&I=="collected"?e.jsx(y.Item,{name:"file_name",label:"File Name",rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(G,{})}):e.jsx(y.Item,{name:"sample_name",label:"Sample Name",rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(G,{})})}),x?e.jsx(e.Fragment,{children:e.jsx(sl,{formJson:x,dataMap:{}})}):e.jsx(e.Fragment,{children:e.jsx(Qe,{description:"This component does not have inputForm configured!",children:e.jsx(b,{color:"cyan",variant:"solid",onClick:()=>{w.openModal("modalC",{data:{component_id:t},structure:{component_type:n}})},children:"Config InputForm"})})}),$&&e.jsx(fl,{parseData:M,columns:H,importData:s}),!$&&e.jsx(b,{size:"small",color:"cyan",variant:"solid",onClick:s,children:"Ok"}),e.jsx(We,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(y.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(me,{children:e.jsx("pre",{children:JSON.stringify(W(S.getFieldsValue()),null,2)})})})})}]})]})})})},jl=({visible:n,onClose:t,params:i,callback:x})=>n?e.jsx(e.Fragment,{children:e.jsx(ve,{open:n,onClose:t,width:"80%",onCancel:t,title:"Import Data",footer:null,children:e.jsx(hl,{params:i,type:"inputFile",callback:()=>{t(),x&&x()}})})}):null,gl=({params:n,type:t,callback:i})=>{if(!n)return e.jsx(e.Fragment,{children:"无数据"});if(n.component_type=="software"){if(n[t]&&Array.isArray(n[t])&&n[t].length>0)return n[t].map((x,w)=>o.createElement(ce,{...x,operatePipeline:n.operatePipeline,key:w,callback:i}))}else{if(n.component_type=="pipeline")return e.jsx(ce,{...n});if(n.component_type=="file")return e.jsx(ce,{...n,callback:i})}},hl=o.memo(gl),Cl=({visible:n,onClose:t,params:i,callback:x})=>{if(!n)return null;const[w]=y.useForm(),V=async()=>{const L=await F(`/analysis-result/find-by-id/${i==null?void 0:i.analysis_result_id}`);w.setFieldsValue(L.data)};o.useEffect(()=>{i!=null&&i.analysis_result_id&&V()},[i==null?void 0:i.analysis_result_id]);const I=async()=>{const S={...await w.validateFields(),id:i.id};console.log(S);const v=await tl(i==null?void 0:i.analysis_result_id,S);console.log(v),x&&x(),t()};return e.jsx(ve,{title:"Edit Analsyis Result",open:n,onClose:t,onCancel:t,onOk:I,children:e.jsxs(y,{form:w,children:[e.jsx(y.Item,{label:"File Name",name:"file_name",children:e.jsx(G,{})}),e.jsx(y.Item,{label:"Sample Source",name:"sample_source",children:e.jsx(G,{})})]})})},Ll=o.forwardRef(({pipeline:n,software:t,title:i,form:x,appendSampleColumns:w=[],setResultTableList:V,cleanDom:I,analysisType:L,setRecord:S,setTableLoading:v,setTabletData:se,shouldTrigger:M,analysisMethod:r,columnsParamsALL:$,activeTabKey:O,setActiveTabKey:H,cardExtra:ae,operatePipeline:u,relationType:Q,onChangeAnalysisResultId:W,currentAnalysisMethod:s,setCurrentAnalysisMethod:ee,params:d,...m},c)=>{o.useImperativeHandle(c,()=>({reload:C})),Xe();const{project:g,projectObj:f}=Ie(),R=Ae(),[h,J]=o.useState([]),[D,E]=o.useState(),[le,U]=o.useState(!0),{modal:B,openModal:pe,closeModal:xe}=Ye(),[ne,ue]=o.useState([]),[De,Ee]=o.useState({}),[Ne,Te]=o.useState([]),[ze,te]=o.useState(!0),[k,Le]=o.useState(),[_e,Oe]=o.useState(200),{baseURL:oe}=de(l=>l.user),Je=Ze(),X=l=>{Le(l),W&&W(l)},Y=l=>{Te([])},j=de(l=>l.global.sseData);o.useEffect(()=>{const l=j;l.msgType==="analysis_result"&&r.map(p=>p.component_id).includes(l.component_id)&&C()},[j]);const C=()=>{if(console.log("analysisMethod: ",r),r&&Array.isArray(r)){const l=r.flatMap(a=>a.component_id);ge({componentIdList:l})}else ge({params:d})},fe=l=>r.reduce((N,T)=>(N[T==null?void 0:T.component_id]=T,N),{})[l];o.useEffect(()=>{var l,a;if(r&&Array.isArray(r)&&r.length>0&&H){H((l=r[0])==null?void 0:l.component_id);const p=fe((a=r[0])==null?void 0:a.component_id);ee(p)}C()},[JSON.stringify(d),JSON.stringify(r),g,f==null?void 0:f.metadata_form]);const Ue=l=>{const a=D[l];J(a),H(l);const p=fe(l);ee(p),a.length>0?(X(a[0].analysis_result_id),Y(a[0].columns)):(Y(),X(void 0))},je=async()=>{if((s==null?void 0:s.file_type)=="collected"&&k){te(!0);const l=await F.get(`/analysis-result/table/${k}?row_num=${_e}`,{timeout:2e4});ue(l.data.tables),te(!1),Ee({nrow:l.data.nrow,ncol:l.data.ncol})}else ue([]),te(!1)};o.useEffect(()=>{je()},[k]);const ge=async({analysisMethodValues:l,params:a,componentIdList:p})=>{var N,T;if(U(!0),p){let re=await F.post("/analysis-result/list-analysis-result-grouped",{project:g,component_ids:p,...a});U(!1);const z=re.data;console.log("groupedData",z),V&&V(z),E(z);let q;O?q=z[O]?z[O]:[]:q=z[(N=r[0])==null?void 0:N.component_id]?z[(T=r[0])==null?void 0:T.component_id]:[],J(q),q.length>0?(X(q[0].analysis_result_id),Y(q[0].columns)):(Y(),X(void 0))}else{let re=await F.post("/analysis-result/list-analysis-result",{project:g,component_ids:p,...a});J(re.data)}U(!1)},he=async l=>{await F.delete(`/analyais-result/delete-by-id/${l}`),R.success("删除成功!"),C()};let Be=[{title:"Project Name",dataIndex:"project_name",key:"project_name",width:100,ellipsis:!0,render:(l,a)=>e.jsx(_,{title:a.project,children:e.jsx("span",{style:{cursor:"pointer"},children:l})})},{title:"Analysis Result ID",dataIndex:"analysis_result_id",key:"analysis_result_id",width:50,ellipsis:!0,render:(l,a)=>e.jsx(_,{title:a.analysis_result_id,children:e.jsx("span",{style:{cursor:"pointer"},children:String(l).slice(0,8)})})},{title:"Analysis Id",dataIndex:"analysis_id",key:"analysis_id",width:50,ellipsis:!0,render:(l,a)=>e.jsx(_,{title:a.analysis_id,children:e.jsx("span",{style:{cursor:"pointer"},children:l?String(l).slice(0,8):""})})},{title:"Component Name",dataIndex:"component_name",key:"component_name",width:100,ellipsis:!0,render:(l,a)=>e.jsx(_,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id: ",a.analysis_id]}),e.jsxs("li",{children:["component_id: ",a.component_id]}),e.jsxs("li",{children:["analysis_result_id: ",a.analysis_result_id]}),e.jsxs("li",{children:["sample_id: ",a.sample_id]}),e.jsxs("li",{children:["file_name: ",a.file_name]}),e.jsxs("li",{children:["analysis_result_hash: ",a.analysis_result_hash]})]})}),children:e.jsx("span",{style:{cursor:"pointer"},children:l})})},{title:"Sample Name",dataIndex:"sample_name",key:"sample_name",width:100,ellipsis:!0,render:(l,a)=>e.jsx(_,{title:e.jsx(e.Fragment,{children:e.jsx("ul",{children:e.jsxs("li",{children:["sample_id: ",a.sample_id]})})}),children:e.jsx("span",{style:{cursor:"pointer"},children:l})})},{title:"Sample Source",dataIndex:"sample_source",key:"sample_source",width:100,ellipsis:!0},...(()=>{var l;return!(f!=null&&f.metadata_form)||!Array.isArray(f==null?void 0:f.metadata_form)?[]:(l=f==null?void 0:f.metadata_form)==null?void 0:l.map(a=>({title:a.label,dataIndex:a.name,key:a.name,ellipsis:!0}))})(),...w,{title:"Action",key:"action",fixed:"right",ellipsis:!0,width:200,render:(l,a)=>e.jsxs(we,{size:"middle",children:[e.jsx(Ke,{content:e.jsx(e.Fragment,{children:e.jsx(me,{children:e.jsx("pre",{children:JSON.stringify(a.content,null,2)})})}),children:e.jsx(b,{size:"small",color:"cyan",variant:"solid",onClick:()=>{S&&S(a),u.openModal("openFile",{content:a.content,fileType:a.file_type,description:s.description})},children:"Open"})}),a.sample_name?e.jsx(e.Fragment,{children:e.jsx(b,{size:"small",color:"cyan",variant:"solid",onClick:()=>{u.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,sample_id:a.sample_id,callback:C})},children:"metadata"})}):e.jsx(e.Fragment,{children:e.jsx(b,{size:"small",color:"cyan",variant:"solid",onClick:()=>{u.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,callback:C})},children:"Add Metadata"})}),e.jsx(b,{size:"small",color:"cyan",variant:"solid",onClick:()=>{console.log(u),u.openModals("bindSample",{analysis_result_id:a.analysis_result_id,callback:C})},children:"Bind Sample "}),e.jsx(P,{title:"Are you sure you want to delete it?",onConfirm:async()=>{await he(a.analysis_result_id)},children:e.jsx(b,{size:"small",color:"danger",variant:"solid",children:"Delete"})})]})}];const[Z,qe]=o.useState("");let K=o.useMemo(()=>Z?(s==null?void 0:s.file_type)=="collected"?ne.filter(l=>Object.values(l).some(a=>String(a).toLowerCase().includes(Z.toLowerCase()))):h.filter(l=>Object.values(l).some(a=>String(a).toLowerCase().includes(Z.toLowerCase()))):(s==null?void 0:s.file_type)=="collected"?ne:h,[h,ne,Z]);const[ie,Ge]=o.useState([]),[Ve,Ce]=o.useState(!1),be={onRemove:l=>{const a=ie.indexOf(l),p=ie.slice();p.splice(a,1),Ge(p)},beforeUpload:l=>(He(l),!1),fileList:ie},He=async l=>{Ce(!0);const a=new FormData;a.append("file",l),a.append("project",g),a.append("component_id",s==null?void 0:s.component_id);for(let[p,N]of a.entries())console.log(p,N);try{const p=await F.post("/analysis-result/upload",a,{timeout:6e4});R.success(`${p.data.file_path} file uploaded successfully`)}catch{}Ce(!1),C()};return e.jsxs(e.Fragment,{children:[e.jsxs(Re,{size:"small",variant:"borderless",style:{boxShadow:"none"},styles:{body:{padding:"0.5rem"}},title:e.jsxs(A,{gap:"small",children:[e.jsx(_l,{}),(s==null?void 0:s.component_name)&&e.jsx(_,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[(n==null?void 0:n.component_id)&&e.jsxs("li",{children:["pipeline: ",n==null?void 0:n.component_id]}),(t==null?void 0:t.component_id)&&e.jsxs("li",{children:["software: ",t==null?void 0:t.component_id]}),(s==null?void 0:s.component_id)&&e.jsxs("li",{children:["file: ",s==null?void 0:s.component_id]}),(s==null?void 0:s.name)&&e.jsxs("li",{children:["name: ",s==null?void 0:s.name]})]})}),children:e.jsxs("span",{onClick:()=>{Je(`/component/file/${s.component_id}`)},style:{cursor:"pointer"},children:[i," (",s==null?void 0:s.component_name,")"]})}),e.jsx(ll,{color:"success",children:s==null?void 0:s.file_type})]}),extra:e.jsxs(e.Fragment,{children:[ae,e.jsxs(A,{gap:"small",wrap:!0,children:[e.jsx(G.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:Z,onChange:l=>qe(l.target.value),style:{width:300}}),e.jsx(P,{title:"Confirm adding example?",onConfirm:async()=>{await F.post(`/analysis-result/add-example/${s.component_id}?project=${g}`),R.success("Example added successfully!"),C()},children:e.jsx("a",{children:"Example"})}),e.jsx(_,{title:"Download Example File",children:e.jsxs("a",{onClick:async()=>{const l=await F.get(`/analysis-result/download-example/${s.component_id}`);window.open(`${oe}${l.data.example_url}`,"_blank"),R.success(`Example ${oe}${l.data.example_url} downloading...`)},children:["Example ",e.jsx(Se,{})]})}),(s==null?void 0:s.relation_id)&&e.jsx(P,{title:"Are you sure to delete?",onConfirm:()=>{u.deletePipelineRelation(s.relation_id)},children:e.jsx(_,{title:`Delete ${s==null?void 0:s.component_name}`,children:e.jsx(Fe,{style:{cursor:"pointer",color:"red"}})})}),(u==null?void 0:u.openModal)&&e.jsxs(e.Fragment,{children:[e.jsx(pl,{style:{cursor:"pointer"},onClick:()=>{pe("importFile",{...s,operatePipeline:u})}}),e.jsx(ye,{style:{cursor:"pointer"},onClick:C}),(m.component_type=="software"||m.component_type=="file"||m.component_type=="script")&&e.jsx(e.Fragment,{children:e.jsx(nl,{menu:{items:[{key:"4",label:e.jsx(_,{title:s==null?void 0:s.component_name,children:e.jsx("a",{onClick:()=>{u.openModal("modalC",{data:void 0,structure:{relation_type:Q,parent_component_id:t.component_id,component_type:"file"}})},children:"Add File"})})},{key:"3",label:e.jsx(_,{title:s==null?void 0:s.component_name,children:e.jsx("a",{onClick:()=>{u.openModal("modalC",{data:s,structure:{component_type:"file"}})},children:"Edit File"})})},{key:"2",label:e.jsx(_,{title:s==null?void 0:s.component_name,children:e.jsx("a",{onClick:()=>{u.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:Q,parent_component_id:t.component_id}})},children:"New File"})})},{key:"1",label:e.jsx(_,{title:s==null?void 0:s.component_name,children:e.jsx("a",{onClick:()=>{u.openModal("modalA",{data:s,pipelineStructure:{relation_type:Q}})},children:"Replace File"})})},{label:e.jsx(_,{title:s==null?void 0:s.component_name,children:e.jsx(P,{title:"Whether to remove file?",onConfirm:()=>{u.deletePipelineRelation(s.relation_id)},children:e.jsx("a",{children:"Remove File"})})}),key:"0"}]},children:e.jsx("a",{onClick:l=>l.preventDefault(),children:e.jsxs(we,{children:["More",e.jsx(Me,{})]})})})})]}),e.jsx(el,{onClick:()=>{u.openModal("descriptionModal",s.description)},style:{cursor:"pointer"}})]})]}),tabList:r&&Array.isArray(r)&&r.length>1?r.map(l=>({key:l.component_id,label:e.jsx(_,{title:l.component_id,children:l.component_name?l.component_name:"no_name"})})):void 0,activeTabKey:O,onTabChange:Ue,children:[j.msgType==="analysis_result"&&e.jsx(e.Fragment,{children:e.jsx(xl,{closable:!0,message:`${j==null?void 0:j.analysis_name}: Add Analsyis: ${j==null?void 0:j.add_num}; Update Analysis: ${j==null?void 0:j.update_num}; Complete Analysis: ${j==null?void 0:j.complete_num}`})}),(s==null?void 0:s.file_type)=="collected"?e.jsx(e.Fragment,{children:e.jsx(ke,{spinning:Ve,tip:"Uploading...",children:Array.isArray(h)&&h.length==0?e.jsx(e.Fragment,{children:e.jsxs(ol,{...be,maxCount:1,children:[e.jsx("p",{className:"ant-upload-drag-icon",children:e.jsx(cl,{})}),e.jsx("p",{className:"ant-upload-text",children:"Click or drag file to this area to upload"})]})}):e.jsxs(e.Fragment,{children:[e.jsx(ul,{activeKey:k,onChange:l=>{const a=h.filter(p=>p.analysis_result_id==l);a.length>0&&Y(a[0].columns),X(l)},tabBarExtraContent:e.jsxs(A,{gap:"small",children:[e.jsx(il,{size:"small",value:_e,onChange:l=>Oe(l)}),e.jsx(rl,{...be,children:e.jsx(_,{title:"Upload new file",children:e.jsx(dl,{style:{cursor:"pointer"}})})}),e.jsx(Se,{style:{cursor:"pointer"},onClick:()=>{const l=h.find(a=>a.analysis_result_id==k);console.log("currentData",l),window.open(`${oe}${l.url}`,"_blank")}}),e.jsx(Pe,{style:{cursor:"pointer"},onClick:()=>{console.log("analysisResultId",k),pe("analysisResultEdit",{analysis_result_id:k})}}),e.jsx(P,{title:`Are you sure you want to delete ${k}?`,onConfirm:async()=>{await he(k)},children:e.jsx(_,{title:`Delete current tab ${k}`,children:e.jsx(Fe,{style:{cursor:"pointer",color:"red"}})})}),e.jsx(ye,{style:{cursor:"pointer"},onClick:()=>je()})]}),items:h.map((l,a)=>({key:l.analysis_result_id,label:e.jsx(_,{title:`${l==null?void 0:l.content} ${l.analysis_result_id}`,children:`${l==null?void 0:l.file_name}`})}))}),e.jsx(ke,{spinning:ze,tip:"Loading table data...",children:e.jsx("div",{style:{height:"50vh"},children:e.jsx(ml,{shape:De,rows:[Ne,...K]})})})]})})}):e.jsx(e.Fragment,{children:e.jsx($e,{rowKey:l=>l.id,size:"small",pagination:{pageSize:10},loading:le,scroll:{x:"max-content",y:55*5},columns:$||Be,footer:()=>`A total of ${K&&Array.isArray(K)&&K.length} records`,dataSource:K})}),(s==null?void 0:s.parseFormat)&&(s==null?void 0:s.relation_type)=="software_output_file"&&e.jsx(me,{children:e.jsx("pre",{children:JSON.stringify(s.parseFormat,null,2)})})]}),e.jsx(jl,{visible:B.visible&&B.key=="importFile",params:B.params,callback:C,onClose:xe}),e.jsx(Cl,{visible:B.visible&&B.key=="analysisResultEdit",params:B.params,callback:C,onClose:xe})]})});export{Ll as R};
