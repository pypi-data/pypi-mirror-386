import{k as useOutletContext,r as reactExports,j as jsxRuntimeExports,R as Row,C as Col,F as Flex,B as Button,P as Popconfirm,z as RefIcon,d as Form,s as staticMethods,M as Modal,m as Collapse,I as Input,i as Typography,a as axios,t as Tooltip}from"./main-CH82g4dw.js";import{R as ResultList}from"./index-BA3Y6Ju-.js";import FormJsonComp from"./index-6IaXHF5K.js";import{A as AnalysisList}from"./index-DgI-8QMg.js";import{A as AnalysisForm}from"./index-CXizBL-u.js";import{a as BioDatabaseForm}from"./index-BtlAu1CQ.js";import{C as Card}from"./index-ZaXfouA1.js";import{S as Spin}from"./index-C0dVCwMu.js";import{R as RefIcon$1}from"./index-BcI8WOZ3.js";const AnalysisSoftwarePanel=({inputFile:e,outputFile:a,pipeline:t,wrapAnalysisPipeline:r,analysisPipline:R,inputAnalysisMethod:F,analysisMethod:u,appendSampleColumns:l,analysisType:g="nonSample",children:E,cardExtra:n,upstreamFormJson:m,downstreamAnalysis:f,operatePipeline:o,...s})=>{const{project:j}=useOutletContext();reactExports.useEffect(()=>{},[]),reactExports.useRef(null);const[h,c]=reactExports.useState(),d=x=>x&&Array.isArray(x)&&x.length>0;return jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Row,{children:jsxRuntimeExports.jsxs(Col,{lg:24,sm:24,xs:24,children:[jsxRuntimeExports.jsx(Card,{size:"small",style:{marginBottom:"1rem"},children:jsxRuntimeExports.jsxs(Flex,{gap:"small",style:{marginBottom:"1rem",flexWrap:"wrap"},children:[t&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalC",{data:void 0,structure:{component_type:"software",relation_type:"pipeline_software",parent_component_id:t.component_id}})},children:"New Software"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalC",{data:s,structure:{component_type:"software"}})},children:"Update Software"}),t&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"pipeline_software",parent_component_id:t.component_id}})},children:"Add Software"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalA",{data:s,pipelineStructure:{relation_type:"pipeline_software"}})},children:"Replace Software"}),jsxRuntimeExports.jsx(Popconfirm,{title:"Whether to remove files?",onConfirm:()=>{o.deletePipelineRelation(s.relation_id)},children:jsxRuntimeExports.jsx(Button,{size:"small",color:"red",variant:"solid",children:"Remove File"})})]}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalB",{module_type:"nextflow",file_type:"nf",module_name:R,component_id:s.component_id})},children:"Component Code"}),s.databases&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalE",s.databases)},children:"Configuration Database"}),jsxRuntimeExports.jsx(RefIcon,{onClick:()=>{o.openModal("descriptionModal",s.description)},style:{cursor:"pointer"}})]})}),d(e)?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(UpstreamAnalysisInput,{...s,pipeline:t,record:h,onClickItem:c,project:j,operatePipeline:o,cardExtra:n,upstreamFormJson:m,analysisPipline:R,analysisMethod:u,inputAnalysisMethod:e})}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs(Flex,{justify:"center",style:{margin:"2rem"},gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalC",{data:void 0,structure:{relation_type:"software_input_file",parent_component_id:s.component_id,component_type:"file"}})},children:"New File"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"software_input_file",parent_component_id:s.component_id}})},children:"Add File"})]})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),d(a)?jsxRuntimeExports.jsx(UpstreamAnalysisOutput,{...s,pipeline:t,software:{pipeline_id:s.pipeline_id,component_id:s.component_id},children:E,onClickItem:c,downstreamAnalysis:f,operatePipeline:o,project:j,analysisType:g,analysisMethod:a,appendSampleColumns:l}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs(Flex,{justify:"center",style:{margin:"2rem"},gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalC",{data:void 0,structure:{relation_type:"software_output_file",parent_component_id:s.component_id,component_type:"file"}})},children:"New File"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"software_output_file",parent_component_id:s.component_id}})},children:"Add File"})]})})]})})})},UpstreamAnalysisInput=({record:e,pipeline:a,operatePipeline:t,project:r,markdown:R,analysisPipline:F,upstreamFormJson:u,inputAnalysisMethod:l,onClickItem:g,cardExtra:E,...n})=>{const[m]=Form.useForm(),[f,o]=reactExports.useState(),[s,j]=staticMethods.useMessage(),[h,c]=reactExports.useState(!1),d=Form.useWatch(i=>i==null?void 0:i.analysis_id,m),[x,v]=reactExports.useState(),[w,b]=reactExports.useState(),[B,D]=Modal.useModal(),_=reactExports.useRef(null),C=i=>{const A=l.map(y=>y.component_id);return{...i,project:r,inputFormJson:l,component_id:n.component_id,data_component_ids:JSON.stringify(A)}},S=async i=>{var y;const A=await m.validateFields(),M=C(A);c(!0);try{const p=await axios.post(`/fast-api/analysis-controller?save=${i}`,M);console.log(p),i?(s.success("执行成功!"),_.current&&_.current.reload()):t.openModal("modalF",p.data)}catch(p){console.log(p),(y=p.response)!=null&&y.data&&s.error(p.response.data.detail)}c(!1)},I={host_genome_index:[{label:"人类",value:"/data/metagenome_data/bowtie2_index/human/human38"},{label:"小鼠",value:"/data/databases/mouse/bowtie2/Mus_musculus.GRCm39.dna_sm.toplevel.fa"}]};return jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[j,D,!(n!=null&&n.hiddenUpstreamAnalysis)&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(Form,{form:m,children:jsxRuntimeExports.jsx(Collapse,{style:{marginTop:"1rem"},size:"small",items:[{key:"1",label:`Run  Analysis (${n.component_name})`,children:jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[l&&jsxRuntimeExports.jsx(ResultList,{...n,pipeline:a,software:n,currentAnalysisMethod:w,setCurrentAnalysisMethod:b,operatePipeline:t,relationType:"software_input_file",cardExtra:E,title:`Input File ${l.length>0?"":l.map(i=>i.label)}`,activeTabKey:x,setActiveTabKey:v,shouldTrigger:!0,analysisType:"sample",analysisMethod:l,setResultTableList:o}),jsxRuntimeExports.jsxs(Spin,{spinning:h,children:[jsxRuntimeExports.jsx(Form.Item,{initialValue:`${n.component_name}`,name:"analysis_name",label:"Analysis Name",rules:[{required:!0,message:"该字段不能为空!"}],children:jsxRuntimeExports.jsx(Input,{})}),jsxRuntimeExports.jsx(FormJsonComp,{formJson:[{name:"group_field",label:"Group Field",rules:[{required:!0,message:"This field cannot be empty!"}],type:"GroupFieldSelect"}],dataMap:[]}),jsxRuntimeExports.jsx(FormJsonComp,{formJson:l,dataMap:f}),jsxRuntimeExports.jsx(BioDatabaseForm,{openModal:()=>t.openModal("modalE",n.databases),formJson:n.databases}),u&&jsxRuntimeExports.jsx(FormJsonComp,{formJson:u,dataMap:I}),jsxRuntimeExports.jsxs(Flex,{gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{S(!1)},children:"View Parameters                                        "}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>S(!0),children:d?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:"Update Analysis"}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:"Save  Analysis"})}),d&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>m.setFieldValue("analysis_id",void 0),children:"Cancel Update"})]}),jsxRuntimeExports.jsx(Collapse,{ghost:!0,items:[{key:"1",label:"More",children:jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Form.Item,{noStyle:!0,shouldUpdate:!0,children:()=>jsxRuntimeExports.jsx(Typography,{children:jsxRuntimeExports.jsx("pre",{children:JSON.stringify(C(m.getFieldsValue()),null,2)})})})})}]})]})]})}]})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(AnalysisList,{ref:_,project:r,component_id:n==null?void 0:n.component_id}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}})]})]})},UpstreamAnalysisOutput=rest=>{const{pipeline,component_id,component_type,componentLayout,operatePipeline,children,project,onClickItem,analysisType,analysisMethod,appendSampleColumns,script}=rest,[form]=Form.useForm(),[record,setRecord]=reactExports.useState(),[filePlot,setFilePlot]=reactExports.useState(),[plotLoading,setPlotLoading]=reactExports.useState(!1),[formDom,setFormDom]=reactExports.useState(),[formJson,setFormJson]=reactExports.useState(),[sampleSelectComp,setSampleSelectComp]=reactExports.useState(!1),{Search}=Input,[messageApi,contextHolder]=staticMethods.useMessage(),[moduleName,setModuleName]=reactExports.useState(),[params,setParams]=reactExports.useState(),[downstreamData,setDownstreamData]=reactExports.useState(),[resultTableList,setResultTableList]=reactExports.useState([]),[saveAnalysisMethod,setSaveAnalysisMethod]=reactExports.useState(),[collapseActiveKey,setCollapseActiveKey]=reactExports.useState("1"),[activeTabKey,setActiveTabKey]=reactExports.useState(),[currentAnalysisMethod,setCurrentAnalysisMethod]=reactExports.useState(),[sampleGroupJSON,setSampleGroupJSON]=reactExports.useState(),[btnName,setBtnName]=reactExports.useState(),[origin,setOrigin]=reactExports.useState(!1),tableRef=reactExports.useRef(null),[sampleGroupApI,setSampleGroupApI]=reactExports.useState(!1),analysis_id=Form.useWatch(e=>e==null?void 0:e.analysis_id,form);reactExports.useEffect(()=>{if(downstreamData&&(currentAnalysisMethod!=null&&currentAnalysisMethod.downstreamAnalysis)){const e=currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis.find(a=>a.component_id==downstreamData.component_id);plot(e)}},[JSON.stringify(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis)]);const plot=async data=>{let{origin=!1,url,moduleName,params,paramsFun,formDom,formJson,saveAnalysisMethod,sampleSelectComp=!1,sampleGroupJSON=!0,sampleGroupApI=!1,...rest}=data;if(cleanDom(),setCollapseActiveKey("1"),setDownstreamData(data),setFormDom(formDom),setModuleName(moduleName),setParams(params),setSampleGroupApI(sampleGroupApI),setFilePlot(void 0),setOrigin(origin),form.resetFields(),form.setFieldValue("analysis_name",rest.component_name),setFormJson(formJson),setSampleSelectComp(sampleSelectComp),setSampleGroupJSON(sampleGroupJSON),paramsFun&&(paramsFun=eval(paramsFun),params=paramsFun(record),console.log(params),setParams(params)),saveAnalysisMethod&&setSaveAnalysisMethod(saveAnalysisMethod),origin){const e=await axios.post(`/fast-api/file-parse-plot/${moduleName}`,{...params,is_save_analysis_result:!1,origin:!0});console.log(e),setFilePlot(e.data)}},cleanDom=()=>{setFormDom(void 0),setFilePlot(void 0),setDownstreamData(void 0),setSaveAnalysisMethod(void 0)},getScript=e=>{const{name:a,analysisType:t,...r}=e;return record&&t=="one"?jsxRuntimeExports.jsxs(Button,{size:"small",color:"purple",variant:(downstreamData==null?void 0:downstreamData.component_id)==r.component_id?"solid":"filled",onClick:()=>plot({...r}),children:[r.component_name,"(",record.sample_name,")"]}):jsxRuntimeExports.jsx(Button,{size:"small",color:"primary",variant:(downstreamData==null?void 0:downstreamData.component_id)==r.component_id?"solid":"filled",onClick:()=>plot({...r}),children:r.component_name})},[componentIds,setComponentIds]=reactExports.useState();reactExports.useEffect(()=>{const e=analysisMethod.filter(t=>t.downstreamAnalysis).map(t=>t.downstreamAnalysis).flat();console.log(e);const a=e.map(t=>t.component_id);a.length>0&&setComponentIds(a)},[]),reactExports.useEffect(()=>{script&&(plot({...script,name:script.name}),setComponentIds([script.component_id]))},[script]);const[scriptMap,setScriptMap]=reactExports.useState();reactExports.useEffect(()=>{if(script)setScriptMap({[script.component_id]:script});else{const a=analysisMethod.filter(t=>"downstreamAnalysis"in t).map(t=>t.downstreamAnalysis).flat(1/0).reduce((t,r)=>(t[r.component_id]=r,t),{});setScriptMap(a)}},[analysisMethod]);const[analysisResultId,setAnalysisResultId]=reactExports.useState();return jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[contextHolder,analysisMethod&&Array.isArray(analysisMethod)&&analysisMethod.length>0&&jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(ResultList,{...rest,onChangeAnalysisResultId:setAnalysisResultId,pipeline,software:rest,currentAnalysisMethod,setCurrentAnalysisMethod,operatePipeline,relationType:"software_output_file",title:`Output File ${analysisMethod.length>0?"":analysisMethod.map(e=>e.name)}`,appendSampleColumns,activeTabKey,setActiveTabKey,cleanDom,analysisType:"sample",analysisMethod,shouldTrigger:!0,form,setResultTableList,setRecord:e=>{setRecord(e)}})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),componentLayout!="simple"&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsxs(Flex,{wrap:!0,style:{marginBottom:"1rem"},gap:"small",children:[(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis)&&(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis.map((e,a)=>jsxRuntimeExports.jsx("span",{children:getScript(e)},a))),script?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{}):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalC",{data:void 0,structure:{relation_type:"file_script",parent_component_id:currentAnalysisMethod.component_id,component_type:"script"}})},children:"New Script"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"file_script",parent_component_id:currentAnalysisMethod.component_id}})},children:"Add Script"}),(downstreamData==null?void 0:downstreamData.component_id)&&jsxRuntimeExports.jsx(RefIcon$1,{onClick:()=>{setDownstreamData(void 0)}})]})]}),jsxRuntimeExports.jsx("div",{children:downstreamData&&jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Collapse,{style:{marginTop:"1rem"},defaultActiveKey:["1"],size:"small",items:[{key:"1",label:jsxRuntimeExports.jsxs(Tooltip,{title:jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs("ul",{children:[jsxRuntimeExports.jsxs("li",{children:["software:",rest==null?void 0:rest.component_id]}),jsxRuntimeExports.jsxs("li",{children:["file:",currentAnalysisMethod==null?void 0:currentAnalysisMethod.component_id]}),jsxRuntimeExports.jsxs("li",{children:["script:",downstreamData==null?void 0:downstreamData.component_id]})]})}),children:["Run  Analysis ",downstreamData?`(${downstreamData.component_name})`:"",analysis_id?`(${analysis_id})`:""]}),children:jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsxs(Flex,{gap:"small",wrap:!0,children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalB",{component_id:downstreamData.component_id})},children:"Component Code"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalC",{data:downstreamData,structure:{component_type:"script"}})},children:"Edit Script"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"parent_file_script",component_id:downstreamData.component_id}})},children:"Add File"}),downstreamData.relation_id&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalA",{data:downstreamData,pipelineStructure:{relation_type:"file_script"}})},children:"Replace Analysis"}),jsxRuntimeExports.jsx(Popconfirm,{title:"Are you sure to delete?",onConfirm:()=>{operatePipeline.deletePipelineRelation(downstreamData.relation_id),setBtnName(void 0)},children:jsxRuntimeExports.jsx(Button,{size:"small",color:"danger",variant:"solid",children:"Delete Analysis"})})]}),jsxRuntimeExports.jsx(RefIcon,{onClick:()=>{operatePipeline.openModal("descriptionModal",downstreamData.description)},style:{cursor:"pointer"}})]}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(AnalysisForm,{...downstreamData,analysisResultId,pipeline,form,resultTableList,formJson,formDom,sampleGroupApI,operatePipeline,params,name:btnName,setPlotLoading,dataComponentIds:analysisMethod.map(e=>e.component_id),inputAnalysisMethod:currentAnalysisMethod,saveAnalysisMethod,project,setFilePlot,callback:()=>{tableRef.current&&tableRef.current.reload()},plotReloadTable:()=>{tableRef.current&&tableRef.current.reload()}})]})}]})})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),componentIds&&jsxRuntimeExports.jsx(AnalysisList,{ref:tableRef,project,component_ids:componentIds})]})]})};export{AnalysisSoftwarePanel as A,UpstreamAnalysisOutput as U,UpstreamAnalysisInput as a};
