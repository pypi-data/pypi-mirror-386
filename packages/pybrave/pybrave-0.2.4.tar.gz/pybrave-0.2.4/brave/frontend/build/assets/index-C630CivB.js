import{d_ as w,j as t,F as j,l as g,a as I,r as n,k as K,b as R,u as A,i as P,B as x,P as z}from"./main-CH82g4dw.js";import{b as E}from"./index-DqMpSPzc.js";import{B as O}from"./index-BcI8WOZ3.js";import{A as D}from"./react-window-Bmvezp4W.js";import{L as M}from"./index-BKAfqOdf.js";import{C as $}from"./index-ZaXfouA1.js";import{S as F}from"./index-C0dVCwMu.js";import{F as N}from"./Table-Rz-gL0vt.js";import{T as S}from"./index-B_L60N4-.js";import"./index-BDU4gvFg.js";import"./usePagination-CNS7-0k1.js";import"./index-CweiUdAw.js";import"./UpOutlined-MKfWXv9S.js";import"./DeleteOutlined-CIV_DNOf.js";import"./Dropdown-B4TP4OlU.js";import"./index-BL_XwOQI.js";import"./index-DOFo5PXu.js";import"./index-Pwpmen_B.js";import"./addEventListener-DrXUXNAy.js";import"./createForOfIteratorHelper-BSFJLzX3.js";import"./DeploymentUnitOutlined-WBguncE1.js";import"./UserSwitchOutlined-D2V22kEV.js";import"./AudioOutlined-Cdmej0V0.js";import"./ClearOutlined-CzC8yyS0.js";import"./TableOutlined-CZ_BS3k3.js";import"./NodeIndexOutlined-Cav4TyHH.js";import"./index-DTJd4Z3p.js";import"./RedoOutlined-DNpCn5kL.js";import"./UndoOutlined-BfseYVP6.js";function J({rows:o}){return w.useToken(),t.jsxs(t.Fragment,{children:[t.jsx(D,{rowComponent:Q,rowCount:o==null?void 0:o.length,rowHeight:30,rowProps:{rows:o}}),t.jsx(j,{justify:"end",gap:"small",children:t.jsxs(g,{color:"default",children:["Rows: ",o==null?void 0:o.length]})})]})}function Q({index:o,rows:c,style:f}){const e=c[o],{token:l}=w.useToken();return t.jsx(j,{align:"center",style:{...f,backgroundColor:o%2?l.colorBgContainer:l.colorFillQuaternary,borderBottom:`1px solid ${l.colorBorderSecondary}`,padding:"0 8px",fontSize:13,minWidth:"fit-content",transition:"background-color 0.2s"},className:"table-row",onMouseEnter:m=>{m.currentTarget.style.backgroundColor=l.colorFillTertiary},onMouseLeave:m=>{m.currentTarget.style.backgroundColor=o%2?l.colorBgContainer:l.colorFillQuaternary},children:JSON.stringify(e)})}const W=(o,c)=>I.post(`/fast-api/parse-analysis-result/${o}?save=${c}`),_e=n.memo(({analysis_id:o,callback:c,onClose:f})=>{const[e,l]=n.useState(),[m,h]=n.useState(!1),{messageApi:_}=K(),{modal:b,openModal:T,closeModal:B}=R(),L=n.useRef(null),[u,v]=n.useState({tabList:[],dataList:[],dataListInfo:{nrow:0,ncol:0}}),[y,C]=n.useState({tabList:[],dataList:[]});n.useEffect(()=>{const s=e==null?void 0:e.result_dict;if(!s)return;const r=Object.keys(s).map(p=>({key:p,label:p}));if(r.length===0)return;const a=r[0].key,i=s[a];v({tabKey:a,tabList:r,dataList:(i==null?void 0:i.tables)??[],dataListInfo:{nrow:(i==null?void 0:i.nrow)??0,ncol:(i==null?void 0:i.ncol)??0}})},[e==null?void 0:e.result_dict]),n.useEffect(()=>{const s=e==null?void 0:e.file_dict;if(!s)return;const r=Object.keys(s).map(p=>({key:p,label:p}));if(r.length===0)return;const a=r[0].key,i=s[a];C({tabKey:a,tabList:r,dataList:i})},[e==null?void 0:e.file_dict]);const k=A(s=>s.global.sseData);n.useEffect(()=>{const s=k;L.current==s.analysis_id&&(s.event=="analysis_complete"||s.event=="analysis_failed"||s.event=="analysis_started")&&d()},[k]);const d=async(s=!1)=>{h(!0);try{const r=await W(o,s);l(r.data),L.current=r.data.analysis_id,h(!1),c&&s&&c()}catch(r){h(!1),_.error(r.response.data.detail)}};return n.useEffect(()=>{d(!1)},[o]),t.jsxs(t.Fragment,{children:[t.jsx($,{size:"small",variant:"borderless",style:{boxShadow:"none"},title:`Analysis Result Parse (${o})`,extra:t.jsxs(j,{gap:"small",children:[(e==null?void 0:e.file_format_list)&&t.jsx(t.Fragment,{children:e==null?void 0:e.file_format_list.map(s=>t.jsx(g,{children:s.name}))}),t.jsx(g,{children:e==null?void 0:e.job_status}),t.jsx(z,{title:"确定解析吗？",onConfirm:()=>{d(!0),_.success("解析成功")},children:t.jsx(x,{size:"small",color:"cyan",variant:"solid",children:"Parse"})}),t.jsx(x,{size:"small",color:"primary",variant:"solid",onClick:()=>d(!1),children:"Refresh"}),f&&t.jsx(x,{onClick:f,size:"small",color:"red",variant:"solid",children:"Close"})]}),children:t.jsx(F,{spinning:m,children:(e==null?void 0:e.job_status)=="failed"?t.jsx("div",{style:{textAlign:"center"},children:t.jsx("div",{style:{flex:1,overflowY:"auto",marginBottom:"1rem"},children:t.jsx(M,{file_path:e==null?void 0:e.command_log_path})})}):t.jsx(t.Fragment,{children:t.jsx(F,{spinning:(e==null?void 0:e.job_status)=="running",tip:"Analysis is running, please wait...",children:e&&t.jsx(t.Fragment,{children:e!=null&&e.error?t.jsx(P,{children:t.jsx("pre",{children:e==null?void 0:e.error})}):t.jsxs(t.Fragment,{children:[t.jsx(N,{size:"small",pagination:!1,rowKey:"component_id",columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"目录",dataIndex:"dir",key:"dir"},{title:"文件组件ID",dataIndex:"component_id",key:"component_id"},{title:"文件格式",dataIndex:"fileFormat",key:"fileFormat",render:(s,r)=>t.jsx("div",{style:{overflowWrap:"break-word",wordBreak:"break-all"},children:JSON.stringify(r.fileFormat)})},{title:"操作",dataIndex:"component_id",key:"component_id",render:(s,r)=>t.jsx(t.Fragment,{children:t.jsx(x,{color:"cyan",variant:"solid",size:"small",onClick:()=>{T("modalC",{data:{component_id:r.component_id},structure:{component_type:"file",files:e==null?void 0:e.file_dict[r.dir]}})},children:"编辑"})})}],dataSource:e==null?void 0:e.file_format_list}),t.jsx(S,{activeKey:u.tabKey,onChange:s=>{const r=e==null?void 0:e.result_dict[s];r&&v(a=>({...a,tabKey:s,dataList:r.tables??[],dataListInfo:{nrow:r.nrow??0,ncol:r.ncol??0}}))},items:u.tabList}),t.jsx("div",{style:{height:"30vh"},children:t.jsx(O,{rows:u.dataList,shape:u.dataListInfo})}),t.jsx(S,{activeKey:y.tabKey,onChange:s=>{const r=e==null?void 0:e.result_dict[s];r&&C(a=>({...a,tabKey:s,dataList:r.tables??[],dataListInfo:{nrow:r.nrow??0,ncol:r.ncol??0}}))},items:y.tabList}),t.jsx("div",{style:{height:"30vh"},children:t.jsx(J,{rows:y.dataList})})]})})})})})}),t.jsx(E,{callback:d,visible:b.key=="modalC"&&b.visible,onClose:B,params:b.params})]})});export{_e as default,W as parseAnalysisResultAPi};
