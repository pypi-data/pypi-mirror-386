import{r as n,s as C,b as le,v as re,c as oe,N as ce,O as de,u as ue,a as y,j as e,F as pe,I as me,t as g,l as x,p as je,B as u,P as p,Q as xe,k as ye,d as I,M as he,e as _e}from"./main-D6qHus43.js";import{P as fe}from"./index-CkLVmzff.js";import{A as ge,E as ve,s as be,r as ke}from"./index-oyOmkC6S.js";import{I as Ce}from"./index-ChzQGd2Q.js";import{C as Se}from"./index-D7dvcYwa.js";import{F as we,S as U,D as Fe}from"./Table-Pcm8h2F_.js";import{R as Re}from"./RedoOutlined-DIIHLGCK.js";import{a as Ie}from"./index-CjmxhRai.js";const Ke=n.forwardRef(({title:P,form:l,appendSampleColumns:S=[],setResultTableList:h,cleanDom:A,analysisType:$,setRecord:v,setTableLoading:w,setTabletData:_,shouldTrigger:E,columnsParamsALL:L,project:r,software:M,component_id:m,component_ids:G,operatePipeline:Ae,editParams:$e},K)=>{n.useImperativeHandle(K,()=>({reload:i}));const[Ee,Q]=n.useState(),[Le,q]=C.useMessage(),{modal:a,openModal:f,closeModal:d}=le(),{modals:D,openModals:z,closeModals:X}=re(["inspectPanel"]),[Me,De]=n.useState(!1),N=oe(),Y=ce(),{eventSourceRef:b,status:ze,reconnect:Ne}=de(),[o,Z]=n.useState([]),F=n.useRef([]),R=n.useRef(null),[ee,B]=n.useState(!0),[Be,se]=n.useState(),{containerURL:O}=ue(t=>t.user);n.useEffect(()=>{if(o&&Array.isArray(o)&&o.length>0&&a.visible&&a.params){const t=o.find(s=>s.analysis_id==a.params.analysis_id);t&&se(t)}},[o,a.params]),n.useEffect(()=>{var t;if(b){const s=c=>{var H;const j=JSON.parse(c.data);console.log("analysisId",F.current),F.current.includes(j.analysis_id)?(j.event=="analysis_complete"||j.event=="analysis_failed"||j.event=="analysis_started")&&(i(),R.current&&((H=R.current)==null||H.relaod())):j.run_type=="retry"&&j.event=="container_pulled"&&i()};return(t=b.current)==null||t.addEventListener("message",s),()=>{var c;console.log("removeEventListener"),(c=b.current)==null||c.removeEventListener("message",s)}}},[b.current,r]);const te=t=>{v&&v(t),Q(t)},i=async()=>{B(!0);let t=await y.post("/list-analysis",{component_id:m,component_ids:G,project:r});h&&h(t.data),Z(t.data);const s=t.data.map(c=>c.analysis_id);F.current=s,B(!1)},ae=async t=>{await y.delete(`/fast-api/analysis/${t}`),C.success("successfully delete!"),i()},T=(t,s)=>a.params?t.analysis_id==a.params.analysis_id&&s==a.key:!1,W=async(t,s)=>{await ke(t.analysis_id,s),C.success("run successfully"),i()},J=async(t,s)=>{await be(t.analysis_id,s),C.success("Stop Success"),i()};let ne=[{title:"Project Name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(t,s)=>e.jsx(g,{title:s.project,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Job Status",dataIndex:"job_status",key:"job_status",ellipsis:!0,render:t=>e.jsx(x,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Server Status",dataIndex:"server_status",key:"server_status",ellipsis:!0,render:t=>e.jsx(x,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Component Name",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(t,s)=>e.jsx(g,{title:s.component_id,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Analysis Name",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"Report",dataIndex:"is_report",key:"is_report",ellipsis:!0,render:(t,s)=>e.jsx(x,{color:t?"green":"blue",children:t?"Report":"NonReport"})},{title:"Analysis Id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(t,s)=>e.jsx(je,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id:",s.analysis_id]}),e.jsxs("li",{children:["analysis_name:",s.analysis_name]}),e.jsxs("li",{children:["pipeline_script:",s.pipeline_script]}),e.jsxs("li",{children:["work_dir:",s.work_dir]}),e.jsxs("li",{children:["output_dir:",s.output_dir]}),e.jsxs("li",{children:["command_log_path:",s.command_log_path]}),e.jsxs("li",{children:["trace_file:",s.trace_file]}),e.jsxs("li",{children:["executor_log_file:",s.executor_log_file]}),e.jsxs("li",{children:["workflow_log_file:",s.workflow_log_file]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:[" ",e.jsx("span",{style:{cursor:"pointer"},children:String(t).slice(0,8)})]})})},{title:"Container Name",dataIndex:"container_name",key:"container_name",ellipsis:!0,render:(t,s)=>e.jsxs(g,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsx("li",{children:s.container_image}),s.sub_container_image&&e.jsx("li",{children:s.sub_container_image})]})}),children:[e.jsx(x,{style:{cursor:"pointer"},children:t}),s.sub_container_name&&e.jsx(x,{style:{cursor:"pointer"},children:s.sub_container_name})]})},{title:"Image Status",dataIndex:"image_status",key:"image_status",ellipsis:!0,render:(t,s)=>e.jsx(g,{title:s.image_id,children:e.jsx(x,{color:"green",children:t})})},{title:"Action",key:"action",fixed:"right",ellipsis:!0,width:200,render:(t,s)=>e.jsxs(U,{size:"small",children:[e.jsx(u,{size:"small",color:"primary",variant:"solid",onClick:()=>N(`/analysis-report?key=${s==null?void 0:s.analysis_id}&project=${r}`),children:"Go Report"}),s.image_status=="exist"?e.jsx(e.Fragment,{children:s.job_status=="running"?e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to stop?",onConfirm:()=>{J(s,"job")},children:e.jsx(u,{size:"small",color:"red",variant:"solid",children:"Stop Job"})})}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to run?",onConfirm:()=>{W(s,"job"),f("modalA",s),te(s)},children:e.jsx(u,{size:"small",color:"cyan",variant:"solid",children:s.job_status=="created"?"Run":"Re-Run"})})})}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Pull?",onConfirm:async()=>{await y.post(`/container/pull-image/${s.container_id}`),i()},children:e.jsx(u,{size:"small",color:"cyan",variant:"solid",children:s.image_status=="pulling"?"pulling":"Pull"})})}),e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>f("editParams",s.analysis_id),children:"Edit Parameters"}),T(s,"modalA")?e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>{d()},children:"Close"}):e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>{f("modalA",s)},children:"View Results"}),e.jsx(Fe,{menu:{items:[{key:"server",label:e.jsx(e.Fragment,{children:s.image_status=="exist"&&e.jsx(e.Fragment,{children:s.server_status=="running"?e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to stop?",onConfirm:()=>{J(s,"server")},children:e.jsx("a",{style:{color:"red"},children:"Stop Server"})})}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether to start the server?",onConfirm:()=>{W(s,"server")},children:e.jsx("a",{children:"Run Server"})})})})})},{key:"open_url",disabled:s.server_status!="running",label:e.jsx(e.Fragment,{children:e.jsx(g,{title:e.jsx(e.Fragment,{children:`${O}/container/${s.analysis_id}/`}),children:e.jsx("a",{onClick:()=>{window.open(`${O}/container/${s.analysis_id}/`,"_blank")},children:"Open URL"})})})},{key:"1",label:e.jsx(e.Fragment,{children:T(s,"modalB")?e.jsx("a",{onClick:()=>{d()},children:"Close"}):e.jsx("a",{onClick:()=>{f("modalB",s)},children:"Details"})})},{key:"inspect_job",disabled:s.job_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{z("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"job"})},children:"Inspect Job"})})},{key:"inspect_server",disabled:s.server_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{z("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"server"})},children:"Inspect Server"})})},{key:"3",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{N(`/software-analysis-editor/${s.analysis_id}`,{state:{location:Y.pathname}})},children:"Edit"})})},{key:"4",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(p,{title:"Delete or not?",onConfirm:async()=>{await ae(s.analysis_id),i()},children:e.jsx("a",{children:"Delete"})})]})},{key:"5",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(p,{title:s.is_report?"Whether to cancel the report?":"Whether to the report?",onConfirm:async()=>{await y.post(`/analysis/update-report/${s.analysis_id}`),i()},children:s.is_report?"Cancel Report":"Report"})]})},{key:"6",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{f("addProject",s)},children:"Add Project"})})}]},children:e.jsx("a",{onClick:c=>c.preventDefault(),children:e.jsxs(U,{children:["More",e.jsx(xe,{})]})})})]})}];n.useEffect(()=>{d()},[r]),n.useEffect(()=>{i()},[r]);const[k,ie]=n.useState(""),V=n.useMemo(()=>k?o.filter(t=>Object.values(t).some(s=>String(s).toLowerCase().includes(k.toLowerCase()))):o,[o,k]);return e.jsxs(e.Fragment,{children:[q,e.jsx(Se,{size:"small",variant:"borderless",style:{boxShadow:"none"},styles:{body:{padding:"0.5rem 0 0 0 "}},title:e.jsxs(e.Fragment,{children:[e.jsx(Ie,{}),"  Analysis Record"]}),extra:e.jsxs(pe,{gap:"small",wrap:!0,children:[e.jsx(me.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:k,onChange:t=>ie(t.target.value),style:{width:300}}),e.jsx(Re,{style:{cursor:"pointer"},onClick:i})]}),children:e.jsx(we,{rowKey:"analysis_id",size:"small",pagination:!1,loading:ee,scroll:{x:"max-content",y:55*5},columns:ne,footer:()=>`A total of ${V.length} records`,dataSource:V})}),e.jsx("div",{style:{marginBottom:"1rem"}}),e.jsx(ge,{visible:a.key=="modalA"&&a.visible,params:a.params,onClose:d}),e.jsx(fe,{ref:R,visible:a.key=="modalB"&&a.visible,params:a.params,onClose:d,callback:i}),e.jsx(ve,{callback:i,visible:a.key=="editParams"&&a.visible,params:a.params,onClose:d}),e.jsx(Pe,{callback:i,visible:a.key=="addProject"&&a.visible,params:a.params,onClose:d}),e.jsx(Ce,{callback:i,visible:D.inspectPanel.visible,params:D.inspectPanel.params,onClose:()=>X("inspectPanel")})]})}),Pe=({visible:P,params:l,onClose:S,callback:h})=>{const[A,$]=n.useState([]),{messageApi:v,project:w}=ye(),[_]=I.useForm(),E=async()=>{const M=(await y.get("/project/list-project")).data.map(m=>({label:`${m.project_name}`,value:m.project_id}));$(M.filter(m=>m.value!=w))};n.useEffect(()=>{E(),_.resetFields(),l!=null&&l.extra_project_ids&&_.setFieldValue("project",JSON.parse(l==null?void 0:l.extra_project_ids))},[w]);const L=async()=>{const r=await _.validateFields();await y.post(`/analysis/update-extra-project/${l==null?void 0:l.analysis_id}`,r),v.success("添加成功!"),h&&h()};return e.jsx(he,{onOk:L,title:`添加项目(${l==null?void 0:l.analysis_name})`,open:P,onCancel:S,onClose:S,children:e.jsx(I,{form:_,children:e.jsx(I.Item,{name:"project",label:"项目",children:e.jsx(_e,{options:A,mode:"multiple"})})})})};export{Ke as R};
