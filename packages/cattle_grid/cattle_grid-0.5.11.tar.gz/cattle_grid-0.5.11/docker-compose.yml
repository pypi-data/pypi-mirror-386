services:
  cattle_grid_db:
    image: postgres:17
    environment:
      POSTGRES_PASSWORD: pass
    healthcheck:
      { test: pg_isready -U postgres, interval: 30s, timeout: 10s, retries: 3 }
  cattle_grid_app:
    build: ./resources/docker_dev
    volumes:
      - .:/opt
    working_dir: /opt
    command: uvicorn --factory cattle_grid:create_app --host 0.0.0.0 --port 80 --reload
    healthcheck:
      test: curl --fail http://localhost/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    ports: ["3001:80"]
    depends_on:
      cattle_grid_db: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
  cattle_grid_processor:
    build: ./resources/docker_dev
    volumes:
      - .:/opt
    working_dir: /opt
    command: faststream run cattle_grid.processor:app --reload
    depends_on:
      cattle_grid_db: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
      cattle_grid_app: { condition: service_healthy }
    profiles: ["processor"]
  cattle_grid_nginx:
    image: nginx:1.25-alpine
    volumes:
      - ./resources/dev/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./resources/dev/nginx_proxy_auth.conf:/etc/nginx/nginx_proxy_auth:ro
    ports:
      - 3000:80
    depends_on:
      cattle_grid_app: { condition: service_healthy }
    networks:
      default:
        aliases:
          - abel
          - banach
          - cattle_grid
  # cattle_grid_caddy:
  #   image: caddy:2.9.1-alpine
  #   volumes:
  #     - ./resources/dev/Caddyfile:/etc/caddy/Caddyfile:ro
  #   depends_on:
  #     cattle_grid_app: { condition: service_healthy }
  #   networks:
  #     default:
  #       aliases:
  #         - banach
  rabbitmq:
    image: rabbitmq:4.1.4
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    ports:
      - 5672:5672
      - 11883:1883
      - 15672:15672
      - 15674:15674
      - 15675:15675
    ulimits:
      nproc: 65535
      nofile:
        soft: 26677
        hard: 46677
    volumes:
      - "./resources/dev/rabbit_enabled_plugins:/etc/rabbitmq/enabled_plugins"
      - "./resources/dev/03_http_auth.conf:/etc/rabbitmq/conf.d/03_http_auth.conf"
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 3
  # cattle_grid_redis:
  #   image: docker.io/redis:7-alpine
  #   healthcheck:
  #     test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
  #     interval: 10s
  #     timeout: 10s
  #     retries: 3
networks:
  default:
    external: true
    name: fediverse-pasture
