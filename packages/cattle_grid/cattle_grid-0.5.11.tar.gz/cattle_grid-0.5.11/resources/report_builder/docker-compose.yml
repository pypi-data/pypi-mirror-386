services:
  cattle_grid_db:
    image: postgres:17
    command: postgres
    environment:
      POSTGRES_PASSWORD: pass
    healthcheck:
      { test: pg_isready -U postgres, interval: 30s, timeout: 10s, retries: 3 }
  cattle_grid_mq:
    image: rabbitmq:4
    command: rabbitmq-server
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes: ["./http_auth.conf:/etc/rabbitmq/conf.d/03_http_auth.conf"]
    working_dir: /app
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 3
  cattle_grid:
    image: helgekr/cattle_grid:${VERSION-latest}
    volumes: [".:/app"]
    working_dir: /app
    command: ./run_app.sh
    depends_on:
      cattle_grid_db: { condition: service_healthy }
      cattle_grid_mq: { condition: service_healthy }
    healthcheck:
      test: curl --fail http://localhost/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
  nginx:
    image: nginx:1.25-alpine
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx_proxy_auth.conf:/etc/nginx/nginx_proxy_auth:ro
    depends_on:
      cattle_grid: { condition: service_healthy }
    networks:
      default:
        aliases:
          - abel
          - banach
networks:
  default:
    external: true
    name: test
