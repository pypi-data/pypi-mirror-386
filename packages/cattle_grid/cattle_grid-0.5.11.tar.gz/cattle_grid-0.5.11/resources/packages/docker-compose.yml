services:
  cattle_grid_db:
    image: postgres:17
    environment:
      POSTGRES_PASSWORD: pass
    healthcheck:
      { test: pg_isready -U postgres, interval: 30s, timeout: 10s, retries: 3 }
  cattle_grid_app:
    build: .
    command: uvicorn --factory cattle_grid:create_app --host 0.0.0.0 --port 80
    healthcheck:
      test: curl --fail http://localhost/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    ports: ["3001:80"]
    depends_on:
      cattle_grid_db: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
  cattle_grid_processor:
    build: .
    command: python -mfaststream run cattle_grid.processor:app
    volumes:
      - ./reports:/reports
    depends_on:
      cattle_grid_db: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
      cattle_grid_app: { condition: service_healthy }
  cattle_grid_nginx:
    image: nginx:1.25-alpine
    volumes:
      - ../dev/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - 3000:80
    depends_on:
      cattle_grid_app: { condition: service_healthy }
    networks:
      default:
        aliases:
          - abel
          - banach
          - cattle_grid
  runner:
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    volumes:
      - .:/opt
    working_dir: /opt
    environment:
      UV_PROJECT_ENVIRONMENT: "/tmp/venv"
    entrypoint: ./resources/dev/startup.sh
    command: /bin/sh
    profiles: ["dev"]

  rabbitmq:
    image: rabbitmq:4
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    ports:
      - 5672:5672
      - 15672:15672
      - 15674:15674
      - 15675:15675
    volumes:
      - "../dev/rabbit_enabled_plugins:/etc/rabbitmq/enabled_plugins"
      - "../dev/03_http_auth.conf:/etc/rabbitmq/conf.d/03_http_auth.conf"
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 3
networks:
  default:
    external: true
    name: fediverse-pasture
