when:
  - branch: [main]
    event: [pull_request, push]

steps:
  build:
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    commands:
      - uv sync --frozen --all-extras
  test_format:
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    commands:
      - uv run ruff format --check .
      - uv run ruff check .
  test_pytest:
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    commands:
      - uv run python -mcattle_grid new-config http://localhost/actor-id
      - uv run pytest
  test_pyright:
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    commands:
      - uv run pyright
  build_docs:
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    commands:
      - uv sync --all-extras --group docs
      - uv run python -mcattle_grid openapi --for_docs
      - uv run python -mcattle_grid async-api --for_docs
      - uv run mkdocs build --strict
