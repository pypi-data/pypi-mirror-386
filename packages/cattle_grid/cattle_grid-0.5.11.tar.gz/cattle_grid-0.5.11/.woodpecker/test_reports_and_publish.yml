when:
  - event: tag
    branch: main

depends_on: ["publish_docker"]

steps:
  - name: cattle_grid_db
    image: postgres:17
    environment:
      POSTGRES_PASSWORD: pass
    detach: true
  - name: cattle_grid_mq
    image: rabbitmq:4
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    commands:
      - cp resources/report_builder/http_auth.conf /etc/rabbitmq/conf.d/03_http_auth.conf
      - cp resources/dev/rabbit_enabled_plugins /etc/rabbitmq/enabled_plugins
      - rabbitmq-server
    detach: true
  - name: cattle_grid
    image: "helgekr/cattle_grid:${CI_COMMIT_TAG}"
    commands:
      - sleep 60
      - pip install redis fakeredis muck_out
      - cd resources/report_builder
      - uvicorn --factory cattle_grid:create_app --host 0.0.0.0 --port 80
    detach: true
  - name: abel
    image: nginx:1.25-alpine
    commands:
      - sleep 90
      - cp resources/report_builder/nginx.conf /etc/nginx/conf.d/default.conf
      - cp resources/dev/nginx_proxy_auth.conf /etc/nginx/nginx_proxy_auth
      - nginx -g "daemon off;"
    detach: true
  - name: banach
    image: nginx:1.25-alpine
    commands:
      - sleep 90
      - cp resources/report_builder/nginx.conf /etc/nginx/conf.d/default.conf
      - cp resources/dev/nginx_proxy_auth.conf /etc/nginx/nginx_proxy_auth
      - nginx -g "daemon off;"
    detach: true
  - name: run_tests
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    commands:
      - uv sync --all-extras
      - sleep 120
      - uv run fediverse-features
      - uv run behave
    failure: ignore
  - name: build_report
    image: ghcr.io/astral-sh/uv:python3.11-alpine
    commands:
      - uv sync --all-extras --group docs
      - mv resources/report_builder/reports/* report_docs/docs/
      - cd report_docs
      - uv run mkdocs build
    environment:
      CATTLE_GRID_MQ: cattle_grid_mq
  - name: publish_docs
    image: codeberg.org/xfix/plugin-codeberg-pages-deploy:1
    settings:
      folder: report_docs/site
      branch: report
      ssh_key:
        from_secret: deploy_ssh_key
