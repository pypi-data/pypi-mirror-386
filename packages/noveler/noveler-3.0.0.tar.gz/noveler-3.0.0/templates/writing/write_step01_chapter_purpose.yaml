# STEP 1: 大骨（章の目的線）Schema v2

metadata:
  step_id: 1
  step_name: "大骨（章の目的線）"
  phase: "structural_design"
  schema_version: "2.1.0"
  last_updated: "2025-10-20"
  author: "noveler system"
  description: "章全体の開始/終了状態・転換点・山場を設計（A38準拠）"
  estimated_duration: "10-15分"

llm_config:
  role_messages:
    system: |
      あなたは編集プランナーです。以下を厳守してください:

      【必須ルール】
      1. constraints.hard_rules を必ず遵守
      2. 出力形式: 生のYAMLテキストのみ（```yamlなどのコードブロック禁止）
      3. 追加説明・前置き文・コメント・補足は一切不要
      4. artifacts.required_fields を必ず含める
      5. YAMLインデントはスペース2固定、タブ禁止
      6. 複数行テキストはブロックリテラル（|）を使用
    user: |
      STEP0のスコープを受け、章の開始/終了、転換点、山場位置と承認描写を設計します。
      下記 tasks.details の各観点をすべてカバーしてください。

prompt:
  main_instruction: |
    目的は「章の目的線の設計」です。inputs/constraints/tasks を満たし、
    artifacts の仕様に従った YAML を出力してください。

inputs:
  files:
    - path: "{project_root}/60_作業ファイル/EP{episode_number:03d}_step00.yaml"
      required: true
    - path: "{project_root}/20_プロット/章別プロット/ch{chapter_number:02d}.yaml"
      required: false
      description: 章別プロット（存在する場合）
    - path: "{project_root}/30_設定集/キャラクター*.yaml"
      required: false
  variables:
    episode_number: { type: int, required: true }
    chapter_number: { type: int, required: false }
    project_root: { type: path, required: true }

constraints:
  hard_rules:
    - "山場は後半2/3 目安で配置"
    - "承認獲得描写（誰から/何を/どう影響）を含める"
  soft_targets:
    - "承認欲求表現密度: 3-5箇所/1000字"
    - "主軸:副軸 ≈ 6–7 : 3–4（物語比重）"

tasks:
  bullets:
    - 開始/終了状態（内面/外面/関係性）を定義する
    - 起承転結の主要転換点を列挙する
    - 山場の位置と根拠（感情/事件）を示す
    - 主軸（メインプロット）と副軸（サブプロット）を定義し、比重を明記する
    - 承認の振幅（最低谷→最高峰）と獲得の具体描写（提供者/種類/影響）を記述する
  details:
    - name: 開始状態の定義
      items:
        - id: start.inner_state
          text: 主人公の内面状態（感情/認識/目標）
        - id: start.approval_density
          text: 承認欲求表現密度（1000字あたり定量）
        - id: start.outer_state
          text: 外面状況（立場/環境/関係性）
        - id: start.surroundings
          text: 周囲の状況（世界・他キャラの状態）
    - name: 終了状態の設計
      items:
        - id: end.delta
          text: 開始からの変化（内面/外面/関係性）
        - id: end.handover
          text: 残る課題と次話への引き継ぎ
    - name: 主軸/副軸の構成
      items:
        - id: main.weight
          text: 主軸の要約と weight_ratio（0.60–0.70）
        - id: sub.weight
          text: 副軸の要約と weight_ratio（0.30–0.40）
    - name: 山場/承認の設計
      items:
        - id: climax.position
          text: 山場の位置（position_ratio）と感情/事件の根拠
        - id: approval.gain
          text: 承認獲得の具体（from/type/effect）

artifacts:
  format: yaml
  path_template: "{project_root}/60_作業ファイル/EP{episode_number:03d}_step01.yaml"
  required_fields: ["story_structure"]
  example: |
    story_structure:
      start_state:
        inner: "○○"
        outer: "○○"
        relations: "○○"
      end_state:
        inner: "○○"
        outer: "○○"
        relations: "○○"
      main_plot:
        summary: "…"
        weight_ratio: 0.65
      subplots:
        - summary: "…"
          weight_ratio: 0.35
      turning_points:
        - label: 起
          description: "…"
        - label: 承
          description: "…"
        - label: 転
          description: "…"
        - label: 結
          description: "…"
      climax:
        position_ratio: 0.66
        approval_gain:
          from: "誰"
          type: "どんな承認"
          effect: "行動/関係への影響"
      approval_density_per_1000: 3.5

acceptance_criteria:
  checklist:
    - "story_structure が存在する"
    - "climax.position_ratio が 0.5–0.9 の範囲"
    - "main_plot と subplots の比重が 0.6–0.7 : 0.3–0.4 に収まる"
    - "approval_density_per_1000 が 3–5 の範囲"
    - "tasks.details の観点が story_structure に反映されている"
  metrics:
    - name: "turning_points_count"
      target: ">= 3"
      method: "turning_points の件数"
    - name: "subplot_ratio"
      target: "0.30–0.40"
      method: "subplots.weight_ratio の合計"

next:
  next_step_id: 2
  message_template: |
    次のステップは以下で実行:
    execute_writing_step episode_number={episode_number} step_id=2

variables:
  - step_id
  - step_name
  - episode_number
  - completed_steps
  - total_steps
  - phase

control_settings:
  strict_single_step: true
  require_completion_confirm: true
  auto_advance_disabled: true
  batch_execution_blocked: true
  validation_rules:
    - id: start.inner_state
      field: story_structure.start_state.inner
      rule: present
    - id: start.approval_density
      field: story_structure.approval_density_per_1000
      rule: range
      range: [3, 5]
    - id: end.delta
      field: story_structure.end_state.inner
      rule: present
    - id: main.weight
      field: story_structure.main_plot.weight_ratio
      rule: range
      range: [0.60, 0.70]
    - id: climax.position
      field: story_structure.climax.position_ratio
      rule: range
      range: [0.5, 0.9]
    - id: approval.gain
      field: story_structure.climax.approval_gain.from
      rule: present
