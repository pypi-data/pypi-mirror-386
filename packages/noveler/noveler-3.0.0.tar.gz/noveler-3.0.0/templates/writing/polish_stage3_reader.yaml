# STEP 27: Polish Stage3 Reader Schema v2

metadata:
  step_id: 27
  step_name: "Polish Stage3 Reader"
  phase: "quality_assurance"
  schema_version: "2.1.0"
  last_updated: "2025-10-20"
  author: "noveler system"
  description: "Stage3 reader experience optimization focusing on immersion and pacing"
  estimated_duration: "15-20分"

llm_config:
  role_messages:
    system: |
      あなたはReader Experience Designerです。以下を厳守してください:

      【必須ルール】
      1. constraints.hard_rules を必ず遵守
      2. 出力形式: 生のYAMLテキストのみ（```yamlなどのコードブロック禁止）
      3. 追加説明・前置き文・コメント・補足は一切不要
      4. artifacts.required_fields を必ず含める
      5. YAMLインデントはスペース2固定、タブ禁止
      6. 本文はmanuscriptフィールドにブロックリテラル（|）で格納
    user: |-
      Stage3 推敲では没入感・読みやすさ・ページターン率を最大化します。
      tasks と acceptance_criteria を満たし、改善根拠は summary.evidence に記録してください。

prompt:
  main_instruction: |-
    目的は「エピソード{episode_number}のStage3読者体験最適化」です。以下を実施してください。
    1. Stage2 結果を参照しつつ manuscript を読者体験視点で調整する。
    2. improvements 配列に没入感・リズム改善点を最大5件挙げ、type・impact・after_text・rationale を含める。
    3. artifacts.required_fields を満たす JSON をコードブロックなしで出力する。

inputs:
  files:
    - path: "{project_root}/.noveler/polish/stage2_ep{episode_number:03d}.json"
      required: false
      description: Stage2結果（存在すれば参照）
    - path: "{project_root}/40_原稿/第{episode_number:03d}話*.md"
      required: true
      description: 対象エピソード原稿
  variables:
    episode_number: { type: int, required: true }
    project_root: { type: path, required: true }

constraints:
  hard_rules:
    - manuscript はブロックリテラル（|）形式で出力する
    - improvements[] には type/impact/after_text/rationale を含める
    - summary.page_turn_score を 0-100 の整数で返す
  soft_targets:
    - 読点密度の平均を0.8-1.6個/文に調整する
    - 章末フックは type(question/reversal/reveal/time_bomb/decision) のいずれかを設定する


tasks:
  bullets:
    - スマホ読みやすさ（段落長・改行）を最適化する
    - 没入感を阻害するメタ発言や冗長説明を削除する
    - 感情カーブと緊張/緩和のリズムを整える
    - 章末のフックを再設計し、次章への期待を残す
  details:
    - name: 没入感
      items:
        - id: stage3.immersion
          text: メタ表現を削除し、内面描写の層と具体性を追加する
    - name: リズム
      items:
        - id: stage3.rhythm
          text: 読点・文長・段落構成を最適化して読みやすさを確保する
    - name: 感情線
      items:
        - id: stage3.emotion_curve
          text: 緊張と緩和の波を明確にし、感情移入を促進する
    - name: フック
      items:
        - id: stage3.hook
          text: 章末で未解決要素や問いを提示し、次章への期待を残す

artifacts:
  format: yaml
  required_fields: ["manuscript", "improvements", "summary"]
  path_template: "{project_root}/.noveler/polish/stage3_ep{episode_number:03d}.yaml"
  schema_reference: |
    manuscript: string (必須、ブロックリテラル形式)
    improvements: array (必須)
      - type: string (immersion/rhythm/emotion_curve/hook)
        impact: string (low/medium/high)
        after_text: string
        rationale: string
    summary:
      page_turn_score: integer (0-100)
      hook_type: string (question/reversal/reveal/time_bomb/decision)
      evidence: array<string>
  example: |
    manuscript: |
      # 第{episode_number:03d}話

      （改稿後本文…）

    improvements:
      - type: "immersion"
        impact: "high"
        after_text: "内面描写を追加して緊張感を維持"
        rationale: "stage3.immersion を満たすためメタ解説を削除"
      - type: "rhythm"
        impact: "medium"
        after_text: "読点密度を1.2個/文に調整"
        rationale: "stage3.rhythm を満たすため文のリズムを最適化"
    summary:
      page_turn_score: 88
      hook_type: "question"
      evidence:
        - "章末に未解決の問いを提示し、次章への期待を形成"

acceptance_criteria:
  checklist:
    - manuscriptフィールドが存在し、ブロックリテラル形式で改稿後本文が含まれている
    - improvements が1件以上あり、type/impact/after_text/rationale を含む
    - summary.page_turn_score が 60 以上
  metrics:
    - name: hook_type_valid
      target: "enum:question|reversal|reveal|time_bomb|decision"
      method: "summary.hook_type の列挙検証"
  by_task:
    - id: stage3.immersion
      field: improvements
      rule: nonempty
    - id: stage3.rhythm
      field: improvements
      rule: nonempty
    - id: stage3.emotion_curve
      field: improvements
      rule: nonempty
    - id: stage3.hook
      field: summary.hook_type
      rule: nonempty

next:
  next_step_id: 27
  message_template: |
    Stage3 推敲が完了しました。A41 品質チェックで総合評価を行ってください。

variables:
  - step_id
  - step_name
  - episode_number
  - completed_steps
  - total_steps
  - phase

control_settings:
  strict_single_step: true
  require_completion_confirm: true
  auto_advance_disabled: true
  batch_execution_blocked: true
  final_step: true
  by_task:
    - id: stage3.immersion
      field: improvements
      rule: nonempty
    - id: stage3.rhythm
      field: improvements
      rule: nonempty
    - id: stage3.emotion_curve
      field: improvements
      rule: nonempty
    - id: stage3.hook
      field: summary.hook_type
      rule: nonempty

check_criteria:
  immersion:
    - メタ表現や作者コメントが除去されている
    - 内面描写が段階的に深化している
  rhythm:
    - 段落長が3-4行以内でスマホでも読みやすい
    - 文長と読点密度が目標範囲に収まっている
  emotion_curve:
    - 緊張と緩和の切り替えが明確に示されている
    - 感情のピークが適切に配置されている
  hook:
    - 章末フックが規定タイプのいずれかに一致している
    - 次章への期待や未解決課題が提示されている
