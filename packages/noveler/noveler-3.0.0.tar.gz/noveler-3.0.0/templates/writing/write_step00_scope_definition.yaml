# STEP 0: スコープ定義（Schema v2）

metadata:
  step_id: 0
  step_name: "スコープ定義"
  phase: "structural_design"
  schema_version: "2.1.0"
  last_updated: "2025-10-20"
  author: "noveler system"
  description: "エピソードの目的・範囲・制約（A38準拠）を明確化"
  estimated_duration: "5-10分"

llm_config:
  role_messages:
    system: |
      あなたはプロ編集者です。以下を厳守してください:

      【必須ルール】
      1. constraints.hard_rules を必ず遵守
      2. 出力形式: 生のYAMLテキストのみ（```yamlなどのコードブロック禁止）
      3. 追加説明・前置き文・コメント・補足は一切不要
      4. artifacts.required_fields を必ず含める
      5. YAMLインデントはスペース2固定、タブ禁止
      6. 複数行テキストはブロックリテラル（|）を使用
    user: |
      本STEPはエピソードのスコープ定義です。inputs/constraints/tasks/artifacts を参照し、
      required_fields を満たす生のYAMLを出力してください（追加説明は不要）。

prompt:
  main_instruction: |
    目的は「エピソード{episode_number}のスコープ定義」です。
    inputs・constraints・tasks を満たし、artifacts の仕様に従った YAML を出力してください。

inputs:
  files:
    - path: "{project_root}/20_プロット/話別プロット/ep{episode_number:03d}.yaml"
      required: true
      description: 話別プロット
    - path: "{project_root}/30_設定集/キャラクター*.yaml"
      required: false
    - path: "{project_root}/30_設定集/世界観.yaml"
      required: false
    - path: "{project_root}/A28_拡張/*.yaml"
      required: false
      description: 伏線追跡/感情曲線/読者反応予測 等
  variables:
    episode_number: { type: int, required: true }
    project_root: { type: path, required: true }

constraints:
  hard_rules:
    - "文字数基準: 8000字以上（日本語Unicode）を満たす計画を明記"
    - "視点統一: 1シーン1視点の方針を明記"
    - "禁止表現: 直説説明/感情直書きの回避方針を明記"
  soft_targets:
    - "セクション配分: 15/70/15% 目安"
    - "承認欲求表現密度: 3-5箇所/1000字目安"
    - "山場の位置: 後半2/3 目安"

tasks:
  bullets:
    - 前後話との接続（引き継ぎ要素/伏線/継続モチーフ）を特定する
    - 今話の物語目標・読者体験・キャラ成長を具体化する
    - 8000字/視点統一/禁止表現回避の運用方針を記述する
    - A28拡張の適用箇所（STEP4/7/8/15等）を紐づける
  details:
    - name: 主要目標の設定
      items:
        - id: scope.story_goal
          text: 物語目標（出来事/到達状態）を1–2行で明記
          output_field: scope_definition.story_goal
        - id: scope.reader_experience
          text: 読者体験（感情推移/余韻）を定義
          output_field: scope_definition.reader_experience
        - id: scope.character_growth
          text: キャラクター成長（内面/外面/関係性）を定義
          output_field: scope_definition.character_growth
        - id: scope.continuity
          text: 前後話との接続（from_prev/to_next）を明記
          output_field: scope_definition.continuity
    - name: 制約条件の明確化
      items:
        - id: constraints.word_count
          text: 文字数基準: word_count_min=8000（日本語Unicode）
          output_field: constraints.word_count_min
        - id: constraints.pov
          text: 視点ポリシー: one_pov_per_scene
          output_field: constraints.pov_policy
        - id: constraints.banned
          text: 禁止表現: 直説説明/感情直書き/説明的記述の回避方針
          output_field: constraints.banned_expressions_policy
    - name: 価値提案/継続設計
      items:
        - id: value.approval_span
          text: 承認欲求の揺れ幅（最低谷→最高峰）と山場の位置（後半2/3）
          output_field: scope_definition.approval_span
        - id: value.handover
          text: 次話への引き（未解決/予告/クリフ）
          output_field: handover_to_next.notes
    - name: A28活用計画
      items:
        - id: a28.foreshadowing
          text: foreshadowing_tracker → STEP4/11で参照
        - id: a28.emotion_tech
          text: emotion_tech_fusion → STEP8/9で参照
        - id: a28.reader_response
          text: reader_response_prediction → STEP16/17で参照

artifacts:
  format: yaml
  path_template: "{project_root}/60_作業ファイル/EP{episode_number:03d}_step00.yaml"
  required_fields: ["scope_definition", "constraints", "handover_to_next"]
  null_policy: omit
  schema_reference: |
    scope_definition:
      story_goal: string (必須)
      reader_experience: string (必須)
      character_growth: string (必須)
      approval_span: string (必須、最低谷→最高峰の揺れ幅と山場位置)
      continuity:
        from_prev: array<string> (必須)
        to_next: array<string> (必須)
    constraints:
      word_count_min: integer >= 8000 (必須)
      pov_policy: enum ["one_pov_per_scene"] (必須)
      banned_expressions_policy: string (必須)
    handover_to_next:
      notes: string (必須)
  example: |
    scope_definition:
      story_goal: "○○を達成し△△を示す"
      reader_experience: "緊張→高揚→余韻"
      character_growth: "内面A→B"
      approval_span: "最低谷（状況X）→最高峰（承認Y）、山場は後半70%地点"
      continuity:
        from_prev:
          - "前話の引き継ぎ要素1"
        to_next:
          - "次話への布石1"
    constraints:
      word_count_min: 8000
      pov_policy: "one_pov_per_scene"
      banned_expressions_policy: "直説説明/感情直書きを避ける"
    handover_to_next:
      notes: "配分/山場/承認密度をSTEP1/2へ引き渡し"

acceptance_criteria:
  checklist:
    - "required_fields がすべて存在する"
    - "word_count_min >= 8000 が明記されている"
    - "pov_policy と banned_expressions_policy が明記されている"
  metrics:
    - name: "spec_completeness"
      target: ">= 1.0"
      method: "必須キー充足率"

next:
  next_step_id: 1
  message_template: |
    次のステップは以下で実行:
    execute_writing_step episode_number={episode_number} step_id=1

control_settings:
  strict_single_step: true
  require_completion_confirm: true
  auto_advance_disabled: true
  batch_execution_blocked: true
  validation_rules:
    - id: scope.story_goal
      field: scope_definition.story_goal
      rule: present
    - id: scope.continuity
      field: scope_definition.continuity
      rule: present
    - id: value.approval_span
      field: scope_definition.approval_span
      rule: present
    - id: constraints.word_count
      field: constraints.word_count_min
      rule: range
      range: [8000, 999999]
    - id: constraints.pov
      field: constraints.pov_policy
      rule: enum
      allowed: ["one_pov_per_scene"]
    - id: value.handover
      field: handover_to_next.notes
      rule: present
