# STEP 12: ç·åˆå“è³ªèªå®š Schema v2

metadata:
  step_id: 12
  step_name: ç·åˆå“è³ªèªå®š
  phase: expression_quality
  version: 2.0.0
  last_updated: '2025-09-24'
  author: noveler system
  description: å…¨ä½“çš„ãªå“è³ªã®æœ€çµ‚ç¢ºèªã¨å…¬é–‹å¯å¦åˆ¤å®š
  estimated_duration: 8-10åˆ†
llm_config:
  role_messages:
    system: |-
      ã‚ãªãŸã¯å“è³ªãƒã‚§ãƒƒã‚¯ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã§ã™ã€‚constraints.hard_rules ã‚’å³å®ˆã—ã€
      å‡ºåŠ›ã¯ artifacts ã®ä»•æ§˜ã«å¾“ã£ãŸ JSON ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚è¿½åŠ ã®èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚
    user: |-
      ç·åˆå“è³ªèªå®š ã«é–¢ã™ã‚‹ tasksãƒ»acceptance_criteria ã‚’é †å®ˆã—ã¦ãã ã•ã„ã€‚
      å•é¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ issues.<category>[] ã¯ç©ºé…åˆ—ã¨ã—ã¦å‡ºåŠ›ã—ã€summary.evidence ã«æ ¹æ‹ ã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚
prompt:
  main_instruction: |-
    ç›®çš„ã¯ã€Œç·åˆå“è³ªèªå®šã€ã§ã™ã€‚inputsãƒ»constraintsãƒ»tasks ã‚’æº€ãŸã—ã€
    artifacts ã®ä»•æ§˜ã«å¾“ã£ãŸ JSON ã‚’ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãªã—ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
  next_action_instruction: |-
    ã‚¹ãƒ†ãƒƒãƒ— {previous_step_id}ã€Œ{previous_step_name}ã€ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

    æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ— {step_id}ã€Œ{step_name}ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
    å…¨ä½“çš„ãªå“è³ªã®ç·åˆè©•ä¾¡ã‚’è¡Œã„ã¾ã™ï¼š
    1. å…¨ãƒã‚§ãƒƒã‚¯é …ç›®ã®çµ±åˆçµæœ
    2. èª­è€…æº€è¶³åº¦ã®äºˆæ¸¬è©•ä¾¡
    3. å…¬é–‹å¯å¦ã®æœ€çµ‚åˆ¤å®š
    4. ä»Šå¾Œã®æ”¹å–„æ–¹å‘æ€§ã®æç¤º

    ã“ã‚ŒãŒæœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚execute_check_step ã§ step_id={step_id} ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
inputs:
  files:
    - path: '{project_root}/40_åŸç¨¿/ç¬¬{episode_number:03d}è©±*.md'
      required: true
      description: å¯¾è±¡ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰åŸç¨¿ï¼ˆæœ€æ–°ç¨¿ï¼‰
    - path: '{project_root}/config/quality_rules.yaml'
      required: false
      description: å“è³ªé–¢é€£ã®è¨­å®šãŒã‚ã‚Œã°å‚ç…§
  variables:
    episode_number:
      type: int
      required: true
    project_root:
      type: path
      required: true
constraints:
  hard_rules:
    - summary.overview ã¨ metrics.score ã‚’å¿…ãšå‡ºåŠ›ã™ã‚‹
    - issues ã¯å„ã‚«ãƒ†ã‚´ãƒª (issues.*) ã‚’ã‚­ãƒ¼ã«ã‚‚ã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å‡ºåŠ›ã™ã‚‹
    - å„ issue ã«ã¯ before_text / after_text / severity / priority ã‚’æ·»ãˆã‚‹
  soft_targets:
    - metrics.score ã¯ 80 ä»¥ä¸Šã‚’ç›®æŒ‡ã™
    - issues å…¨ä½“ã®ä»¶æ•°ã‚’ 5 ä»¶ä»¥å†…ã«æŠ‘ãˆã‚‹ï¼ˆç†æƒ³å€¤ï¼‰
tasks:
  bullets:
    - ç·åˆå“è³ªèªå®šã®è¦³ç‚¹ï¼ˆç·åˆå“è³ªã€èª­è€…æº€è¶³åº¦ã€å…¬é–‹æº–å‚™åº¦ã€æ”¹å–„å„ªå…ˆåº¦ï¼‰ã‚’ä¿¯ç°ã—ã€é‡å¤§åº¦ã¨å„ªå…ˆåº¦ã‚’åˆ¤å®šã™ã‚‹
    - issues.<category>[] ã«åŸç¨¿æŠœç²‹ãƒ»ä¿®æ­£æ¡ˆãƒ»severityãƒ»priorityãƒ»root_cause ã‚’å«ã‚ã¦æ•´ç†ã™ã‚‹
    - summary.overview ã«ç¾çŠ¶ã¨æ”¹å–„æ–¹é‡ã‚’200å­—ä»¥å†…ã§è¦ç´„ã—ã€summary.evidence ã«æ ¹æ‹ ã‚’ç®‡æ¡æ›¸ãã™ã‚‹
    - metrics.score ã¨ metrics.issue_count ã‚’æ›´æ–°ã—ã€recommendations 
      ã«æœ€å„ªå…ˆã®æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’3ä»¶ä»¥å†…ã§åˆ—æŒ™ã™ã‚‹
  details:
    - name: ç·åˆå“è³ª
      items:
        - id: checks.overall_quality
          text: 'ç·åˆå“è³ªè¦³ç‚¹: å…¨ãƒ•ã‚§ãƒ¼ã‚ºã®å“è³ªãƒ¬ãƒ™ãƒ«çµ±åˆ / è‡´å‘½çš„å•é¡Œã®æœ‰ç„¡ç¢ºèª / èª­è€…æœŸå¾…å€¤ã¨ã®ç…§åˆ / ä½œå“ã¨ã—ã¦ã®å®Œæˆåº¦'
    - name: èª­è€…æº€è¶³åº¦
      items:
        - id: checks.reader_satisfaction
          text: 'èª­è€…æº€è¶³åº¦è¦³ç‚¹: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…å±¤ã®æº€è¶³åº¦äºˆæ¸¬ / ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆæ€§ã®è©•ä¾¡ / æ„Ÿæƒ…çš„ãªæº€è¶³æ„Ÿã®äºˆæ¸¬ / å†èª­ä¾¡å€¤ã®åˆ¤å®š'
    - name: å…¬é–‹æº–å‚™åº¦
      items:
        - id: checks.publication_readiness
          text: 'å…¬é–‹æº–å‚™åº¦è¦³ç‚¹: å…¬é–‹ãƒ¬ãƒ™ãƒ«ã®å“è³ªåˆ°é” / æ¥ãšã‹ã—ããªã„å®Œæˆåº¦ / ç«¶åˆä½œå“ã¨ã®æ¯”è¼ƒ / ãƒ–ãƒ©ãƒ³ãƒ‰ä¾¡å€¤ã¸ã®å½±éŸ¿'
    - name: æ”¹å–„å„ªå…ˆåº¦
      items:
        - id: checks.improvement_priority
          text: 'æ”¹å–„å„ªå…ˆåº¦è¦³ç‚¹: ç·Šæ€¥ä¿®æ­£é …ç›®ã®ç‰¹å®š / æ¨å¥¨æ”¹å–„é …ç›®ã®æ•´ç† / é•·æœŸæ”¹å–„èª²é¡Œã®æ˜ç¢ºåŒ– / æ¬¡å›ä½œã¸ã®æ´»ç”¨ææ¡ˆ'
artifacts:
  format: json
  path_template: '{project_root}/.noveler/checks/EP{episode_number:04d}/step{step_id:02d}_quality.json'
  required_fields:
    - summary
    - issues
    - recommendations
    - metrics
  example: |-
    {
      "summary": {
        "overview": "ç·åˆå“è³ªèªå®šã®ä¸»è¦ãªæ‰€è¦‹ã‚’ã“ã“ã«è¨˜è¿°",
        "score": 82,
        "evidence": [
          "ç·åˆå“è³ª: åŸç¨¿ç¬¬3æ®µè½ã§èª¤ç”¨ã‚’ç¢ºèª"
        ]
      },
      "issues": {
        "overall_quality": [
          {
            "location": "line 42",
            "before_text": "èª¤ã£ãŸè¡¨ç¾",
            "after_text": "ä¿®æ­£æ¡ˆ",
            "severity": "medium",
            "priority": "high",
            "rationale": "å…¨ãƒ•ã‚§ãƒ¼ã‚ºã®å“è³ªãƒ¬ãƒ™ãƒ«çµ±åˆ"
          }
        ],
        "reader_satisfaction": [
          {
            "location": "line 42",
            "before_text": "èª¤ã£ãŸè¡¨ç¾",
            "after_text": "ä¿®æ­£æ¡ˆ",
            "severity": "medium",
            "priority": "high",
            "rationale": "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…å±¤ã®æº€è¶³åº¦äºˆæ¸¬"
          }
        ],
        "publication_readiness": [
          {
            "location": "line 42",
            "before_text": "èª¤ã£ãŸè¡¨ç¾",
            "after_text": "ä¿®æ­£æ¡ˆ",
            "severity": "medium",
            "priority": "high",
            "rationale": "å…¬é–‹ãƒ¬ãƒ™ãƒ«ã®å“è³ªåˆ°é”"
          }
        ],
        "improvement_priority": [
          {
            "location": "line 42",
            "before_text": "èª¤ã£ãŸè¡¨ç¾",
            "after_text": "ä¿®æ­£æ¡ˆ",
            "severity": "medium",
            "priority": "high",
            "rationale": "ç·Šæ€¥ä¿®æ­£é …ç›®ã®ç‰¹å®š"
          }
        ]
      },
      "recommendations": [
        "èª¤ç”¨ç®‡æ‰€ã‚’ä¿®æ­£ã—ã€ã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã‚‹",
        "å†ç™ºé˜²æ­¢ã®ãŸã‚ã«è©²å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ ¡æ­£ã™ã‚‹"
      ],
      "metrics": {
        "issue_count": 4,
        "score": 82,
        "severity_distribution": {
          "low": 1,
          "medium": 3,
          "high": 0
        }
      }
    }
acceptance_criteria:
  checklist:
    - summary.overview ã¨ metrics.score ã‚’å‡ºåŠ›ã—ã¦ã„ã‚‹
    - issues.<category>[] ã®å„è¦ç´ ã« before_text / after_text / severity / priority /
      rationale ãŒå«ã¾ã‚Œã¦ã„ã‚‹
  metrics:
    - name: issue_count
      target: '>= 0'
      method: issues.* ã®ç·ä»¶æ•°
    - name: score_range
      target: 0-100
      method: metrics.score ã®ç¯„å›²æ¤œè¨¼
next:
  next_step_id: 12
  message_template: |-
    ã“ã‚Œã§å“è³ªãƒã‚§ãƒƒã‚¯å…¨å·¥ç¨‹ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚
variables:
  - step_id
  - step_name
  - episode_number
  - completed_steps
  - total_steps
  - phase
control_settings:
  strict_single_step: true
  require_completion_confirm: true
  auto_advance_disabled: true
  batch_execution_blocked: true
  final_step: true
  by_task:
    - id: checks.overall_quality
      field: issues.overall_quality
      rule: present
    - id: checks.reader_satisfaction
      field: issues.reader_satisfaction
      rule: present
    - id: checks.publication_readiness
      field: issues.publication_readiness
      rule: present
    - id: checks.improvement_priority
      field: issues.improvement_priority
      rule: present
check_criteria:
  overall_quality:
    - å…¨ãƒ•ã‚§ãƒ¼ã‚ºã®å“è³ªãƒ¬ãƒ™ãƒ«çµ±åˆ
    - è‡´å‘½çš„å•é¡Œã®æœ‰ç„¡ç¢ºèª
    - èª­è€…æœŸå¾…å€¤ã¨ã®ç…§åˆ
    - ä½œå“ã¨ã—ã¦ã®å®Œæˆåº¦
  reader_satisfaction:
    - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…å±¤ã®æº€è¶³åº¦äºˆæ¸¬
    - ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆæ€§ã®è©•ä¾¡
    - æ„Ÿæƒ…çš„ãªæº€è¶³æ„Ÿã®äºˆæ¸¬
    - å†èª­ä¾¡å€¤ã®åˆ¤å®š
  publication_readiness:
    - å…¬é–‹ãƒ¬ãƒ™ãƒ«ã®å“è³ªåˆ°é”
    - æ¥ãšã‹ã—ããªã„å®Œæˆåº¦
    - ç«¶åˆä½œå“ã¨ã®æ¯”è¼ƒ
    - ãƒ–ãƒ©ãƒ³ãƒ‰ä¾¡å€¤ã¸ã®å½±éŸ¿
  improvement_priority:
    - ç·Šæ€¥ä¿®æ­£é …ç›®ã®ç‰¹å®š
    - æ¨å¥¨æ”¹å–„é …ç›®ã®æ•´ç†
    - é•·æœŸæ”¹å–„èª²é¡Œã®æ˜ç¢ºåŒ–
    - æ¬¡å›ä½œã¸ã®æ´»ç”¨ææ¡ˆ
completion_message: |
  ğŸ‰ å“è³ªãƒã‚§ãƒƒã‚¯å…¨å·¥ç¨‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼

  ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ {episode_number} ã®12æ®µéšå“è³ªãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã„ãŸã—ã¾ã—ãŸã€‚
  ä»¥ä¸‹ã®å…¨ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼š

  âœ… åŸºæœ¬å“è³ª: èª¤å­—è„±å­—ãƒ»æ–‡æ³•ãƒ»èª­ã¿ã‚„ã™ã•
  âœ… ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å“è³ª: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ—ãƒ­ãƒƒãƒˆãƒ»ä¸–ç•Œè¦³
  âœ… æ§‹é€ å“è³ª: èµ·æ‰¿è»¢çµãƒ»ä¼ç·šãƒ»ã‚·ãƒ¼ãƒ³è»¢æ›
  âœ… è¡¨ç¾å“è³ª: æ–‡ç« è¡¨ç¾ãƒ»ãƒªã‚ºãƒ ãƒ»ç·åˆèªå®š

  æœ€çµ‚çš„ãªå“è³ªè©•ä¾¡çµæœã¨æ”¹å–„ææ¡ˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
  ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼
