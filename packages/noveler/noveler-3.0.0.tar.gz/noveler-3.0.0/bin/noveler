#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å°èª¬åŸ·ç­†æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ çµ±åˆCLIï¼ˆæœ¬ç•ªç‰ˆï¼‰
Novel Writing Support System Integrated CLI (Production)

æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼š
- dist/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å®‰å®šç‰ˆã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
- MCPã‚µãƒ¼ãƒãƒ¼å°‚ç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ–
"""

import os
import sys
import subprocess
from pathlib import Path

# Windowsç’°å¢ƒã§ã®UTF-8å‡ºåŠ›ã‚’ç¢ºä¿
if sys.platform == "win32":
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

# æœ¬ç•ªç”¨ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
os.environ["NOVEL_PRODUCTION_MODE"] = "1"

# ã‚¬ã‚¤ãƒ‰ãƒ«ãƒ¼ãƒˆã‚’ç‰¹å®š
def find_guide_root():
    """ã‚¬ã‚¤ãƒ‰ãƒ«ãƒ¼ãƒˆï¼ˆ00_ã‚¬ã‚¤ãƒ‰ï¼‰ã‚’ç¢ºå®Ÿã«ç‰¹å®š"""
    current_file = Path(__file__).resolve()

    # bin/novelerã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹
    if current_file.name == "noveler" and current_file.parent.name == "bin":
        return current_file.parent.parent

    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return current_file.parent.parent

BASE_DIR = find_guide_root()

# æœ¬ç•ªç”¨ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ã‚¹
DIST_DIR = BASE_DIR / "dist"
MAIN_SCRIPT = DIST_DIR / "noveler" / "main.py"

# æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
print("ğŸ­ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­ - å®‰å®šç‰ˆã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™")
print("")

# dist/ãƒ‘ã‚¹ã®è¨­å®š
if DIST_DIR.exists():
    path_sep = ";" if sys.platform == "win32" else ":"
    current_pythonpath = os.environ.get('PYTHONPATH', '')
    os.environ["PYTHONPATH"] = f"{str(DIST_DIR)}{path_sep}{current_pythonpath}" if current_pythonpath else str(DIST_DIR)
    os.environ["GUIDE_ROOT"] = str(BASE_DIR)
    os.environ["NOVEL_USE_DIST"] = "1"  # dist/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½¿ç”¨ãƒ•ãƒ©ã‚°

# æœ¬ç•ªç”¨main.pyã®å®Ÿè¡Œ
try:
    result = subprocess.run([sys.executable, str(MAIN_SCRIPT)] + sys.argv[1:])
    sys.exit(result.returncode)
except Exception as e:
    print(f"âŒ æœ¬ç•ªç”¨novelerã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
    sys.exit(1)
