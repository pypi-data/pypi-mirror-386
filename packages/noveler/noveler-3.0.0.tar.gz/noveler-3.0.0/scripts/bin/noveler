#!/usr/bin/env python3
"""
å°èª¬åŸ·ç­†æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ çµ±åˆCLIï¼ˆæœ¬ç•ªç‰ˆï¼‰
Novel Writing Support System Integrated CLI (Production)

æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼š
- dist/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å®‰å®šç‰ˆã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
- MCPã‚µãƒ¼ãƒãƒ¼å°‚ç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ–
"""

import os
import sys
import subprocess
from pathlib import Path

# æœ¬ç•ªç”¨ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
os.environ["NOVEL_PRODUCTION_MODE"] = "1"

# ã‚¬ã‚¤ãƒ‰ãƒ«ãƒ¼ãƒˆã‚’ç‰¹å®š
def find_guide_root():
    """ã‚¬ã‚¤ãƒ‰ãƒ«ãƒ¼ãƒˆï¼ˆ00_ã‚¬ã‚¤ãƒ‰ï¼‰ã‚’ç¢ºå®Ÿã«ç‰¹å®š"""
    current_file = Path(__file__).resolve()

    # bin/novelerã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹
    if current_file.name == "noveler" and current_file.parent.name == "bin":
        return current_file.parent.parent

    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return current_file.parent.parent

BASE_DIR = find_guide_root()

# æœ¬ç•ªç”¨ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³/ã‚½ãƒ¼ã‚¹ã®ãƒ‘ã‚¹
DIST_DIR = BASE_DIR / "dist"
SRC_DIR = BASE_DIR / "src"
DIST_MAIN = DIST_DIR / "noveler" / "main.py"
SRC_MAIN = SRC_DIR / "noveler" / "main.py"

import sys as _sys

def _is_dist_outdated(dist_main: Path, src_main: Path) -> bool:
    try:
        return dist_main.stat().st_mtime < src_main.stat().st_mtime
    except Exception:
        return True


# å®Ÿè¡Œã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®é¸å®šï¼ˆdistå„ªå…ˆã€ãªã‘ã‚Œã°srcã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
use_src_fallback = False
if not DIST_MAIN.exists():
    use_src_fallback = True
elif SRC_MAIN.exists() and _is_dist_outdated(DIST_MAIN, SRC_MAIN):
    use_src_fallback = True

# dist/ã¾ãŸã¯src ã‚’ PYTHONPATH ã«è¨­å®š
os.environ["GUIDE_ROOT"] = str(BASE_DIR)
if not use_src_fallback and DIST_DIR.exists():
    os.environ["PYTHONPATH"] = f"{str(DIST_DIR)}:{os.environ.get('PYTHONPATH', '')}"
    os.environ["NOVEL_USE_DIST"] = "1"
else:
    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: src ã‚’ä½¿ç”¨
    os.environ["PYTHONPATH"] = f"{str(SRC_DIR)}:{os.environ.get('PYTHONPATH', '')}"
    os.environ["NOVEL_USE_DIST"] = "0"

target_script = DIST_MAIN if not use_src_fallback else SRC_MAIN

# å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆæƒ…å ±ã¯stderrã¸ï¼‰
if use_src_fallback:
    print("âš ï¸ dist ãŒä¸åœ¨/å¤ã„ãŸã‚ src ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨ã—ã¾ã™", file=_sys.stderr)
else:
    print("ğŸ­ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­ - dist ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™", file=_sys.stderr)
print("", file=_sys.stderr)

# é¸æŠã—ãŸ main.py ã®å®Ÿè¡Œ
try:
    result = subprocess.run([sys.executable, str(target_script)] + sys.argv[1:])
    sys.exit(result.returncode)
except Exception as e:
    print(f"âŒ noveler ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
    sys.exit(1)
