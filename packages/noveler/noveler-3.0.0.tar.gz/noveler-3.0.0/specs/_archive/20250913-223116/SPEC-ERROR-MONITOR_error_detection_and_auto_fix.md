# SPEC-ERROR-MONITOR: エラー自動検知・修正システム仕様書

## 1. 概要

### 1.1 目的
コードベースのエラーを自動的に検知し、可能な限り自動修正を行うことで開発効率を向上させる。

### 1.2 背景
- 大規模なコードベースでは様々なエラーが発生する
- 手動でのエラー検出・修正は時間がかかる
- 一貫性のある修正を保証したい

## 2. 機能要件

### 2.1 エラー検知機能

#### 2.1.1 検知対象エラータイプ
1. **構文エラー (syntax)**
   - インデントエラー
   - 括弧の不一致
   - 予期しないトークン

2. **テスト失敗 (test)**
   - pytest実行時の失敗
   - アサーションエラー
   - 例外による失敗

3. **命名規則違反 (naming)**
   - 日本語関数名・クラス名
   - 非英語のファイル名
   - PEP8違反の命名

4. **インポートエラー (import)**
   - 相対インポートの使用
   - インポート順序の違反
   - 未使用インポート

5. **型エラー (type)**
   - mypy検出の型不一致
   - 型ヒントの欠落
   - 互換性のない型の使用

#### 2.1.2 検知方法
- Ruff: 構文エラー、スタイルチェック
- pytest: テスト実行と失敗検出
- カスタムチェッカー: 命名規則違反
- isort/Ruff: インポート順序
- mypy: 型チェック

### 2.2 自動修正機能

#### 2.2.1 自動修正可能なエラー
1. **構文エラー**
   - autopep8による自動フォーマット
   - 基本的なインデント修正
   - 末尾のカンマ追加

2. **インポートエラー**
   - isortによる自動整理
   - インポート順序の修正
   - 未使用インポートの削除

3. **基本的なフォーマット**
   - 行末の空白削除
   - ファイル末尾の改行
   - 一貫したクォート使用

#### 2.2.2 手動修正が必要なエラー
1. **命名規則違反**
   - 日本語→英語の翻訳が必要
   - 意味を保持した変換

2. **複雑な型エラー**
   - ロジックの変更が必要
   - 設計の見直しが必要

3. **テスト失敗**
   - ビジネスロジックの修正
   - テストケースの更新

### 2.3 監視機能

#### 2.3.1 継続的監視
- 5秒間隔でエラーチェック
- バックグラウンドで動作
- リソース効率的な実装

#### 2.3.2 通知機能
- 新規エラーの検出時に通知
- 重複通知の防止（ハッシュ管理）
- ログファイルへの記録

## 3. 非機能要件

### 3.1 パフォーマンス
- エラーチェック: 10秒以内に完了
- 自動修正: 該当ファイルのみ処理
- メモリ使用量: 500MB以下

### 3.2 信頼性
- エラーによるクラッシュを防止
- ロールバック機能なし（Gitで管理）
- ログによる追跡可能性

### 3.3 拡張性
- 新しいエラータイプの追加が容易
- カスタムチェッカーの追加可能
- プラグイン形式での拡張

## 4. インターフェース仕様

### 4.1 CLIコマンド

```bash
# 監視開始
novel error-monitor start [--auto-fix]

# 監視停止
novel error-monitor stop

# エラーチェック
novel error-monitor check [--type TYPE]

# エラー修正
novel error-monitor fix [--type TYPE] [--dry-run]
```

### 4.2 オプション
- `--auto-fix`: 自動修正を有効化
- `--type`: エラータイプを指定（syntax, test, naming, import, type, all）
- `--dry-run`: 実際の修正を行わず確認のみ

## 5. データ仕様

### 5.1 エラーログ形式
```json
{
  "timestamp": "2024-01-29T10:00:00",
  "total_errors": 5,
  "errors": {
    "syntax_errors": [
      {
        "file": "path/to/file.py",
        "line": 42,
        "message": "unexpected indent",
        "type": "syntax_error"
      }
    ],
    "test_failures": [],
    "naming_violations": [],
    "import_errors": [],
    "type_errors": []
  }
}
```

### 5.2 修正結果形式
```json
{
  "fixes_applied": 3,
  "details": [
    {
      "type": "syntax",
      "action": "autopep8_applied",
      "status": "success"
    }
  ],
  "timestamp": "2024-01-29T10:00:05"
}
```

## 6. 実装詳細

### 6.1 アーキテクチャ
- **ErrorDetectionServer**: エラー検知・修正のコア
- **ErrorMonitorCommand**: CLIインターフェース
- **非同期処理**: asyncioを使用した並行処理

### 6.2 ディレクトリ構造
```
scripts/
├── infrastructure/
│   └── mcp/
│       └── error_detection_server.py
└── presentation/
    └── cli/
        └── commands/
            └── error_monitor_command.py
```

### 6.3 依存関係
- autopep8: 構文エラー修正
- isort: インポート整理
- mypy: 型チェック
- pytest: テスト実行
- ruff: リンター

## 7. テスト仕様

### 7.1 単体テスト
- エラー検出ロジックのテスト
- 修正ロジックのテスト
- 通知機能のテスト

### 7.2 統合テスト
- エンドツーエンドのエラー検出・修正
- 監視機能の動作確認
- CLIコマンドの実行テスト

## 8. 運用仕様

### 8.1 ログ管理
- ログファイル: `logs/mcp_error_detection.log`
- ローテーション: 日次
- 保持期間: 7日間

### 8.2 監視
- エラー発生率の追跡
- 自動修正成功率の監視
- パフォーマンスメトリクス

## 9. 制限事項

### 9.1 自動修正の限界
- 意味的な修正は不可
- 破壊的な変更は避ける
- 人間の確認が必要な修正

### 9.2 パフォーマンス
- 大規模ファイルでの遅延
- 同時実行の制限
- リソース使用量の上限

## 10. 今後の拡張

### 10.1 機能拡張
- AIによる命名規則違反の自動修正
- より高度な型エラーの修正
- カスタムルールの追加

### 10.2 統合
- CI/CDパイプラインとの統合
- IDEプラグインの開発
- Webダッシュボードの提供
