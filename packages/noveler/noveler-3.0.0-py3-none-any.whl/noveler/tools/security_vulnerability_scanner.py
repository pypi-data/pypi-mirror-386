#!/usr/bin/env python3
"""
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒŠãƒ¼

S110ãƒ‘ã‚¿ãƒ¼ãƒ³ãŠã‚ˆã³è¿½åŠ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’æ¤œå‡ºãƒ»å ±å‘Šã™ã‚‹åŒ…æ‹¬çš„ã‚¹ã‚­ãƒ£ãƒŠãƒ¼
"""

import json
import re
from dataclasses import dataclass, field
from enum import Enum
from pathlib import Path
from typing import Any

from noveler.domain.value_objects.project_time import project_now
from noveler.infrastructure.config.unified_config_manager import get_configuration_manager
from noveler.presentation.shared.shared_utilities import get_console


class VulnerabilityType(Enum):
    """è„†å¼±æ€§ã‚¿ã‚¤ãƒ—åˆ—æŒ™"""

    HARDCODED_SECRET = "HARDCODED_SECRET"
    PATH_TRAVERSAL = "PATH_TRAVERSAL"
    COMMAND_INJECTION = "COMMAND_INJECTION"
    SQL_INJECTION = "SQL_INJECTION"
    UNSAFE_FILE_OPERATION = "UNSAFE_FILE_OPERATION"
    INSECURE_DESERIALIZATION = "INSECURE_DESERIALIZATION"
    MISSING_INPUT_VALIDATION = "MISSING_INPUT_VALIDATION"
    XML_YAML_INJECTION = "XML_YAML_INJECTION"
    INSECURE_RANDOM = "INSECURE_RANDOM"
    WEAK_CRYPTO = "WEAK_CRYPTO"


@dataclass
class SecurityVulnerability:
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹"""

    vuln_type: VulnerabilityType
    file_path: str
    line_number: int
    code_snippet: str
    severity: str
    description: str
    recommendation: str
    cwe_id: str | None = None
    confidence: str = "HIGH"


@dataclass
class SecurityScanResult:
    """ã‚¹ã‚­ãƒ£ãƒ³çµæœãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹"""

    vulnerabilities: list[SecurityVulnerability] = field(default_factory=list)
    files_scanned: int = 0
    high_severity_count: int = 0
    medium_severity_count: int = 0
    low_severity_count: int = 0

    def add_vulnerability(self, vuln: SecurityVulnerability) -> None:
        """è„†å¼±æ€§ã‚’è¿½åŠ ã—ã€çµ±è¨ˆã‚’æ›´æ–°"""
        self.vulnerabilities.append(vuln)
        if vuln.severity == "HIGH":
            self.high_severity_count += 1
        elif vuln.severity == "MEDIUM":
            self.medium_severity_count += 1
        else:
            self.low_severity_count += 1


class SecurityVulnerabilityScanner:
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒŠãƒ¼"""

    def __init__(self, logger_service: Any | None = None, console_service: Any | None = None) -> None:
        self.config = get_configuration_manager()
        self.console = get_console()
        self.scan_patterns = self._initialize_scan_patterns()

        self.logger_service = logger_service
        self.console_service = console_service

    def scan_project(self, project_root: Path | None = None) -> SecurityScanResult:
        """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"""
        if not project_root:
            project_root = self.config.get_project_root()

        result = SecurityScanResult()
        scripts_dir = project_root / "scripts"

        if not scripts_dir.exists():
            self.console.print("âŒ scripts ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", style="error")
            return result

        self.console.print("ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...", style="info")

        # .pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«ã‚¹ã‚­ãƒ£ãƒ³
        for py_file in scripts_dir.rglob("*.py"):
            try:
                self._scan_file(py_file, result)
                result.files_scanned += 1
            except Exception as e:
                self.console.print(f"âš ï¸  ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼: {py_file}: {e}", style="warning")

        self._print_summary(result)
        return result

    def _scan_file(self, file_path: Path, result: SecurityScanResult) -> None:
        """å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³"""
        try:
            content = file_path.read_text(encoding="utf-8")
            lines = content.split("\n")

            for line_num, line in enumerate(lines, 1):
                for vuln_type, patterns in self.scan_patterns.items():
                    for pattern_data in patterns:
                        if re.search(pattern_data["pattern"], line, re.IGNORECASE):
                            # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯é‡è¦åº¦ã‚’ä¸‹ã’ã‚‹
                            severity = "LOW" if "test" in str(file_path).lower() else pattern_data["severity"]

                            vuln = SecurityVulnerability(
                                vuln_type=vuln_type,
                                file_path=str(file_path.relative_to(self.config.get_project_root())),
                                line_number=line_num,
                                code_snippet=line.strip(),
                                severity=severity,
                                description=pattern_data["description"],
                                recommendation=pattern_data["recommendation"],
                                cwe_id=pattern_data.get("cwe_id"),
                                confidence=pattern_data.get("confidence", "HIGH"),
                            )
                            result.add_vulnerability(vuln)

        except UnicodeDecodeError:
            self.console.print(f"âš ï¸  ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å•é¡Œï¼‰: {file_path}", style="warning")

    def _initialize_scan_patterns(self) -> dict[VulnerabilityType, list[dict]]:
        """ã‚¹ã‚­ãƒ£ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆæœŸåŒ–"""
        return {
            VulnerabilityType.HARDCODED_SECRET: [
                {
                    "pattern": r'(password|pwd|secret|key|token)\s*[=:]\s*["\'][^"\']{8,}["\']',
                    "severity": "HIGH",
                    "description": "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "ç’°å¢ƒå¤‰æ•°ã‚„ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-798",
                },
                {
                    "pattern": r'["\'][A-Za-z0-9+/]{40,}={0,2}["\']',
                    "severity": "MEDIUM",
                    "description": "Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå¯èƒ½æ€§ã®ã‚ã‚‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã§ã¯ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-798",
                    "confidence": "MEDIUM",
                },
            ],
            VulnerabilityType.PATH_TRAVERSAL: [
                {
                    "pattern": r"\.\./|\.\.\\\|/\.\./|\\\.\.\\\|\.\./",
                    "severity": "HIGH",
                    "description": "ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™",
                    "recommendation": "ãƒ‘ã‚¹æ­£è¦åŒ–ã¨ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæ¤œè¨¼ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-22",
                },
                {
                    "pattern": r"open\s*\(\s*[^,)]*input\(|open\s*\(\s*user_input",
                    "severity": "HIGH",
                    "description": "ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã«ä½¿ç”¨ã—ã¦ã„ã¾ã™",
                    "recommendation": "å…¥åŠ›æ¤œè¨¼ã¨ãƒ‘ã‚¹åˆ¶é™ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-22",
                },
            ],
            VulnerabilityType.COMMAND_INJECTION: [
                {
                    "pattern": r"os\.system\s*\(|subprocess\.call\s*\([^)]*shell\s*=\s*True",
                    "severity": "HIGH",
                    "description": "ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™",
                    "recommendation": "shellãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é¿ã‘ã€å¼•æ•°ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-78",
                },
                {
                    "pattern": r'f["\'].*cp\s+.*\{.*\}.*["\']|f["\'].*mv\s+.*\{.*\}.*["\']',
                    "severity": "HIGH",
                    "description": "fæ–‡å­—åˆ—ã§ã®ã‚³ãƒãƒ³ãƒ‰æ§‹ç¯‰ã¯å±é™ºã§ã™",
                    "recommendation": "subprocess.runã§å¼•æ•°ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-78",
                },
            ],
            VulnerabilityType.SQL_INJECTION: [
                {
                    "pattern": r'execute\s*\(\s*["\'].*%s.*["\']|query\s*\(\s*["\'].*%s.*["\']',
                    "severity": "HIGH",
                    "description": "SQLæ–‡å­—åˆ—çµåˆã§ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™",
                    "recommendation": "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-89",
                },
                {
                    "pattern": r'\+\s*["\'].*SELECT.*["\']|\+\s*["\'].*INSERT.*["\']|\+\s*["\'].*UPDATE.*["\']',
                    "severity": "HIGH",
                    "description": "SQLæ–‡å­—åˆ—çµåˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-89",
                },
            ],
            VulnerabilityType.UNSAFE_FILE_OPERATION: [
                {
                    "pattern": r'open\s*\([^)]*["\']w["\'][^)]*\)|open\s*\([^)]*mode\s*=\s*["\']w["\']',
                    "severity": "MEDIUM",
                    "description": "æ›¸ãè¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®æ¤œè¨¼ã¨æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-73",
                },
                {
                    "pattern": r"shutil\.copy\s*\(|shutil\.move\s*\(",
                    "severity": "MEDIUM",
                    "description": "ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã§ãƒ‘ã‚¹æ¤œè¨¼ãŒå¿…è¦ã§ã™",
                    "recommendation": "å®›å…ˆãƒ‘ã‚¹ã®æ¤œè¨¼ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-73",
                },
            ],
            VulnerabilityType.INSECURE_DESERIALIZATION: [
                {
                    "pattern": r"pickle\.loads?\s*\(|yaml\.load\s*\((?!.*Loader\s*=)|eval\s*\(",
                    "severity": "HIGH",
                    "description": "å®‰å…¨ã§ãªã„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "safe_load()ã‚„json.loads()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-502",
                }
            ],
            VulnerabilityType.XML_YAML_INJECTION: [
                {
                    "pattern": r"yaml\.load\s*\((?!.*Loader\s*=\s*yaml\.SafeLoader)",
                    "severity": "HIGH",
                    "description": "YAML unsafe loadãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "yaml.safe_load()ã¾ãŸã¯Loader=yaml.SafeLoaderã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-91",
                }
            ],
            VulnerabilityType.INSECURE_RANDOM: [
                {
                    "pattern": r"random\.random\s*\(|random\.choice\s*\(",
                    "severity": "MEDIUM",
                    "description": "æš—å·å­¦çš„ã«å®‰å…¨ã§ãªã„ä¹±æ•°ç”Ÿæˆå™¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "secrets ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-338",
                }
            ],
            VulnerabilityType.WEAK_CRYPTO: [
                {
                    "pattern": r"hashlib\.md5\s*\(|hashlib\.sha1\s*\(",
                    "severity": "MEDIUM",
                    "description": "å¼±ã„ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "recommendation": "SHA-256ä»¥ä¸Šã®å¼·åŠ›ãªãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„",
                    "cwe_id": "CWE-327",
                }
            ],
        }

    def _print_summary(self, result: SecurityScanResult) -> None:
        """ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º"""
        self.console.print("\n" + "=" * 60, style="bold")
        self.console.print("ğŸ›¡ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ", style="bold blue")
        self.console.print("=" * 60, style="bold")

        self.console.print(f"ğŸ“ ã‚¹ã‚­ãƒ£ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {result.files_scanned}")
        self.console.print(f"ğŸ”´ é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§: {result.high_severity_count}")
        self.console.print(f"ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯è„†å¼±æ€§: {result.medium_severity_count}")
        self.console.print(f"ğŸŸ¢ ä½ãƒªã‚¹ã‚¯è„†å¼±æ€§: {result.low_severity_count}")
        self.console.print(f"ğŸ“Š ç·è„†å¼±æ€§æ•°: {len(result.vulnerabilities)}\n")

    def generate_report(self, result: SecurityScanResult, output_path: Path | None = None) -> Path:
        """è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
        if not output_path:
            output_path = self.config.get_project_root() / "50_ç®¡ç†è³‡æ–™" / "security_scan_report.json"

        # ãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
        report_data = {
            "scan_metadata": {
                "timestamp": self._get_current_timestamp(),
                "files_scanned": result.files_scanned,
                "total_vulnerabilities": len(result.vulnerabilities),
                "severity_breakdown": {
                    "high": result.high_severity_count,
                    "medium": result.medium_severity_count,
                    "low": result.low_severity_count,
                },
            },
            "vulnerabilities": [
                {
                    "type": vuln.vuln_type.value,
                    "file_path": vuln.file_path,
                    "line_number": vuln.line_number,
                    "code_snippet": vuln.code_snippet,
                    "severity": vuln.severity,
                    "description": vuln.description,
                    "recommendation": vuln.recommendation,
                    "cwe_id": vuln.cwe_id,
                    "confidence": vuln.confidence,
                }
                for vuln in result.vulnerabilities
            ],
        }

        # ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
        output_path.parent.mkdir(parents=True, exist_ok=True)
        with output_path.open("w", encoding="utf-8") as f:
            json.dump(report_data, f, ensure_ascii=False, indent=2)

        self.console.print(f"ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: {output_path}", style="success")
        return output_path

    def _get_current_timestamp(self) -> str:
        """ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—"""
        return project_now().datetime.isoformat()


def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    scanner = SecurityVulnerabilityScanner()
    result = scanner.scan_project()
    scanner.generate_report(result)


if __name__ == "__main__":
    main()
