#!/bin/bash
#
# DDDãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚€pre-commitãƒ•ãƒƒã‚¯
# .git/hooks/pre-commitã«ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨
#

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/../.." &> /dev/null && pwd )"

echo "ğŸ” Pre-commit DDD validation starting..."

# 1. DDDãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
echo "ğŸ“‹ Checking DDD compliance..."
cd "$PROJECT_ROOT/scripts" || exit 1

python3 tools/ddd_validator_cli.py . --threshold 85 --quiet
DDD_EXIT_CODE=$?

if [ $DDD_EXIT_CODE -ne 0 ]; then
    echo "âŒ DDD validation failed!"
    echo "Run 'python3 scripts/tools/ddd_validator_cli.py scripts' for details"
    exit 1
fi

SCORE=$(python3 tools/ddd_validator_cli.py . --quiet)
echo "âœ… DDD compliance score: ${SCORE}%"

# 2. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
echo "ğŸ“Š Checking test coverage..."
cd "$PROJECT_ROOT/scripts" || exit 1

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | grep -E '(domain|application|infrastructure)/')

if [ -n "$CHANGED_FILES" ]; then
    # å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
    TEST_FILES=""
    for FILE in $CHANGED_FILES; do
        # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¨æ¸¬
        BASE_NAME=$(basename "$FILE" .py)
        TEST_FILE="tests/test_${BASE_NAME}.py"

        if [ -f "$TEST_FILE" ]; then
            TEST_FILES="$TEST_FILES $TEST_FILE"
        fi
    done

    if [ -n "$TEST_FILES" ]; then
        echo "Running tests for changed files..."
        python3 -m pytest $TEST_FILES --cov=. --cov-fail-under=60 -q
        TEST_EXIT_CODE=$?

        if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "âŒ Test coverage failed!"
            exit 1
        fi
    fi
fi

# 3. TDDã‚µã‚¤ã‚¯ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
echo "ğŸ”„ Checking TDD cycle..."

# æ–°ã—ã„ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
NEW_TEST_FILES=$(git diff --cached --name-only --diff-filter=A | grep 'test_.*\.py$')

if [ -n "$NEW_TEST_FILES" ]; then
    echo "âœ… New test files detected - good TDD practice!"

    # å¯¾å¿œã™ã‚‹å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚ã‚‹ã‹ç¢ºèª
    for TEST_FILE in $NEW_TEST_FILES; do
        # test_xxx.py ã‹ã‚‰ xxx ã‚’æŠ½å‡º
        BASE_NAME=$(basename "$TEST_FILE" | sed 's/test_//' | sed 's/\.py$//')

        # å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
        IMPL_FILES=$(git diff --cached --name-only | grep "${BASE_NAME}\.py$" | grep -v test_)

        if [ -z "$IMPL_FILES" ]; then
            echo "âš ï¸  Warning: Test file $TEST_FILE added without corresponding implementation"
            echo "   Following TDD? Make sure to write failing tests first!"
        fi
    done
fi

# 4. ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¾å­˜é–¢ä¿‚ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
echo "ğŸ—ï¸  Checking layer dependencies..."

# domainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒinfrastructureã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã‹
DOMAIN_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^scripts/domain/.*\.py$')

for FILE in $DOMAIN_FILES; do
    if grep -q "from infrastructure" "$FILE" || grep -q "import infrastructure" "$FILE"; then
        echo "âŒ Layer violation detected in $FILE"
        echo "   Domain layer should not import infrastructure!"
        exit 1
    fi
done

# 5. DDDãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ç¢ºèªï¼ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼‰
if [ -f "$PROJECT_ROOT/scripts/templates/ddd_implementation_checklist.md" ]; then
    echo ""
    echo "ğŸ“‹ Reminder: Have you reviewed the DDD implementation checklist?"
    echo "   scripts/templates/ddd_implementation_checklist.md"
fi

echo ""
echo "âœ… All pre-commit checks passed!"
echo ""

exit 0
