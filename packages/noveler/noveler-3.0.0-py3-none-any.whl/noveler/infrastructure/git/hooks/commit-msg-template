#!/bin/bash
# commit-msg template for structured commit messages
# Conventional Commit + Jira ID integration

set -e

# ã‚«ãƒ©ãƒ¼å‡ºåŠ›
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
show_error() {
    echo -e "${RED}âŒ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼: $1${NC}" >&2
    echo -e "${YELLOW}ðŸ’¡ æ­£ã—ã„å½¢å¼:${NC}" >&2
    echo -e "${BLUE}  feat: æ–°æ©Ÿèƒ½ã®è¿½åŠ ${NC}" >&2
    echo -e "${BLUE}  fix: ãƒã‚°ä¿®æ­£${NC}" >&2
    echo -e "${BLUE}  refactor: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°${NC}" >&2
    echo -e "${BLUE}  docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°${NC}" >&2
    echo -e "${BLUE}  test: ãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»ä¿®æ­£${NC}" >&2
    echo -e "${BLUE}  chore: é›‘å‹™ãƒ»è¨­å®šå¤‰æ›´${NC}" >&2
    echo ""
    echo -e "${YELLOW}ðŸ“‹ ä¾‹:${NC}" >&2
    echo -e "${BLUE}  feat: Phase 4 - è¤‡é›‘åº¦é–¾å€¤ã®å¼·åˆ¶å®Ÿè£…${NC}" >&2
    echo -e "${BLUE}  fix: å“è³ªãƒã‚§ãƒƒã‚«ãƒ¼ã®NullPointerExceptionä¿®æ­£${NC}" >&2
    echo -e "${BLUE}  refactor: DDDæº–æ‹ ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åˆ†é›¢${NC}" >&2
    echo ""
    echo -e "${YELLOW}ðŸ”— Jiraé€£æº (ã‚ªãƒ—ã‚·ãƒ§ãƒ³):${NC}" >&2
    echo -e "${BLUE}  feat: [PROJ-123] æ–°æ©Ÿèƒ½ã®è¿½åŠ ${NC}" >&2
    exit 1
}

# æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
show_success() {
    echo -e "${GREEN}âœ… ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼å®Œäº†${NC}"
    echo -e "${BLUE}ðŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $1${NC}"
    if [[ "$2" != "" ]]; then
        echo -e "${BLUE}ðŸ”— Jira ID: $2${NC}"
    fi
}

# ç©ºã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
if [[ -z "$COMMIT_MSG" || "$COMMIT_MSG" =~ ^#.*$ ]]; then
    show_error "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™"
fi

# ãƒžãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã®é™¤å¤–
if [[ "$COMMIT_MSG" =~ ^Merge\ branch ]]; then
    echo -e "${YELLOW}âš ï¸ ãƒžãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‚’æ¤œå‡ºã€æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™${NC}"
    exit 0
fi

# ãƒªãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆã®é™¤å¤–
if [[ "$COMMIT_MSG" =~ ^Revert\ \" ]]; then
    echo -e "${YELLOW}âš ï¸ ãƒªãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆã‚’æ¤œå‡ºã€æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™${NC}"
    exit 0
fi

# Conventional Commitå½¢å¼ã®æ¤œè¨¼
CONVENTIONAL_COMMIT_REGEX="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,50}"

# Jira IDä»˜ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³
JIRA_COMMIT_REGEX="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: \[([A-Z]+-[0-9]+)\] .{1,50}"

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€åˆã®è¡Œã‚’å–å¾—
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

# Jira IDä»˜ããƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
if [[ "$FIRST_LINE" =~ $JIRA_COMMIT_REGEX ]]; then
    TYPE="${BASH_REMATCH[1]}"
    JIRA_ID="${BASH_REMATCH[3]}"
    show_success "$FIRST_LINE" "$JIRA_ID"
    exit 0
fi

# é€šå¸¸ã®Conventional Commitãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
if [[ "$FIRST_LINE" =~ $CONVENTIONAL_COMMIT_REGEX ]]; then
    TYPE="${BASH_REMATCH[1]}"
    show_success "$FIRST_LINE"
    exit 0
fi

# ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
show_error "Conventional Commitå½¢å¼ã«å¾“ã£ã¦ã„ã¾ã›ã‚“"

# å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼è©³ç´°
if [[ ! "$FIRST_LINE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert) ]]; then
    echo -e "${RED}  â†’ ç„¡åŠ¹ãªã‚¿ã‚¤ãƒ—: ${FIRST_LINE%%:*}${NC}" >&2
    echo -e "${YELLOW}  â†’ æœ‰åŠ¹ãªã‚¿ã‚¤ãƒ—: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert${NC}" >&2
fi

if [[ ! "$FIRST_LINE" =~ : ]]; then
    echo -e "${RED}  â†’ ã‚³ãƒ­ãƒ³(:)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}" >&2
fi

if [[ "${#FIRST_LINE}" -gt 50 ]]; then
    echo -e "${RED}  â†’ 1è¡Œç›®ãŒé•·ã™ãŽã¾ã™ (${#FIRST_LINE}æ–‡å­— > 50æ–‡å­—)${NC}" >&2
fi

exit 1
