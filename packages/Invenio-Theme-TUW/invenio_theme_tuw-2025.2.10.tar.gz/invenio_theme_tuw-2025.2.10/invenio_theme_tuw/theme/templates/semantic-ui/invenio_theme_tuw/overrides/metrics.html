{#-
  Copyright (C) 2020      CERN.
  Copyright (C) 2020      Northwestern University.
  Copyright (C) 2021-2024 TU Wien.
  Copyright (C) 2022      New York University.

  Invenio RDM Records is free software; you can redistribute it and/or modify
  it under the terms of the MIT License; see LICENSE file for more details.
#}

{#- base: invenio-app-rdm v13.0.0 (invenio_app_rdm/records/details/side_bar/metrics.html & invenio_app_rdm/records/details/stats.html) #}
{#- changes: condition for rendering the box, remove data volume #}

{% from "invenio_app_rdm/records/macros/stats_popup.html" import stats_popup %}

{#- change: only show stats to record owners #}
{% if record_ui["stats"] and current_user and current_user.id == (record_ui["id"]|resolve_record|resolve_user_owner).id %}
<section id="metrics" aria-label="{{ _('Metrics') }}" class="ui segment rdm-sidebar sidebar-container">
  {#- change: inline rather than import the box #}
  <div class="ui tiny two statistics rel-mt-1">
    {% set all_versions = record_ui["stats"]["all_versions"] %}
    {% set this_version = record_ui["stats"]["this_version"] %}

    <div class="ui statistic">
      <div class="value">{{ all_versions.unique_views|compact_number(max_value=1_000_000) }}</div>
      <div class="label">
        <i aria-hidden="true" class="eye icon"></i>
        {{ _("Views") }}
      </div>
    </div>

    <div class="ui statistic">
      <div class="value">{{ all_versions.unique_downloads|compact_number(max_value=1_000_000) }}</div>
      <div class="label">
        <i aria-hidden="true" class="download icon"></i>
        {{ _("Downloads") }}
      </div>
    </div>
  </div>

  {#- change: make it clear that only record owners can see the statistics here #}
  <div class="ui centered info container mt-30">
    <i class="small circle info icon"></i>
    Statistics are only shown to record owners.
  </div>

  <div class="ui accordion rel-mt-1 centered">
    {#- change: remove tabindex="0" #}
    <div class="title trigger">
      <i class="caret right icon" aria-hidden="true"></i>
      <span
        data-open-text="{{ _('Show more details') }}"
        data-close-text="{{ _('Show less details') }}"
      >
        {{ _('Show more details') }}
      </span>
    </div>

    <div class="content">
      <table id="record-statistics" class="ui definition table fluid">
        <thead>
          <tr>
            <th></th>
            <th class="right aligned">{{ _("All versions") }}</th>
            <th class="right aligned">{{ _("This version") }}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              {{ _("Views") }}
              <i
                style="position:relative"
                class="popup-trigger question circle small icon"
                aria-expanded="false"
                aria-label="{{ _('More info') }}"
                data-variation="mini inverted"
              >
              </i>
              <p role="tooltip" class="popup-content ui flowing popup transition hidden">
                {{ _('Total views') }}
              </p>
            </td>
            <td data-label="{{_('All versions')}}" class="right aligned">{{ stats_popup(all_versions.unique_views) }}</td>
            <td data-label="{{_('This version')}}" class="right aligned">{{ stats_popup(this_version.unique_views) }}</td>
          </tr>
          <tr>
            <td>
              {{ _("Downloads") }}
              <i
                style="position:relative"
                class="popup-trigger question circle small icon"
                aria-expanded="false"
                aria-label="{{ _('More info') }}"
                data-variation="mini inverted"
              >
              </i>
              <p role="tooltip" class="popup-content ui flowing popup transition hidden">
                {{ _('Total downloads') }}
              </p>
            </td>
            <td data-label="{{_('All versions')}}" class="right aligned">{{ stats_popup(all_versions.unique_downloads) }}</td>
            <td data-label="{{_('This version')}}" class="right aligned">{{ stats_popup(this_version.unique_downloads) }}</td>
          </tr>
          {#- change: remove data volume info #}
        </tbody>
      </table>
      <p class="text-align-center rel-mt-1">
        <small>
          <a href="/help/statistics">{{ _("More info on how stats are collected.") }}...</a>
        </small>
      </p>
    </div>
  </div>
</section>
{% endif %}
