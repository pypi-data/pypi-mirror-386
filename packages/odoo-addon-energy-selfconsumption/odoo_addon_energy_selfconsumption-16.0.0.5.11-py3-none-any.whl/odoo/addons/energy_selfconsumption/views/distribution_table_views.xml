<?xml version="1.0" encoding="utf-8" ?>
<!--
Distribution Table Views
========================

This file contains views for managing distribution tables in energy 
self-consumption projects. Distribution tables define how energy is 
distributed among participants in a self-consumption project.

Main functionalities:
- Form view with workflow states (draft → validated → process → active)
- Editable tree for supply point assignations and coefficients
- Import functionality for bulk data loading
- CSV report generation for energy distribution
- State-based decorations and validations
- Coefficient validation and visual feedback
-->
<odoo>
    <data>
        
        <!-- Form View: Distribution Table Management -->
        <record id="distribution_table_form_view" model="ir.ui.view">
            <field name="name">energy_selfconsumption.distribution_table_form_view.form</field>
            <field name="model">energy_selfconsumption.distribution_table</field>
            <field name="arch" type="xml">
                <form string="Distribution Table">
                    
                    <!-- Header with workflow buttons and status -->
                    <header>
                        <!-- Workflow advance buttons -->
                        <button type="object"
                                string="Validate"
                                name="button_validate"
                                states="draft"
                                class="btn btn-primary" />
                        
                        <!-- Workflow rollback buttons -->
                        <button type="object"
                                string="Reset to draft"
                                name="button_draft"
                                attrs="{'invisible':[('state','not in',['validated'])]}" />
                        
                        <!-- Data import button -->
                        <button type="object"
                                name="action_distribution_table_import_wizard"
                                string="Import table"
                                states="draft" />

                        <!-- Report generation buttons -->
                        <button type="object"
                                name="action_manager_authorization_report"
                                string="Manager Authorization Report"
                                class="btn btn-secondary"
                                attrs="{'invisible': [('state', 'in', ['draft'])]}" />
                        
                        <button type="object"
                                name="action_power_sharing_agreement_report"
                                string="Power Sharing Agreement Report"
                                class="btn btn-secondary"
                                attrs="{'invisible': [('state', 'in', ['draft'])]}" />
                        
                        <button type="object"
                                name="action_manager_partition_coefficient_report"
                                string="Partition Coefficient Report"
                                class="btn btn-secondary"
                                attrs="{'invisible': [('state', 'in', ['draft'])]}" />
                        
                        <!-- Status bar -->
                        <field name="state"
                               widget="statusbar"
                               readonly="True"
                               statusbar_visible="draft,validated,process,active" />
                        
                        <!-- Hidden control fields -->
                        <field name="selfconsumption_project_state" invisible="1" />
                    </header>
                    
                    <sheet>
                        <!-- Archived indicator -->
                        <widget name="web_ribbon"
                                text="Archived"
                                bg_color="bg-danger"
                                attrs="{'invisible': [('active', '=', True)]}" />
                        
                        <!-- Hidden control fields -->
                        <field name="active" invisible="True" />
                        
                        <!-- Distribution table basic information -->
                        <group>
                            <!-- Left column: Date information -->
                            <group>
                                <field name="date_start" 
                                       readonly="1" 
                                       attrs="{'invisible': [('state', 'not in', ['active', 'cancelled'])]}" />
                                <field name="selfconsumption_project_id"
                                       attrs="{'readonly': [('state', 'not in', ['draft'])]}"
                                       options="{'no_create': True}"
                                       invisible="1" />
                            </group>
                            
                            <!-- Right column: Configuration -->
                            <group>
                                <field name="date_end" 
                                       readonly="1" 
                                       attrs="{'invisible': [('state', 'not in', ['active', 'cancelled'])]}" />
                                <field name="type"
                                       attrs="{'readonly': [('state', 'not in', ['draft'])]}" />
                            </group>
                        </group>
                        
                        <!-- Supply point assignations section -->
                        <group>
                            <field name="supply_point_assignation_ids"
                                   widget="distribution_table_one2many"
                                   mode="list"
                                   context="{'default_distribution_table_id':id, 'distribution_table_type': type}"
                                   attrs="{'readonly': [('state', 'not in', ['draft'])]}"
                                   nolabel="1"
                                   colspan="2">
                                <tree editable="bottom">
                                    <!-- Hidden control fields -->
                                    <field name="supply_point_filtered_ids" invisible="True" />
                                    <field name="table_coefficient_is_valid" invisible="True" />
                                    
                                    <!-- Supply point selection -->
                                    <field name="supply_point_id"
                                           options="{'no_create': True, 'search_more': True}"
                                           domain="[('id', 'in', supply_point_filtered_ids)]" />
                                    
                                    <!-- Supply point details -->
                                    <field name="owner_id" />
                                    <field name="code" />
                                    
                                    <!-- Energy distribution data -->
                                    <field name="energy_shares" readonly="True" sum="True"/>
                                    <field name="coefficient"
                                           sum="True"
                                           decoration-success="table_coefficient_is_valid == True" />
                                </tree>
                            </field>
                        </group>
                    </sheet>
                    
                    <!-- Communication and activity tracking -->
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers" />
                        <field name="activity_ids" widget="mail_activity" />
                        <field name="message_ids" widget="mail_thread" />
                    </div>
                </form>
            </field>
        </record>

        <!-- Tree View: Distribution Table List -->
        <record id="distribution_table_tree_view" model="ir.ui.view">
            <field name="name">energy_selfconsumption.distribution_table.tree</field>
            <field name="model">energy_selfconsumption.distribution_table</field>
            <field name="arch" type="xml">
                <tree string="Distribution Table" 
                      decoration-warning="state in ['validated', 'process']" 
                      decoration-success="state == 'active'" 
                      decoration-danger="state == 'cancelled'">
                    <!-- Main identification fields -->
                    <field name="name" />
                    <field name="selfconsumption_project_id" />
                    <field name="create_date" />
                    
                    <!-- Date range -->
                    <field name="date_start" />
                    <field name="date_end" />
                    
                    <!-- Configuration and status -->
                    <field name="type" />
                    <field name="state" />
                </tree>
            </field>
        </record>

        <!-- Search View: Filters and Groupings -->
        <record id="distribution_table_search_view" model="ir.ui.view">
            <field name="name">energy_selfconsumption.distribution_table.search</field>
            <field name="model">energy_selfconsumption.distribution_table</field>
            <field name="type">search</field>
            <field name="arch" type="xml">
                <search string="Distribution Table">
                    <!-- Filters by state -->
                    <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Validated" name="validated" domain="[('state', '=', 'validated')]"/>
                    <filter string="In process" name="process" domain="[('state', '=', 'process')]"/>
                    <filter string="Active" name="active" domain="[('state', '=', 'active')]"/>
                    <filter string="Cancelled" name="cancelled" domain="[('state', '=', 'cancelled')]"/>
                    
                    <!-- Filters by type -->
                    <filter string="Fixed" name="fixed" domain="[('type', '=', 'fixed')]"/>
                    <filter string="Variable hourly" name="hourly" domain="[('type', '=', 'hourly')]"/>
                    
                    <!-- Search fields -->
                    <field name="name" />
                    
                    <!-- Grouping options -->
                    <group expand="1" string="Group By">
                        <filter string="Self-consumption Project"
                                name="selfconsumption_project_id"
                                domain="[]"
                                context="{'group_by':'selfconsumption_project_id'}" />
                    </group>
                </search>
            </field>
        </record>

        <!-- Action Window: Distribution Tables -->
        <record id="distribution_table_act_window" model="ir.actions.act_window">
            <field name="name">Distribution Table</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">energy_selfconsumption.distribution_table</field>
            <field name="view_mode">tree,form</field>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    There is no examples click here to add new Distribution Table.
                </p>
            </field>
        </record>

        <!-- CSV Report: Energy Distribution Template -->
        <record id="distribution_table_hourly_csv_report" model="ir.actions.report">
            <field name="name">Customized delivered energy template</field>
            <field name="model">energy_selfconsumption.distribution_table</field>
            <field name="report_type">csv</field>
            <field name="report_name">energy_selfconsumption.distribution_table.csv</field>
            <field name="report_file">distribution_table</field>
            <field name="binding_model_id"
                   ref="energy_selfconsumption.model_energy_selfconsumption_distribution_table" />
            <field name="binding_type">report</field>
        </record>

    </data>
</odoo>
