<?xml version="1.0" encoding="utf-8"?>
<!--
Invoice Template for Self-consumption
=====================================

This file contains the invoice template customization for energy self-consumption
projects that modifies the standard Odoo invoice layout.

Main functionalities:
- Custom invoice headers based on invoicing mode (power acquired, energy delivered)
- Dynamic column display for different billing types
- Integration with self-consumption data (power, coefficients, imports)
- Custom payment communication for SEPA direct debit
- Support for multiple invoicing modes with specific data display
-->
<odoo>

    <!-- Template: Self-consumption Invoice Template -->
    <template id="selfconsumption_invoice_template" inherit_id="account.report_invoice_document">
        
        <!-- Quantity Column Header Customization -->
        <xpath expr="//th[@name='th_quantity']" position="replace">
            <!-- Standard quantity header for none and power acquired modes -->
            <th name="th_quantity" 
                t-if="o.selfconsumption_invoicing_mode == 'none'" 
                class="text-end">
                <span>Quantity</span>
            </th>
            <th name="th_quantity" 
                t-if="o.selfconsumption_invoicing_mode == 'power_acquired'" 
                class="text-end">
                <span>Quantity</span>
            </th>
            
            <!-- Energy delivered mode specific headers -->
            <t t-if="o.selfconsumption_invoicing_mode == 'energy_delivered'">
                <th name="th_total_installation_generation" class="text-end">
                    <span>Total installation generation</span>
                </th>
                <th name="th_partition_coefficient" class="text-end">
                    <span>Partition coefficient</span>
                </th>
                <th name="th_total_amount_invoiced" class="text-end">
                    <span>Total amount invoiced</span>
                </th>
            </t>
        </xpath>
        
        <!-- Import Column Addition -->
        <xpath expr="//th[@name='th_priceunit']" position="after">
            <!-- Import header for power acquired mode -->
            <t t-if="o.selfconsumption_invoicing_mode == 'power_acquired'">
                <th name="th_import" class="text-end">
                    <span>Import</span>
                </th>
            </t>
            
            <!-- Import header for energy delivered mode -->
            <t t-if="o.selfconsumption_invoicing_mode == 'energy_delivered'">
                <th name="th_import" class="text-end">
                    <span>Import</span>
                </th>
            </t>
        </xpath>
        
        <!-- Taxes Column Customization -->
        <xpath expr="//th[@name='th_taxes']" position="replace">
            <!-- Only show taxes column for none mode -->
            <th name="th_taxes" 
                t-if="o.selfconsumption_invoicing_mode == 'none'" 
                t-attf-class="text-start {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span>Taxes</span>
            </th>
        </xpath>
        
        <!-- Subtotal Column Customization -->
        <xpath expr="//th[@name='th_subtotal']" position="replace">
            <!-- Only show subtotal column for none mode -->
            <th name="th_subtotal" 
                t-if="o.selfconsumption_invoicing_mode == 'none'" 
                class="text-end">
                <span groups="account.group_show_line_subtotals_tax_excluded">Amount</span>
                <span groups="account.group_show_line_subtotals_tax_included">Total Price</span>
            </th>
        </xpath>
        
        <!-- Invoice Line Data Customization -->
        <xpath expr="//td[@name='account_invoice_line_name']" position="after">
            <!-- Energy delivered mode specific data -->
            <t t-if="o.selfconsumption_invoicing_mode == 'energy_delivered'">
                <!-- Total installation generation -->
                <td name="td_total_installation_generation" class="text-end">
                    <span t-out="o.energy_delivered"/>
                    <span> kWh</span>
                </td>
                
                <!-- Partition coefficient -->
                <td name="td_partition_coefficient" class="text-end">
                    <t t-if="line.contract_line_id.contract_id.supply_point_assignation_id.coefficient">
                        <span t-field="line.contract_line_id.contract_id.supply_point_assignation_id.coefficient"/>
                    </t>
                </td>
            </t>
        </xpath>
        
        <!-- Tax Data Customization -->
        <xpath expr="//td[@name='td_taxes']" position="replace">
            <!-- Only show taxes data for none mode -->
            <td name="td_taxes" 
                t-if="o.selfconsumption_invoicing_mode == 'none'" 
                t-attf-class="text-start {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }} {{ 'text-nowrap' if len(taxes) &lt; 10 else '' }}">
                <span t-out="taxes" id="line_tax_ids">Tax 15%</span>
            </td>
        </xpath>
        
        <!-- Payment Communication Customization -->
        <xpath expr="//p[@name='payment_communication']" position="replace">
            <!-- Custom payment communication excluding SEPA direct debit -->
            <p t-if="o.move_type in ('out_invoice', 'in_refund') and o.payment_reference and o.payment_mode_id.payment_method_id.code != 'sepa_direct_debit'" 
               name="payment_communication" 
               class="mt-4">
                Please use the following communication for your payment : 
                <b><span t-field="o.payment_reference"/></b>
                <t t-if="o.partner_bank_id">
                    <br/>
                    on this account: <span t-field="o.partner_bank_id" class="fw-bold"/>
                </t>
            </p>
        </xpath>
        
    </template>
    
</odoo>
