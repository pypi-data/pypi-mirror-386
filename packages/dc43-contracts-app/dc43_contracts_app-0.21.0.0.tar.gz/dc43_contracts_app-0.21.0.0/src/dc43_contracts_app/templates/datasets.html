{% extends "base.html" %}
{% block content %}
<h1>Datasets</h1>
<table class="table table-striped align-middle">
  <thead>
    <tr>
      <th scope="col">Dataset</th>
      <th scope="col">Latest Version</th>
      <th scope="col">Status</th>
      <th scope="col">Contract</th>
      <th scope="col">Data products</th>
      <th scope="col">Drafts</th>
      <th scope="col" class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for entry in datasets %}
    <tr>
      <th scope="row">
        <a href="/datasets/{{ entry.dataset_name }}">{{ entry.dataset_name }}</a>
      </th>
      <td>
        {% if entry.latest_version %}
          <a href="/datasets/{{ entry.dataset_name }}/{{ entry.latest_version }}">{{ entry.latest_version }}</a>
        {% else %}
          <span class="text-muted">No versions</span>
        {% endif %}
      </td>
      <td>
        {% if entry.latest_status %}
          <span class="badge {{ entry.latest_status_badge }}">{{ entry.latest_status_label }}</span>
          {% if entry.latest_record_reason %}
            <div class="small text-muted">{{ entry.latest_record_reason }}</div>
          {% endif %}
        {% else %}
          <span class="text-muted">No runs</span>
        {% endif %}
      </td>
      <td>
        {% if entry.contract_summaries %}
          {% for contract in entry.contract_summaries %}
            <div>
              <a href="/contracts/{{ contract.id }}">{{ contract.id }}</a>
              {% if contract.latest_version %}
                <span class="text-muted">/</span>
                <a href="/contracts/{{ contract.id }}/{{ contract.latest_version }}">{{ contract.latest_version }}</a>
              {% endif %}
            </div>
            <div class="small text-muted">Status: {{ contract.latest_status_label }}</div>
            {% if contract.other_versions %}
              <div class="small text-muted">Other versions: {{ contract.other_versions | join(', ') }}</div>
            {% endif %}
          {% endfor %}
        {% else %}
          <span class="text-muted">No contract</span>
        {% endif %}
      </td>
      <td>
        {% if entry.data_products %}
          {% for product in entry.data_products %}
            <div>
              {% if product.product_id %}
                <a href="/data-products/{{ product.product_id }}">{{ product.product_id }}</a>
              {% else %}
                <span class="text-muted">Unknown</span>
              {% endif %}
              {% if product.port_name %}
                <span class="text-muted">/</span>
                <code>{{ product.port_name }}</code>
              {% endif %}
              {% if product.role %}
                <span class="badge bg-secondary text-uppercase ms-1">{{ product.role }}</span>
              {% endif %}
              {% if product.latest_dataset_version %}
                <div class="small text-muted">
                  {{ product.latest_dataset_version }} â†’ {{ product.latest_status or 'unknown' }}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <span class="text-muted">None</span>
        {% endif %}
      </td>
      <td>
        {% set draft_details = [] %}
        {% for contract in entry.contract_summaries %}
          {% if contract.drafts_count %}
            {% set draft_label = contract.drafts_count ~ ' draft' ~ ('s' if contract.drafts_count != 1 else '') %}
            {% if contract.latest_draft_version %}
              {% set draft_label = draft_label ~ ' (latest ' ~ contract.latest_draft_version ~ ')' %}
            {% endif %}
            {% set _ = draft_details.append(contract.id ~ ': ' ~ draft_label) %}
          {% endif %}
        {% endfor %}
        {% if entry.run_drafts_count %}
          {% set label = entry.run_drafts_count ~ ' draft run' ~ ('s' if entry.run_drafts_count != 1 else '') %}
          {% if entry.run_latest_draft_version %}
            {% set label = label ~ ' (latest ' ~ entry.run_latest_draft_version ~ ')' %}
          {% endif %}
          {% set _ = draft_details.append('Runs: ' ~ label) %}
        {% endif %}
        {% if draft_details %}
          <div class="small">{% for line in draft_details %}<div>{{ line }}</div>{% endfor %}</div>
        {% else %}
          <span class="text-muted">None</span>
        {% endif %}
      </td>
      <td class="text-end">
        <a class="btn btn-sm btn-outline-primary" href="/datasets/{{ entry.dataset_name }}">View versions</a>
        {% if entry.contract_summaries %}
          {% set editable_contracts = entry.contract_summaries | selectattr('latest_version') | list %}
          {% if editable_contracts | length == 1 %}
            {% set target = editable_contracts[0] %}
            <a class="btn btn-sm btn-primary ms-2" href="/contracts/{{ target.id }}/{{ target.latest_version }}/edit">Open editor</a>
          {% elif editable_contracts %}
            <div class="btn-group ms-2">
              <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Open editor
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                {% for contract in editable_contracts %}
                  <li>
                    <a class="dropdown-item" href="/contracts/{{ contract.id }}/{{ contract.latest_version }}/edit">
                      {{ contract.id }} {{ contract.latest_version }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% if not datasets %}
  <p class="text-muted">No datasets recorded yet.</p>
{% endif %}
{% endblock %}
