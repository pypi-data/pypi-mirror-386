{
  "$schema": "./../schemas/TaskTable.schema.json",
  "tasktable": {
    "name": "s3-l0",
    "version": 1.0,
    "specification_version": "1.0_draftE",
    "update_datetime": "2025-09-29T17:22:00Z",
    "configuration_path": {}
  },
  "external_variables": [
    "start_datetime",
    "end_datetime"
  ],
  "units": [
    {
      "name": "single_unit",
      "module": "l0.s3.s3_l0_processor",
      "resources_min": {
        "dask": {
          "worker_cpu": 4,
          "worker_ram": "58GB",
          "worker_thread_count": 1,
          "worker_count": 1
        },
        "disk": {
          "size_per_worker": "50GB"
        }
      },
      "input_products": [
        {
          "name": "S3ACADUS",
          "mode": "always",
          "mandatory": true
        }
      ],
      "input_adfs": [
        {
          "name": "OSF",
          "mode": "always",
          "mandatory": false
        },
        {
          "name": "FRO",
          "mode": "always",
          "mandatory": false
        }
      ],
      "output_products": [
        {
          "name": "S03ISPS",
          "mode": "always",
          "mandatory": true,
          "regex" : "^(?!cache).*"
        },
        {
          "name": "S03CACHE",
          "mode": "always",
          "mandatory": true,
          "regex" : "cache.*"
        }
      ]
    }
  ],
  "io": [
    {
      "name": "S3ACADUS",
      "type": "folder",
      "store_type": "cadu"
    },
    {
      "name": "OSF",
      "type": "filename",
      "store_type": "safe",
      "alternatives": [
        {
          "order": 1,
          "timeout_seconds": 0,
          "query": {
            "name": "LatestValCover",
            "parameters": {
              "product_type": "AX___OSF_AX",
              "start_datetime": "{external_variable.start_datetime}",
              "end_datetime": "{external_variable.end_datetime}",
              "dTa": 6000,
              "dTb": 6000
            }
          }
        }
      ]
    },
    {
      "name": "FRO",
      "type": "filename",
      "store_type": "safe",
      "alternatives": [
        {
          "order": 1,
          "timeout_seconds": 0,
          "query": {
            "name": "LatestValCover",
            "parameters": {
              "product_type": "AX___FRO_AX",
              "start_datetime": "{external_variable.start_datetime}",
              "end_datetime": "{external_variable.end_datetime}",
              "dTa": 7000,
              "dTb": 7000
            }
          }
        }
      ]
    },
      {
      "name": "S03ISPS",
      "type": "folder",
      "store_type": "zarr",
      "opening_mode" :"CREATE_OVERWRITE"
    },
      {
      "name": "S03CACHE",
      "type": "folder",
      "store_type": "zarr",
      "opening_mode" :"CREATE_OVERWRITE"
    }
  ],
  "queries": [
    {
      "name": "LatestValCover",
      "parameters": [
        "product_type",
        "start_datetime",
        "end_datetime",
        "dTa",
        "dTb"
      ],
      "stac": {
        "filter": {
          "op": "and",
          "args": [
            {
              "op": "=",
              "args": [
                {
                  "property": "product:type"
                },
                "{product_type}"
              ]
            },
            {
              "op": "t_contains",
              "args": [
                {
                  "interval": [
                    {
                      "property": "start_datetime"
                    },
                    {
                      "property": "end_datetime"
                    }
                  ]
                },
                {
                  "interval": [
                    {
                      "op": "-",
                      "args": [
                        "{start_datetime}",
                        "{dTa}"
                      ]
                    },
                    {
                      "op": "+",
                      "args": [
                        "{end_datetime}",
                        "{dTb}"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        "sortby": [
          {
            "field": "created",
            "direction": "desc"
          }
        ],
        "limit": 1
      }
    }
  ],
  "pipelines": [
    {
      "name": "s3_l0_full",
      "description": "Full pipeline for S3 L0",
      "steps": [
        {
          "unit_name": "single_unit",
          "order": 1,
          "input_products": {
            "S3ACADUS": "pipeline_input"
          },
          "output_products": {
            "S03ISPS": "pipeline_output",
            "S03CACHE": "pipeline_internal"
          }
        }
      ]
    }
  ]
}
