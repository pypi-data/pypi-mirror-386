# BMI Calculator MCP 托管部署指南

## 项目概述

本项目是 `bmi-calculator-mcp-stdio` 的可托管部署版本，已按照魔搭平台的要求进行了配置优化。

## 关键修改说明

### 1. server_info.json 修改

**原配置：**
```json
{
    "server": {
        "command": "python",
        "args": []
    }
}
```

**新配置：**
```json
{
    "server": {
        "command": "uvx",
        "args": [
            "mcp-server-bmi-calculator@latest"
        ]
    }
}
```

**修改原因：**
- 魔搭平台要求 `command` 必须是 `uvx` 或 `npx`
- `args` 必须指定从 PyPI 安装的包名
- `@latest` 确保用户始终使用最新版本

### 2. pyproject.toml 优化

**主要改进：**
- 移除了 `pydantic` 依赖（MCP SDK 已包含）
- 添加了项目 URL（需要替换为实际的 GitHub 仓库地址）
- 扩展了 Python 版本支持（3.10-3.12）

## 部署步骤

### 步骤 1：发布到 PyPI

#### 1.1 安装构建工具

```bash
pip install build twine
```

#### 1.2 构建项目

在项目根目录（`test/bmi-calculator-mcp-stdio-deployable`）执行：

```bash
python -m build
```

这将在 `dist/` 目录下生成两个文件：
- `mcp_server_bmi_calculator-0.1.0-py3-none-any.whl`
- `mcp_server_bmi_calculator-0.1.0.tar.gz`

#### 1.3 上传到 PyPI

**测试环境（推荐先测试）：**

```bash
python -m twine upload --repository testpypi dist/*
```

**生产环境：**

```bash
python -m twine upload dist/*
```

**注意事项：**
- 需要先在 [PyPI](https://pypi.org/) 注册账号
- 建议先使用 [TestPyPI](https://test.pypi.org/) 测试
- 包名 `mcp-server-bmi-calculator` 必须在 PyPI 上唯一

### 步骤 2：在魔搭平台创建 MCP 服务

#### 2.1 前往创建页面

访问魔搭 MCP 广场，点击右上角"创建"按钮，选择"自定义创建"。

#### 2.2 填写基础信息

**必填字段：**

| 字段 | 值 | 说明 |
|------|-----|------|
| 英文名称 | `bmi-calculator` | 将与所有者组成服务ID |
| 展示名称 | `BMI计算器` | 在平台展示的名称 |
| 所有者 | 选择个人或组织 | - |
| 是否公开 | 公开 | 当前仅支持公开 |
| 托管类型 | **可托管部署** | 关键选择 |
| 服务图标 | 上传图标 | 建议尺寸 256x256 |

#### 2.3 填写服务配置

在"服务配置"字段中，粘贴以下 JSON（**不要包含注释**）：

```json
{
  "mcpServers": {
    "bmi-calculator": {
      "command": "uvx",
      "args": [
        "mcp-server-bmi-calculator@latest"
      ]
    }
  }
}
```

**重要提示：**
- JSON 中不能包含注释
- 确保包名与 PyPI 上发布的一致
- 建议使用 `@latest` 后缀

#### 2.4 填写服务介绍

可以直接复制 `README_zh-CN.md` 的内容，或者自定义编写。

#### 2.5 填写其他信息

- **服务描述**：简短描述（1-2句话）
- **类型**：选择"健康工具"或相关分类
- **环境变量配置**：本项目无需环境变量，留空即可

### 步骤 3：等待自动部署检测

提交创建后，魔搭平台将自动执行以下检测：

1. **服务配置解析**：检查 JSON 格式
2. **服务配置可用性**：验证 `command` 和 `args`
3. **尝试部署并连接**：
   - 从 PyPI 下载 `mcp-server-bmi-calculator@latest`
   - 启动服务并调用 `list_tools`
   - 验证工具列表是否正常返回

**检测通过标志：**
- 服务详情页显示"可部署"标签
- 公开服务会显示"hosted"标签
- 工具测试页可以查看可用工具列表

### 步骤 4：测试服务

#### 4.1 本地测试（发布前）

```bash
# 安装依赖
pip install -e .

# 运行服务
python -m bmi_calculator_mcp
```

#### 4.2 平台测试（发布后）

1. 在服务详情页点击"工具测试"
2. 选择 `calculate_bmi` 工具
3. 输入测试参数：
   - `height`: 1.75
   - `weight`: 70
4. 查看返回结果

## 常见问题

### Q1: 部署检测失败怎么办？

**可能原因：**
1. PyPI 包未成功发布
2. 包名不匹配
3. 服务配置 JSON 格式错误
4. 服务启动失败

**解决方法：**
1. 检查 PyPI 上是否能搜索到你的包
2. 确认 `server_info.json` 中的包名与 PyPI 一致
3. 使用 JSON 验证器检查格式
4. 本地测试服务是否能正常启动

### Q2: stdio 模式能托管部署吗？

**答案：可以！**

关键不在于 `stdio` 还是 `sse`，而在于：
- 服务配置使用 `uvx` 或 `npx`
- 包已发布到 PyPI 或 NPM
- 服务不依赖本地资源

### Q3: 如何更新已发布的服务？

1. 修改代码
2. 更新 `pyproject.toml` 中的版本号
3. 重新构建并上传到 PyPI
4. 用户连接时会自动获取 `@latest` 版本

### Q4: 环境变量如何配置？

如果服务需要 API Key 等环境变量：

1. 在 `server_info.json` 中添加 `env` 字段：
```json
{
    "server": {
        "command": "uvx",
        "args": ["mcp-server-bmi-calculator@latest"],
        "env": {
            "API_KEY": "YOUR_API_KEY"
        }
    }
}
```

2. 在魔搭平台创建时，系统会自动提取环境变量配置

## 技术要点总结

### stdio vs sse 的区别

| 特性 | stdio | sse |
|------|-------|-----|
| 通信方式 | 标准输入/输出 | HTTP Server-Sent Events |
| 托管部署 | ✅ 支持 | ✅ 支持 |
| 配置要求 | `uvx`/`npx` + PyPI/NPM | `uvx`/`npx` + PyPI/NPM |
| 适用场景 | 本地工具、CLI | Web服务、远程API |

**结论：** 两种模式都可以托管部署，选择取决于你的使用场景，而非部署能力。

### 魔搭平台部署要求

1. **必须发布到包管理器**：PyPI（Python）或 NPM（JavaScript）
2. **服务配置规范**：
   - `command`: `uvx` 或 `npx`
   - `args`: 包名（建议加 `@latest`）
3. **无本地依赖**：不能依赖本地文件、数据库等
4. **环境变量规范**：使用 `env` 字段或大写参数格式

## 下一步行动

- [ ] 修改 `pyproject.toml` 中的 GitHub URL
- [ ] 本地测试服务功能
- [ ] 构建并发布到 TestPyPI
- [ ] 验证 TestPyPI 安装
- [ ] 发布到正式 PyPI
- [ ] 在魔搭平台创建服务
- [ ] 等待部署检测通过
- [ ] 测试托管服务功能

## 参考资源

- [魔搭 MCP 广场](https://modelscope.cn/mcp)
- [PyPI 官网](https://pypi.org/)
- [TestPyPI](https://test.pypi.org/)
- [Python 打包指南](https://packaging.python.org/)