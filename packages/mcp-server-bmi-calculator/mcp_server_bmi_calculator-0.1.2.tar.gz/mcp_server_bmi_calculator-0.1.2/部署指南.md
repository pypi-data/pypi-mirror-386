# BMI Calculator MCP 托管部署指南

## 项目概述

本项目是 `bmi-calculator-mcp-stdio` 的可托管部署版本，已按照魔搭平台的要求进行了完整的结构优化和配置修正。

## 关键修复说明

### 1. 目录结构修正

**问题根源：**
原项目的包目录名 `bmi_calculator_mcp` 与 `pyproject.toml` 中的项目名 `mcp-server-bmi-calculator` 不匹配，导致 `hatchling` 打包工具无法正确识别要打包的文件。

**修复方案：**
- 将包目录从 `src/bmi_calculator_mcp/` 重命名为 `src/mcp_server_bmi_calculator/`
- 这样包名（`mcp_server_bmi_calculator`）就与项目名（`mcp-server-bmi-calculator`，连字符转下划线）完全匹配

**当前正确的目录结构：**
```
test/bmi-calculator-mcp-stdio-deployable/
├── pyproject.toml
├── README_zh-CN.md
├── README_en-US.md
├── server_info.json
├── 部署指南.md
└── src/
    └── mcp_server_bmi_calculator/
        ├── __init__.py
        ├── __main__.py
        └── bmi_mcp_server.py
```

### 2. pyproject.toml 修正

**关键配置更新：**

```toml
[project]
name = "mcp-server-bmi-calculator"  # 项目名称
version = "0.1.1"

[project.scripts]
mcp-server-bmi-calculator = "mcp_server_bmi_calculator:main"  # 入口点指向正确的包名

[tool.hatch.build.targets.wheel]
packages = ["src/mcp_server_bmi_calculator"]  # 指定正确的包路径
```

### 3. server_info.json 配置

**托管部署配置：**
```json
{
    "server": {
        "command": "uvx",
        "args": [
            "mcp-server-bmi-calculator@latest"
        ]
    }
}
```

**关键点：**
- `command` 必须是 `uvx`（Python 包）或 `npx`（NPM 包）
- `args` 中的包名必须与 PyPI 上发布的包名一致
- `@latest` 确保用户始终使用最新版本

## 部署步骤

### 步骤 1：清理旧的构建文件（如果存在）

```bash
# 删除旧的 dist 目录
Remove-Item -Path "dist" -Recurse -Force -ErrorAction SilentlyContinue

# 删除旧的 build 目录
Remove-Item -Path "build" -Recurse -Force -ErrorAction SilentlyContinue

# 删除旧的 .egg-info 目录
Remove-Item -Path "*.egg-info" -Recurse -Force -ErrorAction SilentlyContinue
```

### 步骤 2：构建项目

#### 2.1 安装构建工具

```bash
pip install build twine
```

#### 2.2 执行构建

在项目根目录（`test/bmi-calculator-mcp-stdio-deployable`）执行：

```bash
python -m build
```

**预期输出：**
```
* Creating isolated environment: venv+pip...
* Installing packages in isolated environment:
  - hatchling
* Getting build dependencies for sdist...
* Building sdist...
* Building wheel from sdist
* Creating isolated environment: venv+pip...
* Installing packages in isolated environment:
  - hatchling
* Getting build dependencies for wheel...
* Building wheel...
Successfully built mcp_server_bmi_calculator-0.1.1.tar.gz and mcp_server_bmi_calculator-0.1.1-py3-none-any.whl
```

**生成的文件：**
- `dist/mcp_server_bmi_calculator-0.1.1-py3-none-any.whl`
- `dist/mcp_server_bmi_calculator-0.1.1.tar.gz`

### 步骤 3：上传到 PyPI

#### 3.1 测试环境（推荐先测试）

```bash
python -m twine upload --repository testpypi dist/*
```

**验证测试安装：**
```bash
pip install --index-url https://test.pypi.org/simple/ mcp-server-bmi-calculator
```

#### 3.2 生产环境

```bash
python -m twine upload dist/*
```

**注意事项：**
- 需要先在 [PyPI](https://pypi.org/) 注册账号
- 包名 `mcp-server-bmi-calculator` 必须在 PyPI 上唯一
- 如果包名已被占用，需要修改 `pyproject.toml` 中的 `name` 字段

### 步骤 4：在魔搭平台创建 MCP 服务

#### 4.1 前往创建页面

访问魔搭 MCP 广场，点击右上角"创建"按钮，选择"自定义创建"。

#### 4.2 填写基础信息

**必填字段：**

| 字段 | 值 | 说明 |
|------|-----|------|
| 英文名称 | `bmi-calculator` | 将与所有者组成服务ID |
| 展示名称 | `BMI计算器` | 在平台展示的名称 |
| 所有者 | 选择个人或组织 | - |
| 是否公开 | 公开 | 当前仅支持公开 |
| 托管类型 | **可托管部署** | 关键选择 |
| 服务图标 | 上传图标 | 建议尺寸 256x256 |

#### 4.3 填写服务配置

在"服务配置"字段中，粘贴以下 JSON（**不要包含注释**）：

```json
{
  "mcpServers": {
    "bmi-calculator": {
      "command": "uvx",
      "args": [
        "mcp-server-bmi-calculator@latest"
      ]
    }
  }
}
```

**重要提示：**
- JSON 中不能包含注释
- 确保包名与 PyPI 上发布的一致
- 建议使用 `@latest` 后缀

#### 4.4 填写服务介绍

可以直接复制 `README_zh-CN.md` 的内容。

#### 4.5 填写其他信息

- **服务描述**：计算身体质量指数(BMI)并提供健康状况评估
- **类型**：选择"健康工具"或相关分类
- **环境变量配置**：本项目无需环境变量，留空即可

### 步骤 5：等待自动部署检测

提交创建后，魔搭平台将自动执行以下检测：

1. **服务配置解析**：检查 JSON 格式
2. **服务配置可用性**：验证 `command` 和 `args`
3. **尝试部署并连接**：
   - 从 PyPI 下载 `mcp-server-bmi-calculator@latest`
   - 启动服务并调用 `list_tools`
   - 验证工具列表是否正常返回

**检测通过标志：**
- 服务详情页显示"可部署"标签
- 公开服务会显示"hosted"标签
- 工具测试页可以查看可用工具列表

### 步骤 6：测试服务

#### 6.1 本地测试（发布前）

```bash
# 安装依赖
pip install -e .

# 运行服务
python -m mcp_server_bmi_calculator
```

#### 6.2 平台测试（发布后）

1. 在服务详情页点击"工具测试"
2. 选择 `calculate_bmi` 工具
3. 输入测试参数：
   - `height`: 1.75
   - `weight`: 70
4. 查看返回结果

## 常见问题

### Q1: 为什么之前打包失败？

**答案：** 包目录名与项目名不匹配。

Python 打包工具（特别是 `hatchling`）要求 `src` 目录下的包名必须与 `pyproject.toml` 中的项目名相对应（连字符 `-` 转换为下划线 `_`）。

**错误示例：**
- 项目名：`mcp-server-bmi-calculator`
- 包目录：`src/bmi_calculator_mcp/` ❌

**正确示例：**
- 项目名：`mcp-server-bmi-calculator`
- 包目录：`src/mcp_server_bmi_calculator/` ✅

### Q2: stdio 模式能托管部署吗？

**答案：可以！**

关键不在于 `stdio` 还是 `sse`，而在于：
- 服务配置使用 `uvx` 或 `npx`
- 包已发布到 PyPI 或 NPM
- 服务不依赖本地资源

**stdio vs sse 对比：**

| 特性 | stdio | sse |
|------|-------|-----|
| 通信方式 | 标准输入/输出 | HTTP Server-Sent Events |
| 托管部署 | ✅ 支持 | ✅ 支持 |
| 配置要求 | `uvx`/`npx` + PyPI/NPM | `uvx`/`npx` + PyPI/NPM |
| 适用场景 | 本地工具、CLI | Web服务、远程API |

### Q3: 如何更新已发布的服务？

1. 修改代码
2. 更新 `pyproject.toml` 中的版本号
3. 重新构建：`python -m build`
4. 重新上传到 PyPI：`python -m twine upload dist/*`
5. 用户连接时会自动获取 `@latest` 版本

### Q4: 部署检测失败怎么办？

**可能原因：**
1. PyPI 包未成功发布
2. 包名不匹配
3. 服务配置 JSON 格式错误
4. 服务启动失败

**解决方法：**
1. 检查 PyPI 上是否能搜索到你的包
2. 确认 `server_info.json` 中的包名与 PyPI 一致
3. 使用 JSON 验证器检查格式
4. 本地测试服务是否能正常启动

## 技术要点总结

### Python 包命名规范

1. **项目名（`pyproject.toml` 中的 `name`）**：
   - 可以使用连字符 `-`
   - 示例：`mcp-server-bmi-calculator`

2. **包目录名（`src/` 下的目录）**：
   - 必须使用下划线 `_`
   - 必须与项目名对应（连字符转下划线）
   - 示例：`mcp_server_bmi_calculator`

3. **入口点（`[project.scripts]`）**：
   - 命令名可以使用连字符
   - 包名必须使用下划线
   - 示例：`mcp-server-bmi-calculator = "mcp_server_bmi_calculator:main"`

### 魔搭平台部署要求

1. **必须发布到包管理器**：PyPI（Python）或 NPM（JavaScript）
2. **服务配置规范**：
   - `command`: `uvx` 或 `npx`
   - `args`: 包名（建议加 `@latest`）
3. **无本地依赖**：不能依赖本地文件、数据库等
4. **环境变量规范**：使用 `env` 字段或大写参数格式

### 参考示例对比

**fetch 示例（成功）：**
- 项目名：`mcp-server-fetch`
- 包目录：`src/mcp_server_fetch/`
- 入口点：`mcp-server-fetch = "mcp_server_fetch:main"`

**sequentialthinking 示例（成功）：**
- 项目名：`@modelcontextprotocol/server-sequential-thinking`
- 使用 NPM 发布（TypeScript 项目）
- 命令：`npx -y @modelcontextprotocol/server-sequential-thinking`

**本项目（修复后）：**
- 项目名：`mcp-server-bmi-calculator`
- 包目录：`src/mcp_server_bmi_calculator/`
- 入口点：`mcp-server-bmi-calculator = "mcp_server_bmi_calculator:main"`

## 下一步行动

- [x] 修正项目目录结构
- [x] 更新 `pyproject.toml` 配置
- [x] 删除旧的包目录
- [ ] 清理旧的构建文件
- [ ] 本地测试服务功能
- [ ] 构建并发布到 TestPyPI
- [ ] 验证 TestPyPI 安装
- [ ] 发布到正式 PyPI
- [ ] 在魔搭平台创建服务
- [ ] 等待部署检测通过
- [ ] 测试托管服务功能

## 参考资源

- [魔搭 MCP 广场](https://modelscope.cn/mcp)
- [PyPI 官网](https://pypi.org/)
- [TestPyPI](https://test.pypi.org/)
- [Python 打包指南](https://packaging.python.org/)
- [Hatchling 文档](https://hatch.pypa.io/latest/)