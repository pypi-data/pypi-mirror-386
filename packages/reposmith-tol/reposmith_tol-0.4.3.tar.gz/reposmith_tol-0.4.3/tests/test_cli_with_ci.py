import sys
import subprocess
import tempfile
from pathlib import Path
import re
import inspect
import pytest

def _help_text_for(subcmd: str) -> str:
    """Return the help text for a specific CLI subcommand.

    Args:
        subcmd (str): The subcommand to retrieve help for.

    Returns:
        str: The help message text for the subcommand.
    """
    proc = subprocess.run(
        [sys.executable, "-m", "reposmith.main", subcmd, "--help"],
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        check=False,
    )
    return proc.stdout or ""

def _is_flag_supported(help_text: str, flag: str) -> bool:
    """Check if a specific flag is present in the help text.

    Args:
        help_text (str): The CLI help message.
        flag (str): The flag to search for.

    Returns:
        bool: True if the flag is supported, False otherwise.
    """
    pat = r"(?:^|\s)" + re.escape(flag) + r"(?:\s|,|$)"
    return re.search(pat, help_text) is not None

class TestCLISmokeWithCI:
    """Smoke tests for the CI-related functionality in reposmith CLI."""

    def _run(self, args, cwd: Path):
        """Run a CLI command with given arguments and working directory.

        Args:
            args (list): Arguments to pass to the CLI.
            cwd (Path): Directory to run the command in.

        Returns:
            CompletedProcess: Result of subprocess.run.
        """
        return subprocess.run(
            [sys.executable, "-m", "reposmith.main"] + args,
            cwd=cwd,
            check=True,
        )

    def test_ci_adaptive(self):
        """Test that CI workflow can be generated either via CLI or via utility function fallback."""
        with tempfile.TemporaryDirectory() as td:
            proj = Path(td) / "proj"
            proj.mkdir(parents=True, exist_ok=True)

            help_text = _help_text_for("init")
            workflows_dir = proj / ".github" / "workflows"
            ci_file = workflows_dir / "ci.yml"

            if _is_flag_supported(help_text, "--with-ci"):
                args = ["init", "--with-ci"]
                if _is_flag_supported(help_text, "--ci-python"):
                    args += ["--ci-python", "3.13"]
                if _is_flag_supported(help_text, "--entry"):
                    args += ["--entry", "run.py"]
                self._run(args, cwd=proj)
                assert ci_file.exists(), "Expected CI workflow to be generated via CLI."
            else:
                try:
                    from reposmith.ci_utils import ensure_github_actions_workflow
                except Exception:
                    self._run(["init"], cwd=proj)
                    return

                sig = inspect.signature(ensure_github_actions_workflow)
                params = sig.parameters

                call_kwargs = {}
                call_args = [proj]

                for name in ("python_version", "version", "py", "python"):
                    if name in params:
                        call_kwargs[name] = "3.12"
                        break

                if not call_kwargs and len(params) > 1:
                    try:
                        ensure_github_actions_workflow(proj, "3.12")
                    except TypeError:
                        ensure_github_actions_workflow(proj)
                    else:
                        assert ci_file.exists()
                        return
                else:
                    ensure_github_actions_workflow(*call_args, **call_kwargs)

                assert ci_file.exists(), "Expected CI workflow to be generated by ensure_github_actions_workflow()."