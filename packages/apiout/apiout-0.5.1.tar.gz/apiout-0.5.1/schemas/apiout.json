{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/apiout/apiout/main/schemas/apiout.json",
  "title": "apiout Configuration",
  "description": "Configuration schema for apiout - a tool for fetching and serializing API data",
  "type": "object",
  "properties": {
    "clients": {
      "type": "object",
      "description": "Named client configurations that can be referenced by multiple APIs",
      "additionalProperties": {
        "$ref": "#/definitions/client"
      }
    },
    "apis": {
      "type": "array",
      "description": "List of API configurations to fetch",
      "items": {
        "$ref": "#/definitions/api"
      }
    },
    "serializers": {
      "type": "object",
      "description": "Named serializer configurations for transforming API responses. Supports both global serializers (top-level) and client-scoped serializers (nested under client names)",
      "additionalProperties": {
        "oneOf": [
          {
            "$ref": "#/definitions/serializer",
            "description": "Global serializer (not scoped to a specific client)"
          },
          {
            "type": "object",
            "description": "Client-scoped serializers (nested under client name)",
            "additionalProperties": {
              "$ref": "#/definitions/serializer"
            }
          }
        ]
      }
    },
    "post_processors": {
      "type": "array",
      "description": "List of post-processors to combine and transform API results",
      "items": {
        "$ref": "#/definitions/post_processor"
      }
    }
  },
  "definitions": {
    "client": {
      "type": "object",
      "description": "Reusable client configuration that can be referenced by multiple APIs. All APIs referencing the same client automatically share one instance.",
      "required": ["module"],
      "properties": {
        "module": {
          "type": "string",
          "description": "Python module to import"
        },
        "client_class": {
          "type": "string",
          "description": "Name of the client class (default: 'Client')",
          "default": "Client"
        },
        "init_params": {
          "type": "object",
          "description": "Parameters to pass to the client class constructor",
          "additionalProperties": true
        },
        "init_method": {
          "type": "string",
          "description": "Method to call once after client instantiation. Called only when the client is first created."
        }
      },
      "additionalProperties": false
    },
    "api": {
      "type": "object",
      "description": "Configuration for a single API call",
      "required": ["name", "method"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique identifier for this API"
        },
        "client": {
          "type": "string",
          "description": "Reference to a client configuration defined in the clients section"
        },
        "module": {
          "type": "string",
          "description": "Python module to import (not required if 'client' is specified)"
        },
        "client_class": {
          "type": "string",
          "description": "Name of the client class (default: 'Client')",
          "default": "Client"
        },
        "method": {
          "type": "string",
          "description": "Method to call on the client instance"
        },
        "url": {
          "type": "string",
          "description": "API endpoint URL",
          "format": "uri"
        },
        "init_params": {
          "type": "object",
          "description": "Parameters to pass to the client class constructor (can override client-level init_params)",
          "additionalProperties": true
        },
        "params": {
          "type": "object",
          "description": "Parameters to pass to the API method",
          "additionalProperties": true
        },
        "serializer": {
          "description": "Reference to a serializer configuration (string) or inline serializer (object). String can be a simple name (resolved with client scope if 'client' is specified, or globally), a dotted reference (e.g., 'client_name.serializer_name'), or an inline object.",
          "oneOf": [
            {
              "type": "string",
              "description": "Name of a serializer. Resolution order: 1) Inline dict (if object), 2) Explicit dotted reference (e.g., 'client.serializer'), 3) Client-scoped (if 'client' is specified), 4) Global serializer"
            },
            {
              "$ref": "#/definitions/serializer",
              "description": "Inline serializer configuration"
            }
          ]
        }
      },
      "additionalProperties": true
    },
    "serializer": {
      "type": "object",
      "description": "Configuration for serializing API response objects",
      "properties": {
        "fields": {
          "type": "object",
          "description": "Field mappings from response object to output",
          "additionalProperties": {
            "$ref": "#/definitions/field_mapping"
          }
        }
      }
    },
    "field_mapping": {
      "description": "Mapping for a single field",
      "oneOf": [
        {
          "type": "string",
          "description": "Simple attribute or method name to access"
        },
        {
          "type": "object",
          "description": "Complex field mapping with method calls, nested fields, or iteration",
          "properties": {
            "method": {
              "type": "string",
              "description": "Method name to call on the object"
            },
            "fields": {
              "type": "object",
              "description": "Nested field mappings",
              "additionalProperties": {
                "$ref": "#/definitions/field_mapping"
              }
            },
            "iterate": {
              "type": "object",
              "description": "Configuration for iterating over collections",
              "required": ["count", "item", "fields"],
              "properties": {
                "count": {
                  "type": "string",
                  "description": "Method or attribute returning the number of items"
                },
                "item": {
                  "type": "string",
                  "description": "Method name that takes an index parameter to get an item"
                },
                "fields": {
                  "type": "object",
                  "description": "Field mappings to extract from each item",
                  "additionalProperties": {
                    "$ref": "#/definitions/field_mapping"
                  }
                }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "post_processor": {
      "type": "object",
      "description": "Configuration for post-processing API results",
      "required": ["name", "class", "inputs"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique identifier for this post-processor"
        },
        "client": {
          "type": "string",
          "description": "Reference to a client configuration defined in the clients section"
        },
        "module": {
          "type": "string",
          "description": "Python module containing the processor class (not required if 'client' is specified)"
        },
        "class": {
          "type": "string",
          "description": "Name of the class to instantiate"
        },
        "method": {
          "type": "string",
          "description": "Optional method to call on the instantiated class"
        },
        "inputs": {
          "type": "array",
          "description": "List of API names or previous post-processor names to use as inputs",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "serializer": {
          "description": "Reference to a serializer configuration (string) or inline serializer (object). String can be a simple name (resolved globally), a dotted reference (e.g., 'client_name.serializer_name'), or an inline object.",
          "oneOf": [
            {
              "type": "string",
              "description": "Name of a serializer defined in the serializers section"
            },
            {
              "$ref": "#/definitions/serializer",
              "description": "Inline serializer configuration"
            }
          ]
        }
      },
      "additionalProperties": false
    }
  }
}
