<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planar SSE Example</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #events {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .event {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .event-time {
            color: #888;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <h1>Planar SSE</h1>
    <div>
        <div style="margin-bottom: 10px;">
            <label for="endpoint">SSE Endpoint:</label>
            <input type="text" id="endpoint" style="width: 400px;" value="http://127.0.0.1:8000/api/sse?subscribe=workflow-*">
        </div>
        <div>
            <button id="connect">Connect</button>
            <button id="disconnect">Disconnect</button>
            <span id="status">Disconnected</span>
        </div>
    </div>
    <div id="events"></div>

    <script>
        let eventSource = null;
        const eventsContainer = document.getElementById('events');
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const endpointInput = document.getElementById('endpoint');

        function appendEvent(eventData, eventType = 'message') {
            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            
            const time = new Date().toISOString();
            const timeEl = document.createElement('div');
            timeEl.className = 'event-time';
            timeEl.textContent = `[${time}] Type: ${eventType}`;
            
            const contentEl = document.createElement('div');
            contentEl.className = 'event-content';
            contentEl.textContent = typeof eventData === 'object' ? 
                JSON.stringify(eventData, null, 2) : 
                eventData;
            
            eventEl.appendChild(timeEl);
            eventEl.appendChild(contentEl);
            eventsContainer.appendChild(eventEl);
            eventsContainer.scrollTop = eventsContainer.scrollHeight;
        }

        function connect() {
            if (eventSource) {
                eventSource.close();
            }

            const url = endpointInput.value.trim();
            if (!url) {
                appendEvent('Please enter a valid endpoint URL', 'error');
                return;
            }
            
            eventSource = new EventSource(url);
            
            eventSource.onopen = () => {
                statusEl.textContent = 'Connected to ' + url;
                appendEvent('Connection established');
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    appendEvent(data.payload, data.name);
                } catch (e) {
                    appendEvent(event.data);
                }
            };

            eventSource.onerror = (error) => {
                statusEl.textContent = 'Error/Disconnected';
                appendEvent(`Connection error: ${error.type}`, 'error');
                eventSource.close();
                eventSource = null;
            };
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                statusEl.textContent = 'Disconnected';
                appendEvent('Connection closed');
            }
        }

        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
    </script>
</body>
</html>
