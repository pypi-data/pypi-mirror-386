# Copyright (C) 2022 ASTRON (Netherlands Institute for Radio Astronomy)
# SPDX-License-Identifier: GPL-3.0-or-later

# Read the Docs configuration file
# See https://docs.readthedocs.io/en/stable/config-file/v2.html

version: 2

build:
  os: ubuntu-24.04
  tools:
    python: "3.12"
  apt_packages:
    - cmake
    - doxygen
    - g++
    - git
    - graphviz
    - libblas-dev
    - libboost-all-dev
    - libcfitsio-dev
    - libfftw3-dev
    - libhdf5-dev
    - liblapack-dev
    - libpng-dev
    - libpython3-dev
    - libxml2-dev
    - ninja-build
    - python3-dev
    - python3-pip
    - wcslib-dev
    - wget
  jobs:
    pre_build:
      # Download a pre-built casacore 3.7.1 in user space
      - cd && wget https://support.astron.nl/software/ci_data/EveryBeam/casacore_3.7.1_ubuntu24.04.tgz && tar xf casacore_3.7.1_ubuntu24.04.tgz
      # Install python-casacore.
      - cd && git clone --branch v3.7.1 --depth 1 https://github.com/casacore/python-casacore && cd ~/python-casacore && CMAKE_ARGS="-DCASACORE_ROOT_DIR=~/casacore -DCMAKE_INSTALL_RPATH=/home/docs/casacore/lib" pip install --break-system-packages .
      # Install the EveryBeam Python package, which contains the Python documentation.
      - CMAKE_ARGS="-DCASACORE_ROOT_DIR=~/casacore" pip install -v --break-system-packages .
      # Finally, build the documentation.
      - mkdir build && cmake -DCASACORE_ROOT_DIR=~/casacore -DBUILD_WITH_PYTHON=ON -DCMAKE_INSTALL_PREFIX=~/.local -DCMAKE_INSTALL_RPATH=/home/docs/.local/lib -DCMAKE_BUILD_RPATH=/home/docs/.local/lib -G Ninja -S . -B build
      - cd build && ninja doxygen
    build:
      html:
        - cd doc && LD_LIBRARY_PATH=/home/docs/casacore/lib:$LD_LIBRARY_PATH python -m sphinx -T -b html -d _build/doctrees -D language=en . $READTHEDOCS_OUTPUT/html

sphinx:
   configuration: doc/conf.py

python:
   install:
     - requirements: doc/requirements.txt
