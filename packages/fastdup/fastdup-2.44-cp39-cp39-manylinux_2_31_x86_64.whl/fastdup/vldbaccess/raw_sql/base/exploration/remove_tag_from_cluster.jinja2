WITH
{% include "_similarity_filtering_cte.jinja2" %},
cluster_media AS (
    SELECT
        *
    FROM
        flat_similarity_clusters
    {% include "_similarity_join_filtering.jinja2" %}
    WHERE True
    {% include "_composite_filter.jinja2" %}
    {% if exclude_media_ids %}
     AND NOT (image_or_object_id = ANY(:exclude_media_ids))
    {% endif %}
)
DELETE FROM media_to_tags
WHERE
    media_id IN (SELECT image_or_object_id FROM cluster_media) AND
    dataset_id = :dataset_id AND
    tag_id = :tag_id;
