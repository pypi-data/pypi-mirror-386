WITH
{% include "_similarity_filtering_cte.jinja2" %}
SELECT
    original_uri, array_agg(DISTINCT tags.name) AS tags
FROM
    media_to_tags
    JOIN tags ON tags.id = media_to_tags.tag_id
    JOIN flat_similarity_clusters ON flat_similarity_clusters.image_or_object_id = media_id
    {% include "_similarity_join_filtering.jinja2" %}
WHERE 1=1
    {% include "_composite_filter.jinja2" %}
    AND original_uri = ANY(:media_original_uris)
GROUP by original_uri
ORDER BY original_uri
;
