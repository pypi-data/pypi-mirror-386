WITH
{% include "_similarity_filtering_cte.jinja2" %}
SELECT
    flat_similarity_clusters.*
FROM
    flat_similarity_clusters
    {% include "_similarity_join_filtering.jinja2" %}
WHERE
    True
    {% include "_composite_filter.jinja2" %}
ORDER BY
--{% if similarity_using_vector_db and anchor_media_id %}
(image_vector_filtered.similarity_distance_) {% if cosine_similarity %} DESC {% else %} ASC {% endif %}
--{% elif anchor_media_id %}
distance DESC
--{% else %}
preview_order ASC
--{% endif %}
--{% if page_number %}
OFFSET {{ page_number * page_size }} LIMIT {{ page_size }}
--{% else %}
LIMIT {{ page_size }}
--{% endif %}
