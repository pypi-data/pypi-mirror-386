WITH
{% include "_similarity_filtering_cte.jinja2" %},
page_of_clusters AS (
    {% include "_page_of_clusters.jinja2" %}
),
ranked_clusters AS (
    {% include "_ranked_clusters.jinja2" %}
),
cluster_flat_labels AS (
    {% include "_cluster_flat_labels.jinja2" %}
)
SELECT
    ranked_clusters.*, cluster_flat_labels.cluster_labels
FROM
    ranked_clusters
LEFT JOIN
    cluster_flat_labels ON ranked_clusters.cluster_id = cluster_flat_labels.cluster_id
WHERE ranked_clusters.rn <=9
ORDER BY cluster_rn, rn
;
