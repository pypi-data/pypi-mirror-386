WITH
{% include "_similarity_filtering_cte.jinja2" %}
SELECT
    cluster_id, jsonb_concat(jsonb_agg(labels), jsonb_agg(vl_labels)) as labels
FROM flat_similarity_clusters
    {% include "_similarity_join_filtering.jinja2" %}
WHERE True
    {% include "_composite_filter.jinja2" %}
    AND (cardinality(labels) != 0 OR cardinality(vl_labels) != 0)
GROUP by cluster_id
