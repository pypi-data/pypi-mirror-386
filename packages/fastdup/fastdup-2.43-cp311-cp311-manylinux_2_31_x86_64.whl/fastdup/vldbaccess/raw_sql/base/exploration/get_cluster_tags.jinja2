WITH
{% include "_similarity_filtering_cte.jinja2" %},
cluster_media AS (
    SELECT
        *
    FROM
        flat_similarity_clusters
    {% include "_similarity_join_filtering.jinja2" %}
    WHERE True
    {% include "_composite_filter.jinja2" %}
    {% if exclude_media_ids %}
     AND NOT (image_or_object_id = ANY(:exclude_media_ids))
    {% endif %}
)
SELECT DISTINCT id, name
FROM cluster_media
JOIN media_to_tags
ON cluster_media.image_or_object_id = media_to_tags.media_id
JOIN tags ON id = media_to_tags.tag_id;
