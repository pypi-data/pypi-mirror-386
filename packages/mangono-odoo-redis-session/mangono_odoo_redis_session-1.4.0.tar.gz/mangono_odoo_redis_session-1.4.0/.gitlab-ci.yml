include:
  - component: $CI_SERVER_FQDN/gitlab-ci/code-quality/ruff@~latest
  - component: $CI_SERVER_FQDN/python-libs/ci-component/build@~latest
  - component: $CI_SERVER_FQDN/python-libs/ci-component/upload-pypi@~latest
    rules:
      - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_COMMIT_TAG == null
    inputs:
      registry_token_var: $TESTPYPI_REGISTRY_TOKEN
      dependencies: [ "build:python" ]
      registry_name: "testpypi"
      name: "pypi:test"
  - component: $CI_SERVER_FQDN/python-libs/ci-component/upload-pypi@~latest
    rules:
      - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED
    inputs:
      registry_token_var: $PYPI_REGISTRY_TOKEN
      registry_name: "pypi"
      dependencies: [ "build:python" ]
  - component: $CI_SERVER_FQDN/python-libs/ci-component/upload-pypi@~latest
    rules:
      - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED
    inputs:
      registry_token_var: $CI_JOB_TOKEN
      registry_name: "$CI_SERVER_HOST"
      dependencies: [ "build:python" ]
  - local: gitlab-ci/runbot-redis.gitlab-ci.yml
  - local: gitlab-ci/runbot-materia-kv.gitlab-ci.yml


# Only run pipeline if a merge request is open or run on a protected ref
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_REF_PROTECTED == "true"


# If we are tagging a release with a specific convention ("v" + number) and all
# previous checks succeeded, we proceed with creating a release automatically.
publish:release:
  tags: ["lint"]
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script: echo "Creating release $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG of components repository $CI_PROJECT_PATH"
